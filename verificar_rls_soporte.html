<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar RLS - Notificaciones Soporte</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Verificar RLS - Notificaciones Soporte</h1>
    <button onclick="verificarRLS()">Verificar RLS</button>
    <button onclick="probarEliminacionDirecta()">Probar Eliminaci√≥n Directa</button>
    <div id="resultado"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://lsmhcpsvjcbduqovbatj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzbWhjcHN2amNiZHVxb3ZiYXRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTM4MzgsImV4cCI6MjA3MjU4OTgzOH0.I7dEer-R2ZaiMvU-Hmve6Ms0wk82U1e7C67e8fYWIEw';
        
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function verificarRLS() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '<p>üîÑ Verificando pol√≠ticas RLS...</p>';

            try {
                // 1. Verificar si podemos leer
                const { data: readData, error: readError } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .limit(1);
                
                if (readError) {
                    resultado.innerHTML += `<p>‚ùå Error al leer: ${readError.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Lectura exitosa: ${readData.length} registros</p>`;
                }

                // 2. Verificar si podemos insertar
                const notificacionPrueba = {
                    cotizacionId: 'TEST-RLS-' + Date.now(),
                    solicitudDespachoId: 'TEST-DESPACHO-' + Date.now(),
                    cliente: 'Cliente RLS Test',
                    solucion: 'Rastreo avanzado',
                    estado: 'pendiente',
                    fechaCreacion: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await client
                    .from('notificaciones_soporte')
                    .insert([{ data: notificacionPrueba }])
                    .select();

                if (insertError) {
                    resultado.innerHTML += `<p>‚ùå Error al insertar: ${insertError.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Inserci√≥n exitosa: ID ${insertData[0].id}</p>`;
                    
                    // 3. Verificar si podemos eliminar
                    const { data: deleteData, error: deleteError } = await client
                        .from('notificaciones_soporte')
                        .delete()
                        .eq('id', insertData[0].id)
                        .select();

                    if (deleteError) {
                        resultado.innerHTML += `<p>‚ùå Error al eliminar: ${deleteError.message}</p>`;
                    } else {
                        resultado.innerHTML += `<p>‚úÖ Eliminaci√≥n exitosa: ${deleteData.length} registros eliminados</p>`;
                    }
                }

                // 4. Verificar pol√≠ticas espec√≠ficas
                resultado.innerHTML += `<p>üîç Verificando pol√≠ticas espec√≠ficas...</p>`;
                
                // Intentar eliminar por cotizacionId
                const { data: deleteByCotizacion, error: errorByCotizacion } = await client
                    .from('notificaciones_soporte')
                    .delete()
                    .eq('data->>cotizacionId', 'COT-2025-297')
                    .select();

                if (errorByCotizacion) {
                    resultado.innerHTML += `<p>‚ùå Error al eliminar por cotizacionId: ${errorByCotizacion.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Eliminaci√≥n por cotizacionId exitosa: ${deleteByCotizacion.length} registros eliminados</p>`;
                }

            } catch (error) {
                console.error('‚ùå Error general:', error);
                resultado.innerHTML += `<p>‚ùå Error general: ${error.message}</p>`;
            }
        }

        async function probarEliminacionDirecta() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML += '<p>üîÑ Probando eliminaci√≥n directa...</p>';

            try {
                // Obtener la notificaci√≥n espec√≠fica
                const { data: notificaciones, error: error1 } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .eq('data->>cotizacionId', 'COT-2025-297');

                if (error1) {
                    resultado.innerHTML += `<p>‚ùå Error al obtener notificaciones: ${error1.message}</p>`;
                    return;
                }

                resultado.innerHTML += `<p>üìä Notificaciones encontradas: ${notificaciones.length}</p>`;

                if (notificaciones.length > 0) {
                    const notif = notificaciones[0];
                    resultado.innerHTML += `<p>üéØ Intentando eliminar notificaci√≥n ID: ${notif.id}</p>`;

                    // Intentar eliminar por ID directo
                    const { data: deleteData, error: deleteError } = await client
                        .from('notificaciones_soporte')
                        .delete()
                        .eq('id', notif.id)
                        .select();

                    if (deleteError) {
                        resultado.innerHTML += `<p>‚ùå Error al eliminar por ID: ${deleteError.message}</p>`;
                    } else {
                        resultado.innerHTML += `<p>‚úÖ Eliminaci√≥n por ID exitosa: ${deleteData.length} registros eliminados</p>`;
                    }

                    // Verificar si realmente se elimin√≥
                    const { data: verificacion, error: errorVerificacion } = await client
                        .from('notificaciones_soporte')
                        .select('*')
                        .eq('id', notif.id);

                    if (errorVerificacion) {
                        resultado.innerHTML += `<p>‚ùå Error al verificar: ${errorVerificacion.message}</p>`;
                    } else if (verificacion.length === 0) {
                        resultado.innerHTML += `<p>‚úÖ Verificaci√≥n exitosa: La notificaci√≥n fue eliminada</p>`;
                    } else {
                        resultado.innerHTML += `<p>‚ùå Verificaci√≥n fallida: La notificaci√≥n a√∫n existe</p>`;
                    }
                } else {
                    resultado.innerHTML += `<p>‚ÑπÔ∏è No hay notificaciones para eliminar</p>`;
                }

            } catch (error) {
                console.error('‚ùå Error en eliminaci√≥n directa:', error);
                resultado.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
