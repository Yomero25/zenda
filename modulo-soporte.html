<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZendA - Workflow Manager | Soporte</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { background: #1f2937; color: #fff; min-height: 100vh; padding: 20px; }
    .sidebar .brand img { height: 40px; }
    .solicitud-card.deshabilitada { opacity: .8; filter: grayscale(.2); }
    .badge-config { background: #e5e7eb; color: #111827; }
    .bg-primary{ background-color:#fb930c !important; }
    .text-primary{ color:#fb930c !important; }
    .kpi-card{ border-radius:12px; padding:16px; color:#fff; }
    .kpi-total{ background: linear-gradient(135deg,#fb930c,#e67e22); }
    .kpi-enconf{ background: linear-gradient(135deg,#17a2b8,#138496); }
    .kpi-listos{ background: linear-gradient(135deg,#28a745,#1e7e34); }
    /* Homologar KPIs como otros módulos */
    .dashboard-card { border-radius: 15px; padding: 20px; color: #fff; margin-bottom: 20px; }
    .dashboard-card h2 { font-size: 2.25rem; font-weight: bold; margin: 0; }
    .dashboard-card p { margin: 0; font-size: 1rem; }
    .bg-gradient-blue { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
    .bg-gradient-green { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
    .bg-gradient-orange { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 sidebar">
        <div class="brand d-flex align-items-center mb-4">
          <img src="./ZENDA.svg" alt="Logo Empresa" class="me-2">
          <h5 class="mb-0">Módulo Soporte</h5>
        </div>
        <!-- KPIs se mueven al cuerpo principal para homologar -->
      </div>
      <div class="col-md-9 p-0">
        <nav class="navbar navbar-dark bg-primary">
          <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-hdd-network"></i> Soporte - Configuración MDVR/GPS</span>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-light btn-sm" id="btnLogout"><i class="bi bi-box-arrow-right"></i> Salir</button>
            </div>
          </div>
        </nav>
        <div class="p-3">
          <!-- KPIs al estilo de otros módulos -->
          <div class="container-fluid mt-2">
            <div class="row">
              <div class="col-md-4">
                <div class="dashboard-card bg-gradient-orange">
                  <h2 id="kpiTotal">0</h2>
                  <p>Solicitudes</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="dashboard-card bg-gradient-blue">
                  <h2 id="kpiEnConfig">0</h2>
                  <p>En configuración</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="dashboard-card bg-gradient-green">
                  <h2 id="kpiListos">0</h2>
                  <p>Configurados</p>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Solicitudes</h5>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0 me-1">Estado:</label>
              <select id="filtroEstado" class="form-select form-select-sm" style="width:220px">
                <option value="">Todos</option>
                <option value="en_configuracion">En configuración</option>
                <option value="configurado">Configurado</option>
              </select>
            </div>
          </div>
          <div id="contenedorSolicitudes" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./dataService.js"></script>
  <script src="./accessGuard.js"></script>
  <script>
    (async function(){
      const ok = await window.accessGuard.ensureAuth(['soporte','admin']);
      if (!ok) return;
      const logoutBtn = document.getElementById('btnLogout');
      if (logoutBtn) logoutBtn.onclick = async () => { try{ await window.dataService.authSignOut(); }catch(_){} window.location.href = './login.html'; };

      const contenedor = document.getElementById('contenedorSolicitudes');
      const filtroEstado = document.getElementById('filtroEstado');

      let solicitudes = [];

      function render(){
        contenedor.innerHTML = '';
        const estado = filtroEstado.value;
        const lista = solicitudes.filter(s => !estado || (s.estado === estado));

        // KPIs (homologados)
        const enConf = solicitudes.filter(s=>s.estado==='en_configuracion').length;
        const listos = solicitudes.filter(s=>s.estado==='configurado').length;
        document.getElementById('kpiTotal').textContent = solicitudes.length;
        document.getElementById('kpiEnConfig').textContent = enConf;
        document.getElementById('kpiListos').textContent = listos;

        // Helper: resumen de configuraciones específicas (Dashcam, GPS, VPC)
        function renderConfigEspecifica(s){
          const det = Array.isArray(s.solucionesDetalladas) ? s.solucionesDetalladas : [];
          const blocks = [];
          // Dashcam: IA / Hosting / Memoria
          const dash = det.find(d => (d.solucion||'').toLowerCase().includes('dashcam'));
          if (dash && dash.configuraciones){
            const ia = dash.configuraciones.ia === true ? 'Sí' : 'No';
            const hosting = dash.configuraciones.hosting === true ? 'Sí' : 'No';
            const mem = dash.configuraciones.memoria ? String(dash.configuraciones.memoria) : '';
            blocks.push(`
              <div class="mt-2">
                <span class="badge bg-dark me-2">Dashcam</span>
                <span class="badge badge-config me-1">IA: ${ia}</span>
                <span class="badge badge-config me-1">Hosting: ${hosting}</span>
                ${mem ? `<span class="badge badge-config">Memoria: ${mem} Gb</span>` : ''}
              </div>
            `);
          }
          // Rastreo/GPS: flags principales
          const rast = det.find(d => (d.solucion||'').toLowerCase().includes('rastreo'));
          if (rast && rast.configuraciones){
            const keys = ['ip67','audio_bidireccional','audio_espia','bloqueo_cc','bloqueo_normal','sos_simple','sos_llamada','sos_bloqueo','alerta','hosting'];
            const chips = keys.filter(k => !!rast.configuraciones[k]).map(k => k.replace(/_/g, ' '));
            if (chips.length){
              blocks.push(`
                <div class="mt-2">
                  <span class="badge bg-dark me-2">GPS</span>
                  ${chips.map(c => `<span class=\"badge badge-config me-1\">${c}</span>`).join('')}
                </div>
              `);
            }
          }
          // VPC/Sideview con Grabación/Hosting
          const vpc = det.find(d => ['vpc','sideview','encadenamiento'].some(x => (d.solucion||'').toLowerCase().includes(x)));
          if (vpc && vpc.configuraciones){
            const g = vpc.configuraciones.grabacion === true ? 'Sí' : 'No';
            const h = vpc.configuraciones.hosting === true ? 'Sí' : 'No';
            blocks.push(`
              <div class="mt-2">
                <span class="badge bg-dark me-2">VPC/Sideview</span>
                <span class="badge badge-config me-1">Grabación: ${g}</span>
                <span class="badge badge-config me-1">Hosting: ${h}</span>
              </div>
            `);
          }
          return blocks.join('');
        }

        // Helper: detectar servicios necesarios según las soluciones
        function detectarServiciosNecesarios(s){
          const det = Array.isArray(s.solucionesDetalladas) ? s.solucionesDetalladas : [];
          const servicios = [];
          
          det.forEach(sd => {
            const tipoSolucion = sd.solucion || '';
            const configuraciones = sd.configuraciones || {};
            
            // Detectar servicios según las soluciones y configuraciones
            if (configuraciones.hosting) {
              // Servicios que requieren hosting
              if (tipoSolucion === 'VPC' || tipoSolucion === 'Dashcam' || 
                  tipoSolucion === 'Encadenamiento de señales' || tipoSolucion === 'Sideview' ||
                  tipoSolucion === 'MDVR 4 Ch' || tipoSolucion === 'MDVR 8 Ch') {
                servicios.push({
                  nombre: 'Datos video',
                  periodicidad: 'mensual',
                  unidad: sd.unidad || 1
                });
              } else if (tipoSolucion === 'Rastreo basico' || tipoSolucion === 'Rastreo avanzado') {
                servicios.push({
                  nombre: 'Datos rastreo basico',
                  periodicidad: 'mensual',
                  unidad: sd.unidad || 1
                });
              } else if (tipoSolucion === 'Rastreo satelital') {
                servicios.push({
                  nombre: 'Datos - Satelitales',
                  periodicidad: 'anual',
                  unidad: sd.unidad || 1
                });
                servicios.push({
                  nombre: 'Activación satelital',
                  periodicidad: 'anual',
                  unidad: sd.unidad || 1
                });
              }
            }
            
            // Detectar servicios de voz
            if (configuraciones.audio_bidireccional || configuraciones.audio_espia || 
                configuraciones.sos_llamada) {
              servicios.push({
                nombre: 'Datos - Voz',
                periodicidad: 'mensual',
                unidad: sd.unidad || 1
              });
            }
            
            // Detectar servicios de rastreo avanzado
            if (tipoSolucion === 'Rastreo avanzado' && configuraciones.hosting) {
              // Reemplazar el servicio básico con el avanzado
              const index = servicios.findIndex(serv => 
                serv.nombre === 'Datos rastreo basico' && serv.unidad === (sd.unidad || 1)
              );
              if (index !== -1) {
                servicios[index].nombre = 'Datos rastreo avanzado';
              }
            }
          });
          
          return servicios;
        }

        // Helper: detectar SIMs necesarias según los servicios
        function detectarSIMsNecesarias(s){
          const det = Array.isArray(s.solucionesDetalladas) ? s.solucionesDetalladas : [];
          const sims = [];
          
          det.forEach(sd => {
            const tipoSolucion = sd.solucion || '';
            const configuraciones = sd.configuraciones || {};
            const unidad = sd.unidad || 1;
            
            let tieneVideo = false;
            let tieneVoz = false;
            let tieneRastreo = false;
            
            if (configuraciones.hosting) {
              if (tipoSolucion === 'VPC' || tipoSolucion === 'Dashcam' || 
                  tipoSolucion === 'Encadenamiento de señales' || tipoSolucion === 'Sideview' ||
                  tipoSolucion === 'MDVR 4 Ch' || tipoSolucion === 'MDVR 8 Ch') {
                tieneVideo = true;
              } else if (tipoSolucion === 'Rastreo basico' || tipoSolucion === 'Rastreo avanzado') {
                tieneRastreo = true;
              }
            }
            
            if (configuraciones.audio_bidireccional || configuraciones.audio_espia || 
                configuraciones.sos_llamada) {
              tieneVoz = true;
            }
            
            // Agregar SIMs según los servicios detectados
            if (tieneVideo) {
              sims.push({
                nombre: 'SIM video',
                unidad: unidad,
                razon: 'Servicio de video'
              });
            }
            
            if (tieneVoz) {
              sims.push({
                nombre: 'SIM voz',
                unidad: unidad,
                razon: 'Servicio de voz'
              });
            }
            
            if (tieneRastreo) {
              sims.push({
                nombre: 'SIM 5 Mb',
                unidad: unidad,
                razon: 'Servicio de rastreo'
              });
            }
          });
          
          return sims;
        }

        lista.forEach(s => {
          const isLote = Number(s.cantidadUnidades || 1) > 1;
          // Bloque soluciones (por unidad o agregado si es lote)
          const solucionesBlock = (() => {
            if (isLote) {
              const u0 = (s.unidadesDetalladas && s.unidadesDetalladas[0]) || {};
              const marca = u0.marca || '';
              const tipo = u0.tipo_unidad || u0.tipo || (s.tipoUnidades || '');
              const modelo = u0.modelo || '';
              const anio = u0.anio || u0.año || '';
              const combustible = u0.combustible || '';
              const voltaje = u0.voltaje || '';
              // Soluciones agregadas
              const det = Array.isArray(s.solucionesDetalladas) ? s.solucionesDetalladas : [];
              const tipos = Array.from(new Set(det.map(d => d.solucion || '').filter(Boolean)));
              // Configs agregadas
              const cfgMap = {};
              det.forEach(d => {
                const cfg = d.configuraciones || {};
                Object.keys(cfg).forEach(k => {
                  const v = cfg[k];
                  if (v === true || (typeof v === 'string' && v) || typeof v === 'number') {
                    cfgMap[k] = cfgMap[k] || new Set();
                    cfgMap[k].add(String(v));
                  }
                });
              });
              const cfgChips = Object.keys(cfgMap).map(k => {
                const values = Array.from(cfgMap[k]);
                if (values.length === 0 || values[0] === 'true') return k.replace(/_/g,' ');
                return `${k.replace(/_/g,' ')}: ${values.join('/')}`;
              });
              return `
                <div class="mt-2">
                  <div class="alert alert-success py-2 mb-2">
                    <strong>Lote:</strong> ${s.cantidadUnidades} unidades idénticas
                  </div>
                  <div class="small">
                    <strong>Unidad:</strong> ${[marca, tipo, modelo].filter(Boolean).join(' ')} ${anio ? '('+anio+')' : ''}
                    ${combustible ? ` • <strong>Combustible:</strong> ${combustible}` : ''}
                    ${voltaje ? ` • <strong>Voltaje:</strong> ${voltaje}` : ''}
                  </div>
                  ${tipos.length ? `<div class="mt-2"><strong>Soluciones:</strong> ${tipos.map(t=>`<span class=\"badge bg-secondary me-1\">${t}</span>`).join('')}</div>` : ''}
                  ${cfgChips.length ? `<div class="mt-2">${cfgChips.map(c=>`<span class=\"badge badge-config me-1\">${c}</span>`).join('')}</div>` : ''}
                </div>
              `;
            }
            // No es lote: mostrar detalle por unidad (existente)
            return Array.isArray(s.solucionesDetalladas) && s.solucionesDetalladas.length ? `
              <div class="mt-2">
                ${s.solucionesDetalladas.map(sd => {
                  const cfgs = sd.configuraciones ? Object.entries(sd.configuraciones)
                    .filter(([k,v])=>v===true || (typeof v==='string'&&v!=='') || (typeof v==='number'))
                    .map(([k,v]) => typeof v === 'boolean' ? k : `${k}: ${v}`) : [];
                  return `<div class=\"mb-1\">
                    <span class=\"badge bg-secondary me-1\">Unidad ${sd.unidad} - ${sd.solucion}</span>
                    ${cfgs.map(c=>`<span class=\"badge badge-config me-1\">${c}</span>`).join('')}
                  </div>`
                }).join('')}
              </div>
            ` : '';
          })();
          const card = document.createElement('div');
          card.className = 'col-12';
          card.innerHTML = `
            <div class="card solicitud-card ${s.estado==='configurado'?'deshabilitada':''}">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="mb-1"><i class="bi bi-gear-wide-connected text-primary"></i> ${s.soluciones?.join(', ') || 'Configuraciones'}</h5>
                    <div class="text-muted">
                      <strong>Cliente:</strong> ${s.cliente || ''} • <strong>Cotización:</strong> ${s.cotizacionId}
                    </div>
                    <div class="mt-2 small">
                      <strong>Unidades:</strong> ${s.cantidadUnidades || 1} (${s.tipoUnidades || ''})
                    </div>
                    ${solucionesBlock}
                    ${renderConfigEspecifica(s)}
                    ${s.equipos ? `
                      <div class="mt-2 small">
                        <strong>Equipos:</strong> ${Object.entries(s.equipos).map(([k,v])=>`${k} x${v}`).join(', ')}
                      </div>
                    ` : ''}
                    ${(() => {
                      const servicios = detectarServiciosNecesarios(s);
                      const sims = detectarSIMsNecesarias(s);
                      let html = '';
                      
                      if (servicios.length > 0) {
                        // Agrupar servicios por nombre y periodicidad
                        const serviciosAgrupados = {};
                        servicios.forEach(servicio => {
                          const key = `${servicio.nombre}_${servicio.periodicidad}`;
                          if (!serviciosAgrupados[key]) {
                            serviciosAgrupados[key] = {
                              nombre: servicio.nombre,
                              periodicidad: servicio.periodicidad,
                              unidades: []
                            };
                          }
                          serviciosAgrupados[key].unidades.push(servicio.unidad);
                        });
                        
                        const serviciosUnicos = Object.values(serviciosAgrupados);
                        
                        html += `
                          <div class="mt-2">
                            <div class="alert alert-info py-2 mb-2">
                              <strong><i class="bi bi-cloud me-1"></i>Servicios de Datos:</strong>
                              <small class="d-block">Servicios detectados automáticamente según las soluciones seleccionadas</small>
                            </div>
                            <div class="row g-1">
                              ${serviciosUnicos.map(servicio => `
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                    <div>
                                      <span class="badge bg-primary me-1">${servicio.nombre}</span>
                                      <span class="badge ${servicio.periodicidad === 'anual' ? 'bg-danger' : 'bg-info'}">${servicio.periodicidad}</span>
                                    </div>
                                    <small class="text-muted">Unidades: ${servicio.unidades.join(', ')}</small>
                                  </div>
                                </div>
                              `).join('')}
                            </div>
                          </div>
                        `;
                      }
                      
                      if (sims.length > 0) {
                        // Agrupar SIMs por nombre
                        const simsAgrupadas = {};
                        sims.forEach(sim => {
                          if (!simsAgrupadas[sim.nombre]) {
                            simsAgrupadas[sim.nombre] = {
                              nombre: sim.nombre,
                              unidades: [],
                              razones: []
                            };
                          }
                          simsAgrupadas[sim.nombre].unidades.push(sim.unidad);
                          simsAgrupadas[sim.nombre].razones.push(sim.razon);
                        });
                        
                        const simsUnicas = Object.values(simsAgrupadas);
                        
                        html += `
                          <div class="mt-2">
                            <div class="alert alert-warning py-2 mb-2">
                              <strong><i class="bi bi-sim me-1"></i>SIMs Requeridas:</strong>
                              <small class="d-block">SIMs detectadas automáticamente según los servicios de datos</small>
                            </div>
                            <div class="row g-1">
                              ${simsUnicas.map(sim => `
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                    <div>
                                      <span class="badge bg-warning me-1">${sim.nombre}</span>
                                      <small class="text-muted">${sim.razones[0]}</small>
                                    </div>
                                    <small class="text-muted">Unidades: ${sim.unidades.join(', ')}</small>
                                  </div>
                                </div>
                              `).join('')}
                            </div>
                          </div>
                        `;
                      }
                      
                      return html;
                    })()}
                  </div>
                  <div class="text-end">
                    <span class="badge ${s.estado==='pendiente'?'bg-warning': s.estado==='en_configuracion'?'bg-info':'bg-success'}">${s.estado||'pendiente'}</span>
                    <div class="mt-2">
                      ${s.estado!=='en_configuracion' && s.estado!=='configurado' ? `<button class="btn btn-sm btn-outline-primary" data-acc="iniciar" data-id="${s.id}"><i class="bi bi-play"></i> Iniciar</button>`:''}
                      ${s.estado==='en_configuracion' ? `<button class="btn btn-sm btn-success" data-acc="finalizar" data-id="${s.id}"><i class="bi bi-check2-circle"></i> Finalizar</button>`:''}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          contenedor.appendChild(card);
        });
      }

      async function cargar(){
        try{
          const res = await window.dataService.fetchNotificacionesSoporte();
          solicitudes = Array.isArray(res) ? res : [];
        }catch(e){
          console.warn('Soporte: fallback local', e); solicitudes = JSON.parse(localStorage.getItem('notificaciones_soporte')||'[]');
        }
        render();
      }

      async function patchEstado(id, nuevoEstado){
        try{
          await window.dataService.patchNotificacionSoporteById(id, { estado: nuevoEstado, fechaActualizacion: new Date().toISOString() });
        }catch(e){
          // fallback local
          const arr = JSON.parse(localStorage.getItem('notificaciones_soporte')||'[]');
          const idx = arr.findIndex(x=>x.id===id);
          if (idx>=0){ arr[idx].estado = nuevoEstado; }
          localStorage.setItem('notificaciones_soporte', JSON.stringify(arr));
        }
        // Propagar a Despacho como bandera de soporte
        try{
          const notif = (solicitudes || []).find(x=>x.id===id);
          if (notif && notif.solicitudDespachoId) {
            const patch = { soporte_estado: nuevoEstado };
            if (nuevoEstado === 'en_configuracion') patch.soporte_fechaInicio = new Date().toISOString();
            if (nuevoEstado === 'configurado') patch.soporte_fechaFin = new Date().toISOString();
            await window.dataService.patchSolicitudDespachoById(String(notif.solicitudDespachoId), patch);
          }
        }catch(_){}
      }

      // Eventos
      filtroEstado.onchange = render;
      contenedor.onclick = async (ev)=>{
        const btn = ev.target.closest('button[data-acc]'); if (!btn) return;
        const id = btn.getAttribute('data-id'); const acc = btn.getAttribute('data-acc');
        if (acc==='iniciar') { await patchEstado(id,'en_configuracion'); await cargar(); }
        if (acc==='finalizar') { await patchEstado(id,'configurado'); await cargar(); }
      };

      // Realtime
      const ch = window.dataService.subscribeNotificacionesSoporte(async ()=>{ await cargar(); });
      await cargar();
    })();
  </script>
</body>
</html>


