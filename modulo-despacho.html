<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZendA - Workflow Manager | Despacho</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .dashboard-card h2 {
            font-size: 3rem;
            font-weight: bold;
            margin: 0;
        }
        .dashboard-card p {
            margin: 0;
            font-size: 1.1rem;
        }
        .bg-gradient-purple { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-blue { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-green { background: linear-gradient(135deg, #fb930c 0%, #f39c12 100%); }
        .bg-gradient-orange { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-red { background: linear-gradient(135deg, #fb930c 0%, #d35400 100%); }
        
        .sidebar {
            background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .solicitud-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .solicitud-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .detail-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .item-row {
            border-bottom: 1px solid #e9ecef;
            padding: 8px 0;
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .urgencia-alta { border-left: 5px solid #dc3545; }
        .urgencia-media { border-left: 5px solid #ffc107; }
        .urgencia-baja { border-left: 5px solid #28a745; }
        .solicitud-despachada { 
            background-color: #f8f9fa; 
            border-left: 5px solid #6c757d;
            opacity: 0.8;
        }
        .solicitud-despachada .card-title {
            color: #6c757d;
        }
        
        @media print {
            .sidebar, .btn, .filter-section { display: none !important; }
            .solicitud-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="text-center mb-4">
                    <img src="./ZENDA.svg?v=2" alt="ZendA - Workflow Manager" height="60" class="mb-3">
                    <h3 class="text-white">
                        <i class="bi bi-truck"></i> Panel de Despacho
                    </h3>
                </div>
                
                <button class="btn btn-success" onclick="generarSolicitudesDespacho()">
                    <i class="bi bi-plus-circle"></i> Generar Solicitudes
                </button>
                <button class="btn btn-warning" onclick="limpiarSolicitudesEliminadas()">
                    <i class="bi bi-trash"></i> Limpiar Eliminadas
                </button>
                
                <button class="btn btn-secondary" onclick="actualizarSolicitudes()">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                
                <div class="mt-4" id="adminActionsSidebar" style="display:none;">
                    <a href="./cotizaciones-completo.html" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Volver al Sistema Principal
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Header -->
                <nav class="navbar navbar-dark bg-dark">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <img src="./ZENDA.svg?v=2" alt="ZendA - Workflow Manager" height="40" class="me-3">
                            <span class="navbar-brand mb-0 h1">
                                <i class="bi bi-truck"></i> M√≥dulo de Despacho - Almac√©n
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="./cotizaciones-completo.html" class="btn btn-outline-light btn-sm" id="btnPrincipalHeader" style="display:none;">
                                <i class="bi bi-arrow-left"></i> Principal
                            </a>
                            <button class="btn btn-outline-light btn-sm" id="btnLogout">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Dashboard -->
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-purple">
                                <h2 id="totalSolicitudes">0</h2>
                                <p>Solicitudes Totales</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="dashboard-card bg-gradient-blue">
                                <h2 id="pendientes">0</h2>
                                <p>Pendientes</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="dashboard-card bg-gradient-green">
                                <h2 id="procesadas">0</h2>
                                <p>Procesadas</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="dashboard-card bg-gradient-orange">
                                <h2 id="cambiosValidados">0</h2>
                                <p>Cambios Validados</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="dashboard-card bg-gradient-blue">
                                <h2 id="despachadas">0</h2>
                                <p>Despachadas</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="dashboard-card bg-gradient-orange">
                                <h2 id="urgentes">0</h2>
                                <p>Urgentes</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-red">
                                <h2 id="totalElementos">0</h2>
                                <p>Elementos a Despachar</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <h5><i class="bi bi-funnel"></i> Filtros</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filtroEstado" class="form-label">Estado:</label>
                                <select class="form-select" id="filtroEstado" onchange="aplicarFiltros()">
                                    <option value="" selected>Todos</option>
                                    <option value="pendiente">Pendientes</option>
                                    <option value="procesada">Procesadas</option>
                                    <option value="cambios_validados">Cambios Validados</option>
                                    <option value="despachada">Despachadas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroUrgencia" class="form-label">Urgencia:</label>
                                <select class="form-select" id="filtroUrgencia" onchange="aplicarFiltros()">
                                    <option value="">Todas</option>
                                    <option value="alta">Alta</option>
                                    <option value="media">Media</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroFecha" class="form-label">Fecha:</label>
                                <input type="date" class="form-control" id="filtroFecha" onchange="aplicarFiltros()">
                            </div>
                            <div class="col-md-3">
                                <label for="filtroCotizacion" class="form-label">Buscar Cotizaci√≥n:</label>
                                <input type="text" class="form-control" id="filtroCotizacion" placeholder="ID Cotizaci√≥n..." onkeyup="aplicarFiltros()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                                </button>
                                <span class="badge bg-info ms-2" id="resultadosFiltro">Mostrando todas las solicitudes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Solicitudes -->
                    <div id="listaSolicitudes">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalles de Solicitud -->
    <div class="modal fade" id="modalDetalleSolicitud" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Solicitud de Despacho</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="contenidoDetalle">
                    <!-- Se llena din√°micamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-info" onclick="imprimirChecklist()">
                        <i class="bi bi-printer"></i> Imprimir Checklist
                    </button>
                    <button type="button" class="btn btn-warning" onclick="marcarComoProcesada()">Marcar como Procesada</button>
                    <button type="button" class="btn btn-success" onclick="marcarComoDespachada()">Marcar como Despachada</button>
                    <button type="button" class="btn btn-info" onclick="actualizarSolicitudActual()">Actualizar Estado</button>
                    <button type="button" class="btn btn-primary" onclick="enviarAInstalacionesModal()" id="btnEnviarInstalaciones">
                        <i class="bi bi-tools"></i> Enviar a Instalaciones
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase CDN + DataService (capa de datos centralizada) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="dataService.js"></script>

    <script>
        // ===== VARIABLES GLOBALES =====
        let solicitudesDespacho = [];
        let solicitudActual = null;
        let solicitudSeleccionada = null;
        let modoCentralizado = false; // true cuando usamos Supabase

        // ===== INTEGRACI√ìN SUPABASE =====
        async function cargarSolicitudesDesdeSupabaseYFallback() {
            try {
                if (window.DataService && window.DataService.hasSupabase()) {
                    const data = await window.DataService.fetchSolicitudesDespacho();
                    if (Array.isArray(data)) {
                        solicitudesDespacho = data;
                        console.log('‚úÖ Solicitudes cargadas desde Supabase:', solicitudesDespacho.length);
                        return;
                    }
                }
                // Fallback
                cargarSolicitudesDesdeStorage();
            } catch (e) {
                console.warn('‚ö†Ô∏è Error obteniendo datos de Supabase; usando localStorage.', e);
                cargarSolicitudesDesdeStorage();
            }
        }

        function inicializarRealtime() {
            if (!(window.DataService && window.DataService.hasSupabase())) return;
            window.DataService.subscribeSolicitudesDespacho(async () => {
                console.log('üì° Realtime: cambio en solicitudes_despacho');
                const data = await window.DataService.fetchSolicitudesDespacho();
                if (Array.isArray(data)) {
                    solicitudesDespacho = data;
                    cargarListaSolicitudes();
                    actualizarEstadisticas();
                }
            });
        }

        // Clasificaci√≥n de categor√≠as (debe coincidir con el wizard)
        const categoriasElementos = {
            insumos: [
                'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m', 
                'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', '"Y" 4 pines', 
                'Base Pollak', 'Pollak Macho', 'Pollak Hembra', 'Tornillo hexagonal 5/16', 
                'Tornillo 3/8', 'Silicon', 'Cinchos grande', 'Cinta de tela', 
                'Cinta de aislar', 'Poliflex 3/8', 'Cincho mediado', 'Cincho con grapa', 
                'Pija brocante 5/16', 'Cable de 1 polo', 'Terminal de ojillo', 'Poliflex 1/4', 
                'Cable 2 vias', 'Cable 4 vias', 'Tuerca 5/16', 'Rondana 5/16', 'Tuerca 3/8', 
                'Rondana 3/8', 'Espiral negro', 'Espiral verde', '7 vias liso 2m', 
                'Relevador 2 pasos 2 tiros', 'placa perforada', 'Gabinete 5*7*3', 'Relevador 12v', 
                'Relevador 24v', 'Portarelevador', 'SD 128 Gb', 'SD 256 Gb', 'SD 512 Gb'
            ],
            accesorios: [
                'Alarma parlante de 3 tonos', 'Alarma parlante programable', 'Camara + radar', 
                'Camara con microfono', 'Camara de reversa', 'Camara Digital (IP)', 
                'Camara exterior mini', 'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC', 
                'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo', 
                'Led de giro a la derecha', 'Led de giro a la izquierda', 'Bocina', 'Bot√≥n balancin', 
                'Boton de panico', 'Microfono', 'Sensor magnetico chico', 'Sensor magnetico grande',
                'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho', 'Sideview izquierdo',
                'Camara frontal', 'Camara izquierda', 'Camara derecha'
            ],
            equipos: [
                'Dashcam ad2', 'Dashcam c6', 'GV310LAU', 'GV58LAU', 'GV75LAU', 'SMOC', 
                'MDVR 4 Ch', 'MDVR 8 Ch', 'Insider', 'Modulo sensor de cinturon seguridad', 
                'Limitador de velocidad', 'Monitor de VPC', 'Grabador de video 4 ch'
            ]
        };

        // Funci√≥n para obtener la categor√≠a de un elemento
        function obtenerCategoriaElemento(elemento) {
            for (const [categoria, elementos] of Object.entries(categoriasElementos)) {
                if (elementos.includes(elemento)) {
                    return categoria;
                }
            }
            return 'insumos'; // Por defecto
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ Inicializando m√≥dulo de despacho...');
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await window.DataService.authSignOut(); } catch(_){}
                    window.location.href = './login.html';
                });
            }
            
            try {
                const rol = await (window.DataService && window.DataService.getUserRole ? window.DataService.getUserRole() : Promise.resolve(null));
                const isAdmin = rol === 'admin';
                const headerBtn = document.getElementById('btnPrincipalHeader');
                if (headerBtn) headerBtn.style.display = isAdmin ? '' : 'none';
                const side = document.getElementById('adminActionsSidebar');
                if (side) side.style.display = isAdmin ? '' : 'none';
            } catch(_) {}

            await cargarSolicitudesDesdeSupabaseYFallback();
            inicializarRealtime();
            modoCentralizado = !!(window.DataService && window.DataService.hasSupabase());
            if (!modoCentralizado) {
                verificarYGenerarSolicitudesAutomaticas();
                limpiarSolicitudesEliminadas(); // Limpieza autom√°tica
            }
            cargarListaSolicitudes();
            actualizarEstadisticas();
            aplicarFiltros(); // Aplicar filtros al cargar
            
            // Listener para cambios en localStorage
            window.addEventListener('storage', function(e) {
                console.log('üîÑ DEBUG: Cambio detectado en localStorage:', e.key, e.newValue);
                if (e.key === 'solicitudes_despacho') {
                    console.log('üîÑ DEBUG: Recargando datos por cambio en solicitudes_despacho');
                    cargarSolicitudesDesdeStorage();
                    cargarListaSolicitudes();
                    actualizarEstadisticas();
                    
                    // Actualizar solicitud actual si est√° abierta
                    if (solicitudActual) {
                        const solicitudActualizada = solicitudesDespacho.find(s => s.id === solicitudActual.id);
                        if (solicitudActualizada) {
                            solicitudActual = solicitudActualizada;
                            console.log('üîÑ DEBUG: Solicitud actual actualizada - Estado:', solicitudActual.estado);
                        }
                    }
                }
            });
            
            // Listener para eventos personalizados de actualizaci√≥n de solicitudes
            window.addEventListener('solicitudesDespachoActualizadas', function(e) {
                console.log('üîÑ DEBUG: Evento personalizado recibido:', e.detail);
                cargarSolicitudesDesdeStorage();
                cargarListaSolicitudes();
                actualizarEstadisticas();
                mostrarAlerta(`Solicitud ${e.detail.solicitudId} actualizada desde instalaciones`, 'info');
                
                // Si hay una solicitud actual abierta y coincide con la actualizada
                if (solicitudActual && e.detail.solicitudId === solicitudActual.id) {
                    const solicitudActualizada = solicitudesDespacho.find(s => s.id === solicitudActual.id);
                    if (solicitudActualizada) {
                        solicitudActual = solicitudActualizada;
                        console.log('üîÑ DEBUG: Solicitud actual actualizada por evento - Estado:', solicitudActual.estado);
                        
                        // Actualizar la interfaz del modal si est√° abierto
                        if (document.getElementById('modalDetalleSolicitud').classList.contains('show')) {
                            verDetalleSolicitud(solicitudActual.id);
                        }
                    }
                }
            });
            
            // Actualizaci√≥n autom√°tica cada 30 segundos (solo en modo local)
            setInterval(() => {
                if (!modoCentralizado) {
                    verificarYGenerarSolicitudesAutomaticas();
                    limpiarSolicitudesEliminadas();
                    cargarListaSolicitudes();
                    actualizarEstadisticas();
                }
            }, 30000);
            
            console.log('‚úÖ M√≥dulo de despacho iniciado');
        });

        function cargarSolicitudesDesdeStorage() {
            const solicitudesGuardadas = localStorage.getItem('solicitudes_despacho');
            if (solicitudesGuardadas) {
                try {
                    solicitudesDespacho = JSON.parse(solicitudesGuardadas);
                    console.log('‚úÖ Solicitudes cargadas desde localStorage');
                } catch (error) {
                    console.error('‚ùå Error parseando solicitudes de localStorage:', error);
                }
            }
        }

        function limpiarSolicitudesEliminadas() {
            if (modoCentralizado) return; // No limpiar contra localStorage en modo Supabase
            const cotizacionesGuardadas = localStorage.getItem('cotizaciones_guardadas');
            if (!cotizacionesGuardadas) {
                mostrarAlerta('No hay cotizaciones guardadas', 'warning');
                return;
            }

            try {
                const cotizaciones = JSON.parse(cotizacionesGuardadas);
                const solicitudesValidas = solicitudesDespacho.filter(solicitud => {
                    return cotizaciones.some(cot => cot.id === solicitud.cotizacionId);
                });
                
                const eliminadas = solicitudesDespacho.length - solicitudesValidas.length;
                
                if (eliminadas > 0) {
                    solicitudesDespacho = solicitudesValidas;
                    guardarSolicitudes();
                    cargarListaSolicitudes();
                    mostrarAlerta(`üßπ Se eliminaron ${eliminadas} solicitudes de cotizaciones inexistentes`, 'success');
                } else {
                    mostrarAlerta('No hay solicitudes para limpiar', 'info');
                }
            } catch (error) {
                console.error('Error limpiando solicitudes:', error);
                mostrarAlerta('Error al limpiar solicitudes', 'danger');
            }
        }

        function verificarYGenerarSolicitudesAutomaticas() {
            if (modoCentralizado) return; // Generaci√≥n autom√°tica solo en modo local
            const cotizacionesGuardadas = localStorage.getItem('cotizaciones_guardadas');
            if (!cotizacionesGuardadas) {
                console.log('‚ÑπÔ∏è No hay cotizaciones disponibles');
                return;
            }

            try {
                const cotizaciones = JSON.parse(cotizacionesGuardadas);
                
                // Limpiar solicitudes de cotizaciones que ya no existen
                const solicitudesValidas = solicitudesDespacho.filter(solicitud => {
                    const cotizacionExiste = cotizaciones.some(cot => cot.id === solicitud.cotizacionId);
                    if (!cotizacionExiste) {
                        console.log(`üóëÔ∏è Eliminando solicitud de cotizaci√≥n inexistente: ${solicitud.cotizacionId}`);
                    }
                    return cotizacionExiste;
                });
                
                // Actualizar la lista si se eliminaron solicitudes
                if (solicitudesValidas.length !== solicitudesDespacho.length) {
                    const eliminadas = solicitudesDespacho.length - solicitudesValidas.length;
                    solicitudesDespacho = solicitudesValidas;
                    guardarSolicitudes();
                    console.log(`üßπ Limpieza completada: ${eliminadas} solicitudes eliminadas`);
                }
                
                // Sincronizar con ambas claves para consistencia
                localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizaciones));
                localStorage.setItem('cotizaciones', JSON.stringify(cotizaciones));
                
                const cotizacionesNuevas = cotizaciones.filter(cot => {
                    return !solicitudesDespacho.some(sol => sol.cotizacionId === cot.id) && 
                           cot.estado === 'aceptada';
                });

                if (cotizacionesNuevas.length > 0) {
                    console.log(`üîÑ Detectadas ${cotizacionesNuevas.length} cotizaciones nuevas, generando solicitudes autom√°ticamente...`);
                    
                    cotizacionesNuevas.forEach(cotizacion => {
                        const solicitud = generarSolicitudDeCotizacion(cotizacion);
                        if (solicitud) {
                            solicitudesDespacho.push(solicitud);
                        }
                    });

                    guardarSolicitudes();
                    mostrarAlerta(`üéØ Se generaron autom√°ticamente ${cotizacionesNuevas.length} nuevas solicitudes de despacho`, 'success');
                } else {
                    console.log('‚ÑπÔ∏è No hay cotizaciones nuevas para procesar');
                }
            } catch (error) {
                console.error('Error verificando cotizaciones:', error);
            }
        }

        function generarSolicitudesDespacho() {
            // Cargar cotizaciones del sistema principal
            const cotizacionesGuardadas = localStorage.getItem('cotizaciones_guardadas');
            if (!cotizacionesGuardadas) {
                mostrarAlerta('No hay cotizaciones disponibles para generar solicitudes', 'warning');
                return;
            }

            try {
                const cotizaciones = JSON.parse(cotizacionesGuardadas);
                const cotizacionesNuevas = cotizaciones.filter(cot => {
                    // Solo generar solicitudes para cotizaciones aceptadas que no tienen solicitud a√∫n
                    return !solicitudesDespacho.some(sol => sol.cotizacionId === cot.id) && 
                           cot.estado === 'aceptada';
                });

                cotizacionesNuevas.forEach(cotizacion => {
                    const solicitud = generarSolicitudDeCotizacion(cotizacion);
                    if (solicitud) {
                        solicitudesDespacho.push(solicitud);
                    }
                });

                if (cotizacionesNuevas.length > 0) {
                    guardarSolicitudes();
                    cargarListaSolicitudes();
                    actualizarEstadisticas();
                    mostrarAlerta(`${cotizacionesNuevas.length} nuevas solicitudes generadas`, 'success');
                } else {
                    mostrarAlerta('No hay cotizaciones nuevas para procesar', 'info');
                }
            } catch (error) {
                console.error('Error procesando cotizaciones:', error);
                mostrarAlerta('Error al generar solicitudes', 'danger');
            }
        }

        function generarSolicitudDeCotizacion(cotizacion) {
            if (!cotizacion.unidades || cotizacion.unidades.length === 0) {
                console.log('‚ùå No hay unidades en la cotizaci√≥n');
                return null;
            }

            console.log('üîÑ Generando solicitud para cotizaci√≥n:', cotizacion);

            // Obtener insumos y equipos reales de la cotizaci√≥n
            const elementosNecesarios = {};
            const equiposNecesarios = {};
            const solucionesLista = [];

            // Procesar soluciones de todas las unidades
            cotizacion.unidades.forEach((unidad, index) => {
                console.log(`üì¶ Procesando unidad ${index + 1}:`, unidad);
                
                // Agregar soluciones
                if (unidad.soluciones && Array.isArray(unidad.soluciones)) {
                    unidad.soluciones.forEach(solucion => {
                        if (solucion && (solucion.nombre || solucion.tipo_solucion)) {
                            solucionesLista.push(solucion.nombre || solucion.tipo_solucion);
                        }
                    });
                }
            });

            // Procesar insumos y accesorios globales de la cotizaci√≥n
            console.log('üîç Estructura de cotizaci√≥n:', {
                insumosSugeridos: cotizacion.insumosSugeridos,
                accesoriosSugeridos: cotizacion.accesoriosSugeridos,
                equiposAutomaticos: cotizacion.equiposAutomaticos
            });

            // Agregar insumos sugeridos globales (array)
            // NOTA: Los insumos sugeridos ya vienen multiplicados por cantidad de unidades desde el wizard
            if (cotizacion.insumosSugeridos && Array.isArray(cotizacion.insumosSugeridos)) {
                console.log('üìã Procesando insumos sugeridos globales (array):', cotizacion.insumosSugeridos);
                cotizacion.insumosSugeridos.forEach(item => {
                    if (item && item.nombre && item.cantidad > 0) {
                        // Los insumos ya vienen multiplicados por cantidad de unidades, no sumar
                        elementosNecesarios[item.nombre] = item.cantidad;
                        console.log(`‚úÖ Agregado insumo: ${item.nombre} = ${item.cantidad} (ya multiplicado por unidades)`);
                    }
                });
            }

            // Agregar accesorios sugeridos globales (array)
            // NOTA: Los accesorios sugeridos ya vienen multiplicados por cantidad de unidades desde el wizard
            if (cotizacion.accesoriosSugeridos && Array.isArray(cotizacion.accesoriosSugeridos)) {
                console.log('üîß Procesando accesorios sugeridos globales (array):', cotizacion.accesoriosSugeridos);
                cotizacion.accesoriosSugeridos.forEach(item => {
                    if (item && item.nombre && item.cantidad > 0) {
                        // Los accesorios ya vienen multiplicados por cantidad de unidades, no sumar
                        elementosNecesarios[item.nombre] = item.cantidad;
                        console.log(`‚úÖ Agregado accesorio: ${item.nombre} = ${item.cantidad} (ya multiplicado por unidades)`);
                    }
                });
            }

            // Agregar equipos autom√°ticos globales
            if (cotizacion.equiposAutomaticos) {
                Object.entries(cotizacion.equiposAutomaticos).forEach(([equipo, datos]) => {
                    if (datos && datos.cantidad > 0) {
                        equiposNecesarios[equipo] = (equiposNecesarios[equipo] || 0) + (datos.cantidad * (cotizacion.cantidadLote || 1));
                    }
                });
            }

            // Determinar urgencia
            let urgencia = cotizacion.urgente || 'baja';
            
            if (!cotizacion.urgente && cotizacion.fecha_vencimiento) {
                const fechaVencimiento = new Date(cotizacion.fecha_vencimiento);
                const fechaActual = new Date();
                const diasRestantes = Math.ceil((fechaVencimiento - fechaActual) / (1000 * 60 * 60 * 24));
                
                if (diasRestantes <= 3) urgencia = 'alta';
                else if (diasRestantes <= 7) urgencia = 'media';
                else urgencia = 'baja';
            }

            const solicitud = {
                id: `DESP-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                cotizacionId: cotizacion.id,
                cliente: cotizacion.cliente_nombre || cotizacion.nombre_cliente || 'Cliente no especificado',
                fecha: new Date().toISOString().split('T')[0],
                fechaRequerida: cotizacion.fecha_vencimiento,
                urgencia: urgencia,
                estado: 'pendiente',
                cantidadUnidades: cotizacion.cantidadLote || 1,
                tipoUnidades: cotizacion.unidades.map(u => u.tipo).join(', '),
                insumos: elementosNecesarios,
                equipos: equiposNecesarios,
                observaciones: `Solicitud generada autom√°ticamente para cotizaci√≥n ${cotizacion.folio || cotizacion.id}`,
                fechaCreacion: new Date().toISOString(),
                soluciones: [...new Set(solucionesLista)], // Eliminar duplicados
                tipoVenta: cotizacion.tipoVenta || 'instalacion' // Agregar tipo de venta
            };

            console.log('‚úÖ Solicitud generada:', solicitud);
            return solicitud;
        }

        function agregarElementosDeAlamcen(solucion, tipoUnidad, elementos, multiplicador) {
            // Simulaci√≥n de elementos basada en las soluciones m√°s comunes
            const elementosPorSolucion = {
                'VPC': {
                    'Cable 4 pin 5 m': 1,
                    'Cable 4 pin 7 m': 2,
                    'Cinta de aislar': 1,
                    'Cincho mediado': 80,
                    'Monitor de VPC': 1,
                    'Camara de reversa': 1
                },
                'MDVR 4 Ch': {
                    'Cable 6 pin 5 m': 1,
                    'SD 256 Gb': 1,
                    'Grabador de video 4 ch': 1
                },
                'Dashcam': {
                    'Dashcam c6': 1,
                    'SD 128 Gb': 1
                },
                'Rastreo basico': {
                    'Relevador 12v': 1,
                    'Cable 2 vias': 5
                }
            };

            const elementosSolucion = elementosPorSolucion[solucion] || {};
            Object.entries(elementosSolucion).forEach(([elemento, cantidad]) => {
                elementos[elemento] = (elementos[elemento] || 0) + (cantidad * multiplicador);
            });
        }

        function cargarListaSolicitudes() {
            const contenedor = document.getElementById('listaSolicitudes');
            contenedor.innerHTML = '';

            // Mostrar todas las solicitudes (incluyendo despachadas para historial)
            if (solicitudesDespacho.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <h4 class="text-muted mt-3">No hay solicitudes de despacho</h4>
                        <p class="text-muted">Haz clic en "Generar Solicitudes" para crear nuevas solicitudes desde las cotizaciones.</p>
                    </div>
                `;
                return;
            }

            solicitudesDespacho.forEach(solicitud => {
                const urgenciaClass = `urgencia-${solicitud.urgencia}`;
                const estadoBadge = obtenerEstadoBadge(solicitud.estado);
                const soporteBadge = (() => {
                    if (solicitud.soporte_estado === 'en_configuracion') return '<span class="badge bg-info ms-2">Soporte: En configuraci√≥n</span>';
                    if (solicitud.soporte_estado === 'configurado') return '<span class="badge bg-success ms-2">Soporte: Configuraci√≥n finalizada</span>';
                    return '';
                })();
                const urgenciaBadge = obtenerUrgenciaBadge(solicitud.urgencia);

                const totalInsumos = Object.values(solicitud.insumos).reduce((sum, cant) => sum + cant, 0);
                const totalEquipos = Object.values(solicitud.equipos).reduce((sum, cant) => sum + cant, 0);

                // Agregar clase especial para solicitudes despachadas
                const claseDespachada = solicitud.estado === 'despachada' ? 'solicitud-despachada' : '';
                
                const card = `
                    <div class="solicitud-card ${urgenciaClass} ${claseDespachada}" data-solicitud-id="${solicitud.id}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">
                                        <i class="bi bi-truck me-2"></i>
                                        Solicitud ${solicitud.id}
                                        ${estadoBadge} ${soporteBadge}
                                        ${urgenciaBadge}
                                    </h5>
                                    <p class="card-text">
                                        <strong>Cliente:</strong> ${solicitud.cliente}<br>
                                        <strong>Cotizaci√≥n:</strong> ${solicitud.cotizacionId}<br>
                                        <strong>Unidades:</strong> ${solicitud.cantidadUnidades} (${solicitud.tipoUnidades})<br>
                                        <strong>Fecha Requerida:</strong> ${solicitud.fechaRequerida}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <small class="text-muted">Elementos a despachar:</small><br>
                                        <span class="badge bg-primary">${totalInsumos} Insumos</span>
                                        <span class="badge bg-info">${totalEquipos} Equipos</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="verDetalleSolicitud('${solicitud.id}')">
                                        <i class="bi bi-eye"></i> Ver Detalles
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="cambiarEstado('${solicitud.id}', 'procesada')">
                                        <i class="bi bi-check"></i> Procesar
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="enviarAInstalaciones('${solicitud.id}')" 
                                            ${solicitud.tipoVenta === 'venta' ? 'disabled title="No disponible para venta sin instalaci√≥n"' : ''}>
                                        <i class="bi bi-tools"></i> Enviar a Instalaciones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                contenedor.innerHTML += card;
            });
        }

        function obtenerEstadoBadge(estado) {
            const estados = {
                'pendiente': '<span class="badge bg-warning">Pendiente</span>',
                'procesada': '<span class="badge bg-info">Procesada</span>',
                'cambios_validados': '<span class="badge bg-success">Cambios Validados</span>',
                'enviada_instalaciones': '<span class="badge bg-primary">En Instalaciones</span>',
                'validada_instalaciones': '<span class="badge bg-success">Validada</span>',
                'retornada_instalaciones': '<span class="badge bg-warning">Retornada</span>',
                'despachada': '<span class="badge bg-success">Despachada</span>'
            };
            return estados[estado] || '<span class="badge bg-secondary">Desconocido</span>';
        }

        function obtenerUrgenciaBadge(urgencia) {
            const urgencias = {
                'alta': '<span class="badge bg-danger">Urgente</span>',
                'media': '<span class="badge bg-warning">Media</span>',
                'baja': '<span class="badge bg-success">Baja</span>'
            };
            return urgencias[urgencia] || '<span class="badge bg-secondary">Normal</span>';
        }

        function verDetalleSolicitud(solicitudId) {
            const solicitud = solicitudesDespacho.find(s => s.id === solicitudId);
            if (!solicitud) return;

            solicitudActual = solicitud;

            let detalleHTML = `
                <div class="detail-section">
                    <h6><i class="bi bi-info-circle"></i> Informaci√≥n General</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ID Solicitud:</strong> ${solicitud.id}<br>
                            <strong>Cotizaci√≥n:</strong> ${solicitud.cotizacionId}<br>
                            <strong>Cliente:</strong> ${solicitud.cliente}<br>
                            <strong>Estado:</strong> ${obtenerEstadoBadge(solicitud.estado)}
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha Creaci√≥n:</strong> ${solicitud.fecha}<br>
                            <strong>Fecha Requerida:</strong> ${solicitud.fechaRequerida}<br>
                            <strong>Urgencia:</strong> ${obtenerUrgenciaBadge(solicitud.urgencia)}<br>
                            <strong>Unidades:</strong> ${solicitud.cantidadUnidades} (${solicitud.tipoUnidades})
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h6><i class="bi bi-tools"></i> Soluciones a Instalar</h6>
                    <div class="row">
                        ${solicitud.soluciones.map(solucion => `<div class="col-md-4"><span class="badge bg-info me-1">${solucion}</span></div>`).join('')}
                    </div>
                </div>
            `;

            if (Object.keys(solicitud.insumos).length > 0) {
                // Separar SIMs de otros insumos
                const sims = {};
                const otrosInsumos = {};
                
                Object.entries(solicitud.insumos).forEach(([insumo, cantidad]) => {
                    if (insumo.includes('SIM') || insumo.includes('sim')) {
                        sims[insumo] = cantidad;
                    } else {
                        otrosInsumos[insumo] = cantidad;
                    }
                });
                
                // Mostrar SIMs en secci√≥n especial
                if (Object.keys(sims).length > 0) {
                    detalleHTML += `
                        <div class="detail-section">
                            <h6><i class="bi bi-sim"></i> SIMs Requeridas</h6>
                            <div class="alert alert-info mb-3">
                                <small><i class="bi bi-info-circle"></i> SIMs detectadas autom√°ticamente seg√∫n los servicios de datos seleccionados</small>
                            </div>
                            ${Object.entries(sims).map(([sim, cantidad]) => `
                                <div class="item-row border-start border-info border-3 ps-3 mb-2">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <span class="badge bg-info me-2">${sim}</span>
                                        </div>
                                        <div class="col-md-4 text-end"><strong>${cantidad}</strong> unidades</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Mostrar otros insumos
                if (Object.keys(otrosInsumos).length > 0) {
                    detalleHTML += `
                        <div class="detail-section">
                            <h6><i class="bi bi-box"></i> Insumos Requeridos</h6>
                            ${Object.entries(otrosInsumos).map(([insumo, cantidad]) => `
                                <div class="item-row">
                                    <div class="row">
                                        <div class="col-md-8">${insumo}</div>
                                        <div class="col-md-4 text-end"><strong>${cantidad}</strong> unidades</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            if (Object.keys(solicitud.equipos).length > 0) {
                detalleHTML += `
                    <div class="detail-section">
                        <h6><i class="bi bi-cpu"></i> Equipos Requeridos</h6>
                        ${Object.entries(solicitud.equipos).map(([equipo, cantidad]) => `
                            <div class="item-row">
                                <div class="row">
                                    <div class="col-md-8">${equipo}</div>
                                    <div class="col-md-4 text-end"><strong>${cantidad}</strong> unidades</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (solicitud.observaciones) {
                detalleHTML += `
                    <div class="detail-section">
                        <h6><i class="bi bi-chat-text"></i> Observaciones</h6>
                        <p>${solicitud.observaciones}</p>
                    </div>
                `;
            }

            // Mostrar observaciones de retorno si existen
            if (solicitud.observacionesRetorno) {
                detalleHTML += `
                    <div class="detail-section">
                        <h6><i class="bi bi-arrow-left-circle"></i> Observaciones de Retorno</h6>
                        <p><strong>Retornado por:</strong> ${solicitud.retornadoPor || 'N/A'}</p>
                        <p><strong>Fecha de retorno:</strong> ${solicitud.fechaRetorno || 'N/A'}</p>
                        <p><strong>Observaciones:</strong> ${solicitud.observacionesRetorno}</p>
                    </div>
                `;
            }

            // Mostrar insumos adicionales si existen
            console.log('üîç DEBUG: Verificando insumos adicionales para solicitud:', solicitud.id);
            console.log('üîç DEBUG: insumosAdicionales:', solicitud.insumosAdicionales);
            
            if (solicitud.insumosAdicionales && solicitud.insumosAdicionales.length > 0) {
                console.log('‚úÖ DEBUG: Mostrando secci√≥n de insumos adicionales');
                detalleHTML += `
                    <div class="detail-section">
                        <h6><i class="bi bi-plus-circle"></i> Insumos Adicionales Solicitados</h6>
                        <div class="alert alert-info">
                            <small><i class="bi bi-info-circle"></i> Estos insumos fueron solicitados por el Gerente de Instalaciones</small>
                        </div>
                        ${solicitud.insumosAdicionales.map(insumo => `
                            <div class="item-row border-start border-info border-3 ps-3 mb-2">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>${insumo.nombre}</strong>
                                        <br><small class="text-muted">Categor√≠a: ${insumo.categoria}</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <span class="badge bg-primary">${insumo.cantidad} unidades</span>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <small class="text-muted">${insumo.fechaAgregado}</small>
                                    </div>
                                </div>
                                ${insumo.observaciones ? `<div class="row mt-1"><div class="col-12"><small class="text-muted"><i class="bi bi-chat-text"></i> ${insumo.observaciones}</small></div></div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                console.log('‚ö†Ô∏è DEBUG: No hay insumos adicionales o el array est√° vac√≠o');
            }

            document.getElementById('contenidoDetalle').innerHTML = detalleHTML;
            
            // Controlar bot√≥n de enviar a instalaciones seg√∫n tipo de venta
            const btnEnviarInstalaciones = document.getElementById('btnEnviarInstalaciones');
            if (solicitud.tipoVenta === 'venta') {
                btnEnviarInstalaciones.disabled = true;
                btnEnviarInstalaciones.title = 'No disponible para venta sin instalaci√≥n';
                btnEnviarInstalaciones.classList.add('btn-secondary');
                btnEnviarInstalaciones.classList.remove('btn-primary');
            } else {
                btnEnviarInstalaciones.disabled = false;
                btnEnviarInstalaciones.title = '';
                btnEnviarInstalaciones.classList.add('btn-primary');
                btnEnviarInstalaciones.classList.remove('btn-secondary');
            }
            
            new bootstrap.Modal(document.getElementById('modalDetalleSolicitud')).show();
        }

        function cambiarEstado(solicitudId, nuevoEstado) {
            const solicitud = solicitudesDespacho.find(s => s.id === solicitudId);
            if (!solicitud) return;

            solicitud.estado = nuevoEstado;
            if (modoCentralizado) {
                // Persistir en Supabase
                window.DataService.patchSolicitudDespachoById(solicitud.id, { estado: nuevoEstado })
                  .then(ok => { if (!ok) console.warn('No se pudo persistir estado en Supabase'); });
            } else {
                guardarSolicitudes();
            }
            cargarListaSolicitudes();
            actualizarEstadisticas();
            
            const estadoTexto = nuevoEstado === 'procesada' ? 'procesada' : 'despachada';
            mostrarAlerta(`Solicitud marcada como ${estadoTexto}`, 'success');
        }

        function marcarComoProcesada() {
            if (!solicitudActual) return;
            
            // Verificar si tiene insumos adicionales
            const tieneInsumosAdicionales = solicitudActual.insumosAdicionales && solicitudActual.insumosAdicionales.length > 0;
            
            if (tieneInsumosAdicionales) {
                // Notificar a Instalaciones que los cambios han sido procesados
                notificarInstalacionesCambiosProcesados(solicitudActual);
            }
            
            cambiarEstado(solicitudActual.id, 'procesada');
            bootstrap.Modal.getInstance(document.getElementById('modalDetalleSolicitud')).hide();
        }

        function marcarComoDespachada() {
            if (!solicitudActual) return;
            
            // Verificar si tiene insumos adicionales y si est√°n validados
            const tieneInsumosAdicionales = solicitudActual.insumosAdicionales && solicitudActual.insumosAdicionales.length > 0;
            
            console.log('üîç DEBUG: Verificando despacho...');
            console.log('üîç DEBUG: Estado actual:', solicitudActual.estado);
            console.log('üîç DEBUG: Tiene insumos adicionales:', tieneInsumosAdicionales);
            
            if (tieneInsumosAdicionales && solicitudActual.estado !== 'cambios_validados') {
                console.log('‚ùå DEBUG: No se puede despachar - Estado no es cambios_validados');
                mostrarAlerta('No se puede despachar. Los insumos adicionales deben ser validados por Instalaciones primero.', 'warning');
                return;
            }
            
            console.log('‚úÖ DEBUG: Procediendo con despacho');
            cambiarEstado(solicitudActual.id, 'despachada');
            bootstrap.Modal.getInstance(document.getElementById('modalDetalleSolicitud')).hide();
        }

        // Funci√≥n para actualizar la solicitud actual desde localStorage
        function actualizarSolicitudActual() {
            if (!solicitudActual) {
                mostrarAlerta('No hay solicitud seleccionada', 'warning');
                return;
            }
            
            console.log('üîÑ DEBUG: Actualizando solicitud actual...');
            
            // Recargar datos desde localStorage
            cargarSolicitudesDesdeStorage();
            
            // Buscar la solicitud actualizada
            const solicitudActualizada = solicitudesDespacho.find(s => s.id === solicitudActual.id);
            if (solicitudActualizada) {
                solicitudActual = solicitudActualizada;
                console.log('‚úÖ DEBUG: Solicitud actualizada - Estado:', solicitudActual.estado);
                
                // Actualizar la interfaz del modal
                verDetalleSolicitud(solicitudActual.id);
                
                mostrarAlerta('Estado actualizado correctamente', 'success');
            } else {
                console.log('‚ùå DEBUG: No se encontr√≥ la solicitud actualizada');
                mostrarAlerta('No se pudo actualizar la solicitud', 'danger');
            }
        }

        // Funci√≥n para notificar a Instalaciones que los cambios han sido procesados
        function notificarInstalacionesCambiosProcesados(solicitud) {
            try {
                // Obtener notificaciones existentes
                let notificacionesInstalaciones = JSON.parse(localStorage.getItem('notificaciones_instalaciones') || '[]');
                
                // Buscar la notificaci√≥n correspondiente
                const notificacionIndex = notificacionesInstalaciones.findIndex(n => n.solicitudDespachoId === solicitud.id);
                
                if (notificacionIndex !== -1) {
                    // Actualizar el estado a "despacho_cambios_solicitados"
                    notificacionesInstalaciones[notificacionIndex].estado = 'despacho_cambios_solicitados';
                    notificacionesInstalaciones[notificacionIndex].fechaProcesamiento = new Date().toISOString();
                    notificacionesInstalaciones[notificacionIndex].mensaje = 'Despacho ha procesado los insumos adicionales solicitados. Por favor validar.';
                    
                    // Guardar en localStorage
                    localStorage.setItem('notificaciones_instalaciones', JSON.stringify(notificacionesInstalaciones));
                    
                    console.log('‚úÖ DEBUG: Notificaci√≥n enviada a Instalaciones - Estado: despacho_cambios_solicitados');
                    mostrarAlerta('Instalaciones ha sido notificado de que los cambios han sido procesados', 'info');
                } else {
                    console.log('‚ö†Ô∏è DEBUG: No se encontr√≥ notificaci√≥n correspondiente en Instalaciones');
                }
            } catch (error) {
                console.error('‚ùå Error al notificar a Instalaciones:', error);
                mostrarAlerta('Error al notificar a Instalaciones', 'danger');
            }
        }

        function marcarComoProcesadas() {
            const pendientes = solicitudesDespacho.filter(s => s.estado === 'pendiente');
            if (pendientes.length === 0) {
                mostrarAlerta('No hay solicitudes pendientes', 'info');
                return;
            }

            if (confirm(`¬øMarcar ${pendientes.length} solicitudes como procesadas?`)) {
                pendientes.forEach(solicitud => {
                    solicitud.estado = 'procesada';
                });
                
                guardarSolicitudes();
                cargarListaSolicitudes();
                actualizarEstadisticas();
                mostrarAlerta(`${pendientes.length} solicitudes marcadas como procesadas`, 'success');
            }
        }

        function actualizarEstadisticas() {
            const total = solicitudesDespacho.length;
            const pendientes = solicitudesDespacho.filter(s => s.estado === 'pendiente').length;
            const procesadas = solicitudesDespacho.filter(s => s.estado === 'procesada').length;
            const cambiosValidados = solicitudesDespacho.filter(s => s.estado === 'cambios_validados').length;
            const despachadas = solicitudesDespacho.filter(s => s.estado === 'despachada').length;
            const urgentes = solicitudesDespacho.filter(s => s.urgencia === 'alta' && s.estado !== 'despachada').length;
            
            // Solo contar elementos de solicitudes activas (no despachadas)
            const totalElementos = solicitudesDespacho
                .filter(s => s.estado !== 'despachada')
                .reduce((sum, s) => {
                    const insumos = Object.values(s.insumos).reduce((a, b) => a + b, 0);
                    const equipos = Object.values(s.equipos).reduce((a, b) => a + b, 0);
                    return sum + insumos + equipos;
                }, 0);

            document.getElementById('totalSolicitudes').textContent = total;
            document.getElementById('pendientes').textContent = pendientes;
            document.getElementById('procesadas').textContent = procesadas;
            document.getElementById('cambiosValidados').textContent = cambiosValidados;
            document.getElementById('despachadas').textContent = despachadas;
            document.getElementById('urgentes').textContent = urgentes;
            document.getElementById('totalElementos').textContent = totalElementos;
        }

        function aplicarFiltros() {
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroUrgencia = document.getElementById('filtroUrgencia').value;
            const filtroFecha = document.getElementById('filtroFecha').value;
            const filtroCotizacion = document.getElementById('filtroCotizacion').value.toLowerCase();

            const cards = document.querySelectorAll('.solicitud-card');
            let visibles = 0;

            cards.forEach(card => {
                const solicitudId = card.dataset.solicitudId;
                const solicitud = solicitudesDespacho.find(s => s.id === solicitudId);
                
                if (!solicitud) return;

                // Mostrar todas las solicitudes por defecto (incluyendo despachadas)
                let mostrar = true;

                if (filtroEstado && solicitud.estado !== filtroEstado) mostrar = false;
                if (filtroUrgencia && solicitud.urgencia !== filtroUrgencia) mostrar = false;
                if (filtroFecha && solicitud.fecha !== filtroFecha) mostrar = false;
                if (filtroCotizacion && !solicitud.cotizacionId.toLowerCase().includes(filtroCotizacion)) mostrar = false;

                card.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });

            const totalSolicitudes = solicitudesDespacho.length;
            document.getElementById('resultadosFiltro').textContent = `Mostrando ${visibles} de ${totalSolicitudes} solicitudes`;
        }

        function limpiarFiltros() {
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroUrgencia').value = '';
            document.getElementById('filtroFecha').value = '';
            document.getElementById('filtroCotizacion').value = '';
            
            const cards = document.querySelectorAll('.solicitud-card');
            cards.forEach(card => {
                card.style.display = '';
            });
            
            document.getElementById('resultadosFiltro').textContent = 'Mostrando todas las solicitudes';
        }

        function actualizarSolicitudes() {
            generarSolicitudesDespacho();
        }

        function exportarSolicitudes() {
            if (solicitudesDespacho.length === 0) {
                mostrarAlerta('No hay solicitudes para exportar', 'warning');
                return;
            }

            const csv = generarCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `solicitudes_despacho_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarAlerta('Solicitudes exportadas correctamente', 'success');
        }

        function generarCSV() {
            const headers = ['ID Solicitud', 'Cotizaci√≥n', 'Cliente', 'Fecha', 'Estado', 'Urgencia', 'Unidades', 'Elementos Total'];
            const rows = solicitudesDespacho.map(solicitud => {
                const totalElementos = Object.values(solicitud.insumos).reduce((a, b) => a + b, 0) + 
                                     Object.values(solicitud.equipos).reduce((a, b) => a + b, 0);
                return [
                    solicitud.id,
                    solicitud.cotizacionId,
                    solicitud.cliente,
                    solicitud.fecha,
                    solicitud.estado,
                    solicitud.urgencia,
                    solicitud.cantidadUnidades,
                    totalElementos
                ];
            });

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function guardarSolicitudes() {
            localStorage.setItem('solicitudes_despacho', JSON.stringify(solicitudesDespacho));
        }

        function imprimirChecklist() {
            if (!solicitudActual) {
                mostrarAlerta('No hay solicitud seleccionada', 'warning');
                return;
            }

            // Crear ventana de impresi√≥n
            const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
            
            // Obtener fecha actual
            const fechaActual = new Date().toLocaleDateString('es-ES');
            
            // Generar HTML del checklist
            const htmlChecklist = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Checklist de Despacho - ${solicitudActual.cliente}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            line-height: 1.6;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #2c3e50;
                            margin: 0;
                        }
                        .header h2 {
                            color: #7f8c8d;
                            margin: 10px 0;
                        }
                        .info-section {
                            background-color: #f8f9fa;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .info-label {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        .items-section {
                            margin: 30px 0;
                        }
                        .items-section h3 {
                            color: #2c3e50;
                            border-bottom: 1px solid #bdc3c7;
                            padding-bottom: 10px;
                        }
                        .item-list {
                            list-style: none;
                            padding: 0;
                        }
                        .item-list li {
                            padding: 8px 0;
                            border-bottom: 1px dotted #bdc3c7;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .item-list li:before {
                            content: "‚òê";
                            margin-right: 10px;
                            font-size: 16px;
                        }
                        .item-name {
                            flex-grow: 1;
                        }
                        .item-quantity {
                            font-weight: bold;
                            color: #e74c3c;
                        }
                        .signatures {
                            margin-top: 50px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .signature-box {
                            text-align: center;
                            width: 45%;
                        }
                        .signature-line {
                            border-bottom: 1px solid #333;
                            height: 40px;
                            margin-bottom: 10px;
                        }
                        .signature-label {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            color: #7f8c8d;
                            font-size: 12px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header" style="border-bottom: 3px solid #fb930c;">
                        <img src="./ZENDA.svg?v=2" alt="ZendA - Workflow Manager" height="60" style="margin-bottom: 15px;">
                        <h1 style="color:#fb930c;">CHECKLIST DE DESPACHO</h1>
                        <h2 style="color:#fb930c66;">Sistema de Trazabilidad</h2>
                        <p>Fecha: ${fechaActual}</p>
                    </div>

                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">ID Solicitud:</span>
                            <span>${solicitudActual.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Cliente:</span>
                            <span>${solicitudActual.cliente}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Cotizaci√≥n:</span>
                            <span>${solicitudActual.cotizacionId}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha Requerida:</span>
                            <span>${solicitudActual.fechaRequerida}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Unidades:</span>
                            <span>${solicitudActual.cantidadUnidades}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Urgencia:</span>
                            <span>${solicitudActual.urgencia}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tipo de Venta:</span>
                            <span>${solicitudActual.tipoVenta === 'instalacion' ? 'Instalaci√≥n por nuestro personal' : 'Solo venta de equipos'}</span>
                        </div>
                    </div>

                    <div class="items-section">
                        <h3>üì¶ INSUMOS</h3>
                        <ul class="item-list">
                            ${Object.entries(solicitudActual.insumos || {}).map(([item, cantidad]) => {
                                const categoria = obtenerCategoriaElemento(item);
                                if (categoria === 'insumos') {
                                    return `<li><span class="item-name">${item}</span><span class="item-quantity">${cantidad}</span></li>`;
                                }
                                return '';
                            }).filter(item => item !== '').join('')}
                        </ul>
                    </div>

                    <div class="items-section">
                        <h3>üîß EQUIPOS</h3>
                        <ul class="item-list">
                            ${Object.entries(solicitudActual.insumos || {}).map(([item, cantidad]) => {
                                const categoria = obtenerCategoriaElemento(item);
                                if (categoria === 'equipos') {
                                    return `<li><span class="item-name">${item}</span><span class="item-quantity">${cantidad}</span></li>`;
                                }
                                return '';
                            }).filter(item => item !== '').join('')}
                        </ul>
                    </div>

                    <div class="items-section">
                        <h3>‚ö° ACCESORIOS</h3>
                        <ul class="item-list">
                            ${Object.entries(solicitudActual.insumos || {}).map(([item, cantidad]) => {
                                const categoria = obtenerCategoriaElemento(item);
                                if (categoria === 'accesorios') {
                                    return `<li><span class="item-name">${item}</span><span class="item-quantity">${cantidad}</span></li>`;
                                }
                                return '';
                            }).filter(item => item !== '').join('')}
                        </ul>
                    </div>

                    ${solicitudActual.insumosAdicionales && solicitudActual.insumosAdicionales.length > 0 ? `
                    <div class="items-section">
                        <h3>‚ûï INSUMOS ADICIONALES SOLICITADOS</h3>
                        <p style="color: #e74c3c; font-weight: bold; margin-bottom: 15px;">
                            ‚ö†Ô∏è Estos insumos fueron solicitados por el Gerente de Instalaciones
                        </p>
                        <ul class="item-list">
                            ${solicitudActual.insumosAdicionales.map(insumo => 
                                `<li><span class="item-name">${insumo.nombre} (${insumo.categoria})</span><span class="item-quantity">${insumo.cantidad}</span></li>`
                            ).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <div class="items-section">
                        <h3>‚öôÔ∏è SOLUCIONES A INSTALAR</h3>
                        <ul class="item-list">
                            ${(solicitudActual.soluciones || []).map(solucion => 
                                `<li><span class="item-name">${solucion}</span><span class="item-quantity">-</span></li>`
                            ).join('')}
                        </ul>
                    </div>

                    <div class="signatures">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-label">ENTREGA</div>
                            <div>Gerente de Almac√©n</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-label">${solicitudActual.tipoVenta === 'venta' ? 'RECIBE' : 'RECIBE'}</div>
                            <div>${solicitudActual.tipoVenta === 'venta' ? 'Gerente Operativo' : 'Gerente de Instalaciones'}</div>
                        </div>
                    </div>

                    <div class="footer">
                        <p>Checklist generado autom√°ticamente por el Sistema de Trazabilidad</p>
                        <p>Fecha de generaci√≥n: ${new Date().toLocaleString('es-ES')}</p>
                    </div>

                </body>
                </html>
            `;
            
            ventanaImpresion.document.write(htmlChecklist);
            ventanaImpresion.document.close();
            
            // Auto-imprimir al cargar
            ventanaImpresion.onload = function() {
                setTimeout(() => {
                    ventanaImpresion.print();
                }, 500);
            };
        }

        function obtenerCotizacionOriginal(cotizacionId) {
            // Buscar en cotizaciones guardadas
            const cotizacionesGuardadas = localStorage.getItem('cotizaciones_guardadas');
            if (cotizacionesGuardadas) {
                try {
                    const cotizaciones = JSON.parse(cotizacionesGuardadas);
                    return cotizaciones.find(cot => cot.id === cotizacionId);
                } catch (error) {
                    console.error('Error parseando cotizaciones guardadas:', error);
                }
            }
            
            // Buscar en cotizacionData
            const cotizacionData = localStorage.getItem('cotizacionData');
            if (cotizacionData) {
                try {
                    const cotizaciones = JSON.parse(cotizacionData);
                    return cotizaciones.find(cot => cot.id === cotizacionId);
                } catch (error) {
                    console.error('Error parseando cotizacionData:', error);
                }
            }
            
            return null;
        }

        function obtenerSolucionesDetalladas(cotizacion) {
            const solucionesDetalladas = [];
            
            if (cotizacion.unidades && Array.isArray(cotizacion.unidades)) {
                cotizacion.unidades.forEach((unidad, index) => {
                    if (unidad.soluciones && Array.isArray(unidad.soluciones)) {
                        unidad.soluciones.forEach(solucion => {
                            if (solucion && (solucion.nombre || solucion.tipo_solucion)) {
                                solucionesDetalladas.push({
                                    unidad: index + 1,
                                    tipoUnidad: unidad.tipo,
                                    solucion: solucion.nombre || solucion.tipo_solucion,
                                    configuraciones: solucion.configuraciones || {}
                                });
                            }
                        });
                    }
                });
            }
            
            return solucionesDetalladas;
        }

        function enviarAInstalacionesModal() {
            if (!solicitudActual) return;
            enviarAInstalaciones(solicitudActual.id);
            bootstrap.Modal.getInstance(document.getElementById('modalDetalleSolicitud')).hide();
        }

        async function enviarAInstalaciones(solicitudId) {
            const solicitud = solicitudesDespacho.find(s => s.id === solicitudId);
            if (!solicitud) return;
            
            // Verificar si es venta sin instalaci√≥n
            if (solicitud.tipoVenta === 'venta') {
                mostrarAlerta('No se puede enviar a instalaciones una solicitud de venta sin instalaci√≥n', 'warning');
                return;
            }

            if (confirm(`¬øEnviar la solicitud ${solicitud.id} al m√≥dulo de instalaciones para validaci√≥n?`)) {
                // Obtener datos detallados de la cotizaci√≥n original
                let cotizacionOriginal = obtenerCotizacionOriginal(solicitud.cotizacionId);
                if (!cotizacionOriginal && modoCentralizado && window.DataService && window.DataService.getCotizacionByIdOrFolio) {
                    try {
                        cotizacionOriginal = await window.DataService.getCotizacionByIdOrFolio(String(solicitud.cotizacionId));
                    } catch (_) { /* continuar con null */ }
                }
                
                // Crear notificaci√≥n para instalaciones
                const notificacionInstalaciones = {
                    id: `INST-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    solicitudDespachoId: solicitud.id,
                    cotizacionId: solicitud.cotizacionId,
                    cliente: solicitud.cliente,
                    fecha: new Date().toISOString().split('T')[0],
                    estado: 'pendiente_validacion',
                    urgencia: solicitud.urgencia,
                    insumos: solicitud.insumos,
                    equipos: solicitud.equipos,
                    soluciones: solicitud.soluciones,
                    cantidadUnidades: solicitud.cantidadUnidades,
                    tipoUnidades: solicitud.tipoUnidades,
                    // Datos detallados de unidades y soluciones
                    unidadesDetalladas: cotizacionOriginal ? cotizacionOriginal.unidades : [],
                    solucionesDetalladas: cotizacionOriginal ? obtenerSolucionesDetalladas(cotizacionOriginal) : [],
                    observaciones: `Solicitud enviada desde despacho para validaci√≥n de materiales`,
                    fechaCreacion: new Date().toISOString()
                };

                if (modoCentralizado) {
                    // Evitar duplicados: verificar si ya existe notificaci√≥n para esta solicitud
                    await window.DataService.findNotificacionBySolicitudId(solicitud.id).then(async (exists) => {
                        if (exists && exists.id) {
                            mostrarAlerta('Esta solicitud ya fue enviada a Instalaciones.', 'warning');
                            return;
                        } else {
                            // Proceder con inserci√≥n y patch
                            await window.DataService.insertNotificacionInstalaciones(notificacionInstalaciones)
                              .then(ok => { if (!ok) mostrarAlerta('No se pudo enviar a instalaciones (Supabase)', 'danger'); });
                            console.log('‚úÖ DEBUG: Notificaci√≥n enviada a instalaciones:', notificacionInstalaciones);
                            solicitud.estado = 'enviada_instalaciones';
                            solicitud.fechaEnvioInstalaciones = new Date().toISOString().split('T')[0];
                            window.DataService.patchSolicitudDespachoById(solicitud.id, { estado: 'enviada_instalaciones', fechaEnvioInstalaciones: solicitud.fechaEnvioInstalaciones });
                            // Enviar a Soporte en paralelo si la soluci√≥n requiere configuraci√≥n
                            try {
                                const requiereSoporte = (() => {
                                    // Obtener soluciones detalladas de la cotizaci√≥n
                                    const det = (notificacionInstalaciones.solucionesDetalladas && notificacionInstalaciones.solucionesDetalladas.length)
                                      ? notificacionInstalaciones.solucionesDetalladas
                                      : (cotizacionOriginal ? obtenerSolucionesDetalladas(cotizacionOriginal) : []);
                                    
                                    console.log('üîç DEBUG SOPORTE - Soluciones detalladas:', det);
                                    
                                    // Verificar si alguna soluci√≥n requiere soporte
                                    const requiere = det.some(sd => {
                                        const sol = (sd.solucion || '').toLowerCase();
                                        console.log('üîç DEBUG SOPORTE - Verificando soluci√≥n:', sol);
                                        
                                        // Soluciones que siempre requieren soporte
                                        const solucionesSoporte = [
                                            'rastreo b√°sico',
                                            'rastreo avanzado', 
                                            'rastreo satelital',
                                            'mdvr 4 canales',
                                            'mdvr 8 canales'
                                        ];
                                        
                                        // Verificar soluciones exactas
                                        const esSolucionSoporte = solucionesSoporte.some(s => sol.includes(s));
                                        if (esSolucionSoporte) {
                                            console.log('üîç DEBUG SOPORTE - Soluci√≥n requiere soporte (exacta):', sol);
                                            return true;
                                        }
                                        
                                        // Verificar si incluye "grabaci√≥n" en el nombre
                                        if (sol.includes('grabaci√≥n') || sol.includes('grabacion')) {
                                            console.log('üîç DEBUG SOPORTE - Soluci√≥n con grabaci√≥n detectada:', sol);
                                            return true;
                                        }
                                        
                                        // Verificar configuraciones que requieren grabaci√≥n
                                        const cfg = sd.configuraciones || {};
                                        const grab = !!(cfg.grabacion === true || cfg['grabaci√≥n'] === true);
                                        if (grab) {
                                            console.log('üîç DEBUG SOPORTE - Configuraci√≥n con grabaci√≥n detectada:', cfg);
                                            return true;
                                        }
                                        
                                        return false;
                                    });
                                    
                                    console.log('üîç DEBUG SOPORTE - Requiere soporte:', requiere);
                                    return requiere;
                                })();
                                console.log('üîç DEBUG SOPORTE - Requiere soporte:', requiereSoporte);
                                
                                if (requiereSoporte) {
                                    console.log('‚úÖ DEBUG SOPORTE - Creando notificaci√≥n para soporte...');
                                    const notifSoporte = Object.assign({}, notificacionInstalaciones, {
                                        id: `SOP-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,
                                        modulo: 'soporte',
                                        estado: 'pendiente',
                                        fechaCreacion: new Date().toISOString(),
                                    });
                                    console.log('‚úÖ DEBUG SOPORTE - Notificaci√≥n creada:', notifSoporte);
                                    
                                    await window.DataService.findNotificacionSoporteBySolicitudId(solicitud.id).then(async (exSoporte) => {
                                        console.log('üîç DEBUG SOPORTE - Verificando si ya existe notificaci√≥n:', exSoporte);
                                        if (!exSoporte || !exSoporte.id) {
                                            console.log('‚úÖ DEBUG SOPORTE - Insertando nueva notificaci√≥n...');
                                            await window.DataService.insertNotificacionSoporte(notifSoporte)
                                              .then(ok => { 
                                                if (ok) {
                                                    console.log('‚úÖ DEBUG SOPORTE - Notificaci√≥n enviada exitosamente');
                                                } else {
                                                    console.warn('‚ùå DEBUG SOPORTE - No se pudo enviar a soporte');
                                                }
                                              });
                                        } else {
                                            console.log('‚ÑπÔ∏è DEBUG SOPORTE - Ya existe notificaci√≥n para esta solicitud');
                                        }
                                    });
                                } else {
                                    console.log('‚ÑπÔ∏è DEBUG SOPORTE - No requiere soporte, no se env√≠a notificaci√≥n');
                                }
                            } catch(e) { console.warn('Hook soporte fallo:', e); }
                            cargarListaSolicitudes();
                            actualizarEstadisticas();
                            mostrarAlerta(`Solicitud enviada al m√≥dulo de instalaciones para validaci√≥n`, 'success');
                        }
                    });
                } else {
                    // Guardar en localStorage para el m√≥dulo de instalaciones con validaci√≥n
                    const notificacionesInstalaciones = JSON.parse(localStorage.getItem('notificaciones_instalaciones') || '[]');
                    if (notificacionesInstalaciones.some(n => n.solicitudDespachoId === solicitud.id)) {
                        mostrarAlerta('Esta solicitud ya fue enviada a Instalaciones.', 'warning');
                        return;
                    }
                    notificacionesInstalaciones.push(notificacionInstalaciones);
                    localStorage.setItem('notificaciones_instalaciones', JSON.stringify(notificacionesInstalaciones));
                    console.log('‚úÖ DEBUG: Notificaci√≥n enviada a instalaciones:', notificacionInstalaciones);
                    const _tmp = JSON.parse(localStorage.getItem('notificaciones_instalaciones') || '[]');
                    console.log('‚úÖ DEBUG: Total notificaciones en localStorage:', _tmp.length);
                    // Actualizar estado local
                    solicitud.estado = 'enviada_instalaciones';
                    solicitud.fechaEnvioInstalaciones = new Date().toISOString().split('T')[0];
                    guardarSolicitudes();
                    cargarListaSolicitudes();
                    actualizarEstadisticas();
                    mostrarAlerta(`Solicitud enviada al m√≥dulo de instalaciones para validaci√≥n`, 'success');
                    return;
                }
            }
        }

        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
