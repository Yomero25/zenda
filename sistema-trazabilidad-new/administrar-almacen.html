<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Almacén - Sistema de Trazabilidad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .dashboard-card h2 {
            font-size: 3rem;
            font-weight: bold;
            margin: 0;
        }
        .dashboard-card p {
            margin: 0;
            font-size: 1.1rem;
        }
        .bg-gradient-purple { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-blue { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-green { background: linear-gradient(135deg, #fb930c 0%, #f39c12 100%); }
        .bg-gradient-orange { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        
        .sidebar {
            background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="text-center mb-4">
                    <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="60" class="mb-3">
                    <h3 class="text-white">
                        <i class="bi bi-gear"></i> Panel de Control
                    </h3>
                </div>
                
                <button class="btn btn-success" onclick="agregarNuevaCombinacion()">
                    <i class="bi bi-plus-circle"></i> Nueva Combinación
                </button>
                
                <button class="btn btn-warning" onclick="restaurarAlmacen()">
                    <i class="bi bi-arrow-clockwise"></i> Restaurar Almacén
                </button>

                
                <div class="mt-4">
                    <a href="./cotizaciones-completo.html" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Volver al Sistema Principal
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Header -->
                <nav class="navbar navbar-dark bg-dark">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="40" class="me-3">
                            <span class="navbar-brand mb-0 h1">
                                <i class="bi bi-boxes"></i> Sistema de Trazabilidad
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="./cotizaciones-completo.html" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Principal
                            </a>
                            <button class="btn btn-outline-light btn-sm" id="btnLogout">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Dashboard -->
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-purple">
                                <h2 id="totalCombinaciones">0</h2>
                                <p>Combinaciones</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-blue">
                                <h2 id="totalInsumos">0</h2>
                                <p>Insumos Únicos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-green">
                                <h2 id="totalTiposUnidad">0</h2>
                                <p>Tipos de Unidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-orange">
                                <h2 id="totalTiposSolucion">0</h2>
                                <p>Tipos de Solución</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <h5><i class="bi bi-funnel"></i> Filtros</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filtroTipoUnidad" class="form-label">Tipo de Unidad:</label>
                                <select class="form-select" id="filtroTipoUnidad" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroTipoSolucion" class="form-label">Tipo de Solución:</label>
                                <select class="form-select" id="filtroTipoSolucion" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroInsumo" class="form-label">Buscar Insumo:</label>
                                <input type="text" class="form-control" id="filtroInsumo" placeholder="Escriba para buscar..." onkeyup="aplicarFiltros()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                                </button>
                                <span class="badge bg-info ms-2" id="resultadosFiltro">Mostrando todas las combinaciones</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Matriz -->
                    <div class="card">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #fb930c, #e67e22);">
                            <h4><i class="bi bi-grid-3x3-gap"></i> Matriz de Insumos</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Tipo Unidad</th>
                                            <th>Tipo Solución</th>
                                            <th>Insumos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaAlmacen">
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Combinación -->
    <div class="modal fade" id="modalEditarCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Combinación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <input type="text" class="form-control" id="editTipoUnidad" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editTipoSolucion" class="form-label">Tipo de Solución:</label>
                            <input type="text" class="form-control" id="editTipoSolucion" readonly>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Insumos y Cantidades:</label>
                        <div id="editInsumos">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicionCombinacion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Combinación -->
    <div class="modal fade" id="modalNuevaCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Combinación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="nuevoTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <input type="text" class="form-control" id="nuevoTipoUnidad" list="listaTiposUnidad" placeholder="Ej. Tracto">
                            <datalist id="listaTiposUnidad"></datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevoTipoSolucion" class="form-label">Tipo de Solución:</label>
                            <input type="text" class="form-control" id="nuevoTipoSolucion" list="listaTiposSolucion" placeholder="Ej. VPC">
                            <datalist id="listaTiposSolucion"></datalist>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Insumos y Cantidades:</label>
                        <div id="nuevoInsumos"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="agregarInsumoNueva()">
                        <i class="bi bi-plus"></i> Agregar Insumo
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarNuevaCombinacion()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase + dataService -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./dataService.js"></script>
    <script src="./accessGuard.js"></script>

    <script>
        (async function(){
            const ok = await window.accessGuard.ensureAuth(['admin','almacen']);
            if (!ok) return;
        })();
        document.addEventListener('DOMContentLoaded', function(){
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await window.dataService.authSignOut(); } catch(_){}
                    window.location.href = './login.html';
                });
            }
        });
        // ===== VARIABLES GLOBALES =====
        const modoCentralizado = (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase());
        let almacenInsumos = {};
        let combinacionEditando = null;
        let datosFiltrados = [];

        // Lista completa de insumos posibles
        const listaInsumos = [
            // Cables y conectores
            'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m',
            'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', 'Cable 2 vias', 'Cable 4 vias',
            '"Y" 4 pines', 'Base Pollak', 'Pollak Macho ', 'Pollak Hembra', 'Cable de 1 polo',
            'Terminal de ojillo', '7 vias liso 2m',
            
            // Materiales básicos
            'Silicon', 'Cinchos grande', 'Cinta de tela', 'Cinta de aislar',
            'Poliflex 3/8', 'Poliflex 1/4', 'Cincho mediado', 'Cincho con grapa',
            'Pija brocante 5/16', 'Tornillo hexagonal 5/16', 'Tornillo 3/8',
            'Tuerca 5/16', 'Tuerca 3/8', 'Rondana 5/16', 'Rondana 3/8',
            'Espiral negro', 'Espiral verde',
            
            // Componentes electrónicos
            'Relevador 2 pasos 2 tiros', 'Relevador 12v', 'Relevador 24v', 'Portarelevador',
            'placa perforada', 'Gabinete 5*7*3',
            
            // Almacenamiento
            'SD 128 Gb', 'SD 256 Gb', 'SD 512 Gb',
            
            // Alarmas y audio
            'Alarma parlante de 3 tonos', 'Alarma parlante programable', 'Bocina', 'Microfono',
            
            // Controles
            'Botón balancin', 'Boton de panico',
            
            // Cámaras
            'Camara + radar', 'Camara con microfono', 'Camara de reversa', 'Camara Digital (IP)',
            'Camara exterior mini', 'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC',
            'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo',
            
            // Dashcams
            'Dashcam ad2', 'Dashcam c6',
            
            // Sensores y accesorios
            'Sensor magnetico chico', 'Sensor magnetico grande', 'Insider',
            'Led de giro a la derecha', 'Led de giro a la izquierda', 'Limitador de velocidad',
            'Modulo sensor de cinturon seguridad',
            
            // Equipos principales
            'Monitor de VPC', 'Grabador de video 4 ch',
            
            // Sensores VPC
            'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho', 'Sideview izquierdo'
        ];

        // ===== MATRIZ COMPLETA Y CORREGIDA DEL CSV =====
        function cargarMatrizCompletaCSV() {
            // MATRIZ CORREGIDA: Sin "Guía de meta", con Pollaks, datos exactos del CSV
            return Promise.resolve({
                "Tracto": {
                    "VPC": {
                        "Cable 4 pin 5 m": "1",
                        "Cable 4 pin 7 m": "2", 
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    },
                    "Sensor VPC": {
                        "Cable 4 vias": "4",
                        "Sensor derecho VPC": "1",
                        "Sensor izquierda VPC": "1"
                    },
                    "Led de giro": {
                        "Pija brocante 5/16": "10",
                        "Terminal de ojillo": "2",
                        "Poliflex 1/4": "8",
                        "Cable 2 vias": "26",
                        "Led de giro a la derecha": "2",
                        "Led de giro a la izquierda": "2"
                    },
                    "Alarma parlante estandar": {
                        "Tornillo 3/8": "2",
                        "Cinta de tela": "1/2",
                        "Poliflex 3/8": "8",
                        "Cincho mediado": "30",
                        "Pija brocante 5/16": "2",
                        "Cable 4 vias": "6",
                        "Tuerca 3/8": "2",
                        "Rondana 3/8": "2",
                        "Alarma parlante de 3 tonos": "1"
                    },
                    "Alarma parlante programable": {},
                    "Encadenamiento señales": {
                        // NOTA: Los condicionales deben aplicarse en el wizard:
                        // - Si encadenamiento SENCILLO: 1 cámara de reversa
                        // - Si encadenamiento FULL: 2 cámaras de reversa
                        "Cable 4 pin 1 m": "5",
                        "Cable 4 pin 5 m": "1", 
                        "Cable 4 pin 7 m": "1",
                        "Cable 4 pin 15 m": "2",
                        "Base Pollak": "7",
                        "Pollak Macho ": "4",
                        "Pollak Hembra": "4",
                        "Silicon": "1/10",
                        "Cinta de tela": "1",
                        "Poliflex 3/8": "30",
                        "Cincho mediado": "120",
                        "Cincho con grapa": "80",
                        "Pija brocante 5/16": "40",
                        "Cable 2 vias": "40",
                        "Cable 4 vias": "40",
                        "Espiral negro": "1",
                        "Espiral verde": "2",
                        "7 vias liso 2m": "1",
                        "Relevador 2 pasos 2 tiros": "5",
                        "placa perforada": "2.5",
                        "Gabinete 5*7*3": "4",
                        "Camara con microfono": "2",
                        "Camara de reversa": "2"
                    },
                    "MDVR 4 Ch": {
                        "Cable 4 pin 3 m": "1",
                        "Cable 4 pin 7 m": "2",
                        "Cable 4 pin 15 m": "1",
                        "Cable 6 pin 5 m": "1",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "30",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Grabador de video 4 ch": "1"
                    },
                    "MDVR 8 Ch": {
                        "Cable 4 pin 3 m": "1",
                        "Cable 4 pin 7 m": "2",
                        "Cable 4 pin 15 m": "1",
                        "Cable 6 pin 5 m": "1",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "30",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Grabador de video 4 ch": "1"
                    },
                    "Sideview": {
                        "Cable 4 pin 7 m": "4",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "15",
                        "Cincho mediado": "60",
                        "Pija brocante 5/16": "16",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "10",
                        "Cable 4 vias": "10",
                        "Camara sideview derecho": "1",
                        "Camara sideview izquierdo": "1",
                        "Sideview derecho": "1",
                        "Sideview izquierdo": "1"
                    },
                    "Dashcam": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Cable 4 vias": "5",
                        "Dashcam ad2": "1",
                        "Dashcam c6": "1"
                    },
                    "Rastreo basico": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo avanzado": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo satelital": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 4 vias": "4",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Insider": {},
                    "Limitador de velocidad": {},
                    "Modulo sensor cinturon": {}
                },
                "Tracto Cabina sobre motor": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    },
                    "Sensor VPC": {
                        "Cable 4 vias": "4",
                        "Sensor derecho VPC": "1",
                        "Sensor izquierda VPC": "1"
                    }
                },
                "Rabón": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Torton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "4.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "3.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "2.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "1.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Van pasajeros": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Autobus pasajeros": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "SUV": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Sedan lujo": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Sedan": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Motocicleta": {
                    "Rastreo basico": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo avanzado": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo satelital": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 4 vias": "4",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    }
                }
            });
        }

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 Inicializando almacén...');
            try {
                if (modoCentralizado) {
                    console.log('📦 Modo centralizado (Supabase)');
                    await cargarDesdeSupabase();
                    suscribirRealtimeAlmacen();
                } else {
                    console.log('🗄️ Modo localStorage');
                    almacenInsumos = await cargarMatrizCompletaCSV();
                    cargarAlmacenDesdeStorage();
                }
                cargarFiltros();
                cargarTablaAlmacen();
                actualizarEstadisticas();
            } catch (error) {
                console.error('❌ Error inicializando almacén:', error);
                mostrarAlerta('Error al inicializar el almacén', 'danger');
            }
        });

        // Función para restaurar almacén si se perdió
        async function restaurarAlmacen() {
            console.log('🔄 Restaurando almacén...');
            try {
                almacenInsumos = await cargarMatrizCompletaCSV();
                console.log(`✅ Matriz restaurada: ${Object.keys(almacenInsumos).length} tipos de unidad`);
                // Sincronizar con Supabase si está activo: sembrar por filas (tipo_unidad/tipo_solucion)
                try {
                    if (modoCentralizado) {
                        await migrarAlmacenLocalASupabase(almacenInsumos);
                        console.log('✅ Almacén restaurado en Supabase (por filas)');
                    }
                } catch (e) { console.warn('⚠️ Error sincronizando almacén en Supabase', e); }

                cargarFiltros();
                cargarTablaAlmacen();
                actualizarEstadisticas();
                console.log('✅ Almacén restaurado');
            } catch (error) {
                console.error('❌ Error al restaurar almacén:', error);
                mostrarAlerta('Error al restaurar el almacén', 'danger');
            }
        }

        // ===== FUNCIONES PRINCIPALES =====
        
        async function cargarDesdeSupabase() {
            try {
                const registros = await window.dataService.fetchAlmacenInsumos();
                // Soporte esquema single-doc: {insumos: {...}}
                let mapa = {};
                if (Array.isArray(registros) && registros.length === 1 && registros[0]._schema === 'single_doc' && registros[0].insumos) {
                    mapa = registros[0].insumos;
                } else {
                    (registros || []).forEach(r => {
                        const tipoUnidad = r.tipoUnidad;
                        const tipoSolucion = r.tipoSolucion;
                        const insumos = r.insumos || {};
                        if (!mapa[tipoUnidad]) mapa[tipoUnidad] = {};
                        mapa[tipoUnidad][tipoSolucion] = insumos;
                    });
                }
                almacenInsumos = mapa;
                console.log(`✅ Supabase: ${Array.isArray(registros) ? registros.length : 0} registros`);

                // Si no hay datos en Supabase, intentar migrar desde localStorage o CSV
                const yaMigrado = localStorage.getItem('almacen_migrado_supabase') === 'true';
                if ((registros || []).length === 0 && !yaMigrado) {
                    console.log('ℹ️ Supabase vacío. Intentando migrar desde localStorage o CSV...');
                    let origenMapa = null;
                    try {
                        const almacenGuardado = localStorage.getItem('almacen_insumos');
                        if (almacenGuardado) {
                            origenMapa = JSON.parse(almacenGuardado);
                            console.log('📥 Encontrado almacén en localStorage; migrando...');
                        } else {
                            origenMapa = await cargarMatrizCompletaCSV();
                            console.log('📥 Usando matriz CSV por defecto; migrando...');
                        }
                    } catch (e) {
                        console.warn('⚠️ No fue posible obtener origen para migración:', e);
                    }
                    if (origenMapa) {
                        await migrarAlmacenLocalASupabase(origenMapa);
                        localStorage.setItem('almacen_migrado_supabase', 'true');
                        // recargar desde supabase
                        return cargarDesdeSupabase();
                    }
                }
            } catch (e) {
                console.error('❌ Error cargando Supabase almacen:', e);
                mostrarAlerta('No se pudo cargar almacen desde Supabase', 'danger');
            }
        }

        async function migrarAlmacenLocalASupabase(mapa) {
            try {
                const tareas = [];
                for (const [tipoUnidad, soluciones] of Object.entries(mapa)) {
                    for (const [tipoSolucion, insumos] of Object.entries(soluciones || {})) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        tareas.push(window.dataService.upsertAlmacenInsumoById(id, {
                            id,
                            tipoUnidad,
                            tipoSolucion,
                            insumos: insumos || {},
                        }));
                    }
                }
                for (let i = 0; i < tareas.length; i += 25) {
                    const slice = tareas.slice(i, i + 25);
                    // eslint-disable-next-line no-await-in-loop
                    await Promise.all(slice);
                }
                console.log(`✅ Migración de almacén completada (filas)`);
                mostrarAlerta('Almacén migrado a Supabase', 'success');
            } catch (e) {
                console.error('❌ Error migrando almacén a Supabase:', e);
                mostrarAlerta('Error migrando almacén a Supabase', 'danger');
            }
        }

        function cargarAlmacenDesdeStorage() {
            const almacenGuardado = localStorage.getItem('almacen_insumos');
            if (almacenGuardado) {
                try {
                    const almacenParsed = JSON.parse(almacenGuardado);
                    // Fusionar con la matriz CSV (prioridad a localStorage)
                    almacenInsumos = { ...almacenInsumos, ...almacenParsed };
                    console.log('✅ Almacén cargado desde localStorage');
                } catch (error) {
                    console.error('❌ Error parseando almacén de localStorage:', error);
                }
            }
        }

        function cargarFiltros() {
            const tiposUnidad = [...new Set(Object.keys(almacenInsumos))].sort();
            const tiposSolucion = [...new Set(
                Object.values(almacenInsumos).flatMap(obj => Object.keys(obj))
            )].sort();

            // Cargar filtro de tipos de unidad
            const selectUnidad = document.getElementById('filtroTipoUnidad');
            selectUnidad.innerHTML = '<option value="">Todos</option>';
            tiposUnidad.forEach(tipo => {
                selectUnidad.innerHTML += `<option value="${tipo}">${tipo}</option>`;
            });

            // Cargar filtro de tipos de solución
            const selectSolucion = document.getElementById('filtroTipoSolucion');
            selectSolucion.innerHTML = '<option value="">Todos</option>';
            tiposSolucion.forEach(tipo => {
                selectSolucion.innerHTML += `<option value="${tipo}">${tipo}</option>`;
            });
        }

        function cargarTablaAlmacen() {
            const tbody = document.getElementById('tablaAlmacen');
            tbody.innerHTML = '';

            let combinaciones = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    combinaciones.push({
                        tipoUnidad,
                        tipoSolucion,
                        insumos: Object.keys(insumos).length > 0 ? insumos : {}
                    });
                }
            }

            datosFiltrados = combinaciones;
            mostrarCombinaciones(combinaciones);
        }

        function mostrarCombinaciones(combinaciones) {
            const tbody = document.getElementById('tablaAlmacen');
            tbody.innerHTML = '';

            combinaciones.forEach((combo, index) => {
                const insumosTexto = Object.keys(combo.insumos).length > 0 
                    ? Object.entries(combo.insumos)
                        .map(([insumo, cantidad]) => `${insumo} (${cantidad})`)
                        .join(', ')
                    : 'Sin insumos';

                const row = `
                    <tr>
                        <td><strong>${combo.tipoUnidad}</strong></td>
                        <td><span class="badge bg-secondary">${combo.tipoSolucion}</span></td>
                        <td style="max-width: 300px; word-wrap: break-word;">${insumosTexto}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editarCombinacion('${combo.tipoUnidad}', '${combo.tipoSolucion}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCombinacion('${combo.tipoUnidad}', '${combo.tipoSolucion}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('resultadosFiltro').textContent = 
                `Mostrando ${combinaciones.length} combinaciones`;
        }

        function actualizarEstadisticas() {
            const totalCombinaciones = Object.values(almacenInsumos)
                .reduce((total, soluciones) => total + Object.keys(soluciones).length, 0);
            
            const insumosUnicos = new Set();
            Object.values(almacenInsumos).forEach(soluciones => {
                Object.values(soluciones).forEach(insumos => {
                    Object.keys(insumos).forEach(insumo => insumosUnicos.add(insumo));
                });
            });

            const tiposSolucionUnicos = new Set();
            Object.values(almacenInsumos).forEach(soluciones => {
                Object.keys(soluciones).forEach(tipo => tiposSolucionUnicos.add(tipo));
            });

            document.getElementById('totalCombinaciones').textContent = totalCombinaciones;
            document.getElementById('totalInsumos').textContent = insumosUnicos.size;
            document.getElementById('totalTiposUnidad').textContent = Object.keys(almacenInsumos).length;
            document.getElementById('totalTiposSolucion').textContent = tiposSolucionUnicos.size;
        }

        function aplicarFiltros() {
            const filtroUnidad = document.getElementById('filtroTipoUnidad').value;
            const filtroSolucion = document.getElementById('filtroTipoSolucion').value;
            const filtroInsumo = document.getElementById('filtroInsumo').value.toLowerCase();

            let combinacionesFiltradas = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    let coincide = true;

                    if (filtroUnidad && tipoUnidad !== filtroUnidad) coincide = false;
                    if (filtroSolucion && tipoSolucion !== filtroSolucion) coincide = false;
                    if (filtroInsumo) {
                        const tieneInsumo = Object.keys(insumos).some(insumo => 
                            insumo.toLowerCase().includes(filtroInsumo)
                        );
                        if (!tieneInsumo) coincide = false;
                    }

                    if (coincide) {
                        combinacionesFiltradas.push({
                            tipoUnidad,
                            tipoSolucion,
                            insumos
                        });
                    }
                }
            }

            mostrarCombinaciones(combinacionesFiltradas);
        }

        function limpiarFiltros() {
            document.getElementById('filtroTipoUnidad').value = '';
            document.getElementById('filtroTipoSolucion').value = '';
            document.getElementById('filtroInsumo').value = '';
            cargarTablaAlmacen();
        }

        function editarCombinacion(tipoUnidad, tipoSolucion) {
            combinacionEditando = { tipoUnidad, tipoSolucion };
            
            document.getElementById('editTipoUnidad').value = tipoUnidad;
            document.getElementById('editTipoSolucion').value = tipoSolucion;
            
            const insumos = almacenInsumos[tipoUnidad][tipoSolucion] || {};
            const contenedor = document.getElementById('editInsumos');
            contenedor.innerHTML = '';

            // Mostrar insumos existentes
            Object.entries(insumos).forEach(([insumo, cantidad]) => {
                const div = document.createElement('div');
                div.className = 'row mb-2';
                div.innerHTML = `
                    <div class="col-md-8">
                        <input type="text" class="form-control" value="${insumo}" readonly>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" value="${cantidad}" data-insumo="${insumo}">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                contenedor.appendChild(div);
            });

            // Botón para agregar nuevo insumo
            const divAgregar = document.createElement('div');
            divAgregar.className = 'row mt-3';
            divAgregar.innerHTML = `
                <div class="col-md-12">
                    <button class="btn btn-success btn-sm" onclick="agregarInsumoAEdicion()">
                        <i class="bi bi-plus"></i> Agregar Insumo
                    </button>
                </div>
            `;
            contenedor.appendChild(divAgregar);

            new bootstrap.Modal(document.getElementById('modalEditarCombinacion')).show();
        }

        function agregarInsumoAEdicion() {
            const contenedor = document.getElementById('editInsumos');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-8">
                    <select class="form-control">
                        <option value="">Seleccionar insumo...</option>
                        ${listaInsumos.map(insumo => `<option value="${insumo}">${insumo}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            contenedor.insertBefore(div, contenedor.lastElementChild);
        }

        async function guardarEdicionCombinacion() {
            if (!combinacionEditando) return;

            const { tipoUnidad, tipoSolucion } = combinacionEditando;
            const contenedor = document.getElementById('editInsumos');
            const nuevosInsumos = {};

            // Recopilar insumos del modal
            const rows = contenedor.querySelectorAll('.row:not(:last-child)');
            rows.forEach(row => {
                const insumo = row.querySelector('input[readonly]')?.value || 
                              row.querySelector('select')?.value;
                const cantidad = row.querySelector('input:not([readonly])')?.value;
                
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });

            // Actualizar almacén
            if (!almacenInsumos[tipoUnidad]) almacenInsumos[tipoUnidad] = {};
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;
            try {
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
            } catch (error) {
                console.warn('No se pudo guardar cambios', error);
            }
            
            // Actualizar tabla y estadísticas
            cargarTablaAlmacen();
            actualizarEstadisticas();
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalEditarCombinacion')).hide();
            
            mostrarAlerta(`Combinación ${tipoUnidad} - ${tipoSolucion} actualizada`, 'success');
        }

        async function eliminarCombinacion(tipoUnidad, tipoSolucion) {
            if (confirm(`¿Está seguro de eliminar la combinación ${tipoUnidad} - ${tipoSolucion}?`)) {
                delete almacenInsumos[tipoUnidad][tipoSolucion];
                
                // Si no quedan soluciones para este tipo de unidad, eliminar el tipo
                if (Object.keys(almacenInsumos[tipoUnidad]).length === 0) {
                    delete almacenInsumos[tipoUnidad];
                }
                try {
                    if (modoCentralizado) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        await window.dataService.deleteAlmacenInsumoById(id);
                    } else {
                        localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                    }
                } catch (error) {
                    console.warn('No se pudo guardar cambios', error);
                }
                
                cargarFiltros();
                cargarTablaAlmacen();
                actualizarEstadisticas();
                
                mostrarAlerta(`Combinación eliminada`, 'success');
            }
        }

        // ===== NUEVA COMBINACIÓN =====
        function agregarNuevaCombinacion() {
            try {
                const tiposUnidad = [...new Set(Object.keys(almacenInsumos))].sort();
                const tiposSolucion = [...new Set(
                    Object.values(almacenInsumos).flatMap(obj => Object.keys(obj))
                )].sort();

                const dlUnidad = document.getElementById('listaTiposUnidad');
                const dlSolucion = document.getElementById('listaTiposSolucion');
                dlUnidad.innerHTML = tiposUnidad.map(t => `<option value="${t}">`).join('');
                dlSolucion.innerHTML = tiposSolucion.map(t => `<option value="${t}">`).join('');

                document.getElementById('nuevoTipoUnidad').value = '';
                document.getElementById('nuevoTipoSolucion').value = '';

                const cont = document.getElementById('nuevoInsumos');
                cont.innerHTML = '';
                agregarInsumoNueva();

                new bootstrap.Modal(document.getElementById('modalNuevaCombinacion')).show();
            } catch (e) {
                console.error('❌ Error preparando modal nueva combinación:', e);
                mostrarAlerta('Error preparando el formulario de nueva combinación', 'danger');
            }
        }

        function agregarInsumoNueva() {
            const cont = document.getElementById('nuevoInsumos');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-8">
                    <select class="form-control">
                        <option value="">Seleccionar insumo...</option>
                        ${listaInsumos.map(insumo => `<option>${insumo.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            cont.appendChild(div);
        }

        async function guardarNuevaCombinacion() {
            const tipoUnidad = document.getElementById('nuevoTipoUnidad').value.trim();
            const tipoSolucion = document.getElementById('nuevoTipoSolucion').value.trim();
            if (!tipoUnidad || !tipoSolucion) {
                mostrarAlerta('Especifique tipo de unidad y tipo de solución', 'warning');
                return;
            }

            const cont = document.getElementById('nuevoInsumos');
            const rows = cont.querySelectorAll('.row');
            const nuevosInsumos = {};
            rows.forEach(row => {
                const insumo = row.querySelector('select')?.value;
                const cantidad = row.querySelector('input')?.value;
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });
            if (Object.keys(nuevosInsumos).length === 0) {
                mostrarAlerta('Agregue al menos un insumo con cantidad', 'warning');
                return;
            }

            if (!almacenInsumos[tipoUnidad]) {
                almacenInsumos[tipoUnidad] = {};
            }
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;

            try {
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
            } catch (e) {
                console.warn('No se pudo guardar combinación', e);
            }

            cargarFiltros();
            cargarTablaAlmacen();
            actualizarEstadisticas();
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaCombinacion')).hide();
            mostrarAlerta(`Combinación ${tipoUnidad} - ${tipoSolucion} creada`, 'success');
        }

        function guardarCambios() {
            if (modoCentralizado) {
                mostrarAlerta('Los cambios ya se guardan automáticamente en Supabase', 'info');
            } else {
                localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                mostrarAlerta('Cambios guardados en el navegador', 'success');
            }
        }

        function exportarAlmacen() {
            const dataStr = JSON.stringify(almacenInsumos, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'almacen_insumos.json';
            link.click();
            URL.revokeObjectURL(url);
            
            mostrarAlerta('Almacén exportado correctamente', 'success');
        }

        function importarAlmacen(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const almacenImportado = JSON.parse(e.target.result);
                    almacenInsumos = almacenImportado;
                    
                    cargarFiltros();
                    cargarTablaAlmacen();
                    actualizarEstadisticas();
                    
                    mostrarAlerta('Almacén importado correctamente', 'success');
                } catch (error) {
                    mostrarAlerta('Error al importar el archivo', 'danger');
                }
            };
            reader.readAsText(file);
        }

        function resetearAlmacen() {
            if (confirm('¿Está seguro de resetear el almacén a los valores por defecto del CSV?')) {
                localStorage.removeItem('almacen_insumos');
                cargarMatrizCompletaCSV().then(matriz => {
                    almacenInsumos = matriz;
                    cargarFiltros();
                    cargarTablaAlmacen();
                    actualizarEstadisticas();
                    mostrarAlerta('Almacén reseteado a valores del CSV', 'success');
                });
            }
        }

        function suscribirRealtimeAlmacen() {
            if (!modoCentralizado) return;
            window.dataService.subscribeAlmacenInsumos(async (payload) => {
                try {
                    await cargarDesdeSupabase();
                    cargarFiltros();
                    cargarTablaAlmacen();
                    actualizarEstadisticas();
                } catch (e) {
                    console.warn('Realtime almacen refresco fallido', e);
                }
            });
        }

        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
