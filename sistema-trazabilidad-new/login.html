<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      var s=document.createElement('script');
      s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }
  window.ensureDataService = async function(){
    if (window.dataService) return true;
    // candidatos según desde dónde se abra el login
    const candidates = [
      './dataService.js',                          // login está en sistema-trazabilidad-new/
      'sistema-trazabilidad-new/dataService.js',   // si login está en Distribucion/
      '../sistema-trazabilidad-new/dataService.js' // otras estructuras
    ];
    for (const path of candidates){
      try {
        await loadScript(path);
        if (window.dataService) return true;
      } catch(_) {}
    }
    return false;
  }
})();
</script>
<script>
(function(){
  function loadScript(src, onload, onerror){
    var s=document.createElement('script'); s.src=src; s.onload=onload; s.onerror=onerror||function(){}; document.head.appendChild(s);
  }
  // Fallback si el archivo anterior no existe por la ruta
  if (!window.dataService){
    // Intentar primero la ruta local
    loadScript('./dataService.js', function(){}, function(){
      // Alternativas por si se abre desde otro nivel de carpetas
      loadScript('sistema-trazabilidad-new/dataService.js', function(){}, function(){
        loadScript('../sistema-trazabilidad-new/dataService.js');
      });
    });
  }
  window.__ensureDataService = function(cb){
    if (window.dataService) return cb();
    var tries = 0;
    var t = setInterval(function(){
      tries++;
      if (window.dataService || tries > 20){
        clearInterval(t); cb();
      }
    }, 100);
  };
})();
</script>
</head>
<body class="d-flex align-items-center" style="min-height:100vh; background: linear-gradient(135deg, #fff7ec 0%, #ffe8cf 100%);">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-4">
        <img src="./LOGO TECHINNOVATION_Naranja.svg" alt="Logo Empresa" height="210" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,.2));">
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm" style="border: 1px solid #ffd6a6;">
          <div class="card-header text-white text-center" style="background-color:#fb930c;">
            <h5 class="mb-0">Acceso</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="email" class="form-control" placeholder="tu@correo.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              <input type="password" id="password" class="form-control" placeholder="••••••••">
            </div>
            <div class="d-grid">
              <button id="btnLogin" class="btn text-white" style="background-color:#fb930c;border-color:#fb930c;">
                <i class="bi bi-unlock me-1"></i> Entrar
              </button>
            </div>
            <div id="msg" class="mt-3 small text-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
(async function(){
  const btn = document.getElementById('btnLogin');
  const msg = document.getElementById('msg');
  btn.addEventListener('click', async () => {
    msg.textContent = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Entrando…';
    try {
      const ok = await window.ensureDataService();
      if (!ok || !window.dataService) throw new Error('No se pudo cargar dataService');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) throw new Error('Ingresa email y contraseña');
      await window.dataService.authSignIn(email, password);
      const rol = await window.dataService.getUserRole();
      // Redirección según rol (todas relativas a este directorio)
      const rutasPorRol = {
        admin: 'cotizaciones-completo.html',
        ventas: 'cotizaciones-completo.html',
        despacho: 'modulo-despacho.html',
        instalaciones: 'instalaciones_modulo.html',
        almacen: 'administrar-almacen.html',
        precios: 'administrar-precios.html',
        soporte: 'modulo-soporte.html'
      };
      if (!rol || !rutasPorRol[rol]){
        msg.textContent = 'Tu usuario no tiene un rol asignado. Contacta al administrador.';
        try { await window.dataService.authSignOut(); } catch(_){}
        return;
      }
      window.location.href = rutasPorRol[rol];
    } catch(e){
      msg.textContent = e.message || 'Error de acceso';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-unlock me-1"></i> Entrar';
    }
  });
})();
</script>
</body>
</html>
