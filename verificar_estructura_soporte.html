<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Estructura Notificaciones Soporte</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Verificaci√≥n de Estructura - Notificaciones Soporte</h1>
    <button onclick="verificarEstructura()">Verificar Estructura</button>
    <button onclick="probarEliminacion()">Probar Eliminaci√≥n</button>
    <div id="resultado"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://lsmhcpsvjcbduqovbatj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzbWhjcHN2amNiZHVxb3ZiYXRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTM4MzgsImV4cCI6MjA3MjU4OTgzOH0.8Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q';
        
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function verificarEstructura() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '<p>üîÑ Verificando estructura de la tabla...</p>';

            try {
                // 1. Verificar si podemos acceder a la tabla
                console.log('üîç Verificando acceso a notificaciones_soporte...');
                const { data: tableData, error: tableError } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .limit(1);
                
                if (tableError) {
                    resultado.innerHTML = `<p>‚ùå Error al acceder a la tabla: ${tableError.message}</p>`;
                    return;
                }

                resultado.innerHTML += `<p>‚úÖ Tabla accesible. Estructura de datos:</p>`;
                
                if (tableData && tableData.length > 0) {
                    const sample = tableData[0];
                    resultado.innerHTML += `<pre>${JSON.stringify(sample, null, 2)}</pre>`;
                    
                    // Verificar campos espec√≠ficos
                    if (sample.data) {
                        resultado.innerHTML += `<p>üìã Campos en data:</p>`;
                        resultado.innerHTML += `<ul>`;
                        Object.keys(sample.data).forEach(key => {
                            resultado.innerHTML += `<li><strong>${key}:</strong> ${typeof sample.data[key]} = ${JSON.stringify(sample.data[key])}</li>`;
                        });
                        resultado.innerHTML += `</ul>`;
                    }
                } else {
                    resultado.innerHTML += `<p>‚ÑπÔ∏è La tabla est√° vac√≠a</p>`;
                }

                // 2. Verificar √≠ndices y pol√≠ticas
                resultado.innerHTML += `<p>üîç Verificando pol√≠ticas RLS...</p>`;
                const { data: policies, error: policiesError } = await client
                    .rpc('get_table_policies', { table_name: 'notificaciones_soporte' });
                
                if (policiesError) {
                    resultado.innerHTML += `<p>‚ö†Ô∏è No se pudieron verificar pol√≠ticas: ${policiesError.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Pol√≠ticas verificadas</p>`;
                }

            } catch (error) {
                console.error('‚ùå Error general:', error);
                resultado.innerHTML = `<p>‚ùå Error general: ${error.message}</p>`;
            }
        }

        async function probarEliminacion() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML += '<p>üîÑ Probando eliminaci√≥n...</p>';

            try {
                // 1. Crear notificaci√≥n de prueba
                const notificacionPrueba = {
                    cotizacionId: 'TEST-ELIMINACION-' + Date.now(),
                    solicitudDespachoId: 'TEST-DESPACHO-' + Date.now(),
                    cliente: 'Cliente Prueba',
                    solucion: 'Rastreo avanzado',
                    estado: 'pendiente',
                    fechaCreacion: new Date().toISOString()
                };

                console.log('üìù Creando notificaci√≥n de prueba...');
                const { data: insertData, error: insertError } = await client
                    .from('notificaciones_soporte')
                    .insert([{ data: notificacionPrueba }])
                    .select();

                if (insertError) {
                    resultado.innerHTML += `<p>‚ùå Error al crear notificaci√≥n: ${insertError.message}</p>`;
                    return;
                }

                const notificacionId = insertData[0].id;
                resultado.innerHTML += `<p>‚úÖ Notificaci√≥n creada con ID: ${notificacionId}</p>`;

                // 2. Probar eliminaci√≥n por cotizacionId
                console.log('üóëÔ∏è Probando eliminaci√≥n por cotizacionId...');
                const { data: deleteData, error: deleteError } = await client
                    .from('notificaciones_soporte')
                    .delete()
                    .eq('data->>cotizacionId', notificacionPrueba.cotizacionId)
                    .select();

                if (deleteError) {
                    resultado.innerHTML += `<p>‚ùå Error al eliminar por cotizacionId: ${deleteError.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Eliminaci√≥n por cotizacionId exitosa: ${deleteData.length} registros eliminados</p>`;
                }

                // 3. Verificar que se elimin√≥
                const { data: finalCheck, error: finalError } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .eq('id', notificacionId);

                if (finalError) {
                    resultado.innerHTML += `<p>‚ùå Error al verificar eliminaci√≥n: ${finalError.message}</p>`;
                } else if (!finalCheck || finalCheck.length === 0) {
                    resultado.innerHTML += `<p>‚úÖ Verificaci√≥n exitosa: La notificaci√≥n fue eliminada correctamente</p>`;
                } else {
                    resultado.innerHTML += `<p>‚ùå Error: La notificaci√≥n a√∫n existe despu√©s de la eliminaci√≥n</p>`;
                }

            } catch (error) {
                console.error('‚ùå Error en prueba de eliminaci√≥n:', error);
                resultado.innerHTML += `<p>‚ùå Error en prueba: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
