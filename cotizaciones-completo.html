<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZendA - Workflow Manager | Cotizaciones</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
        }
        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
        }
        
        /* Estilos para filas finalizadas */
        .fila-finalizada {
            background-color: #d4edda !important;
            border-left: 4px solid #198754 !important;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(25, 135, 84, 0.1);
            transition: all 0.3s ease;
        }
        
        .fila-finalizada:hover {
            background-color: #c3e6cb !important;
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.15);
        }
        /* Badge unificado para todos los tipos */
        .badge-unificado {
            padding: 0.5rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            text-align: center;
            line-height: 1.2;
        }
        
        .estado-badge {
            padding: 0.5rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            text-align: center;
            line-height: 1.2;
        }
        
        .estado-finalizada {
            background-color: #198754 !important;
            color: white !important;
            border: 1px solid #198754 !important;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 90px;
        }
        .estado-borrador { 
            background-color: #f3f4f6; 
            color: #374151; 
            border: 1px solid #d1d5db;
        }
        .estado-enviada { 
            background-color: #dbeafe; 
            color: #1e40af; 
            border: 1px solid #93c5fd;
        }
        .estado-aceptada { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #a7f3d0;
        }
        .estado-rechazada { 
            background-color: #fee2e2; 
            color: #dc2626; 
            border: 1px solid #fca5a5;
        }
        .estado-revisando { 
            background-color: #fef3c7; 
            color: #92400e; 
            border: 1px solid #fde68a;
        }
        .estado-autorizada { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #a7f3d0;
        }
        
        /* Estilos específicos para badges de tipo cliente */
        .badge-unificado.bg-light {
            background-color: #f8f9fa !important;
            color: #495057 !important;
            border: 1px solid #dee2e6 !important;
        }
        
        /* Asegurar que todos los badges tengan el mismo tamaño base */
        .estado-badge,
        .badge-unificado {
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Estilos para iconos dentro de badges */
        .estado-badge i,
        .badge-unificado i {
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }
        
        /* Colores personalizados de la empresa */
        .bg-primary { background-color: #fb930c !important; }
        .btn-primary { background-color: #fb930c; border-color: #fb930c; }
        .btn-primary:hover { background-color: #e67e22; border-color: #e67e22; }
        .text-primary { color: #fb930c !important; }
        .border-primary { border-color: #fb930c !important; }
        
        .unidad-item {
            border: 2px dashed #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }
        .solucion-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff, #fafbff);
            border-left: 6px solid #fb930c;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <div class="d-flex align-items-center">
                <img src="./LOGO_ZENDA.svg" alt="ZendA - Workflow Manager" height="40" class="me-3">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    ZendA - Cotizaciones
                </a>
            </div>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="./administrar-almacen.html" target="_blank">
                    <i class="bi bi-warehouse me-1"></i>Administrar Almacén
                </a>
                <a class="nav-link" href="./administrar-precios.html" target="_blank">
                    <i class="bi bi-currency-dollar me-1"></i>Administrar Precios
                </a>
                <a class="nav-link" href="./modulo-despacho.html" target="_blank">
                    <i class="bi bi-truck me-1"></i>Módulo Despacho
                </a>
                <a class="nav-link" href="./instalaciones_modulo.html" target="_blank">
                    <i class="bi bi-tools me-1"></i>Módulo Instalaciones
                </a>
                <a class="nav-link" href="./modulo-soporte.html" target="_blank">
                    <i class="bi bi-hdd-network me-1"></i>Módulo Soporte
                </a>
                <button class="btn btn-outline-light btn-sm ms-2" id="btnLogout">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 fw-bold text-dark">
                            <i class="bi bi-briefcase me-2 text-primary"></i>
                            Gestión de Cotizaciones
                        </h1>
                        <p class="text-muted lead">Crear y gestionar cotizaciones del sistema empresarial</p>
                    </div>
                    <div>
                        <button class="btn btn-primary btn-lg" onclick="abrirWizard()">
                            <i class="bi bi-magic me-2"></i>Nueva Cotización
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="alertas"></div>

        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button" role="tab">
                    <i class="bi bi-table me-2"></i>Lista de Cotizaciones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pipeline-tab" data-bs-toggle="tab" data-bs-target="#pipeline" type="button" role="tab">
                    <i class="bi bi-kanban me-2"></i>Pipeline de Ventas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="plantillas-tab" data-bs-toggle="tab" data-bs-target="#plantillas" type="button" role="tab">
                    <i class="bi bi-envelope-check me-2"></i>Plantillas de Correo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="config-correo-tab" data-bs-toggle="tab" data-bs-target="#config-correo" type="button" role="tab">
                    <i class="bi bi-gear me-2"></i>Configuración de Correo
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="lista" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            Lista de Cotizaciones
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Folio</th>
                                        <th>Cliente</th>
                                        <th>Tipo Cliente</th>
                                        <th>Estado</th>
                                        <th>Progreso</th>
                                        <th>Facturada</th>
                                        <th>Fecha</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCotizaciones">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="pipeline" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Pipeline de Cotizaciones</h5>
                        <p>Vista de pipeline en desarrollo</p>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña Plantillas de Correo -->
            <div class="tab-pane fade" id="plantillas" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope-check me-2"></i>
                            Editor de Plantillas de Correo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Seleccionar Plantilla:</h6>
                                <select class="form-select" id="selectorPlantilla" onchange="cargarPlantilla()">
                                    <option value="">Seleccionar plantilla...</option>
                                    <option value="cotizacion">Plantilla de Cotización</option>
                                    <option value="seguimiento">Plantilla de Seguimiento</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <h6>Acciones:</h6>
                                <button type="button" class="btn btn-success me-2" onclick="guardarPlantilla()">
                                    <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                                </button>
                                <button type="button" class="btn btn-info me-2" onclick="previsualizarPlantilla()">
                                    <i class="bi bi-eye me-1"></i>Vista Previa
                                </button>
                                <button type="button" class="btn btn-warning" onclick="restaurarPlantilla()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Restaurar Original
                                </button>
                            </div>
                        </div>
                        
                        <div id="editorPlantillas" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Asunto del Correo:</h6>
                                    <input type="text" class="form-control mb-3" id="asuntoPlantilla" placeholder="Asunto del correo">
                                    
                                    <h6>Variables Disponibles:</h6>
                                    <div class="alert alert-info">
                                        <small>
                                            <strong>Variables que puedes usar:</strong><br>
                                            <code>{numero}</code> - Número de cotización<br>
                                            <code>{empresa}</code> - Nombre de la empresa<br>
                                            <code>{contacto}</code> - Nombre del contacto<br>
                                            <code>{email}</code> - Email del contacto<br>
                                            <code>{telefono}</code> - Teléfono del contacto<br>
                                            <code>{fecha}</code> - Fecha actual<br>
                                            <code>{validez}</code> - Validez de la cotización<br>
                                            <code>{total}</code> - Total de la cotización<br>
                                            <code>{equipos_servicios}</code> - Lista de equipos y servicios<br>
                                            <code>{mensaje_personalizado}</code> - Mensaje personalizado
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Contenido HTML:</h6>
                                    <textarea class="form-control" id="contenidoPlantilla" rows="15" placeholder="Contenido HTML de la plantilla..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div id="vistaPrevia" style="display: none;">
                            <h6>Vista Previa:</h6>
                            <div class="border rounded p-3" style="background: #f8f9fa; max-height: 500px; overflow-y: auto;">
                                <div id="contenidoPrevia"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña Configuración de Correo -->
            <div class="tab-pane fade" id="config-correo" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear me-2"></i>
                            Configuración de Servidor de Correo
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="formConfigCorreo">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-server me-2"></i>
                                                Configuración SMTP
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Servidor SMTP</label>
                                                    <input type="text" class="form-control" id="smtpServer" placeholder="smtp.gmail.com">
                                                    <div class="form-text">Ejemplo: smtp.gmail.com, smtp.outlook.com</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Puerto SMTP</label>
                                                    <input type="number" class="form-control" id="smtpPort" placeholder="587">
                                                    <div class="form-text">587 (TLS) o 465 (SSL)</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Email de Envío</label>
                                                    <input type="email" class="form-control" id="fromEmail" placeholder="ventas@empresa.com">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Nombre de Envío</label>
                                                    <input type="text" class="form-control" id="fromName" placeholder="Sistema de Cotizaciones">
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Contraseña de Aplicación</label>
                                                <input type="password" class="form-control" id="emailPassword" placeholder="Contraseña de app">
                                                <div class="form-text">
                                                    <strong>Para Gmail:</strong> Usar contraseña de aplicación, no la contraseña normal.
                                                    <a href="https://support.google.com/mail/answer/185833" target="_blank">¿Cómo obtenerla?</a>
                                                </div>
                                            </div>
                                            
                                            <!-- SERVICIOS DE ENVÍO REAL -->
                                            <hr class="my-4">
                                            <h6 class="text-primary mb-3">
                                                <i class="bi bi-cloud-arrow-up me-2"></i>Servicios de Envío Real
                                            </h6>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">EmailJS Public Key</label>
                                                    <input type="text" class="form-control" id="emailjsPublicKey" placeholder="user_xxxxxxx">
                                                    <div class="form-text">Clave pública de EmailJS</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">EmailJS Service ID</label>
                                                    <input type="text" class="form-control" id="emailjsServiceId" placeholder="service_xxxxxxx">
                                                    <div class="form-text">ID del servicio configurado</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">EmailJS Template ID</label>
                                                    <input type="text" class="form-control" id="emailjsTemplateId" placeholder="template_xxxxxxx">
                                                    <div class="form-text">ID de la plantilla</div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">URL del Backend (Opcional)</label>
                                                <input type="url" class="form-control" id="backendUrl" placeholder="https://tu-servidor.com">
                                                <div class="form-text">URL de tu servidor para envío via backend propio</div>
                                            </div>
                                            
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-success" onclick="guardarConfigCorreo()">
                                                    <i class="bi bi-check-lg me-1"></i>Guardar Configuración
                                                </button>
                                                <button type="button" class="btn btn-info" onclick="probarConfigCorreo()">
                                                    <i class="bi bi-envelope-check me-1"></i>Probar Configuración
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle me-2"></i>
                                                Guía de Configuración
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <h6>📧 Servicios Recomendados:</h6>
                                                <ul class="mb-0">
                                                    <li><strong>EmailJS:</strong> Servicio gratuito para envío desde frontend</li>
                                                    <li><strong>SendGrid:</strong> Servicio profesional con API</li>
                                                    <li><strong>Gmail SMTP:</strong> Usando contraseña de aplicación</li>
                                                </ul>
                                            </div>
                                            
                                            <div class="alert alert-warning">
                                                <h6>⚙️ Configuración para Gmail:</h6>
                                                <ol class="mb-0">
                                                    <li>Habilita la verificación en 2 pasos</li>
                                                    <li>Ve a "Contraseñas de aplicaciones"</li>
                                                    <li>Genera una nueva para "Otra aplicación"</li>
                                                    <li>Usa esa contraseña aquí (no tu contraseña normal)</li>
                                                </ol>
                                            </div>
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <small class="text-muted">Estado de la Configuración</small>
                                                </div>
                                                <div class="card-body p-2">
                                                    <div id="estadoConfig">
                                                        <span class="badge bg-secondary">No configurado</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-bell me-2"></i>
                                                Configuración de Notificaciones
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="notificacionesAuto" checked>
                                                <label class="form-check-label" for="notificacionesAuto">
                                                    Enviar seguimientos automáticos
                                                </label>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Días para seguimiento automático</label>
                                                <select class="form-select" id="diasSeguimiento" onchange="guardarDiasSeguimiento()">
                                                    <option value="3">3 días</option>
                                                    <option value="5">5 días</option>
                                                    <option value="7" selected>7 días</option>
                                                    <option value="10">10 días</option>
                                                    <option value="15">15 días</option>
                                                    <option value="30">30 días</option>
                                                </select>
                                                <div class="form-text">Este valor se sincroniza con la configuración del wizard</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Cotización -->
    <div class="modal fade" id="modalNuevaCotizacion" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nueva Cotización
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevaCotizacion">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-person-badge me-2"></i>
                                    Información del Cliente
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold" for="cliente_nombre">Cliente *</label>
                                        <input type="text" class="form-control" id="cliente_nombre" placeholder="Nombre del cliente" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold" for="tipo_cliente">Tipo de Cliente</label>
                                        <select class="form-select" id="tipo_cliente" onchange="actualizarDescuento()">
                                            <option value="">Seleccionar tipo</option>
                                            <option value="Distribuidor A">Distribuidor A (25% desc.)</option>
                                            <option value="Distribuidor B">Distribuidor B (20% desc.)</option>
                                            <option value="Distribuidor C">Distribuidor C (15% desc.)</option>
                                            <option value="Cliente final A">Cliente final A (10% desc.)</option>
                                            <option value="Cliente final B">Cliente final B (5% desc.)</option>
                                            <option value="Cliente final C">Cliente final C (0% desc.)</option>
                                            <option value="Cliente corporativo A">Cliente corporativo A (30% desc.)</option>
                                            <option value="Cliente corporativo B">Cliente corporativo B (20% desc.)</option>
                                            <option value="Cliente corporativo C">Cliente corporativo C (10% desc.)</option>
                                            <option value="Integrador A">Integrador A (25% desc.)</option>
                                            <option value="Integrador B">Integrador B (20% desc.)</option>
                                            <option value="Integrador C">Integrador C (15% desc.)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold" for="descuento">Descuento (%)</label>
                                        <input type="number" class="form-control" id="descuento" min="0" max="100" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold" for="fecha_vencimiento">Fecha Vencimiento</label>
                                        <input type="date" class="form-control" id="fecha_vencimiento">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold" for="observaciones">Observaciones</label>
                                    <textarea class="form-control" id="observaciones" rows="3" placeholder="Observaciones adicionales"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-box me-2"></i>Unidades
                                    </h6>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarUnidad()">
                                        <i class="bi bi-plus me-1"></i>Agregar Unidad
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="unidades-container">
                                    <p class="text-muted text-center py-4">
                                        No hay unidades agregadas. Haz clic en "Agregar Unidad" para comenzar.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-gear me-2"></i>Soluciones
                                    </h6>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="agregarSolucion()">
                                        <i class="bi bi-plus me-1"></i>Agregar Solución
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="soluciones-container">
                                    <p class="text-muted text-center py-4">
                                        No hay soluciones agregadas. Haz clic en "Agregar Solución" para comenzar.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormulario()">Limpiar</button>
                    <button type="button" class="btn btn-primary" onclick="crearCotizacion()">Crear Cotización</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Rechazo con Observaciones -->
    <div class="modal fade" id="modalRechazo" tabindex="-1" aria-labelledby="modalRechazoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalRechazoLabel">
                        <i class="bi bi-x-circle me-2"></i>Rechazar Cotización
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>¿Estás seguro de rechazar esta cotización?</strong>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesRechazo" class="form-label fw-bold">
                            Observaciones del Rechazo <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="observacionesRechazo" rows="4" 
                                placeholder="Describe las razones del rechazo..." required></textarea>
                        <div class="form-text">Este campo es obligatorio para rechazar la cotización.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmarRechazo()">
                        <i class="bi bi-x-circle me-1"></i>Rechazar Cotización
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="./dataService.js"></script>
    <script src="./accessGuard.js"></script>
    <script>
        (async function(){
            const ok = await window.accessGuard.ensureAuth(['admin','ventas']);
            if (!ok) return;
            // Logout handler
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await window.dataService.authSignOut(); } catch(_){}
                    window.location.href = './login.html';
                });
            }
        })();
    </script>
    <script>
        let cotizaciones = [];
        const modoCentralizado = (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase());

        const descuentosPorCliente = {
            "Distribuidor A": 25,
            "Distribuidor B": 20,
            "Distribuidor C": 15,
            "Cliente final A": 10,
            "Cliente final B": 5,
            "Cliente final C": 0,
            "Cliente corporativo A": 30,
            "Cliente corporativo B": 20,
            "Cliente corporativo C": 10,
            "Integrador A": 25,
            "Integrador B": 20,
            "Integrador C": 15
        };

        let unidadIdCounter = 1;
        let solucionIdCounter = 1;

        // Función para manejar errores de conectividad de Supabase
        function manejarErrorConectividad() {
            // Los errores de WebSocket y ERR_ADDRESS_UNREACHABLE son temporales
            // Supabase maneja automáticamente la reconexión, solo necesitamos evitar spam en consola
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const mensaje = args.join(' ');
                // Filtrar errores conocidos de conectividad temporal
                if (mensaje.includes('ERR_ADDRESS_UNREACHABLE') || 
                    mensaje.includes('WebSocket connection') ||
                    mensaje.includes('Failed to fetch') ||
                    mensaje.includes('CHANNEL_ERROR')) {
                    // Solo mostrar estos errores una vez cada 30 segundos
                    if (!window.lastConnectivityError || Date.now() - window.lastConnectivityError > 30000) {
                        console.warn('⚠️ Problema temporal de conectividad con Supabase (se reintentará automáticamente)');
                        window.lastConnectivityError = Date.now();
                    }
                    return;
                }
                // Para otros errores, mostrar normalmente
                originalConsoleError.apply(console, args);
            };
        }

        document.addEventListener("DOMContentLoaded", async function() {
            manejarErrorConectividad();
            await cargarCotizaciones();
            suscribirRealtimeCotizaciones();
            
            // Suscribirse a cambios en tiempo real de precios
            if (window.dataService && window.dataService.subscribePreciosElementos) {
                try {
                    console.log('🔄 Suscribiéndose a cambios de precios en tiempo real...');
                    window.dataService.subscribePreciosElementos((payload) => {
                        console.log('💲 Cambio en precios detectado:', payload);
                        console.log('✅ Precios actualizados en tiempo real - las cotizaciones usarán los nuevos precios');
                    });
                } catch (error) {
                    console.warn('⚠️ Error al suscribirse a cambios de precios:', error);
                    // No es crítico, solo loggeamos el error
                }
            }
        });

        async function cargarCotizaciones() {
            try {
                if (modoCentralizado) {
                    const res = await window.dataService.fetchCotizaciones();
                    if (Array.isArray(res) && res.length > 0) {
                        cotizaciones = res;
                    } else {
                        // Migración automática desde localStorage si hay datos y aún no migrado
                        const yaMigrado = localStorage.getItem('cotizaciones_migradas_supabase') === 'true';
                        const locales = JSON.parse(localStorage.getItem('cotizaciones_guardadas') || '[]');
                        if (!yaMigrado && locales.length > 0) {
                            console.log('ℹ️ Supabase vacío. Migrando cotizaciones locales...');
                            for (const c of locales) {
                                // Asegurar compatibilidad de campos
                                try { await window.dataService.upsertCotizacion(c); } catch (e) { console.warn('No se pudo migrar cotización', c.folio, e); }
                            }
                            localStorage.setItem('cotizaciones_migradas_supabase', 'true');
                            const rec = await window.dataService.fetchCotizaciones();
                            cotizaciones = Array.isArray(rec) ? rec : [];
                        } else {
                            cotizaciones = [];
                        }
                    }
                } else {
                    cotizaciones = JSON.parse(localStorage.getItem('cotizaciones_guardadas') || '[]');
                }
            } catch (e) {
                console.warn('⚠️ Error cargando cotizaciones. Usando localStorage.', e);
                cotizaciones = JSON.parse(localStorage.getItem('cotizaciones_guardadas') || '[]');
            }

            console.log('📋 Cargando cotizaciones:', cotizaciones.length, 'cotizaciones encontradas');
            cotizaciones.forEach(cot => { console.log(`  - ${cot.folio}: ${cot.estado}`); });
            renderTablaCotizaciones();
        }

        function renderTablaCotizaciones() {
            const tbody = document.getElementById("tablaCotizaciones");
            tbody.innerHTML = "";
            cotizaciones.forEach(cotizacion => {
                const row = document.createElement("tr");
                const fecha = cotizacion.fecha_cotizacion ? new Date(cotizacion.fecha_cotizacion).toLocaleDateString('es-ES') : '';
                const total = Number(cotizacion.total || 0);
                const idAttr = String(cotizacion.id || cotizacion.folio || '');
                
                // Agregar data-cotizacion-id para el sistema de correo
                row.dataset.cotizacionId = idAttr;
                
                // Aplicar sombreado naranja si requiere seguimiento
                if (requiereSeguimiento(cotizacion)) {
                    row.style.backgroundColor = '#fff3cd';
                    row.style.borderLeft = '4px solid #ffc107';
                }
                
                // Aplicar clase CSS para filas finalizadas
                if (esFinalizada(cotizacion)) {
                    row.classList.add('fila-finalizada');
                }
                row.innerHTML = `
                    <td>
                        <strong class="text-primary">${cotizacion.folio || ('COT-' + (cotizacion.id || 'N/A'))}</strong>
                        ${esFinalizada(cotizacion) ? '<i class="bi bi-check-circle-fill text-success ms-2" title="Cotización Finalizada"></i>' : ''}
                    </td>
                    <td><strong>${cotizacion.cliente_nombre || ''}</strong></td>
                    <td><span class="badge-unificado bg-light text-dark">${cotizacion.tipo_cliente || ''}</span></td>
                    <td>${getEstadoBadge(cotizacion.estado, cotizacion)}</td>
                    <td>${generarBarraProgreso(cotizacion)}</td>
                    <td>
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" 
                                   ${cotizacion.facturada ? 'checked' : ''} 
                                   onchange="toggleFacturada('${idAttr}', this.checked)"
                                   ${cotizacion.estado !== 'aceptada' && !cotizacion.fecha_aceptacion ? 'disabled' : ''}>
                        </div>
                    </td>
                    <td><small class="text-muted">${fecha}</small></td>
                    <td><strong class="text-success">$${total.toLocaleString()}</strong></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary btn-email" data-action="correo" data-id="${idAttr}" title="Enviar por correo">
                                <i class="bi bi-envelope"></i>
                            </button>
                            <button type="button" class="btn btn-outline-info" data-action="ver" data-id="${idAttr}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning" data-action="editar" data-id="${idAttr}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success" data-action="estado" data-id="${idAttr}" title="Cambiar Estado">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" data-action="eliminar" data-id="${idAttr}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Delegación de eventos para evitar problemas con IDs string
            tbody.onclick = (ev) => {
                const btn = ev.target.closest('button[data-action]');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                if (!id) return;
                // Buscar por id o por folio
                switch (action) {
                    case 'correo':
                        enviarCorreoCotizacionDesdeTabla(id);
                        break;
                    case 'ver':
                        verCotizacion(id);
                        break;
                    case 'editar':
                        editarCotizacion(id);
                        break;
                    case 'estado':
                        cambiarEstadoCotizacion(id);
                        break;
                    case 'eliminar':
                        eliminarCotizacion(id);
                        break;
                }
            };
        }

        function suscribirRealtimeCotizaciones() {
            if (!modoCentralizado) return;
            
            try {
                window.dataService.subscribeCotizaciones(async () => {
                    await cargarCotizaciones();
                });
            } catch (error) {
                console.warn('⚠️ Error al suscribirse a cambios de cotizaciones:', error);
                // Reintentar suscripción después de 5 segundos
                setTimeout(() => {
                    console.log('🔄 Reintentando suscripción a cotizaciones...');
                    suscribirRealtimeCotizaciones();
                }, 5000);
            }
        }

        function getEstadoBadge(estado, cotizacion = null) {
            // Si se proporciona la cotización y está finalizada, mostrar "FINALIZADA"
            if (cotizacion && esFinalizada(cotizacion)) {
                return `<span class="estado-badge estado-finalizada">
                    <i class="bi bi-check-circle-fill me-1"></i>FINALIZADA
                </span>`;
            }
            
            const estados = {
                "borrador": {class: "estado-borrador", text: "Borrador"},
                "enviada": {class: "estado-enviada", text: "Enviada"},
                "aceptada": {class: "estado-aceptada", text: "Aceptada"},
                "finalizada": {class: "estado-finalizada", text: "Finalizada"},
                "rechazada": {class: "estado-rechazada", text: "Rechazada"},
                "revisando": {class: "estado-revisando", text: "En Revisión"},
                "autorizada": {class: "estado-autorizada", text: "Autorizada"}
            };
            
            const estadoInfo = estados[estado] || estados["borrador"];
            console.log(`🏷️ Generando badge para estado: "${estado}" → "${estadoInfo.text}"`);
            return `<span class="estado-badge ${estadoInfo.class}">${estadoInfo.text}</span>`;
        }

        function abrirModal() {
            limpiarFormulario();
            const modal = new bootstrap.Modal(document.getElementById("modalNuevaCotizacion"));
            modal.show();
        }

        function actualizarDescuento() {
            const tipoCliente = document.getElementById("tipo_cliente").value;
            const descuento = descuentosPorCliente[tipoCliente] || 0;
            document.getElementById("descuento").value = descuento;
        }

        function agregarUnidad() {
            const container = document.getElementById("unidades-container");
            
            const noUnidadesMsg = container.querySelector('.text-muted.text-center');
            if (noUnidadesMsg) {
                noUnidadesMsg.remove();
            }
            
            const unidadDiv = document.createElement("div");
            unidadDiv.className = "unidad-item";
            unidadDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="text-primary">Unidad #${unidadIdCounter}</h6>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarUnidad(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tipo de Unidad</label>
                        <select class="form-select" name="unidad_tipo_${unidadIdCounter}">
                            <option value="">Seleccionar...</option>
                            <option value="UPS">UPS</option>
                            <option value="Batería">Batería</option>
                            <option value="Accesorio">Accesorio</option>
                            <option value="Regulador">Regulador</option>
                            <option value="PDU">PDU</option>
                            <option value="Software">Software</option>
                            <option value="Inversor">Inversor</option>
                            <option value="Estabilizador">Estabilizador</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Marca</label>
                        <select class="form-select" name="unidad_marca_${unidadIdCounter}">
                            <option value="">Seleccionar...</option>
                            <option value="APC">APC</option>
                            <option value="Schneider Electric">Schneider Electric</option>
                            <option value="Eaton">Eaton</option>
                            <option value="Vertiv">Vertiv</option>
                            <option value="Tripp Lite">Tripp Lite</option>
                            <option value="CyberPower">CyberPower</option>
                            <option value="Liebert">Liebert</option>
                            <option value="Delta">Delta</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Modelo</label>
                        <input type="text" class="form-control" name="unidad_modelo_${unidadIdCounter}" placeholder="Modelo">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Cantidad</label>
                        <input type="number" class="form-control" name="unidad_cantidad_${unidadIdCounter}" value="1" min="1">
                    </div>
                </div>
            `;
            container.appendChild(unidadDiv);
            unidadIdCounter++;
        }

        function agregarSolucion() {
            const container = document.getElementById("soluciones-container");
            
            const noSolucionesMsg = container.querySelector('.text-muted.text-center');
            if (noSolucionesMsg) {
                noSolucionesMsg.remove();
            }
            
            const solucionDiv = document.createElement("div");
            solucionDiv.className = "solucion-item";
            solucionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="text-success">Solución #${solucionIdCounter}</h6>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarSolucion(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tipo de Solución</label>
                        <select class="form-select" name="solucion_tipo_${solucionIdCounter}">
                            <option value="">Seleccionar...</option>
                            <option value="Instalación">Instalación</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Capacitación">Capacitación</option>
                            <option value="Soporte">Soporte Técnico</option>
                            <option value="Consultoría">Consultoría</option>
                            <option value="Garantía Extendida">Garantía Extendida</option>
                            <option value="Monitoreo Remoto">Monitoreo Remoto</option>
                            <option value="Configuración">Configuración</option>
                            <option value="Migración">Migración</option>
                            <option value="Auditoría">Auditoría</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Descripción</label>
                        <input type="text" class="form-control" name="solucion_descripcion_${solucionIdCounter}" placeholder="Descripción de la solución">
                    </div>
                </div>
            `;
            container.appendChild(solucionDiv);
            solucionIdCounter++;
        }

        function eliminarUnidad(button) {
            button.closest(".unidad-item").remove();
        }

        function eliminarSolucion(button) {
            button.closest(".solucion-item").remove();
        }

        function limpiarFormulario() {
            document.getElementById("formNuevaCotizacion").reset();
            document.getElementById("descuento").value = "";
            
            document.getElementById("unidades-container").innerHTML = `
                <p class="text-muted text-center py-4">
                    No hay unidades agregadas. Haz clic en "Agregar Unidad" para comenzar.
                </p>
            `;
            
            document.getElementById("soluciones-container").innerHTML = `
                <p class="text-muted text-center py-4">
                    No hay soluciones agregadas. Haz clic en "Agregar Solución" para comenzar.
                </p>
            `;
            
            unidadIdCounter = 1;
            solucionIdCounter = 1;
        }

        async function crearCotizacion() {
            const cliente = document.getElementById("cliente_nombre").value.trim();
            
            if (!cliente) {
                mostrarAlerta("El nombre del cliente es obligatorio", "danger");
                return;
            }

            const nuevaCotizacion = {
                id: cotizaciones.length + 1,
                folio: `COT-2025-${String(cotizaciones.length + 1).padStart(3, "0")}`,
                cliente_nombre: cliente,
                tipo_cliente: document.getElementById("tipo_cliente").value,
                estado: "borrador",
                fecha_cotizacion: new Date().toISOString().split("T")[0],
                total: 0,
                unidades: [],
                soluciones: []
            };

            try {
                if (modoCentralizado) {
                    // No forzar id en Supabase; usar folio como conflicto
                    const payload = Object.assign({}, nuevaCotizacion);
                    delete payload.id;
                    await window.dataService.upsertCotizacion(payload);
                    await cargarCotizaciones();
                } else {
                    cotizaciones.push(nuevaCotizacion);
                    localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizaciones));
                    renderTablaCotizaciones();
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById("modalNuevaCotizacion"));
                modal.hide();
                mostrarAlerta(`Cotización creada exitosamente: ${nuevaCotizacion.folio}`, "success");
                limpiarFormulario();
            } catch (e) {
                console.error('❌ Error creando cotización:', e);
                mostrarAlerta('No se pudo crear la cotización', 'danger');
            }
        }

        function verCotizacion(id) {
            const cotizacion = cotizaciones.find(c => String(c.id) === String(id) || String(c.folio) === String(id));
            if (!cotizacion) return;

            // Crear HTML para unidades y soluciones - manejo de diferentes estructuras
            let unidadesHtml = '';
            const unidades = cotizacion.unidades || [];
            const cantidadLote = cotizacion.cantidadLote;
            
            if (unidades.length > 0) {
                // Detectar si es lote con unidades idénticas
                const esLoteIdentico = cantidadLote && cantidadLote > 1;
                
                if (esLoteIdentico) {
                    // Mostrar formato compacto para lotes
                    const unidadModelo = unidades[0];
                    unidadesHtml = `
                        <h6><i class="bi bi-layers me-2"></i>Cotización en Lote</h6>
                        <div class="alert alert-success">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-success mb-2"><i class="bi bi-truck me-1"></i>Cantidad: ${cantidadLote} unidades idénticas</h6>
                                    <p class="mb-1"><strong>Modelo:</strong> ${unidadModelo.marca || 'No especificada'} ${unidadModelo.tipo_unidad || unidadModelo.tipo || 'No especificado'} ${unidadModelo.modelo || 'No especificado'} ${unidadModelo.anio || unidadModelo.año || ''}</p>
                                    <p class="mb-0"><strong>Especificaciones:</strong> ${unidadModelo.combustible || 'No especificado'} - ${unidadModelo.voltaje || 'No especificado'}</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-primary fs-5">${cantidadLote}x</span>
                                </div>
                            </div>
                            ${unidadModelo.soluciones && unidadModelo.soluciones.length > 0 ? `
                                <hr class="my-2">
                                <div class="mt-2">
                                    <strong class="text-success"><i class="bi bi-gear me-1"></i>Soluciones aplicadas a cada unidad:</strong>
                                    <div class="mt-2">
                                        ${unidadModelo.soluciones.map(sol => {
                                            let solucionHtml = `<div class="mb-2 p-2 bg-white rounded border-start border-success border-3">
                                                <span class="badge bg-secondary me-1 mb-1">${sol.tipo_solucion || sol.tipo || 'Sin especificar'}</span>`;
                                            
                                            // Mostrar configuraciones si las hay
                                            if (sol.configuraciones && Object.keys(sol.configuraciones).length > 0) {
                                                const configuracionesFormateadas = Object.keys(sol.configuraciones)
                                                    .filter(key => sol.configuraciones[key])
                                                    .map(key => {
                                                        const value = sol.configuraciones[key];
                                                        
                                                        // Formatear nombres de configuraciones
                                                        let formattedKey = key.replace(/_/g, ' ')
                                                                 .replace(/\b\w/g, l => l.toUpperCase())
                                                                 .replace('Camara', 'Cámara')
                                                                 .replace('Transmision', 'Transmisión')
                                                                 .replace('Grabacion', 'Grabación')
                                                                 .replace('Sensor Vpc', 'Sensor VPC')
                                                                 .replace(' Vpc', ' VPC')
                                                                 .replace('Jammer', 'Jammer')
                                                                 .replace('Ip67', 'IP67')
                                                                 .replace('Canal Ip', 'Canal IP');
                                                        
                                                        // Si es boolean y true, solo mostrar el nombre
                                                        if (typeof value === 'boolean' && value) {
                                                            return formattedKey;
                                                        }
                                                        // Si tiene valor específico, mostrarlo
                                                        else if (typeof value === 'string' && value !== 'true') {
                                                            return `${formattedKey}: ${value}`;
                                                        }
                                                        // Si es número, mostrarlo
                                                        else if (typeof value === 'number') {
                                                            return `${formattedKey}: ${value}`;
                                                        }
                                                        
                                                        return null;
                                                    })
                                                    .filter(item => item !== null);
                                                
                                                if (configuracionesFormateadas.length > 0) {
                                                    solucionHtml += `<br><div class="ms-3 mt-1">
                                                        <small class="text-info">
                                                            <strong>Configuraciones:</strong><br>
                                                            ${configuracionesFormateadas.map(conf => `• ${conf}`).join('<br>')}
                                                        </small>
                                                    </div>`;
                                                }
                                            }
                                            
                                            solucionHtml += '</div>';
                                            return solucionHtml;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    // Mostrar formato detallado para unidades individuales
                    unidadesHtml = `
                        <h6><i class="bi bi-box me-2"></i>Unidades (${unidades.length})</h6>
                        ${unidades.map((unidad, index) => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>Unidad ${index + 1}</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Marca:</strong> ${unidad.marca || 'No especificada'}<br>
                                            <strong>Tipo:</strong> ${unidad.tipo_unidad || unidad.tipo || 'No especificado'}<br>
                                            <strong>Modelo:</strong> ${unidad.modelo || 'No especificado'}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Año:</strong> ${unidad.anio || unidad.año || 'No especificado'}<br>
                                            <strong>Combustible:</strong> ${unidad.combustible || 'No especificado'}<br>
                                            <strong>Voltaje:</strong> ${unidad.voltaje || 'No especificado'}
                                            ${unidad.cantidad ? `<br><strong>Cantidad:</strong> ${unidad.cantidad}` : ''}
                                        </div>
                                    </div>
                                    ${unidad.soluciones && unidad.soluciones.length > 0 ? `
                                        <hr>
                                        <strong>Soluciones:</strong><br>
                                        ${unidad.soluciones.map(sol => {
                                            let solucionHtml = `<span class="badge bg-secondary me-1 mb-1">${sol.tipo_solucion || sol.tipo || 'Sin especificar'}</span>`;
                                            
                                            // Mostrar configuraciones si las hay
                                            if (sol.configuraciones && Object.keys(sol.configuraciones).length > 0) {
                                                const configuracionesFormateadas = Object.keys(sol.configuraciones)
                                                    .filter(key => sol.configuraciones[key])
                                                    .map(key => {
                                                        const value = sol.configuraciones[key];
                                                        
                                                        // Formatear nombres de configuraciones
                                                        let formattedKey = key.replace(/_/g, ' ')
                                                                 .replace(/\b\w/g, l => l.toUpperCase())
                                                                 .replace('Camara', 'Cámara')
                                                                 .replace('Transmision', 'Transmisión')
                                                                 .replace('Grabacion', 'Grabación')
                                                                 .replace('Sensor Vpc', 'Sensor VPC')
                                                                 .replace(' Vpc', ' VPC')
                                                                 .replace('Jammer', 'Jammer')
                                                                 .replace('Ip67', 'IP67')
                                                                 .replace('Canal Ip', 'Canal IP');
                                                        
                                                        // Si es boolean y true, solo mostrar el nombre
                                                        if (typeof value === 'boolean' && value) {
                                                            return formattedKey;
                                                        }
                                                        // Si tiene valor específico, mostrarlo
                                                        else if (typeof value === 'string' && value !== 'true') {
                                                            return `${formattedKey}: ${value}`;
                                                        }
                                                        // Si es número, mostrarlo
                                                        else if (typeof value === 'number') {
                                                            return `${formattedKey}: ${value}`;
                                                        }
                                                        
                                                        return null;
                                                    })
                                                    .filter(item => item !== null);
                                                
                                                if (configuracionesFormateadas.length > 0) {
                                                    solucionHtml += `<br><div class="ms-3 mt-1">
                                                        <small class="text-info">
                                                            <strong>Configuraciones:</strong><br>
                                                            ${configuracionesFormateadas.map(conf => `• ${conf}`).join('<br>')}
                                                        </small>
                                                    </div>`;
                                                }
                                            }
                                            
                                            return `<div class="mb-2">${solucionHtml}</div>`;
                                        }).join('')}
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } else {
                unidadesHtml = '<h6><i class="bi bi-box me-2"></i>Unidades</h6><p class="text-muted">No hay unidades registradas</p>';
            }

            // Soluciones globales (si no están por unidad)
            let solucionesGlobalesHtml = '';
            const solucionesGlobales = cotizacion.soluciones || [];
            if (solucionesGlobales.length > 0 && !unidades.some(u => u.soluciones && u.soluciones.length > 0)) {
                solucionesGlobalesHtml = `
                    <hr>
                    <h6><i class="bi bi-gear me-2"></i>Soluciones (${solucionesGlobales.length})</h6>
                    ${solucionesGlobales.map(s => `
                        <div class="solucion-item mb-2">
                            <strong>${s.tipo || s.tipo_solucion || 'Tipo no especificado'}</strong>
                            ${s.descripcion ? ` - ${s.descripcion}` : ''}
                        </div>
                    `).join('')}
                `;
            }

            // Insumos, accesorios y servicios
            let extrasHtml = '';
            if ((cotizacion.insumos && cotizacion.insumos.length > 0) || 
                (cotizacion.accesorios && cotizacion.accesorios.length > 0) || 
                (cotizacion.servicios && cotizacion.servicios.length > 0)) {
                
                extrasHtml = '<hr><div class="row">';
                
                if (cotizacion.insumos && cotizacion.insumos.length > 0) {
                    extrasHtml += `
                        <div class="col-md-4 mb-3">
                            <h6 class="text-primary">📦 Insumos</h6>
                            ${cotizacion.insumos.map(insumo => `<span class="badge bg-warning text-dark me-1 mb-1">${insumo}</span>`).join('')}
                        </div>
                    `;
                }
                
                if (cotizacion.accesorios && cotizacion.accesorios.length > 0) {
                    extrasHtml += `
                        <div class="col-md-4 mb-3">
                            <h6 class="text-primary">🔌 Accesorios</h6>
                            ${cotizacion.accesorios.map(acc => `<span class="badge bg-info me-1 mb-1">${acc}</span>`).join('')}
                        </div>
                    `;
                }
                
                if (cotizacion.servicios && cotizacion.servicios.length > 0) {
                    extrasHtml += `
                        <div class="col-md-4 mb-3">
                            <h6 class="text-primary">🛠️ Servicios</h6>
                            ${cotizacion.servicios.map(serv => `<span class="badge bg-success me-1 mb-1">${serv}</span>`).join('')}
                        </div>
                    `;
                }
                
                extrasHtml += '</div>';
            }

            const modalBody = `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye me-2"></i>
                            Detalles de Cotización: ${cotizacion.folio}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Cliente:</strong> ${cotizacion.cliente_nombre}<br>
                                <strong>Tipo Cliente:</strong> ${cotizacion.tipo_cliente}<br>
                                <strong>Estado:</strong> ${getEstadoBadge(cotizacion.estado)}
                            </div>
                            <div class="col-md-6">
                                <strong>Fecha:</strong> ${cotizacion.fecha_cotizacion ? new Date(cotizacion.fecha_cotizacion).toLocaleDateString('es-ES') : 'No especificada'}<br>
                                <strong>Fecha Vencimiento:</strong> ${cotizacion.fecha_vencimiento || 'No especificada'}<br>
                                <strong>Total:</strong> <span class="text-success fw-bold">$${cotizacion.total ? cotizacion.total.toLocaleString() : '0.00'}</span>
                            </div>
                        </div>
                        <hr>
                        ${unidadesHtml}
                        ${solucionesGlobalesHtml}
                        ${extrasHtml}
                        ${cotizacion.observaciones ? `
                            <hr>
                            <h6><i class="bi bi-chat-text me-2"></i>Observaciones</h6>
                            <p>${cotizacion.observaciones}</p>
                        ` : ''}
                    </div>
                </div>
            `;

            // Crear modal dinámico
            const modalHtml = `
                <div class="modal fade" id="modalVerDetalles" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Ver Cotización</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${modalBody}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary" onclick="imprimirCotizacion()">
                                    <i class="bi bi-printer me-1"></i>Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal anterior si existe
            const modalExistente = document.getElementById("modalVerDetalles");
            if (modalExistente) {
                modalExistente.remove();
            }

            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Guardar datos de la cotización en el modal para impresión
            document.getElementById("modalVerDetalles").dataset.cotizacion = JSON.stringify(cotizacion);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById("modalVerDetalles"));
            modal.show();
        }

        function editarCotizacion(id) {
            const cotizacion = cotizaciones.find(c => String(c.id) === String(id) || String(c.folio) === String(id));
            if (!cotizacion) return;

            // Llenar el formulario de nueva cotización con los datos existentes
            document.getElementById("cliente_nombre").value = cotizacion.cliente_nombre || '';
            document.getElementById("tipo_cliente").value = cotizacion.tipo_cliente || '';
            document.getElementById("descuento").value = cotizacion.descuento || '';
            document.getElementById("fecha_vencimiento").value = cotizacion.fecha_vencimiento || '';
            document.getElementById("observaciones").value = cotizacion.observaciones || '';
            
            // Limpiar unidades y soluciones existentes
            // Redirigir al wizard para edición completa
            localStorage.setItem('cotizacion_editar', JSON.stringify(cotizacion));
            mostrarAlerta('Redirigiendo al wizard para editar...', 'info');
            
            setTimeout(() => {
                window.location.href = 'cotizaciones-wizard-corregido.html?editar=' + id;
            }, 1000);
            return;
            document.getElementById("solucionesContainer").innerHTML = '';
            
            // Cargar unidades con sus soluciones
            if (cotizacion.unidades && cotizacion.unidades.length > 0) {
                cotizacion.unidades.forEach(unidad => {
                    agregarUnidad();
                    const ultimaUnidad = document.getElementById("unidadesContainer").lastElementChild;
                    
                    // Llenar datos de la unidad
                    ultimaUnidad.querySelector('.unidad-marca').value = unidad.marca || '';
                    ultimaUnidad.querySelector('.unidad-tipo').value = unidad.tipo_unidad || unidad.tipo || '';
                    ultimaUnidad.querySelector('.unidad-modelo').value = unidad.modelo || '';
                    ultimaUnidad.querySelector('.unidad-anio').value = unidad.anio || unidad.año || '';
                    ultimaUnidad.querySelector('.unidad-combustible').value = unidad.combustible || '';
                    ultimaUnidad.querySelector('.unidad-voltaje').value = unidad.voltaje || '';
                    
                    // Cargar soluciones de esta unidad
                    if (unidad.soluciones && unidad.soluciones.length > 0) {
                        unidad.soluciones.forEach(solucion => {
                            agregarSolucion();
                            const ultimaSolucion = document.getElementById("solucionesContainer").lastElementChild;
                            ultimaSolucion.querySelector('.solucion-tipo').value = solucion.tipo_solucion || solucion.tipo || '';
                        });
                    }
                });
            }
            
            // Si no hay unidades pero hay soluciones globales, cargarlas
            if ((!cotizacion.unidades || cotizacion.unidades.length === 0) && cotizacion.soluciones && cotizacion.soluciones.length > 0) {
                cotizacion.soluciones.forEach(solucion => {
                    agregarSolucion();
                    const ultimaSolucion = document.getElementById("solucionesContainer").lastElementChild;
                    ultimaSolucion.querySelector('.solucion-tipo').value = solucion.tipo_solucion || solucion.tipo || '';
                });
            }
            
            actualizarDescuento();
            
            // Cambiar el título y botón del modal
            document.querySelector("#modalNuevaCotizacion .modal-title").innerHTML = `
                <i class="bi bi-pencil me-2"></i>Editar Cotización: ${cotizacion.folio}
            `;
            
            // Cambiar el botón de crear por actualizar
            const btnCrear = document.getElementById("btnCrear") || document.querySelector("#modalNuevaCotizacion .btn-primary");
            if (btnCrear) {
                btnCrear.innerHTML = '<i class="bi bi-check-circle me-1"></i>Actualizar Cotización';
                btnCrear.onclick = () => actualizarCotizacion(id);
            }

            // Abrir el modal
            const modal = new bootstrap.Modal(document.getElementById("modalNuevaCotizacion"));
            modal.show();
        }

        function cambiarEstadoCotizacion(id) {
            // Buscar la cotización por id o folio
            const cotizacion = cotizaciones.find(c => String(c.id) === String(id) || String(c.folio) === String(id));
            if (!cotizacion) {
                alert('Cotización no encontrada');
                return;
            }

            const estadosNombres = {
                'borrador': 'Borrador',
                'enviada': 'Enviada',
                'aceptada': 'Aceptada',
                'finalizada': 'Finalizada',
                'rechazada': 'Rechazada'
            };

            // Remover modal anterior si existe
            const modalExistente = document.getElementById("modalCambiarEstado");
            if (modalExistente) {
                const modalInstance = bootstrap.Modal.getInstance(modalExistente);
                if (modalInstance) {
                    modalInstance.dispose();
                }
                modalExistente.remove();
            }
            
            // Mostrar modal de selección de estado
            const estadoActual = cotizacion.estado || 'borrador';
            
            // Crear modal dinámicamente
            const modalHtml = `
                <div class="modal fade" id="modalCambiarEstado" tabindex="-1" aria-labelledby="modalCambiarEstadoLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="modalCambiarEstadoLabel">
                                    <i class="bi bi-arrow-repeat me-2"></i>Cambiar Estado de Cotización
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <strong>Cotización:</strong> ${cotizacion.folio}<br>
                                    <strong>Cliente:</strong> ${cotizacion.cliente_nombre}<br>
                                    <strong>Estado actual:</strong> <span class="badge bg-secondary">${estadosNombres[estadoActual]}</span>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold" for="selectNuevoEstado">Nuevo Estado:</label>
                                    <select class="form-select" id="selectNuevoEstado" onchange="manejarCambioEstado(this.value, '${String(id)}')">
                                        <option value="borrador" ${estadoActual === 'borrador' ? 'selected' : ''}>📝 Borrador</option>
                                        <option value="enviada" ${estadoActual === 'enviada' ? 'selected' : ''}>📤 Enviada</option>
                                        <option value="aceptada" ${estadoActual === 'aceptada' ? 'selected' : ''}>✅ Aceptada</option>
                                        <option value="finalizada" ${estadoActual === 'finalizada' ? 'selected' : ''}>🏁 Finalizada</option>
                                        <option value="rechazada" ${estadoActual === 'rechazada' ? 'selected' : ''}>❌ Rechazada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="btnConfirmarCambioEstado" data-id="${String(id)}">
                                    <i class="bi bi-check-circle me-1"></i>Cambiar Estado
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar modal en el DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalCambiarEstado'));
            modal.show();

            // Vincular acción del botón (evita inline y problemas con folios tipo COT-...)
            const btnConfirm = document.getElementById('btnConfirmarCambioEstado');
            if (btnConfirm) {
                btnConfirm.addEventListener('click', () => {
                    const key = btnConfirm.getAttribute('data-id');
                    confirmarCambioEstado(key);
                });
            }
            
            // Limpiar modal cuando se cierre
            modal._element.addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        async function confirmarCambioEstado(id) {
            const cotizacion = cotizaciones.find(c => String(c.id) === String(id) || String(c.folio) === String(id));
            const estadoSeleccionado = document.getElementById('selectNuevoEstado').value;
            const estadosNombres = {
                'borrador': 'Borrador',
                'enviada': 'Enviada',
                'aceptada': 'Aceptada',
                'finalizada': 'Finalizada',
                'rechazada': 'Rechazada'
            };
            const estadoActual = cotizacion.estado || 'borrador';
            
            console.log('🔄 Cambiando estado:', {
                id: id,
                estadoActual: estadoActual,
                estadoSeleccionado: estadoSeleccionado,
                cotizacion: cotizacion
            });
                
            if (estadoSeleccionado && estadoSeleccionado !== estadoActual) {
                // Actualizar el estado
                cotizacion.estado = estadoSeleccionado;
                cotizacion.fecha_actualizacion = new Date().toISOString().split('T')[0];
                try {
                    if (modoCentralizado) {
                        await window.dataService.patchCotizacionById(cotizacion.folio || id, {
                            estado: estadoSeleccionado,
                            fecha_actualizacion: cotizacion.fecha_actualizacion
                        });
                        // Auto-enviar a despacho cuando pasa a Aceptada (evitar duplicados)
                        if (estadoSeleccionado === 'aceptada') {
                            try {
                                const claveBusqueda = (cotizacion.id && String(cotizacion.id).trim() !== '') ? cotizacion.id : (cotizacion.folio || id);
                                const yaExiste = await window.dataService.findSolicitudByCotizacionId(String(claveBusqueda));
                                if (!yaExiste) {
                                    const solicitud = (function buildSolicitud(c) {
                                        const elementosNecesarios = {};
                                        const equiposNecesarios = {};
                                        const solucionesLista = [];
                                        // Unidades y soluciones
                                        (c.unidades || []).forEach(unidad => {
                                            if (unidad && Array.isArray(unidad.soluciones)) {
                                                unidad.soluciones.forEach(sol => {
                                                    if (sol && (sol.nombre || sol.tipo_solucion)) {
                                                        solucionesLista.push(sol.nombre || sol.tipo_solucion);
                                                    }
                                                });
                                            }
                                        });
                                        // Insumos sugeridos globales
                                        if (Array.isArray(c.insumosSugeridos)) {
                                            c.insumosSugeridos.forEach(item => {
                                                if (item && item.nombre && item.cantidad > 0) {
                                                    elementosNecesarios[item.nombre] = (elementosNecesarios[item.nombre] || 0) + item.cantidad;
                                                }
                                            });
                                        }
                                        // Accesorios sugeridos globales
                                        if (Array.isArray(c.accesoriosSugeridos)) {
                                            c.accesoriosSugeridos.forEach(item => {
                                                if (item && item.nombre && item.cantidad > 0) {
                                                    elementosNecesarios[item.nombre] = (elementosNecesarios[item.nombre] || 0) + item.cantidad;
                                                }
                                            });
                                        }
                                        // Equipos automáticos globales
                                        if (c.equiposAutomaticos) {
                                            Object.entries(c.equiposAutomaticos).forEach(([equipo, datos]) => {
                                                if (datos && datos.cantidad > 0) {
                                                    const mult = c.cantidadLote || 1;
                                                    equiposNecesarios[equipo] = (equiposNecesarios[equipo] || 0) + (datos.cantidad * mult);
                                                }
                                            });
                                        }
                                        // Equipos seleccionados manualmente
                                        if (c.equipos) {
                                            Object.entries(c.equipos).forEach(([equipo, datos]) => {
                                                if (datos && datos.cantidad > 0) {
                                                    const mult = c.cantidadLote || 1;
                                                    equiposNecesarios[equipo] = (equiposNecesarios[equipo] || 0) + (datos.cantidad * mult);
                                                }
                                            });
                                        }
                                        const tipoUnidades = (c.unidades || []).map(u => u.tipo || u.tipo_unidad || '').filter(Boolean).join(', ');
                                        
                                        console.log('🔍 DEBUG CREACION SOLICITUD - Cotización:', c.folio || c.id);
                                        console.log('🔍 DEBUG CREACION SOLICITUD - equiposAutomaticos:', c.equiposAutomaticos);
                                        console.log('🔍 DEBUG CREACION SOLICITUD - equipos:', c.equipos);
                                        console.log('🔍 DEBUG CREACION SOLICITUD - equiposNecesarios final:', equiposNecesarios);
                                        
                                        return {
                                            id: `DESP-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                            cotizacionId: String(claveBusqueda),
                                            cliente: c.cliente_nombre || c.nombre_cliente || 'Cliente no especificado',
                                            fecha: new Date().toISOString().split('T')[0],
                                            fechaRequerida: c.fecha_vencimiento || null,
                                            urgencia: c.urgente || 'baja',
                                            estado: 'pendiente',
                                            cantidadUnidades: c.cantidadLote || (c.unidades ? c.unidades.length : 1),
                                            tipoUnidades,
                                            insumos: elementosNecesarios,
                                            equipos: equiposNecesarios,
                                            observaciones: `Solicitud generada automáticamente para cotización ${c.folio || c.id}`,
                                            fechaCreacion: new Date().toISOString(),
                                            soluciones: [...new Set(solucionesLista)],
                                            tipoVenta: c.tipoVenta || 'instalacion'
                                        };
                                    })(cotizacion);
                                    const ok = await window.dataService.insertSolicitudDespacho(solicitud);
                                    if (!ok) console.warn('No se pudo insertar la solicitud de despacho en Supabase');
                                } else {
                                    console.log('Solicitud de despacho ya existe para esta cotización, no se duplica.');
                                }
                            } catch (ee) {
                                console.warn('No fue posible generar la solicitud automática a despacho (esto es esperado si la tabla usa JSONB y no columnas de clave foránea):', ee);
                            }
                        }
                        // refrescar lista desde Supabase
                        await cargarCotizaciones();
                    } else {
                        const indexLocal = cotizaciones.findIndex(c => c.id == id);
                        if (indexLocal !== -1) cotizaciones[indexLocal] = cotizacion;
                        localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizaciones));
                        localStorage.setItem('cotizaciones', JSON.stringify(cotizaciones));
                        // En modo local, delega al módulo de despacho vía su escaneo periódico
                    }
                    console.log('💾 Estado guardado:', { id, nuevoEstado: estadoSeleccionado });
                } catch (e) {
                    console.error('❌ Error actualizando estado:', e);
                    mostrarAlerta('No se pudo actualizar el estado', 'danger');
                    return;
                }
                    
                // Cerrar modal primero
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambiarEstado'));
                if (modal) {
                    modal.hide();
                }
                
                // Recargar la lista después de cerrar el modal
                setTimeout(() => {
                    renderTablaCotizaciones();
                    mostrarAlerta(`Estado cambiado exitosamente a: ${estadosNombres[estadoSeleccionado]}`, 'success');
                }, 300);
            } else if (estadoSeleccionado === estadoActual) {
                mostrarAlerta('El estado seleccionado es el mismo que el actual', 'warning');
            } else {
                mostrarAlerta('Opción no válida', 'danger');
            }
        }

        function actualizarCotizacion(id) {
            const cliente = document.getElementById("cliente_nombre").value.trim();
            
            if (!cliente) {
                mostrarAlerta("El nombre del cliente es obligatorio", "danger");
                return;
            }

            // Encontrar y actualizar la cotización
            const index = cotizaciones.findIndex(c => c.id === id);
            if (index !== -1) {
                cotizaciones[index].cliente_nombre = cliente;
                cotizaciones[index].tipo_cliente = document.getElementById("tipo_cliente").value;
                
                // Recargar la tabla
                cargarCotizaciones();
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById("modalNuevaCotizacion"));
                modal.hide();
                
                // Restaurar el modal a su estado original
                restaurarModalNuevo();
                
                mostrarAlerta(`Cotización ${cotizaciones[index].folio} actualizada exitosamente`, "success");
            }
        }

        function restaurarModalNuevo() {
            // Restaurar título
            document.querySelector("#modalNuevaCotizacion .modal-title").innerHTML = `
                <i class="bi bi-plus-circle me-2"></i>Nueva Cotización
            `;
            
            // Restaurar botón
            const btnCrear = document.querySelector("#modalNuevaCotizacion .btn-primary");
            if (btnCrear) {
                btnCrear.innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Cotización';
                btnCrear.onclick = crearCotizacion;
            }
            
            // Limpiar formulario
            limpiarFormulario();
        }

        function imprimirCotizacion() {
            // Crear ventana de impresión con formato profesional
            const cotizacionActual = JSON.parse(document.getElementById('modalVerDetalles').dataset.cotizacion || '{}');
            
            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Cotización ${cotizacionActual.folio || 'N/A'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #007bff; margin-bottom: 5px; }
                        .header p { color: #666; margin: 0; }
                        .info-section { margin-bottom: 25px; }
                        .info-section h3 { background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-left: 4px solid #007bff; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                        .info-item { margin-bottom: 8px; }
                        .info-item strong { color: #007bff; }
                        .unidades-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        .unidades-table th, .unidades-table td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
                        .unidades-table th { background: #007bff; color: white; }
                        .unidades-table tr:nth-child(even) { background: #f8f9fa; }
                        .soluciones-list { margin-top: 8px; }
                        .solucion-item { background: #e3f2fd; padding: 5px 10px; margin: 3px 0; border-radius: 3px; font-size: 0.9em; }
                        .configuraciones { color: #1976d2; font-size: 0.85em; margin-left: 15px; }
                        .totales { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9em; border-top: 1px solid #dee2e6; padding-top: 20px; }
                        @media print { 
                            body { margin: 0; } 
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>COTIZACIÓN</h1>
                        <p>Folio: <strong>${cotizacionActual.folio || 'N/A'}</strong></p>
                        <p>Fecha: ${new Date(cotizacionActual.fecha_cotizacion || new Date()).toLocaleDateString('es-ES')}</p>
                    </div>

                    <div class="info-section">
                        <h3>📋 Información del Cliente</h3>
                        <div class="info-grid">
                            <div>
                                <div class="info-item"><strong>Cliente:</strong> ${cotizacionActual.cliente_nombre || 'No especificado'}</div>
                                <div class="info-item"><strong>Empresa:</strong> ${cotizacionActual.empresa || 'No especificado'}</div>
                                <div class="info-item"><strong>Tipo de Cliente:</strong> ${cotizacionActual.tipo_cliente || 'No especificado'}</div>
                            </div>
                            <div>
                                <div class="info-item"><strong>Descuento:</strong> ${cotizacionActual.descuento || 0}%</div>
                                <div class="info-item"><strong>Válida hasta:</strong> ${cotizacionActual.fecha_vencimiento ? new Date(cotizacionActual.fecha_vencimiento).toLocaleDateString('es-ES') : 'No especificado'}</div>
                                <div class="info-item"><strong>Estado:</strong> ${(cotizacionActual.estado || 'borrador').toUpperCase()}</div>
                            </div>
                        </div>
                        ${cotizacionActual.observaciones ? `<div class="info-item"><strong>Observaciones:</strong> ${cotizacionActual.observaciones}</div>` : ''}
                    </div>

                    <div class="info-section">
                        <h3>🚛 Unidades y Soluciones</h3>
                        ${cotizacionActual.unidades && cotizacionActual.unidades.length > 0 ? (() => {
                            // Detectar si es un lote (cantidad > 1 y unidades idénticas)
                            const cantidadLote = cotizacionActual.cantidadLote || 1;
                            const esLote = cantidadLote > 1;
                            
                            if (esLote) {
                                // Mostrar formato compacto para lotes
                                const unidadModelo = cotizacionActual.unidades[0];
                                return `
                                    <div class="alert alert-success" style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px;">
                                        <h4 style="color: #155724; margin-bottom: 15px;">📦 Cotización en Lote - ${cantidadLote} Unidades Idénticas</h4>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                            <div>
                                                <h5 style="color: #155724;">Especificaciones de la Unidad</h5>
                                                <strong>Marca:</strong> ${unidadModelo.marca || 'N/A'}<br>
                                                <strong>Tipo:</strong> ${unidadModelo.tipo_unidad || unidadModelo.tipo || 'N/A'}<br>
                                                <strong>Modelo:</strong> ${unidadModelo.modelo || 'N/A'} (${unidadModelo.anio || unidadModelo.año || 'N/A'})<br>
                                                <strong>Combustible:</strong> ${unidadModelo.combustible || 'N/A'}<br>
                                                <strong>Voltaje:</strong> ${unidadModelo.voltaje || 'N/A'}
                                            </div>
                                            <div>
                                                <h5 style="color: #155724;">Soluciones por Unidad</h5>
                                                ${unidadModelo.soluciones && unidadModelo.soluciones.length > 0 ? 
                                                    unidadModelo.soluciones.map(sol => {
                                                        let solucionHtml = `<div class="solucion-item">${sol.tipo_solucion || sol.tipo || 'Sin especificar'}</div>`;
                                                        
                                                        if (sol.configuraciones && Object.keys(sol.configuraciones).length > 0) {
                                                            const configs = Object.keys(sol.configuraciones)
                                                                .filter(key => sol.configuraciones[key])
                                                                .map(key => key.replace(/_/g, ' ')
                                                                              .replace(/\b\w/g, l => l.toUpperCase())
                                                                              .replace('Sensor Vpc', 'Sensor VPC')
                                                                              .replace(' Vpc', ' VPC'));
                                                            
                                                            if (configs.length > 0) {
                                                                solucionHtml += `<div class="configuraciones">• ${configs.join(', ')}</div>`;
                                                            }
                                                        }
                                                        
                                                        return solucionHtml;
                                                    }).join('')
                                                    : '<em>Sin soluciones</em>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Mostrar formato detallado para cotizaciones individuales
                                return `
                                    <table class="unidades-table">
                                        <thead>
                                            <tr>
                                                <th>Unidad</th>
                                                <th>Especificaciones</th>
                                                <th>Soluciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${cotizacionActual.unidades.map((unidad, index) => `
                                                <tr>
                                                    <td><strong>Unidad ${index + 1}</strong></td>
                                                    <td>
                                                        <strong>Marca:</strong> ${unidad.marca || 'N/A'}<br>
                                                        <strong>Tipo:</strong> ${unidad.tipo_unidad || unidad.tipo || 'N/A'}<br>
                                                        <strong>Modelo:</strong> ${unidad.modelo || 'N/A'} (${unidad.anio || unidad.año || 'N/A'})<br>
                                                        <strong>Combustible:</strong> ${unidad.combustible || 'N/A'}<br>
                                                        <strong>Voltaje:</strong> ${unidad.voltaje || 'N/A'}
                                                    </td>
                                                    <td>
                                                        ${unidad.soluciones && unidad.soluciones.length > 0 ? 
                                                            unidad.soluciones.map(sol => {
                                                                let solucionHtml = `<div class="solucion-item">${sol.tipo_solucion || sol.tipo || 'Sin especificar'}</div>`;
                                                                
                                                                if (sol.configuraciones && Object.keys(sol.configuraciones).length > 0) {
                                                                    const configs = Object.keys(sol.configuraciones)
                                                                        .filter(key => sol.configuraciones[key])
                                                                        .map(key => key.replace(/_/g, ' ')
                                                                                      .replace(/\b\w/g, l => l.toUpperCase())
                                                                                      .replace('Sensor Vpc', 'Sensor VPC')
                                                                                      .replace(' Vpc', ' VPC'));
                                                                    
                                                                    if (configs.length > 0) {
                                                                        solucionHtml += `<div class="configuraciones">• ${configs.join(', ')}</div>`;
                                                                    }
                                                                }
                                                                
                                                                return solucionHtml;
                                                            }).join('')
                                                            : '<em>Sin soluciones</em>'
                                                        }
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `;
                            }
                        })() : '<p><em>No hay unidades registradas</em></p>'}
                    </div>

                    ${(cotizacionActual.insumos && cotizacionActual.insumos.length > 0) || 
                      (cotizacionActual.servicios && cotizacionActual.servicios.length > 0) || 
                      (cotizacionActual.accesorios && cotizacionActual.accesorios.length > 0) ? `
                        <div class="info-section">
                            <h3>📦 Insumos, Servicios y Accesorios</h3>
                            <div class="info-grid">
                                ${cotizacionActual.insumos && cotizacionActual.insumos.length > 0 ? `
                                    <div>
                                        <strong>Insumos:</strong>
                                        <ul>${cotizacionActual.insumos.map(item => `<li>${item}</li>`).join('')}</ul>
                                    </div>
                                ` : ''}
                                ${cotizacionActual.servicios && cotizacionActual.servicios.length > 0 ? `
                                    <div>
                                        <strong>Servicios:</strong>
                                        <ul>${cotizacionActual.servicios.map(item => `<li>${item}</li>`).join('')}</ul>
                                    </div>
                                ` : ''}
                                ${cotizacionActual.accesorios && cotizacionActual.accesorios.length > 0 ? `
                                    <div>
                                        <strong>Accesorios:</strong>
                                        <ul>${cotizacionActual.accesorios.map(item => `<li>${item}</li>`).join('')}</ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="totales">
                        <h3>💰 Información Comercial</h3>
                        <div class="info-grid">
                            <div>
                                <div class="info-item"><strong>Total de Unidades:</strong> ${cotizacionActual.unidades ? cotizacionActual.unidades.length : 0}</div>
                                ${cotizacionActual.cantidadLote ? `<div class="info-item"><strong>Cantidad Lote:</strong> ${cotizacionActual.cantidadLote}</div>` : ''}
                            </div>
                            <div>
                                <div class="info-item"><strong>Descuento:</strong> ${cotizacionActual.descuento || 0}%</div>
                                <div class="info-item"><strong>Total:</strong> $${(cotizacionActual.total || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="footer">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
                        <p><em>Esta cotización es válida hasta la fecha indicada y está sujeta a términos y condiciones.</em></p>
                    </div>
                </body>
                </html>
            `);
            
            ventanaImpresion.document.close();
            
            // Esperar a que cargue y luego imprimir
            setTimeout(() => {
                ventanaImpresion.print();
            }, 500);
        }

        async function eliminarCotizacion(id) {
            const cotizacion = cotizaciones.find(c => String(c.id) === String(id) || String(c.folio) === String(id));
            if (!cotizacion) return;

            if (confirm(`¿Estás seguro de que deseas eliminar la cotización ${cotizacion.folio}?`)) {
                try {
                    if (modoCentralizado) {
                        await window.dataService.deleteCotizacionCascade(cotizacion.folio || id);
                        await cargarCotizaciones();
                    } else {
                        const index = cotizaciones.findIndex(c => c.id === id);
                        if (index !== -1) cotizaciones.splice(index, 1);
                        localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizaciones));
                        renderTablaCotizaciones();
                    }
                    mostrarAlerta(`Cotización ${cotizacion.folio} eliminada exitosamente`, "success");
                } catch (e) {
                    console.error('❌ Error eliminando cotización:', e);
                    mostrarAlerta('No se pudo eliminar la cotización', 'danger');
                }
            }
        }

        function abrirWizard() {
            // Al crear nueva, limpiar cualquier progreso de borrador para no precargarlo
            localStorage.removeItem('cotizacion_progreso');
            localStorage.removeItem('cotizacion_progreso_id');
            window.location.href = 'cotizaciones-wizard-corregido.html';
        }



        function mostrarAlerta(mensaje, tipo) {
            const alertasDiv = document.getElementById("alertas");
            const alerta = document.createElement("div");
            alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
            alerta.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertasDiv.appendChild(alerta);

            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.remove();
                }
            }, 5000);
        }

        // =====================
        // FUNCIONES DE PROGRESO DE VENTAS
        // =====================

        function generarBarraProgreso(cotizacion) {
            // Comentado para reducir ruido en consola
            // console.log('🎨 DEBUG BARRA PROGRESO:', {
            //     folio: cotizacion.folio, 
            //     estado: cotizacion.estado, 
            //     fecha_envio: cotizacion.fecha_envio, 
            //     fecha_aceptacion: cotizacion.fecha_aceptacion
            // });
            
            const estados = [
                { key: 'enviada', label: 'Enviada', icon: 'bi-send' },
                { key: 'seguimiento', label: 'En Seguimiento', icon: 'bi-clock' },
                { key: 'aceptada', label: 'Aceptada', icon: 'bi-check-circle' },
                { key: 'rechazada', label: 'Rechazada', icon: 'bi-x-circle' },
                { key: 'instalada', label: 'Instalada', icon: 'bi-tools' },
                { key: 'facturada', label: 'Facturada', icon: 'bi-receipt' },
                { key: 'finalizada', label: 'Finalizada', icon: 'bi-flag-fill' }
            ];

            let html = '<div class="d-flex align-items-center" style="min-width: 200px;">';
            
            // Barra de progreso
            const progreso = calcularProgreso(cotizacion);
            const esRechazada = cotizacion.estado === 'rechazada' || cotizacion.fecha_rechazo;
            const colorBarra = esRechazada ? '#dc3545' : '#fb930c';
            
            html += '<div class="progress flex-grow-1 me-2" style="height: 8px;">';
            html += '<div class="progress-bar" style="width: ' + progreso + '%; background-color: ' + colorBarra + ';"></div>';
            html += '</div>';

            // Círculos de estados
            html += '<div class="d-flex">';
            estados.forEach((estado, index) => {
                const activo = esEstadoActivo(cotizacion, estado.key);
                
                // Lógica simplificada de colores
                let colorIcono = '';
                if (estado.key === 'rechazada' && (cotizacion.estado === 'rechazada' || cotizacion.fecha_rechazo)) {
                    colorIcono = 'color: #dc3545 !important;'; // Rojo para rechazada
                } else if (estado.key === 'finalizada' && esFinalizada(cotizacion)) {
                    colorIcono = 'color: #198754 !important;'; // Verde para finalizada
                } else if (activo) {
                    colorIcono = 'color: #fb930c !important;'; // Naranja para activos/completados
                } else {
                    colorIcono = 'color: #6c757d !important;'; // Gris para inactivos
                }
                
                // console.log(`🎨 ${estado.key}: activo=${activo}, color=${colorIcono}`);
                
                html += `<div class="me-1" title="${estado.label}">
                    <i class="bi ${estado.icon}" 
                       style="font-size: 12px; ${colorIcono}"></i>
                </div>`;
            });
            html += '</div>';

            html += '</div>';
            return html;
        }

        function calcularProgreso(cotizacion) {
            let progreso = 0;

            // Rechazada = 0% (barra roja) - PRIORIDAD MÁXIMA
            if (cotizacion.estado === 'rechazada' || cotizacion.fecha_rechazo) {
                return 0;
            }

            // Enviada = 25%
            if (cotizacion.estado === 'enviada' || cotizacion.fecha_envio) {
                progreso = 25;
            }

            // En seguimiento = 25% (mismo que enviada)
            if (requiereSeguimiento(cotizacion)) {
                progreso = 25;
            }

            // Aceptada = 50%
            if (cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion) {
                progreso = 50;
            }

            // Verificar si está aceptada para continuar
            const estaAceptada = cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion;
            
            if (estaAceptada) {
                // Verificar instalada y facturada
                const estaInstalada = cotizacion.fecha_instalacion;
                const estaFacturada = cotizacion.facturada;
                
                // Si tiene AMBOS (instalada Y facturada) = 100%
                if (estaInstalada && estaFacturada) {
                    progreso = 100;
                }
                // Si tiene SOLO UNO (instalada O facturada) = 75%
                else if (estaInstalada || estaFacturada) {
                    progreso = 75;
                }
                // Si solo está aceptada = 50% (ya establecido arriba)
            }

            return Math.min(progreso, 100);
        }

        function esEstadoActivo(cotizacion, estadoKey) {
            // Comentado para reducir ruido en consola
            // console.log(`🔍 DEBUG esEstadoActivo: ${estadoKey}`, {
            //     estado: cotizacion.estado,
            //     fecha_envio: cotizacion.fecha_envio,
            //     fecha_aceptacion: cotizacion.fecha_aceptacion,
            //     fecha_rechazo: cotizacion.fecha_rechazo,
            //     fecha_instalacion: cotizacion.fecha_instalacion
            // });
            
            switch(estadoKey) {
                case 'enviada': 
                    // Activo si fue enviada (completado) o está actualmente enviada
                    // Si está aceptada, rechazada, instalada o finalizada, significa que pasó por enviada
                    const resultadoEnviada = cotizacion.estado === 'enviada' || 
                           cotizacion.fecha_envio || 
                           cotizacion.estado === 'aceptada' || 
                           cotizacion.estado === 'rechazada' || 
                           cotizacion.estado === 'instalada' || 
                           cotizacion.estado === 'finalizada' ||
                           cotizacion.fecha_aceptacion ||
                           cotizacion.fecha_rechazo ||
                           cotizacion.fecha_instalacion;
                    // console.log(`🔍 DEBUG enviada resultado:`, resultadoEnviada);
                    return resultadoEnviada;
                case 'seguimiento': 
                    return requiereSeguimiento(cotizacion);
                case 'aceptada': 
                    return cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion;
                case 'rechazada': 
                    return cotizacion.estado === 'rechazada' || cotizacion.fecha_rechazo;
                case 'instalada': 
                    // Solo activo si está instalada Y aceptada, pero no debe afectar facturada
                    return cotizacion.fecha_instalacion && (cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion);
                case 'facturada': 
                    const resultadoFacturada = cotizacion.facturada && (cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion);
                    // console.log(`🔍 DEBUG facturada:`, {
                    //     facturada: cotizacion.facturada,
                    //     estado: cotizacion.estado,
                    //     fecha_aceptacion: cotizacion.fecha_aceptacion,
                    //     resultado: resultadoFacturada
                    // });
                    return resultadoFacturada;
                case 'finalizada': 
                    return esFinalizada(cotizacion);
                default: 
                    return false;
            }
        }

        function obtenerColorEstado(cotizacion, estadoKey) {
            // Rechazada siempre es roja
            if (estadoKey === 'rechazada' && (cotizacion.estado === 'rechazada' || cotizacion.fecha_rechazo)) {
                return 'danger';
            }
            
            // Finalizada siempre es verde
            if (estadoKey === 'finalizada' && esFinalizada(cotizacion)) {
                return 'success';
            }
            
            // Si el estado está activo, usar color naranja empresarial
            if (esEstadoActivo(cotizacion, estadoKey)) {
                return 'primary';
            }
            
            // Si no está activo, usar color secundario (gris)
            return 'secondary';
        }

        function requiereSeguimiento(cotizacion) {
            if (!cotizacion.fecha_envio || cotizacion.estado === 'aceptada' || cotizacion.estado === 'rechazada') {
                return false;
            }

            const diasSeguimiento = parseInt(cotizacion.dias_seguimiento || '7');
            const fechaEnvio = new Date(cotizacion.fecha_envio);
            const fechaLimite = new Date(fechaEnvio);
            fechaLimite.setDate(fechaLimite.getDate() + diasSeguimiento);
            
            return new Date() >= fechaLimite;
        }

        function esFinalizada(cotizacion) {
            return (cotizacion.estado === 'aceptada' || cotizacion.fecha_aceptacion) && 
                   cotizacion.fecha_instalacion && 
                   cotizacion.facturada;
        }

        async function toggleFacturada(cotizacionId, facturada) {
            try {
                const cotizacion = cotizaciones.find(c => String(c.id || c.folio) === String(cotizacionId));
                if (!cotizacion) return;

                // Actualizar localmente
                cotizacion.facturada = facturada;
                cotizacion.fecha_facturacion = facturada ? new Date().toISOString() : null;

                // Actualizar en Supabase si está disponible
                if (modoCentralizado && window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase()) {
                    await window.dataService.actualizarCotizacion(cotizacionId, {
                        facturada: facturada,
                        fecha_facturacion: cotizacion.fecha_facturacion
                    });
                }

                // Re-renderizar la tabla para actualizar la barra de progreso
                renderTablaCotizaciones();
                
                mostrarAlerta(`Cotización ${facturada ? 'marcada como facturada' : 'desmarcada de facturada'}`, 'success');
            } catch (error) {
                console.error('Error actualizando estado de facturación:', error);
                mostrarAlerta('Error al actualizar el estado de facturación', 'danger');
            }
        }

        // Variables para el modal de rechazo
        let cotizacionRechazoId = null;

        function mostrarModalRechazo(cotizacionId) {
            cotizacionRechazoId = cotizacionId;
            document.getElementById('observacionesRechazo').value = '';
            const modal = new bootstrap.Modal(document.getElementById('modalRechazo'));
            modal.show();
        }

        async function confirmarRechazo() {
            const observaciones = document.getElementById('observacionesRechazo').value.trim();
            
            if (!observaciones) {
                mostrarAlerta('Las observaciones del rechazo son obligatorias', 'warning');
                return;
            }

            try {
                const cotizacion = cotizaciones.find(c => String(c.id || c.folio) === String(cotizacionRechazoId));
                if (!cotizacion) return;

                // Actualizar localmente
                cotizacion.estado = 'rechazada';
                cotizacion.fecha_rechazo = new Date().toISOString();
                cotizacion.observaciones_rechazo = observaciones;

                // Actualizar en Supabase si está disponible
                if (modoCentralizado && window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase()) {
                    await window.dataService.actualizarCotizacion(cotizacionRechazoId, {
                        estado: 'rechazada',
                        fecha_rechazo: cotizacion.fecha_rechazo,
                        observaciones_rechazo: observaciones
                    });
                }

                // Cerrar modal y re-renderizar
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalRechazo'));
                modal.hide();
                renderTablaCotizaciones();
                
                mostrarAlerta('Cotización rechazada exitosamente', 'success');
            } catch (error) {
                console.error('Error rechazando cotización:', error);
                mostrarAlerta('Error al rechazar la cotización', 'danger');
            }
        }

        function manejarCambioEstado(nuevoEstado, cotizacionId) {
            if (nuevoEstado === 'rechazada') {
                // Cerrar modal actual y abrir modal de rechazo
                const modalActual = bootstrap.Modal.getInstance(document.getElementById('modalCambiarEstado'));
                if (modalActual) {
                    modalActual.hide();
                }
                
                // Mostrar modal de rechazo después de un pequeño delay
                setTimeout(() => {
                    mostrarModalRechazo(cotizacionId);
                }, 300);
            }
        }

        // ===========================================
        // FUNCIONES DE UTILIDADES
        // ===========================================
        
        function mostrarCargando(mensaje = 'Cargando...') {
            // Crear overlay de carga si no existe
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                
                const loadingContent = document.createElement('div');
                loadingContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;
                
                loadingContent.innerHTML = `
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="loadingMessage">${mensaje}</div>
                `;
                
                overlay.appendChild(loadingContent);
                document.body.appendChild(overlay);
            } else {
                document.getElementById('loadingMessage').textContent = mensaje;
                overlay.style.display = 'flex';
            }
        }
        
        function ocultarCargando() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // ===========================================
        // FUNCIONES PARA PLANTILLAS DE CORREO
        // ===========================================
        
        function cargarPlantilla() {
            const selector = document.getElementById('selectorPlantilla');
            const tipoPlantilla = selector.value;
            
            if (!tipoPlantilla) {
                document.getElementById('editorPlantillas').style.display = 'none';
                document.getElementById('vistaPrevia').style.display = 'none';
                return;
            }
            
            // Mostrar editor
            document.getElementById('editorPlantillas').style.display = 'block';
            document.getElementById('vistaPrevia').style.display = 'none';
            
            // Cargar plantilla seleccionada
            const plantilla = emailTemplates[tipoPlantilla];
            if (plantilla) {
                document.getElementById('asuntoPlantilla').value = plantilla.subject;
                document.getElementById('contenidoPlantilla').value = plantilla.html;
            }
        }
        
        async function guardarPlantilla() {
            const selector = document.getElementById('selectorPlantilla');
            const tipoPlantilla = selector.value;
            
            if (!tipoPlantilla) {
                mostrarAlerta('Selecciona una plantilla para guardar', 'warning');
                return;
            }
            
            const asunto = document.getElementById('asuntoPlantilla').value;
            const contenido = document.getElementById('contenidoPlantilla').value;
            
            if (!asunto || !contenido) {
                mostrarAlerta('El asunto y contenido son requeridos', 'warning');
                return;
            }
            
            try {
                mostrarCargando('Guardando plantilla...');
                
                // Actualizar plantilla en memoria
                emailTemplates[tipoPlantilla].subject = asunto;
                emailTemplates[tipoPlantilla].html = contenido;
                
                // Guardar en Supabase si está disponible
                if (modoCentralizado && window.dataService) {
                    await window.dataService.guardarPlantillaCorreo(tipoPlantilla, {
                        subject: asunto,
                        html: contenido
                    });
                } else {
                    // Fallback a localStorage
                    localStorage.setItem('emailTemplates', JSON.stringify(emailTemplates));
                }
                
                ocultarCargando();
                mostrarAlerta('Plantilla guardada exitosamente', 'success');
                
            } catch (error) {
                ocultarCargando();
                console.error('Error guardando plantilla:', error);
                
                // Fallback a localStorage en caso de error
                localStorage.setItem('emailTemplates', JSON.stringify(emailTemplates));
                mostrarAlerta('Plantilla guardada localmente (sin sincronización)', 'warning');
            }
        }
        
        function previsualizarPlantilla() {
            const contenido = document.getElementById('contenidoPlantilla').value;
            
            if (!contenido) {
                mostrarAlerta('No hay contenido para previsualizar', 'warning');
                return;
            }
            
            // Datos de ejemplo para previsualización
            const datosEjemplo = {
                numero: 'COT-2024-001',
                empresa: 'Empresa Ejemplo SA',
                contacto: 'Juan Pérez',
                email: 'juan@empresa.com',
                telefono: '555-1234',
                fecha: new Date().toLocaleDateString('es-ES'),
                validez: '30 días',
                unidades: '2',
                total: '$150,000.00',
                equipos_servicios: '<p><strong>• Rastreo Avanzado</strong></p><p><strong>• VPC</strong></p>',
                mensaje_personalizado: '<div style="background: #fff3cd; padding: 10px;">Mensaje personalizado de ejemplo</div>',
                fecha_envio: new Date().toLocaleDateString('es-ES')
            };
            
            // Reemplazar variables con datos de ejemplo
            let contenidoPrevia = contenido;
            Object.keys(datosEjemplo).forEach(key => {
                const regex = new RegExp(`{${key}}`, 'g');
                contenidoPrevia = contenidoPrevia.replace(regex, datosEjemplo[key]);
            });
            
            // Mostrar vista previa
            document.getElementById('contenidoPrevia').innerHTML = contenidoPrevia;
            document.getElementById('editorPlantillas').style.display = 'none';
            document.getElementById('vistaPrevia').style.display = 'block';
        }
        
        function restaurarPlantilla() {
            const selector = document.getElementById('selectorPlantilla');
            const tipoPlantilla = selector.value;
            
            if (!tipoPlantilla) {
                mostrarAlerta('Selecciona una plantilla para restaurar', 'warning');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres restaurar la plantilla original? Se perderán todos los cambios.')) {
                // Eliminar plantilla personalizada de localStorage
                const plantillasGuardadas = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
                delete plantillasGuardadas[tipoPlantilla];
                localStorage.setItem('emailTemplates', JSON.stringify(plantillasGuardadas));
                
                // Recargar plantilla original
                cargarPlantilla();
                mostrarAlerta('Plantilla restaurada a su versión original', 'success');
            }
        }
        
        // ===========================================
        // FUNCIONES PARA CONFIGURACIÓN DE CORREO
        // ===========================================
        
        async function guardarConfigCorreo() {
            const config = {
                smtpServer: document.getElementById('smtpServer').value,
                smtpPort: parseInt(document.getElementById('smtpPort').value),
                fromEmail: document.getElementById('fromEmail').value,
                fromName: document.getElementById('fromName').value,
                password: document.getElementById('emailPassword').value,
                emailjsPublicKey: document.getElementById('emailjsPublicKey').value,
                emailjsServiceId: document.getElementById('emailjsServiceId').value,
                emailjsTemplateId: document.getElementById('emailjsTemplateId').value,
                backendUrl: document.getElementById('backendUrl').value
            };
            
            // Validar campos requeridos
            if (!config.smtpServer || !config.fromEmail || !config.password) {
                mostrarAlerta('Por favor completa todos los campos requeridos', 'warning');
                return;
            }
            
            try {
                mostrarCargando('Guardando configuración...');
                
                // Actualizar configuración global
                Object.assign(emailConfig, config);
                
                // Guardar en Supabase si está disponible
                if (modoCentralizado && window.dataService) {
                    await window.dataService.guardarConfiguracionCorreo(config);
                } else {
                    // Fallback a localStorage
                    localStorage.setItem('emailConfig', JSON.stringify(config));
                }
                
                ocultarCargando();
                
                // Actualizar estado visual
                actualizarEstadoConfig();
                
                mostrarAlerta('Configuración de correo guardada exitosamente', 'success');
                
            } catch (error) {
                ocultarCargando();
                console.error('Error guardando configuración:', error);
                
                // Fallback a localStorage en caso de error
                localStorage.setItem('emailConfig', JSON.stringify(config));
                actualizarEstadoConfig();
                
                mostrarAlerta('Configuración guardada localmente (sin sincronización)', 'warning');
            }
        }
        
        async function probarConfigCorreo() {
            const config = {
                smtpServer: document.getElementById('smtpServer').value,
                smtpPort: parseInt(document.getElementById('smtpPort').value),
                fromEmail: document.getElementById('fromEmail').value,
                fromName: document.getElementById('fromName').value,
                password: document.getElementById('emailPassword').value
            };
            
            if (!config.smtpServer || !config.fromEmail || !config.password) {
                mostrarAlerta('Completa la configuración antes de probar', 'warning');
                return;
            }
            
            try {
                mostrarCargando('Probando configuración de correo...');
                
                // Simular prueba de configuración
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Guardar estado de prueba exitosa en Supabase
                const configConEstado = {
                    ...config,
                    estadoPrueba: 'exitoso',
                    ultimaPrueba: new Date().toISOString()
                };
                
                // Guardar configuración con estado
                if (modoCentralizado && window.dataService) {
                    await window.dataService.guardarConfiguracionCorreo(configConEstado);
                } else {
                    localStorage.setItem('emailConfig', JSON.stringify(configConEstado));
                }
                
                ocultarCargando();
                actualizarEstadoConfig(true);
                mostrarAlerta('Configuración probada exitosamente', 'success');
                
            } catch (error) {
                ocultarCargando();
                actualizarEstadoConfig(false);
                mostrarAlerta('Error al probar la configuración: ' + error.message, 'danger');
            }
        }
        
        function actualizarEstadoConfig(exito = null) {
            const estadoDiv = document.getElementById('estadoConfig');
            
            if (exito === true) {
                estadoDiv.innerHTML = '<span class="badge bg-success">Configuración válida</span>';
            } else if (exito === false) {
                estadoDiv.innerHTML = '<span class="badge bg-danger">Error en configuración</span>';
            } else {
                // Verificar estado desde la configuración cargada
                if (emailConfig && emailConfig.estadoPrueba === 'exitoso') {
                    estadoDiv.innerHTML = '<span class="badge bg-success">Configuración válida</span>';
                } else if (emailConfig && (emailConfig.smtpServer || emailConfig.fromEmail)) {
                    estadoDiv.innerHTML = '<span class="badge bg-warning">Configurado (no probado)</span>';
                } else {
                    estadoDiv.innerHTML = '<span class="badge bg-secondary">No configurado</span>';
                }
            }
        }
        
        async function cargarConfiguracionCorreo() {
            try {
                console.log('📧 Cargando configuración de correo...');
                let config = null;
                
                // Intentar cargar desde Supabase
                if (modoCentralizado && window.dataService) {
                    try {
                        config = await window.dataService.obtenerConfiguracionCorreo();
                        console.log('📧 Configuración cargada desde Supabase:', config);
                    } catch (error) {
                        console.warn('Error cargando configuración de Supabase, usando localStorage:', error);
                    }
                }
                
                // Fallback a localStorage si no hay configuración en Supabase
                if (!config) {
                    const configGuardada = localStorage.getItem('emailConfig');
                    if (configGuardada) {
                        config = JSON.parse(configGuardada);
                        console.log('📧 Configuración cargada desde localStorage:', config);
                    }
                }
                
                if (config) {
                    Object.assign(emailConfig, config);
                    
                    // Pre-llenar el formulario de configuración
                    const smtpServerEl = document.getElementById('smtpServer');
                    if (smtpServerEl) {
                        console.log('📧 Pre-llenando formulario...');
                        document.getElementById('smtpServer').value = config.smtpServer || '';
                        document.getElementById('smtpPort').value = config.smtpPort || '';
                        document.getElementById('fromEmail').value = config.fromEmail || '';
                        document.getElementById('fromName').value = config.fromName || '';
                        document.getElementById('emailjsPublicKey').value = config.emailjsPublicKey || '';
                        document.getElementById('emailjsServiceId').value = config.emailjsServiceId || '';
                        document.getElementById('emailjsTemplateId').value = config.emailjsTemplateId || '';
                        document.getElementById('backendUrl').value = config.backendUrl || '';
                        console.log('📧 Formulario pre-llenado exitosamente');
                    } else {
                        console.warn('📧 Elementos del formulario no encontrados, reintentando...');
                    }
                    
                    // Actualizar estado
                    actualizarEstadoConfig();
                } else {
                    console.log('📧 No se encontró configuración guardada');
                }
            } catch (error) {
                console.error('Error cargando configuración de correo:', error);
            }
        }
        
        // Cargar plantillas personalizadas
        async function cargarPlantillasPersonalizadas() {
            try {
                let plantillas = null;
                
                // Intentar cargar desde Supabase
                if (modoCentralizado && window.dataService) {
                    try {
                        plantillas = await window.dataService.obtenerPlantillasCorreo();
                    } catch (error) {
                        console.warn('Error cargando plantillas de Supabase, usando localStorage:', error);
                    }
                }
                
                // Fallback a localStorage si no hay plantillas en Supabase
                if (!plantillas) {
                    const plantillasGuardadas = localStorage.getItem('emailTemplates');
                    if (plantillasGuardadas) {
                        plantillas = JSON.parse(plantillasGuardadas);
                    }
                }
                
                if (plantillas) {
                    Object.assign(emailTemplates, plantillas);
                }
            } catch (error) {
                console.error('Error cargando plantillas personalizadas:', error);
            }
        }

        // ===========================================
        // FUNCIONES PARA DÍAS DE SEGUIMIENTO
        // ===========================================
        
        async function guardarDiasSeguimiento() {
            const dias = document.getElementById('diasSeguimiento').value;
            
            try {
                // Guardar en Supabase si está disponible
                if (modoCentralizado && window.dataService) {
                    await window.dataService.guardarConfiguracionSeguimiento({ diasSeguimiento: parseInt(dias) });
                } else {
                    // Fallback a localStorage
                    localStorage.setItem('diasSeguimiento', dias);
                }
                
                mostrarAlerta(`Días de seguimiento actualizados: ${dias} días`, 'success');
            } catch (error) {
                console.error('Error guardando días de seguimiento:', error);
                // Fallback a localStorage en caso de error
                localStorage.setItem('diasSeguimiento', dias);
                mostrarAlerta('Configuración guardada localmente', 'warning');
            }
        }
        
        async function cargarDiasSeguimiento() {
            try {
                let dias = 7; // valor por defecto
                
                // Intentar cargar desde Supabase
                if (modoCentralizado && window.dataService) {
                    try {
                        const config = await window.dataService.obtenerConfiguracionSeguimiento();
                        if (config && config.diasSeguimiento) {
                            dias = config.diasSeguimiento;
                        }
                    } catch (error) {
                        console.warn('Error cargando días de seguimiento de Supabase, usando localStorage:', error);
                    }
                }
                
                // Fallback a localStorage si no hay configuración en Supabase
                const diasGuardados = localStorage.getItem('diasSeguimiento');
                if (diasGuardados && !dias) {
                    dias = parseInt(diasGuardados);
                }
                
                // Actualizar el selector
                const selector = document.getElementById('diasSeguimiento');
                if (selector) {
                    selector.value = dias.toString();
                }
                
                return dias;
            } catch (error) {
                console.error('Error cargando días de seguimiento:', error);
                return 7; // valor por defecto
            }
        }
        
        // ===========================================
        // SISTEMA DE CORREO Y NOTIFICACIONES
        // ===========================================
        
        // Configuración de correo (sincronizada con wizard)
        const emailConfig = {
            smtpServer: 'smtp.gmail.com',
            smtpPort: 587,
            secure: false,
            user: 'tu-email@empresa.com',
            password: 'tu-password-app',
            fromName: 'Sistema de Cotizaciones',
            fromEmail: 'tu-email@empresa.com'
        };
        
        // Plantillas de correo mejoradas
        const emailTemplates = {
            cotizacion: {
                subject: 'Cotización #{numero} - {empresa}',
                html: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <div style="background: linear-gradient(135deg, #fb930c, #e67e22); color: white; padding: 20px; text-align: center;">
                        <h1 style="margin: 0;">Cotización #{numero}</h1>
                        <p style="margin: 5px 0;">Sistema de Cotizaciones</p>
                    </div>
                    
                    <div style="padding: 20px; background: #f8f9fa;">
                        <h2 style="color: #fb930c;">Datos del Cliente</h2>
                        <p><strong>Empresa:</strong> {empresa}</p>
                        <p><strong>Contacto:</strong> {contacto}</p>
                        <p><strong>Email:</strong> {email}</p>
                        <p><strong>Teléfono:</strong> {telefono}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <h2 style="color: #fb930c;">Resumen de la Cotización</h2>
                        <p><strong>Fecha:</strong> {fecha}</p>
                        <p><strong>Validez:</strong> {validez}</p>
                        <p><strong>Total de Unidades:</strong> {unidades}</p>
                        
                        <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Total de la Cotización</h3>
                            <p style="font-size: 24px; font-weight: bold; color: #fb930c; margin: 0;">{total}</p>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3 style="color: #fb930c;">Equipos y Servicios</h3>
                            {equipos_servicios}
                        </div>
                        
                        {mensaje_personalizado}
                    </div>
                    
                    <!-- Botón de Aceptación -->
                    <div style="text-align: center; margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="color: #28a745; margin-bottom: 15px;">¿Acepta esta cotización?</h3>
                        <p style="color: #666; margin-bottom: 20px;">Haga clic en el siguiente botón para aceptar formalmente esta cotización:</p>
                        <a href="{enlace_aceptacion}" 
                           style="background: linear-gradient(135deg, #28a745, #20c997); 
                                  color: white; 
                                  padding: 15px 40px; 
                                  text-decoration: none; 
                                  border-radius: 50px; 
                                  font-weight: bold; 
                                  font-size: 16px;
                                  display: inline-block;
                                  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                  transition: all 0.3s ease;">
                            ✅ ACEPTAR COTIZACIÓN
                        </a>
                        <p style="color: #999; font-size: 12px; margin-top: 15px;">
                            Este enlace expira en 15 días. Al aceptar, recibirá una confirmación inmediata.
                        </p>
                    </div>
                    
                    <div style="background: #2c3e50; color: white; padding: 15px; text-align: center;">
                        <p style="margin: 0;">Gracias por confiar en nosotros</p>
                        <p style="margin: 5px 0; font-size: 12px;">Para cualquier consulta, responda a este correo</p>
                    </div>
                </div>
                `
            },
            seguimiento: {
                subject: 'Seguimiento de Cotización #{numero} - {empresa}',
                html: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <div style="background: #28a745; color: white; padding: 20px; text-align: center;">
                        <h1 style="margin: 0;">Seguimiento de Cotización</h1>
                        <p style="margin: 5px 0;">Cotización #{numero}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <h2 style="color: #28a745;">Hola {contacto},</h2>
                        <p>Esperamos que se encuentre bien. Nos ponemos en contacto para dar seguimiento a la cotización #{numero} que enviamos el {fecha_envio}.</p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h3 style="color: #fb930c;">Recordatorio de la Cotización</h3>
                            <p><strong>Total:</strong> {total}</p>
                            <p><strong>Validez hasta:</strong> {validez}</p>
                        </div>
                        
                        <p>¿Tiene alguna pregunta sobre nuestra propuesta? Estamos disponibles para:</p>
                        <ul>
                            <li>Resolver cualquier duda técnica</li>
                            <li>Ajustar la cotización según sus necesidades</li>
                            <li>Programar una reunión para discutir detalles</li>
                            <li>Comenzar con el proceso de implementación</li>
                        </ul>
                        
                        <p>No dude en contactarnos respondiendo a este correo.</p>
                        
                        <p style="margin-top: 30px;">Saludos cordiales,<br>
                        Equipo de Ventas</p>
                    </div>
                </div>
                `
            }
        };
        
        // Funciones para tokens de aceptación
        function generarTokenAceptacion() {
            // Generar token único de 32 caracteres
            return Array.from(crypto.getRandomValues(new Uint8Array(16)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }
        
        async function crearTokenAceptacion(folio) {
            try {
                const token = generarTokenAceptacion();
                const ahora = new Date();
                const expiracion = new Date(ahora.getTime() + (15 * 24 * 60 * 60 * 1000)); // 15 días
                
                if (modoCentralizado && window.dataService && window.dataService.supabase) {
                    // Insertar token en Supabase
                    const { data, error } = await window.dataService.supabase
                        .from('acceptance_tokens')
                        .insert({
                            cotizacion_folio: folio,
                            token: token,
                            expires_at: expiracion.toISOString()
                        })
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('Error creando token de aceptación:', error);
                        return null;
                    }
                    
                    console.log('✅ Token de aceptación creado:', { folio, token, expires_at: expiracion });
                    return token;
                } else {
                    // Fallback: usar directamente el cliente de Supabase si dataService no tiene supabase expuesto
                    if (typeof supabase !== 'undefined') {
                        try {
                            const { data, error } = await supabase
                                .from('acceptance_tokens')
                                .insert({
                                    cotizacion_folio: folio,
                                    token: token,
                                    expires_at: expiracion.toISOString()
                                })
                                .select()
                                .single();
                            
                            if (error) {
                                console.error('Error creando token de aceptación (fallback):', error);
                                console.warn('⚠️ Usando token local por error en Supabase');
                                return token; // Devolver token local para que el email funcione
                            }
                            
                            console.log('✅ Token de aceptación creado (fallback):', { folio, token, expires_at: expiracion });
                            return token;
                        } catch (fallbackError) {
                            console.error('Error en fallback de token:', fallbackError);
                            console.warn('⚠️ Usando token local por error en fallback');
                            return token;
                        }
                    } else {
                        // Último fallback: token local
                        console.warn('⚠️ Supabase no disponible: token de aceptación local (no persistente)');
                        return token;
                    }
                }
            } catch (error) {
                console.error('Error creando token de aceptación:', error);
                return null;
            }
        }
        
        function generarEnlaceAceptacion(token) {
            // URL base del dominio ZendA (temporal: usar Edge Function directa)
            // TODO: Cambiar por https://zenda.techinnovation.com.mx cuando esté configurado el dominio
            const baseUrl = 'https://lsmhcpsvjcbduqovbatj.supabase.co/functions/v1/aceptar-cotizacion';
            return `${baseUrl}?token=${token}`;
        }

        // Funciones de correo principal
        async function enviarCorreoCotizacion(datosCorreo) {
            try {
                mostrarCargando('Enviando cotización por correo...');
                
                // Generar el HTML de equipos y servicios
                const equiposHtml = generarHtmlEquiposServicios(datosCorreo.cotizacionData);
                
                // Preparar mensaje personalizado
                let mensajePersonalizado = '';
                if (datosCorreo.mensajePersonalizado) {
                    mensajePersonalizado = `
                        <div style="background: #fff3cd; border: 1px solid #ffecb5; border-radius: 5px; padding: 15px; margin: 20px 0;">
                            <h4 style="color: #856404; margin: 0 0 10px 0;">Mensaje Personalizado</h4>
                            <p style="margin: 0; color: #856404;">${datosCorreo.mensajePersonalizado}</p>
                        </div>
                    `;
                }
                
                // Crear token de aceptación
                const folio = datosCorreo.numero || datosCorreo.cotizacionData.folio || `COT-${Date.now()}`;
                const tokenAceptacion = await crearTokenAceptacion(folio);
                let enlaceAceptacion = '#';
                
                if (tokenAceptacion) {
                    enlaceAceptacion = generarEnlaceAceptacion(tokenAceptacion);
                    console.log('✅ Enlace de aceptación generado:', enlaceAceptacion);
                } else {
                    console.warn('⚠️ No se pudo crear token de aceptación, botón deshabilitado');
                    // El botón seguirá apareciendo pero llevará a una página de error
                    enlaceAceptacion = 'https://lsmhcpsvjcbduqovbatj.supabase.co/functions/v1/aceptar-cotizacion?token=invalid';
                }
                
                // Preparar los datos del template
                const templateData = {
                    numero: folio,
                    empresa: datosCorreo.cliente.empresa || 'N/A',
                    contacto: datosCorreo.cliente.contacto || 'N/A',
                    email: datosCorreo.cliente.email || '',
                    telefono: datosCorreo.cliente.telefono || 'N/A',
                    fecha: new Date().toLocaleDateString('es-ES'),
                    validez: datosCorreo.validez || '30 días',
                    unidades: datosCorreo.cotizacionData.vehiculos?.length || 0,
                    total: formatearPrecio(datosCorreo.total || 0),
                    equipos_servicios: equiposHtml,
                    mensaje_personalizado: mensajePersonalizado,
                    enlace_aceptacion: enlaceAceptacion
                };
                
                // Reemplazar placeholders en el template
                let htmlContent = emailTemplates.cotizacion.html;
                let subject = emailTemplates.cotizacion.subject;
                
                Object.keys(templateData).forEach(key => {
                    const regex = new RegExp(`{${key}}`, 'g');
                    htmlContent = htmlContent.replace(regex, templateData[key]);
                    subject = subject.replace(regex, templateData[key]);
                });
                
                // Enviar correo
                const resultado = await enviarCorreoConServicio({
                    to: datosCorreo.emails.principales,
                    cc: datosCorreo.emails.copia,
                    subject: subject,
                    html: htmlContent,
                    ...datosCorreo
                });
                
                ocultarCargando();
                
                if (resultado.success) {
                    mostrarAlerta('Cotización enviada por correo exitosamente', 'success');
                    
                    // Guardar registro del envío
                    await guardarRegistroEnvio({
                        ...datosCorreo,
                        fecha_envio: new Date().toISOString(),
                        tipo: 'cotizacion'
                    });
                    
                    // 🚀 ACTUALIZAR ESTADO DE COTIZACIÓN A "ENVIADA"
                    try {
                        const cotizacionId = datosCorreo.cotizacionData.id || datosCorreo.cotizacionData.folio;
                        console.log('📧 DEBUG: Intentando actualizar cotización:', {
                            id: datosCorreo.cotizacionData.id,
                            folio: datosCorreo.cotizacionData.folio,
                            cotizacionId,
                            cotizacionData: datosCorreo.cotizacionData
                        });
                        
                        if (modoCentralizado && window.dataService) {
                            // Actualizar en Supabase
                            await window.dataService.actualizarCotizacion(cotizacionId, {
                                estado: 'enviada',
                                fecha_envio: new Date().toISOString()
                            });
                            console.log('📧 Estado de cotización actualizado a "enviada" en Supabase');
                        }
                        
                        // Actualizar en la lista local
                        const cotizacionIndex = cotizaciones.findIndex(c => 
                            String(c.id || c.folio) === String(cotizacionId)
                        );
                        
                        if (cotizacionIndex !== -1) {
                            cotizaciones[cotizacionIndex].estado = 'enviada';
                            cotizaciones[cotizacionIndex].fecha_envio = new Date().toISOString();
                            
                            // Re-renderizar la tabla para mostrar los cambios
                            renderTablaCotizaciones();
                            console.log('📧 Estado actualizado en lista local y tabla re-renderizada');
                        }
                        
                    } catch (updateError) {
                        console.warn('Error actualizando estado de cotización:', updateError);
                    }
                    
                } else {
                    throw new Error(resultado.error || 'Error al enviar correo');
                }
                
            } catch (error) {
                ocultarCargando();
                console.error('Error enviando correo:', error);
                mostrarAlerta('Error al enviar correo: ' + error.message, 'danger');
            }
        }
        
        function generarHtmlEquiposServicios(cotizacionData) {
            let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">';
            
            if (cotizacionData.vehiculos && cotizacionData.vehiculos.length > 0) {
                cotizacionData.vehiculos.forEach((vehiculo, index) => {
                    html += `<h4 style="color: #fb930c; margin-bottom: 10px;">Unidad ${index + 1}</h4>`;
                    
                    if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                        vehiculo.soluciones.forEach(solucion => {
                            html += `<p style="margin: 5px 0;"><strong>• ${solucion.tipo_solucion}</strong></p>`;
                        });
                    }
                });
            }
            
            // Agregar servicios si existen
            if (cotizacionData.serviciosSugeridos && cotizacionData.serviciosSugeridos.length > 0) {
                html += '<h4 style="color: #fb930c; margin: 20px 0 10px 0;">Servicios</h4>';
                cotizacionData.serviciosSugeridos.forEach(servicio => {
                    html += `<p style="margin: 5px 0;">• ${servicio.nombre} (${servicio.periodicidad})</p>`;
                });
            }
            
            html += '</div>';
            return html;
        }
        
        async function enviarCorreoConServicio(emailData) {
            try {
                console.log('📧 Iniciando envío de correo real...');
                
                // OPCIÓN 1: EmailJS (Servicio real de correo)
                if (typeof emailjs !== 'undefined' && emailConfig.emailjsPublicKey && emailConfig.emailjsServiceId && emailConfig.emailjsTemplateId) {
                    console.log('📧 Usando EmailJS para envío real...');
                    
                    // Inicializar EmailJS con la Public Key
                    emailjs.init(emailConfig.emailjsPublicKey);
                    
                    const result = await emailjs.send(
                        emailConfig.emailjsServiceId,
                        emailConfig.emailjsTemplateId,
                        {
                            to_email: Array.isArray(emailData.to) ? emailData.to.join(',') : emailData.to,
                            cc_email: Array.isArray(emailData.cc) ? emailData.cc.join(',') : emailData.cc,
                            subject: emailData.subject,
                            html_content: emailData.html,
                            from_name: emailConfig.fromName,
                            from_email: emailConfig.fromEmail
                        }
                    );
                    console.log('📧 Correo enviado exitosamente via EmailJS:', result);
                    return { success: true, data: result };
                }
                
                // OPCIÓN 2: Fetch a tu backend personalizado
                if (emailConfig.backendUrl) {
                    console.log('📧 Usando backend personalizado...');
                    const response = await fetch(emailConfig.backendUrl + '/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (emailConfig.apiKey || '')
                        },
                        body: JSON.stringify({
                            from: `${emailConfig.fromName} <${emailConfig.fromEmail}>`,
                            to: emailData.to,
                            cc: emailData.cc,
                            subject: emailData.subject,
                            html: emailData.html,
                            smtp: {
                                server: emailConfig.smtpServer,
                                port: emailConfig.smtpPort,
                                user: emailConfig.fromEmail,
                                password: emailConfig.password
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('📧 Correo enviado exitosamente via backend:', result);
                    return { success: true, data: result };
                }
                
                // FALLBACK: Simulación si no hay servicio configurado
                console.log('⚠️ No hay servicio de correo configurado, usando simulación...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const result = {
                    messageId: 'sim-' + Date.now(),
                    timestamp: new Date().toISOString(),
                    recipients: emailData.to || [],
                    subject: emailData.subject,
                    status: 'simulated'
                };
                
                console.log('📧 Correo simulado:', result);
                return { success: true, data: result };
                
            } catch (error) {
                console.error('Error en servicio de correo:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function guardarRegistroEnvio(datosEnvio) {
            try {
                if (modoCentralizado && window.dataService) {
                    // Guardar en Supabase
                    await window.dataService.guardarRegistroCorreo(datosEnvio);
                } else {
                    // Fallback a localStorage
                    const registros = JSON.parse(localStorage.getItem('registros_correos') || '[]');
                    registros.push({
                        ...datosEnvio,
                        id: Date.now()
                    });
                    localStorage.setItem('registros_correos', JSON.stringify(registros));
                }
            } catch (error) {
                console.error('Error guardando registro de envío:', error);
                // Fallback a localStorage en caso de error
                const registros = JSON.parse(localStorage.getItem('registros_correos') || '[]');
                registros.push({
                    ...datosEnvio,
                    id: Date.now()
                });
                localStorage.setItem('registros_correos', JSON.stringify(registros));
            }
        }
        
        function formatearPrecio(precio) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(precio);
        }
        
        // NOTA: cargarConfiguracionCorreo ya está definida arriba con soporte Supabase
        
        // ===========================================
        // FUNCIONES PARA MODAL DE ENVÍO MEJORADO
        // ===========================================
        
        let cotizacionActualCorreo = null;
        
        function mostrarModalEnviarCorreo(cotizacion = null) {
            cotizacionActualCorreo = cotizacion;
            
            // Limpiar formulario
            document.getElementById('emailsPrincipales').value = '';
            document.getElementById('emailsCopia').value = '';
            document.getElementById('emailsBCC').value = '';
            document.getElementById('mensajePersonalizado').value = '';
            
            // Pre-llenar datos si hay cotización
            if (cotizacion) {
                if (cotizacion.cliente_email) {
                    document.getElementById('emailsPrincipales').value = cotizacion.cliente_email;
                }
                
                // Generar número de cotización automático
                const numero = cotizacion.folio || `COT-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`;
                document.getElementById('numeroCotizacion').value = numero;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalEnviarCorreo'));
            modal.show();
        }
        
        function procesarEmailsDestinatarios(textareaValue) {
            if (!textareaValue) return [];
            
            // Dividir por líneas y luego por comas
            const emails = textareaValue
                .split(/[\n,]/)
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));
            
            return emails;
        }
        
        function procesarEnvioCorreo() {
            const emailsPrincipales = procesarEmailsDestinatarios(document.getElementById('emailsPrincipales').value);
            const emailsCopia = procesarEmailsDestinatarios(document.getElementById('emailsCopia').value);
            const emailsBCC = procesarEmailsDestinatarios(document.getElementById('emailsBCC').value);
            
            // Validar emails principales
            if (emailsPrincipales.length === 0) {
                mostrarAlerta('Debe ingresar al menos un destinatario principal', 'warning');
                return;
            }
            
            const numeroCotizacion = document.getElementById('numeroCotizacion').value;
            const validez = document.getElementById('validezCotizacion').value;
            const mensajePersonalizado = document.getElementById('mensajePersonalizado').value;
            const tipoEnvio = document.querySelector('input[name="tipoEnvio"]:checked').value;
            const prioridad = document.getElementById('prioridadCorreo').value;
            
            if (!cotizacionActualCorreo) {
                mostrarAlerta('No hay datos de cotización para enviar', 'danger');
                return;
            }
            
            // Obtener total real de la cotización
            const total = cotizacionActualCorreo.total || 0;
            
            // Preparar datos para envío
            const datosCorreo = {
                cliente: {
                    empresa: cotizacionActualCorreo.cliente_nombre || 'N/A',
                    contacto: cotizacionActualCorreo.cliente_nombre || 'N/A',
                    email: emailsPrincipales[0],
                    telefono: cotizacionActualCorreo.telefono || 'N/A'
                },
                numero: numeroCotizacion,
                validez: validez,
                total: total,
                cotizacionData: {
                    id: cotizacionActualCorreo.id,
                    folio: cotizacionActualCorreo.folio,
                    vehiculos: cotizacionActualCorreo.vehiculos || [],
                    serviciosSugeridos: cotizacionActualCorreo.servicios || [],
                    cliente_nombre: cotizacionActualCorreo.cliente_nombre,
                    estado: cotizacionActualCorreo.estado
                },
                emails: {
                    principales: emailsPrincipales,
                    copia: emailsCopia,
                    bcc: emailsBCC
                },
                mensajePersonalizado: mensajePersonalizado,
                tipoEnvio: tipoEnvio,
                prioridad: prioridad
            };
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEnviarCorreo'));
            modal.hide();
            
            // Enviar correo
            enviarCorreoCotizacion(datosCorreo);
        }
        
        function previsualizarCorreo() {
            const emailsPrincipales = procesarEmailsDestinatarios(document.getElementById('emailsPrincipales').value);
            const tipoEnvio = document.querySelector('input[name="tipoEnvio"]:checked').value;
            const numeroCotizacion = document.getElementById('numeroCotizacion').value;
            const mensajePersonalizado = document.getElementById('mensajePersonalizado').value;
            
            if (emailsPrincipales.length === 0) {
                mostrarAlerta('Ingresa al menos un destinatario para ver la vista previa', 'warning');
                return;
            }
            
            // Preparar datos de ejemplo para vista previa
            const datosEjemplo = {
                numero: numeroCotizacion || 'COT-2024-001',
                empresa: cotizacionActualCorreo?.cliente_nombre || 'Empresa Ejemplo SA',
                contacto: cotizacionActualCorreo?.cliente_nombre || 'Juan Pérez',
                email: emailsPrincipales[0],
                telefono: '555-1234',
                fecha: new Date().toLocaleDateString('es-ES'),
                validez: document.getElementById('validezCotizacion').value,
                unidades: '2',
                total: '$150,000.00',
                equipos_servicios: '<p><strong>• Rastreo Avanzado</strong></p><p><strong>• VPC</strong></p>',
                mensaje_personalizado: mensajePersonalizado ? 
                    `<div style="background: #fff3cd; border: 1px solid #ffecb5; border-radius: 5px; padding: 15px; margin: 20px 0;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">Mensaje Personalizado</h4>
                        <p style="margin: 0; color: #856404;">${mensajePersonalizado}</p>
                    </div>` : '',
                fecha_envio: new Date().toLocaleDateString('es-ES')
            };
            
            // Obtener plantilla según tipo de envío
            const plantilla = emailTemplates[tipoEnvio];
            
            // Reemplazar variables en el contenido
            let contenidoPrevia = plantilla.html;
            let asuntoPrevia = plantilla.subject;
            
            Object.keys(datosEjemplo).forEach(key => {
                const regex = new RegExp(`{${key}}`, 'g');
                contenidoPrevia = contenidoPrevia.replace(regex, datosEjemplo[key]);
                asuntoPrevia = asuntoPrevia.replace(regex, datosEjemplo[key]);
            });
            
            // Llenar vista previa
            document.getElementById('previaDestinatarios').textContent = emailsPrincipales.join(', ');
            document.getElementById('previaAsunto').textContent = asuntoPrevia;
            document.getElementById('previaTipo').textContent = tipoEnvio === 'cotizacion' ? 'Cotización Nueva' : 'Seguimiento';
            document.getElementById('previaContenido').innerHTML = contenidoPrevia;
            
            // Mostrar modal de vista previa
            const modalPrevia = new bootstrap.Modal(document.getElementById('modalPreviaCorreo'));
            modalPrevia.show();
        }
        
        function cerrarPreviaYEnviar() {
            // Cerrar modal de vista previa
            const modalPrevia = bootstrap.Modal.getInstance(document.getElementById('modalPreviaCorreo'));
            modalPrevia.hide();
            
            // Enviar correo directamente
            setTimeout(() => {
                procesarEnvioCorreo();
            }, 300);
        }
        
        // Función para abrir modal desde la tabla (se conectará con el botón en la tabla)
        function enviarCorreoCotizacionDesdeTabla(cotizacionId) {
            // Buscar la cotización en la lista
            const cotizacion = cotizaciones.find(c => String(c.id || c.folio) === String(cotizacionId));
            
            if (!cotizacion) {
                mostrarAlerta('Cotización no encontrada', 'danger');
                return;
            }
            
            mostrarModalEnviarCorreo(cotizacion);
        }
        

        // Inicializar configuración de correo
        document.addEventListener('DOMContentLoaded', async function() {
            await cargarConfiguracionCorreo();
            await cargarPlantillasPersonalizadas();
            await cargarDiasSeguimiento();
            
            // Listener para cuando se abra la pestaña de configuración de correo
            const configCorreoTab = document.getElementById('config-correo-tab');
            if (configCorreoTab) {
                configCorreoTab.addEventListener('click', async function() {
                    // Pequeño delay para asegurar que el tab esté completamente cargado
                    setTimeout(async () => {
                        await cargarConfiguracionCorreo();
                    }, 100);
                });
            }
        });
    </script>

    <!-- Modal Envío de Correo Mejorado -->
    <div class="modal fade" id="modalEnviarCorreo" tabindex="-1" aria-labelledby="modalEnviarCorreoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalEnviarCorreoLabel">
                        <i class="bi bi-envelope-paper me-2"></i>
                        Enviar Cotización por Correo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEnviarCorreo">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-people me-2"></i>
                                            Destinatarios
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Destinatarios Principales *</label>
                                            <textarea class="form-control" id="emailsPrincipales" rows="3" 
                                                placeholder="cliente@empresa.com&#10;ventas@empresa.com&#10;Uno por línea o separados por comas"></textarea>
                                            <div class="form-text">Ingresa uno por línea o separados por comas</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Copias (CC)</label>
                                            <textarea class="form-control" id="emailsCopia" rows="2" 
                                                placeholder="supervisor@empresa.com&#10;manager@empresa.com"></textarea>
                                            <div class="form-text">Opcional: Copias del correo</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Copias Ocultas (BCC)</label>
                                            <textarea class="form-control" id="emailsBCC" rows="2" 
                                                placeholder="admin@empresa.com"></textarea>
                                            <div class="form-text">Opcional: Copias ocultas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Detalles de la Cotización
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Número de Cotización</label>
                                                <input type="text" class="form-control" id="numeroCotizacion" placeholder="COT-001">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Validez de la Cotización</label>
                                                <select class="form-select" id="validezCotizacion">
                                                    <option value="15 días">15 días</option>
                                                    <option value="30 días" selected>30 días</option>
                                                    <option value="45 días">45 días</option>
                                                    <option value="60 días">60 días</option>
                                                    <option value="90 días">90 días</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Tipo de Envío</label>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="tipoEnvio" id="envioCotizacion" value="cotizacion" checked>
                                                        <label class="form-check-label" for="envioCotizacion">
                                                            <strong>Cotización Nueva</strong><br>
                                                            <small class="text-muted">Enviar cotización completa</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="tipoEnvio" id="envioSeguimiento" value="seguimiento">
                                                        <label class="form-check-label" for="envioSeguimiento">
                                                            <strong>Seguimiento</strong><br>
                                                            <small class="text-muted">Recordatorio de cotización</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Prioridad</label>
                                            <select class="form-select" id="prioridadCorreo">
                                                <option value="normal" selected>Normal</option>
                                                <option value="alta">Alta</option>
                                                <option value="baja">Baja</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-chat-square-text me-2"></i>
                                    Mensaje Personalizado
                                </h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="mensajePersonalizado" rows="4" 
                                    placeholder="Mensaje adicional que aparecerá en el correo (opcional)..."></textarea>
                                <div class="form-text">Este mensaje aparecerá como una sección destacada en el correo</div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Antes de enviar:</strong> Asegúrate de que los datos del cliente estén completos y de haber configurado el servidor de correo en la pestaña correspondiente.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning me-2" onclick="previsualizarCorreo()">
                        <i class="bi bi-eye me-1"></i>Vista Previa
                    </button>
                    <button type="button" class="btn btn-primary" onclick="procesarEnvioCorreo()">
                        <i class="bi bi-send me-1"></i>Enviar Correo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Vista Previa del Correo -->
    <div class="modal fade" id="modalPreviaCorreo" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>
                        Vista Previa del Correo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Información del Envío</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Para:</strong>
                                    <div id="previaDestinatarios" class="text-muted"></div>
                                </div>
                                <div class="col-md-4">
                                    <strong>Asunto:</strong>
                                    <div id="previaAsunto" class="text-muted"></div>
                                </div>
                                <div class="col-md-4">
                                    <strong>Tipo:</strong>
                                    <div id="previaTipo" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Contenido del Correo</h6>
                        </div>
                        <div class="card-body">
                            <div id="previaContenido" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                                <!-- Contenido del correo se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar Vista Previa</button>
                    <button type="button" class="btn btn-primary" onclick="cerrarPreviaYEnviar()">
                        <i class="bi bi-send me-1"></i>Enviar Correo
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>