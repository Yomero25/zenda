<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Eliminaci√≥n Soporte</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test de Eliminaci√≥n de Notificaciones de Soporte</h1>
    <button onclick="testEliminacion()">Probar Eliminaci√≥n</button>
    <div id="resultado"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://lsmhcpsvjcbduqovbatj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzbWhjcHN2amNiZHVxb3ZiYXRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTM4MzgsImV4cCI6MjA3MjU4OTgzOH0.I7dEer-R2ZaiMvU-Hmve6Ms0wk82U1e7C67e8fYWIEw';
        
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testEliminacion() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '<p>üîÑ Probando eliminaci√≥n...</p>';

            try {
                // 1. Verificar si la tabla existe
                console.log('üîç Verificando tabla notificaciones_soporte...');
                const { data: tableCheck, error: tableError } = await client
                    .from('notificaciones_soporte')
                    .select('count')
                    .limit(1);
                
                if (tableError) {
                    resultado.innerHTML = `<p>‚ùå Error: La tabla notificaciones_soporte no existe o no es accesible: ${tableError.message}</p>`;
                    return;
                }

                // 2. Crear una notificaci√≥n de prueba
                console.log('üìù Creando notificaci√≥n de prueba...');
                const notificacionPrueba = {
                    cotizacionId: 'TEST-ELIMINACION-123',
                    solicitudDespachoId: 'TEST-DESPACHO-456',
                    cliente: 'Cliente Prueba',
                    solucion: 'Rastreo avanzado',
                    estado: 'pendiente',
                    fechaCreacion: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await client
                    .from('notificaciones_soporte')
                    .insert([{ data: notificacionPrueba }])
                    .select();

                if (insertError) {
                    resultado.innerHTML = `<p>‚ùå Error al crear notificaci√≥n de prueba: ${insertError.message}</p>`;
                    return;
                }

                const notificacionId = insertData[0].id;
                resultado.innerHTML += `<p>‚úÖ Notificaci√≥n de prueba creada con ID: ${notificacionId}</p>`;

                // 3. Verificar que existe
                console.log('üîç Verificando que la notificaci√≥n existe...');
                const { data: checkData, error: checkError } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .eq('id', notificacionId);

                if (checkError || !checkData || checkData.length === 0) {
                    resultado.innerHTML += `<p>‚ùå Error: No se pudo verificar la notificaci√≥n creada</p>`;
                    return;
                }

                resultado.innerHTML += `<p>‚úÖ Notificaci√≥n verificada: ${JSON.stringify(checkData[0].data)}</p>`;

                // 4. Probar eliminaci√≥n por cotizacionId
                console.log('üóëÔ∏è Probando eliminaci√≥n por cotizacionId...');
                const { data: deleteData1, error: deleteError1 } = await client
                    .from('notificaciones_soporte')
                    .delete()
                    .eq('data->>cotizacionId', 'TEST-ELIMINACION-123')
                    .select();

                if (deleteError1) {
                    resultado.innerHTML += `<p>‚ùå Error al eliminar por cotizacionId: ${deleteError1.message}</p>`;
                } else {
                    resultado.innerHTML += `<p>‚úÖ Eliminaci√≥n por cotizacionId exitosa: ${deleteData1.length} registros eliminados</p>`;
                }

                // 5. Verificar que se elimin√≥
                console.log('üîç Verificando que se elimin√≥...');
                const { data: finalCheck, error: finalError } = await client
                    .from('notificaciones_soporte')
                    .select('*')
                    .eq('id', notificacionId);

                if (finalError) {
                    resultado.innerHTML += `<p>‚ùå Error al verificar eliminaci√≥n: ${finalError.message}</p>`;
                } else if (!finalCheck || finalCheck.length === 0) {
                    resultado.innerHTML += `<p>‚úÖ Verificaci√≥n exitosa: La notificaci√≥n fue eliminada correctamente</p>`;
                } else {
                    resultado.innerHTML += `<p>‚ùå Error: La notificaci√≥n a√∫n existe despu√©s de la eliminaci√≥n</p>`;
                }

            } catch (error) {
                console.error('‚ùå Error general:', error);
                resultado.innerHTML = `<p>‚ùå Error general: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
