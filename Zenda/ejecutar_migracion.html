<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejecutar Migraci√≥n - Tablas Separadas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); min-height: 100vh; }
        .container { padding-top: 50px; }
        .card { border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn { border-radius: 10px; padding: 12px 24px; font-weight: bold; }
        .log-container { 
            background: #1e1e1e; 
            color: #00ff00; 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            border-radius: 10px; 
            max-height: 400px; 
            overflow-y: auto; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white text-center">
                        <h2>üîÑ Migraci√≥n a Tablas Separadas</h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>‚ÑπÔ∏è ¬øQu√© hace esta migraci√≥n?</h5>
                            <ul class="mb-0">
                                <li>Migra todos los tipos de veh√≠culos, soluciones e insumos de localStorage a las nuevas tablas de Supabase</li>
                                <li>Los datos se guardar√°n permanentemente en la base de datos</li>
                                <li>Podr√°s eliminar tipos directamente desde Supabase Dashboard</li>
                                <li>Los cambios persistir√°n al refrescar la p√°gina</li>
                            </ul>
                        </div>
                        
                        <div class="text-center mb-4">
                            <button id="btnVerificar" class="btn btn-warning btn-lg me-2">
                                üîç Verificar Conexi√≥n
                            </button>
                            <button id="btnMigrar" class="btn btn-success btn-lg me-2">
                                üöÄ Ejecutar Migraci√≥n
                            </button>
                            <button id="btnProbar" class="btn btn-info btn-lg">
                                üß™ Probar Tablas
                            </button>
                        </div>
                        
                        <div id="logContainer" class="log-container" style="display: none;">
                            <div id="logContent">Esperando ejecuci√≥n...</div>
                        </div>
                        
                        <div id="resultado" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="dataService.js" onload="console.log('‚úÖ dataService.js cargado')" onerror="console.error('‚ùå Error cargando dataService.js')"></script>
    
    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('logContent').textContent = logContent;
            document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
        }
        
        function mostrarResultado(mensaje, tipo = 'info') {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `<div class="alert alert-${tipo}">${mensaje}</div>`;
        }
        
        // Funci√≥n para verificar conexi√≥n
        async function verificarConexion() {
            log('üîç Verificando conexi√≥n...');
            
            try {
                // Verificar que dataService est√© disponible
                if (!window.dataService) {
                    log('‚ùå dataService no est√° definido');
                    mostrarResultado('Error: dataService no est√° definido. Verifica que dataService.js se carg√≥ correctamente.', 'danger');
                    return false;
                }
                
                if (!window.dataService.client) {
                    log('‚ùå dataService.client no est√° disponible');
                    mostrarResultado('Error: dataService.client no est√° disponible. Verifica la conexi√≥n a Supabase.', 'danger');
                    return false;
                }
                
                // Probar una consulta simple
                log('üì° Probando conexi√≥n a Supabase...');
                const testResult = await window.dataService.client.from('tipos_unidad').select('count').limit(1);
                log('‚úÖ Conexi√≥n a Supabase exitosa');
                
                // Verificar funciones espec√≠ficas
                if (typeof window.dataService.fetchTiposUnidad !== 'function') {
                    log('‚ùå fetchTiposUnidad no est√° disponible');
                    mostrarResultado('Error: fetchTiposUnidad no est√° disponible', 'danger');
                    return false;
                }
                
                if (typeof window.dataService.upsertTipoUnidad !== 'function') {
                    log('‚ùå upsertTipoUnidad no est√° disponible');
                    mostrarResultado('Error: upsertTipoUnidad no est√° disponible', 'danger');
                    return false;
                }
                
                log('‚úÖ Todas las funciones est√°n disponibles');
                mostrarResultado('‚úÖ Conexi√≥n verificada correctamente. Puedes proceder con la migraci√≥n.', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Error verificando conexi√≥n: ${error.message}`);
                mostrarResultado('‚ùå Error verificando conexi√≥n: ' + error.message, 'danger');
                return false;
            }
        }

        // Funci√≥n de migraci√≥n
        async function migrarATablasSeparadas() {
            log('üöÄ Iniciando migraci√≥n a tablas separadas...');
            
            try {
                // Verificar que dataService est√© disponible
                if (!window.dataService || !window.dataService.client) {
                    log('‚ùå dataService no est√° disponible');
                    mostrarResultado('Error: dataService no est√° disponible. Usa "Verificar Conexi√≥n" primero.', 'danger');
                    return false;
                }
                
                // 1. Obtener tipos existentes de localStorage
                const tiposGlobales = JSON.parse(localStorage.getItem('tipos_globales') || '{"vehiculos":[],"soluciones":[],"insumos":[]}');
                
                log('üìã Tipos encontrados en localStorage:');
                log(`- Veh√≠culos: ${tiposGlobales.vehiculos?.length || 0}`);
                log(`- Soluciones: ${tiposGlobales.soluciones?.length || 0}`);
                log(`- Insumos: ${tiposGlobales.insumos?.length || 0}`);
                
                // 2. Migrar tipos de veh√≠culo
                log('üöó Migrando tipos de veh√≠culo...');
                for (const vehiculo of tiposGlobales.vehiculos || []) {
                    if (vehiculo && vehiculo.trim()) {
                        await window.dataService.upsertTipoUnidad(vehiculo.trim(), `Tipo de veh√≠culo: ${vehiculo}`);
                        log(`‚úÖ Veh√≠culo migrado: ${vehiculo}`);
                    }
                }
                
                // 3. Migrar tipos de soluci√≥n
                log('üîß Migrando tipos de soluci√≥n...');
                for (const solucion of tiposGlobales.soluciones || []) {
                    if (solucion && solucion.trim()) {
                        await window.dataService.upsertTipoSolucion(solucion.trim(), `Tipo de soluci√≥n: ${solucion}`, 'General');
                        log(`‚úÖ Soluci√≥n migrada: ${solucion}`);
                    }
                }
                
                // 4. Migrar tipos de insumo
                log('üì¶ Migrando tipos de insumo...');
                for (const insumo of tiposGlobales.insumos || []) {
                    if (insumo && insumo.trim()) {
                        await window.dataService.upsertTipoInsumo(insumo.trim(), `Tipo de insumo: ${insumo}`, 'General', 'piezas');
                        log(`‚úÖ Insumo migrado: ${insumo}`);
                    }
                }
                
                // 5. Verificar migraci√≥n
                log('üîç Verificando migraci√≥n...');
                const vehiculosMigrados = await window.dataService.fetchTiposUnidad();
                const solucionesMigradas = await window.dataService.fetchTiposSolucion();
                const insumosMigrados = await window.dataService.fetchTiposInsumo();
                
                log(`‚úÖ Veh√≠culos migrados: ${vehiculosMigrados.length}`);
                log(`‚úÖ Soluciones migradas: ${solucionesMigradas.length}`);
                log(`‚úÖ Insumos migrados: ${insumosMigrados.length}`);
                
                // 6. Limpiar localStorage (opcional)
                const limpiar = confirm('¬øDeseas limpiar los tipos_globales de localStorage? (Recomendado despu√©s de la migraci√≥n)');
                if (limpiar) {
                    localStorage.removeItem('tipos_globales');
                    log('üßπ localStorage limpiado');
                }
                
                log('‚úÖ Migraci√≥n completada exitosamente');
                mostrarResultado('‚úÖ Migraci√≥n completada exitosamente. Ahora puedes usar el m√≥dulo de administrar almac√©n con las nuevas tablas.', 'success');
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error durante la migraci√≥n: ${error.message}`);
                mostrarResultado('‚ùå Error durante la migraci√≥n: ' + error.message, 'danger');
                return false;
            }
        }

        // Funci√≥n para probar las nuevas tablas
        async function probarTablasSeparadas() {
            log('üß™ Probando tablas separadas...');
            
            try {
                // Probar fetch de cada tabla
                const vehiculos = await window.dataService.fetchTiposUnidad();
                const soluciones = await window.dataService.fetchTiposSolucion();
                const insumos = await window.dataService.fetchTiposInsumo();
                
                log('üìä Resultados:');
                log(`- Veh√≠culos: ${vehiculos.length} registros`);
                log(`- Soluciones: ${soluciones.length} registros`);
                log(`- Insumos: ${insumos.length} registros`);
                
                // Mostrar algunos ejemplos
                if (vehiculos.length > 0) {
                    log(`üöó Ejemplo de veh√≠culo: ${JSON.stringify(vehiculos[0])}`);
                }
                if (soluciones.length > 0) {
                    log(`üîß Ejemplo de soluci√≥n: ${JSON.stringify(soluciones[0])}`);
                }
                if (insumos.length > 0) {
                    log(`üì¶ Ejemplo de insumo: ${JSON.stringify(insumos[0])}`);
                }
                
                mostrarResultado(`‚úÖ Prueba completada: ${vehiculos.length} veh√≠culos, ${soluciones.length} soluciones, ${insumos.length} insumos`, 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Error probando tablas: ${error.message}`);
                mostrarResultado('‚ùå Error probando tablas: ' + error.message, 'danger');
                return false;
            }
        }
        
        // Event listeners
        document.getElementById('btnVerificar').addEventListener('click', async function() {
            document.getElementById('logContainer').style.display = 'block';
            logContent = '';
            this.disabled = true;
            this.innerHTML = '‚è≥ Verificando...';
            
            const resultado = await verificarConexion();
            
            this.disabled = false;
            this.innerHTML = 'üîç Verificar Conexi√≥n';
        });
        
        document.getElementById('btnMigrar').addEventListener('click', async function() {
            document.getElementById('logContainer').style.display = 'block';
            logContent = '';
            this.disabled = true;
            this.innerHTML = '‚è≥ Migrando...';
            
            const resultado = await migrarATablasSeparadas();
            
            this.disabled = false;
            this.innerHTML = 'üöÄ Ejecutar Migraci√≥n';
        });
        
        document.getElementById('btnProbar').addEventListener('click', async function() {
            document.getElementById('logContainer').style.display = 'block';
            logContent = '';
            this.disabled = true;
            this.innerHTML = '‚è≥ Probando...';
            
            const resultado = await probarTablasSeparadas();
            
            this.disabled = false;
            this.innerHTML = 'üß™ Probar Tablas';
        });
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß P√°gina de migraci√≥n cargada');
            log('üí° Haz clic en "Ejecutar Migraci√≥n" para comenzar');
        });
    </script>
</body>
</html>
