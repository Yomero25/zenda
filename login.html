<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      var s=document.createElement('script');
      s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }
  window.ensureDataService = async function(){
    if (window.dataService) return true;
    // candidatos según desde dónde se abra el login
    const candidates = [
      'sistema-trazabilidad-new/dataService.js',   // si login está en Distribucion/
      './dataService.js',                          // si login está en sistema-trazabilidad-new/
      '../sistema-trazabilidad-new/dataService.js' // si hay otra estructura
    ];
    for (const path of candidates){
      try {
        await loadScript(path);
        if (window.dataService) return true;
      } catch(_) {}
    }
    return false;
  }
})();
</script>
<script>
(function(){
  function loadScript(src, onload, onerror){
    var s=document.createElement('script'); s.src=src; s.onload=onload; s.onerror=onerror||function(){}; document.head.appendChild(s);
  }
  // Fallback si el archivo anterior no existe por la ruta
  if (!window.dataService){
    // Si estamos dentro de sistema-trazabilidad-new/login.html, la ruta válida es './dataService.js'
    loadScript('./sistema-trazabilidad-new/dataService.js', function(){}, function(){
      loadScript('./dataService.js');
    });
  }
  window.__ensureDataService = function(cb){
    if (window.dataService) return cb();
    var tries = 0;
    var t = setInterval(function(){
      tries++;
      if (window.dataService || tries > 20){
        clearInterval(t); cb();
      }
    }, 100);
  };
})();
</script>
</head>
<body class="bg-light d-flex align-items-center" style="min-height:100vh;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-box-arrow-in-right me-2"></i>Acceso</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="email" class="form-control" placeholder="tu@correo.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              <input type="password" id="password" class="form-control" placeholder="••••••••">
            </div>
            <div class="d-grid">
              <button id="btnLogin" class="btn btn-primary"><i class="bi bi-unlock me-1"></i> Entrar</button>
            </div>
            <div id="msg" class="mt-3 small text-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
(async function(){
  const btn = document.getElementById('btnLogin');
  const msg = document.getElementById('msg');
  btn.addEventListener('click', async () => {
    msg.textContent = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Entrando…';
    try {
      const ok = await window.ensureDataService();
      if (!ok || !window.dataService) throw new Error('No se pudo cargar dataService');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) throw new Error('Ingresa email y contraseña');
      await window.dataService.authSignIn(email, password);
      const rol = await window.dataService.getUserRole();
      // Redirección según rol
      switch(rol){
        case 'admin':
        case 'ventas':
          window.location.href = 'cotizaciones-completo.html'; break;
        case 'despacho':
          window.location.href = 'sistema-trazabilidad-new/modulo-despacho.html'; break;
        case 'instalaciones':
          window.location.href = 'sistema-trazabilidad-new/instalaciones_modulo.html'; break;
        case 'almacen':
          window.location.href = 'sistema-trazabilidad-new/administrar-almacen.html'; break;
        case 'precios':
          window.location.href = 'sistema-trazabilidad-new/administrar-precios.html'; break;
        default:
          window.location.href = 'cotizaciones-completo.html';
      }
    } catch(e){
      msg.textContent = e.message || 'Error de acceso';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-unlock me-1"></i> Entrar';
    }
  });
})();
</script>
</body>
</html>
