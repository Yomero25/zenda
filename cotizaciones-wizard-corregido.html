<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones - Wizard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .wizard-header {
            background: linear-gradient(135deg, #fb930c, #e67e22);
            color: white;
            padding: 2rem 0;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: #fb930c;
            color: white;
        }
        
        .step.completed .step-number {
            background-color: #f39c12;
            color: white;
        }
        
        .step.inactive .step-number {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        
        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .solution-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .solution-card:hover {
            border-color: #fb930c;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .solution-card.selected {
            border-color: #fb930c;
            background-color: #eff6ff;
        }
        
        .unidad-vehiculo-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        
        .config-section {
            display: none;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
            background-color: white;
        }
        
        .config-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .progress-bar-custom {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #fb930c, #e67e22);
            transition: width 0.3s ease;
        }
        
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f39c12;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .auto-save-indicator.show {
            opacity: 1;
        }
        
        .resumen-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: white;
        }
    </style>
</head>
<body>
    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        <i class="bi bi-check-circle me-1"></i>
        Progreso guardado autom√°ticamente
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #fb930c, #e67e22);">
        <div class="container">
            <div class="d-flex align-items-center">
                <img src="./LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="40" class="me-3">
                <a class="navbar-brand" href="cotizaciones-completo.html">
                    <i class="bi bi-arrow-left me-2"></i>
                    Sistema de Cotizaciones
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="wizard-container">
            <div class="card">
                <div class="wizard-header">
                    <div class="container">
                        <h2 class="text-center mb-0">
                            <i class="bi bi-plus-circle me-2"></i>
                            Nueva Cotizaci√≥n - Wizard
                        </h2>
                        <p class="text-center mb-0 opacity-75">Completa la informaci√≥n paso a paso</p>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Progress Bar -->
                    <div class="px-4 py-3 bg-light">
                        <div class="progress-bar-custom">
                            <div id="progressFill" class="progress-fill" style="width: 16.67%;"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">Paso <span id="currentStep">1</span> de 4</small>
                    </div>

                    <!-- Step Indicator -->
                    <div class="step-indicator py-4">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <span>Cliente</span>
                        </div>
                        <div class="step inactive" data-step="2">
                            <div class="step-number">2</div>
                            <span>Unidades</span>
                        </div>
                        <div class="step inactive" data-step="3">
                            <div class="step-number">3</div>
                            <span>Insumos</span>
                        </div>
                        <div class="step inactive" data-step="4">
                            <div class="step-number">4</div>
                            <span>Resumen</span>
                        </div>
                    </div>

                    <!-- Step Contents -->
                    <div class="px-4 pb-4">
                        <!-- Paso 1: Informaci√≥n del Cliente -->
                        <div id="step1" class="step-content active">
                            <h4 class="mb-4">
                                <i class="bi bi-person-badge me-2" style="color: #fb930c;"></i>
                                Informaci√≥n del Cliente
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="cliente_nombre">Cliente *</label>
                                        <input type="text" class="form-control" id="cliente_nombre" placeholder="Nombre del cliente" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="cliente_empresa">Empresa</label>
                                        <input type="text" class="form-control" id="cliente_empresa" placeholder="Nombre de la empresa">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="tipo_cliente">Tipo de Cliente</label>
                                        <select class="form-select" id="tipo_cliente" onchange="actualizarDescuento()">
                                            <option value="">Seleccionar tipo</option>
                                            <option value="Cliente corporativo A">Cliente corporativo A (30% desc.)</option>
                                            <option value="Cliente corporativo B">Cliente corporativo B (20% desc.)</option>
                                            <option value="Cliente corporativo C">Cliente corporativo C (10% desc.)</option>
                                            <option value="Cliente final A">Cliente final A (10% desc.)</option>
                                            <option value="Cliente final B">Cliente final B (5% desc.)</option>
                                            <option value="Cliente final C">Cliente final C (0% desc.)</option>
                                            <option value="Distribuidor A">Distribuidor A (25% desc.)</option>
                                            <option value="Distribuidor B">Distribuidor B (20% desc.)</option>
                                            <option value="Distribuidor C">Distribuidor C (15% desc.)</option>
                                            <option value="Integrador A">Integrador A (25% desc.)</option>
                                            <option value="Integrador B">Integrador B (20% desc.)</option>
                                            <option value="Integrador C">Integrador C (15% desc.)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="descuento">Descuento (%)</label>
                                        <input type="number" class="form-control" id="descuento" min="0" max="100" readonly>
                                        <div class="form-text">Descuento autom√°tico seg√∫n tipo de cliente</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="fecha_vencimiento">Fecha Vencimiento</label>
                                        <input type="date" class="form-control" id="fecha_vencimiento">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="urgente">Prioridad Interna</label>
                                        <select class="form-control" id="urgente">
                                            <option value="baja">Prioridad Normal</option>
                                            <option value="media">Prioridad Media</option>
                                            <option value="alta">Prioridad Alta - Urgente</option>
                                        </select>
                                        <div class="form-text text-warning">
                                            <i class="bi bi-info-circle"></i> Solo para uso interno - No visible en cotizaci√≥n impresa
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="dias_seguimiento">D√≠as de Seguimiento</label>
                                        <select class="form-select" id="dias_seguimiento">
                                            <option value="">Seleccionar d√≠as (opcional)</option>
                                            <option value="1">1 d√≠a</option>
                                            <option value="2">2 d√≠as</option>
                                            <option value="3">3 d√≠as</option>
                                            <option value="4">4 d√≠as</option>
                                            <option value="5">5 d√≠as</option>
                                            <option value="6">6 d√≠as</option>
                                            <option value="7" selected>7 d√≠as (por defecto)</option>
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> D√≠as despu√©s de enviar la cotizaci√≥n para dar seguimiento
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" for="observaciones">Observaciones</label>
                                        <textarea class="form-control" id="observaciones" rows="3" placeholder="Observaciones adicionales"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paso 2: Informaci√≥n del Veh√≠culo -->
                        <div id="step2" class="step-content">
                            <h4 class="mb-4">
                                <i class="bi bi-truck me-2" style="color: #fb930c;"></i>
                                Informaci√≥n del Veh√≠culo
                            </h4>
                            
                            <!-- Campo para cotizaci√≥n en lote -->
                            <div class="card mb-4 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-stack me-2"></i>Cotizaci√≥n en Lote (Opcional)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label" for="cantidadUnidadesLote">Cantidad de Unidades Id√©nticas</label>
                                            <input type="number" class="form-control" id="cantidadUnidadesLote" min="1" max="1000" placeholder="Ej: 10, 20, 50">
                                            <div class="form-text">Deja vac√≠o para cotizaci√≥n individual</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label" for="tipoVenta">Tipo de Venta</label>
                                            <select class="form-select" id="tipoVenta">
                                                <option value="instalacion">Instalaci√≥n por nuestro personal</option>
                                                <option value="venta">Solo venta de equipos</option>
                                            </select>
                                            <div class="form-text">Determina qu√© insumos se incluyen</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Descripci√≥n</label>
                                            <p class="text-muted mb-0">Si especificas una cantidad, se aplicar√° a la primera unidad configurada. Ideal para flotas con equipos id√©nticos.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">Unidades a Cotizar</h5>
                                        <button type="button" class="btn btn-sm" style="border-color: #fb930c; color: #fb930c;" onclick="agregarUnidadVehiculo()">
                                            <i class="bi bi-plus me-1"></i>Agregar Unidad
                                        </button>
                                    </div>
                                    <div id="unidadesVehiculoContainer">
                                        <!-- Unidades din√°micas -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paso 3: Insumos y Servicios -->
                        <div id="step3" class="step-content">
                            <h4 class="mb-4">
                                <i class="bi bi-box me-2" style="color: #fb930c;"></i>
                                Insumos y Servicios
                            </h4>
                            
                            <!-- Insumos Sugeridos Autom√°ticamente -->
                            <div class="alert alert-info mb-4">
                                <h5 class="alert-heading">
                                    <i class="bi bi-lightbulb me-2"></i>Insumos Sugeridos Autom√°ticamente
                                </h5>
                                <p class="mb-2">Basado en los tipos de unidad y soluciones seleccionadas, se sugieren los siguientes insumos para despacho e instalaci√≥n:</p>
                                <div id="insumosSugeridosContainer">
                                    <!-- Se llena autom√°ticamente -->
                                </div>
                                <button type="button" class="btn btn-sm mt-2 me-2" style="border-color: #fb930c; color: #fb930c;" onclick="generarInsumosSugeridos()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Sugerencias
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="mostrarDebugCalculos()">
                                    <i class="bi bi-bug me-1"></i>Debug C√°lculos
                                </button>

                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>
                                        <i class="bi bi-plus-circle me-2 text-success"></i>Insumos Adicionales
                                    </h5>
                                    <p class="text-muted small">Agrega insumos adicionales si son necesarios:</p>
                                    
                                    <div class="mb-3">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label class="form-label visually-hidden" for="selectInsumoAdicional">Seleccionar insumo adicional</label>
                                                <select class="form-select" id="selectInsumoAdicional">
                                                    <option value="">Seleccionar insumo adicional...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label visually-hidden" for="cantidadInsumoAdicional">Cantidad del insumo adicional</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="cantidadInsumoAdicional" 
                                                           placeholder="Cant." min="1" step="0.1">
                                                    <button class="btn btn-success" type="button" onclick="agregarInsumoAdicional()">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="insumosAdicionalesContainer">
                                        <!-- Lista de insumos adicionales agregados -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Servicios</h5>
                                    <div id="serviciosContainer">
                                        <!-- Servicios din√°micos -->
                                    </div>
                                    
                                    <h5 class="mt-4">Accesorios</h5>
                                    <div id="accesoriosContainer">
                                        <!-- Accesorios din√°micos -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paso 4: Resumen -->
                        <div id="step4" class="step-content">
                            <h4 class="mb-4">
                                <i class="bi bi-check-circle me-2" style="color: #fb930c;"></i>
                                Resumen de la Cotizaci√≥n
                            </h4>
                            
                            <div id="resumenContainer">
                                <!-- Resumen din√°mico -->
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" disabled>
                                <i class="bi bi-arrow-left me-1"></i>Anterior
                            </button>
                            
                            <div>
                                <button type="button" class="btn me-2" style="border-color: #fb930c; color: #fb930c;" onclick="guardarBorrador()">
                                    <i class="bi bi-save me-1"></i>Guardar Borrador
                                </button>
                                <button type="button" class="btn" id="nextBtn" style="background-color: #fb930c; border-color: #fb930c; color: white;" onclick="nextStep()">
                                    Siguiente<i class="bi bi-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./dataService.js"></script>
    <script>
        // Variables globales
        const modoCentralizado = (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase());
        let currentStepNumber = 1;
        let cotizacionData = {};
        let selectedSolutions = [];
        let unidadVehiculoCounter = 1;
        let preciosCache = null;
        let funcionesRastreo = [];

        async function cargarPreciosCache() {
            try {
                if (modoCentralizado) {
                    const lista = await window.dataService.fetchPreciosElementos();
                    preciosCache = {};
                    (lista || []).forEach((it) => {
                        const nombre = it.nombre || it.elemento;
                        if (!nombre) return;
                        preciosCache[nombre] = {
                            precio: Number(it.precio || 0),
                            categoria: it.categoria || 'insumos',
                            ultimaActualizacion: it.ultimaActualizacion || it.ultima_actualizacion
                        };
                    });
                } else {
                    const p = JSON.parse(localStorage.getItem('precios_elementos') || '{}');
                    if (Object.keys(p).length === 0) {
                        inicializarPreciosSiNoExisten();
                    }
                    preciosCache = JSON.parse(localStorage.getItem('precios_elementos') || '{}');
                }
            } catch (e) {
                console.warn('No se pudieron cargar precios; usando localStorage si existe', e);
                preciosCache = JSON.parse(localStorage.getItem('precios_elementos') || '{}');
            }
        }

        // Funciones cr√≠ticas (definidas temprano para evitar errores de referencia)
        function nextStep() {
            if (validarPasoActual()) {
                guardarPasoActual();
                currentStepNumber++;
                if (currentStepNumber === 4) {
                    generarResumen();
                }
                mostrarPaso(currentStepNumber);
                actualizarProgreso();
            }
        }

        function previousStep() {
            currentStepNumber--;
            mostrarPaso(currentStepNumber);
            actualizarProgreso();
        }

        function actualizarDescuento() {
            const tipoCliente = document.getElementById('tipo_cliente');
            const descuentoInput = document.getElementById('descuento');
            
            if (tipoCliente && descuentoInput) {
                const descuento = descuentosPorCliente[tipoCliente.value] || 0;
                descuentoInput.value = descuento;
            }
        }

        // Funci√≥n para inicializar precios si no existen
        function inicializarPreciosSiNoExisten() {
            const preciosElementos = JSON.parse(localStorage.getItem('precios_elementos') || '{}');
            if (Object.keys(preciosElementos).length === 0) {
                console.log('üîß Inicializando precios por defecto...');
                
                // Precios estimados b√°sicos
                const preciosEstimados = {
                    'Cable 4 pin 5 m': 95,
                    'Cable 4 pin 7 m': 125,
                    'Cable 6 pin 5 m': 115,
                    'Cinta de aislar': 15,
                    'Cincho mediado': 2,
                    'Poliflex 3/8': 8,
                    'SD 256 Gb': 450,
                    'SD 128 Gb': 250,
                    'Monitor de VPC': 2885,
                    'Grabador de video 4 ch': 3285,
                    'Dashcam ad2': 2485,
                    'Dashcam c6': 1885,
                    'Insider': 1585,
                    'Limitador de velocidad': 1285,
                    'Modulo sensor de cinturon seguridad': 985,
                    'Relevador 12v': 85,
                    'Cable 2 vias': 18,
                    'Base Pollak': 85,
                    'Pollak Macho ': 65,
                    'Pollak Hembra': 65
                };
                
                Object.entries(preciosEstimados).forEach(([elemento, precio]) => {
                    preciosElementos[elemento] = {
                        precio: precio,
                        categoria: 'insumo',
                        ultimaActualizacion: new Date().toISOString().split('T')[0]
                    };
                });
                
                localStorage.setItem('precios_elementos', JSON.stringify(preciosElementos));
                console.log('‚úÖ Precios inicializados:', Object.keys(preciosElementos).length);
            }
        }

        // Funci√≥n para calcular el total de la cotizaci√≥n usando precios del administrador
        function calcularTotalCotizacion(unidades, cotizacionData) {
            const preciosElementos = preciosCache || JSON.parse(localStorage.getItem('precios_elementos') || '{}');
            let total = 0;
            let detalleCalculo = [];

            try {
                console.log('üí∞ Iniciando c√°lculo de total...');
                console.log('Precios disponibles:', Object.keys(preciosElementos).length);
                console.log('Unidades:', unidades);
                console.log('CotizacionData:', cotizacionData);

                // Calcular equipos autom√°ticos
                if (cotizacionData.equiposAutomaticos) {
                    console.log('üì¶ Procesando equipos autom√°ticos:', cotizacionData.equiposAutomaticos);
                    Object.entries(cotizacionData.equiposAutomaticos).forEach(([equipo, datos]) => {
                        if (datos && datos.cantidad > 0) {
                            if (preciosElementos[equipo]) {
                                const precio = preciosElementos[equipo].precio || 0;
                                const subtotal = precio * datos.cantidad * (cotizacionData.cantidadLote || 1);
                                total += subtotal;
                                detalleCalculo.push(`${equipo}: $${precio} √ó ${datos.cantidad} √ó ${cotizacionData.cantidadLote || 1} = $${subtotal}`);
                                console.log(`‚úÖ ${equipo}: $${precio} √ó ${datos.cantidad} = $${subtotal}`);
                            } else {
                                console.log(`‚ö†Ô∏è Sin precio para equipo: ${equipo}`);
                            }
                        }
                    });
                }

                // Calcular insumos por unidad
                // Calcular insumos y accesorios globales
                if (cotizacionData.insumosSugeridos && Array.isArray(cotizacionData.insumosSugeridos)) {
                    console.log('üìã Procesando insumos sugeridos globales (array):', cotizacionData.insumosSugeridos);
                    cotizacionData.insumosSugeridos.forEach(item => {
                        if (item && item.nombre && item.cantidad > 0) {
                            if (preciosElementos[item.nombre]) {
                                const precio = preciosElementos[item.nombre].precio || 0;
                                const subtotal = precio * item.cantidad;
                                total += subtotal;
                                detalleCalculo.push(`${item.nombre}: $${precio} √ó ${item.cantidad} = $${subtotal}`);
                                console.log(`‚úÖ ${item.nombre}: $${precio} √ó ${item.cantidad} = $${subtotal}`);
                            } else {
                                console.log(`‚ö†Ô∏è Sin precio para insumo: ${item.nombre}`);
                            }
                        }
                    });
                }

                if (cotizacionData.accesoriosSugeridos && Array.isArray(cotizacionData.accesoriosSugeridos)) {
                    console.log('üîß Procesando accesorios sugeridos globales (array):', cotizacionData.accesoriosSugeridos);
                    cotizacionData.accesoriosSugeridos.forEach(item => {
                        if (item && item.nombre && item.cantidad > 0) {
                            if (preciosElementos[item.nombre]) {
                                const precio = preciosElementos[item.nombre].precio || 0;
                                const subtotal = precio * item.cantidad;
                                total += subtotal;
                                detalleCalculo.push(`${item.nombre}: $${precio} √ó ${item.cantidad} = $${subtotal}`);
                                console.log(`‚úÖ ${item.nombre}: $${precio} √ó ${item.cantidad} = $${subtotal}`);
                            } else {
                                console.log(`‚ö†Ô∏è Sin precio para accesorio: ${item.nombre}`);
                            }
                        }
                    });
                }

                // Aplicar descuento si existe
                const descuento = parseFloat(cotizacionData.cliente.descuento || 0);
                if (descuento > 0) {
                    const totalConDescuento = total * (1 - descuento / 100);
                    console.log(`üè∑Ô∏è Aplicando descuento ${descuento}%: $${total} ‚Üí $${totalConDescuento}`);
                    total = totalConDescuento;
                }

                console.log('üí∞ TOTAL FINAL:', total);
                console.log('üìã Detalle del c√°lculo:', detalleCalculo);
                return Math.round(total * 100) / 100; // Redondear a 2 decimales
            } catch (error) {
                console.error('‚ùå Error calculando total:', error);
                return 0;
            }
        }

        async function guardarBorrador() {
            guardarPasoActual();
            try {
                if (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase()) {
                    await guardarBorradorSupabase();
                }
                alert('Borrador guardado exitosamente');
            } catch (e) {
                console.warn('No se pudo guardar borrador en Supabase:', e);
                alert('Borrador guardado localmente');
            }
        }

        function establecerFechaVencimiento() {
            const fechaVencimientoInput = document.getElementById('fecha_vencimiento');
            if (fechaVencimientoInput && !fechaVencimientoInput.value) {
                const fechaActual = new Date();
                fechaActual.setDate(fechaActual.getDate() + 15);
                const fechaVencimiento = fechaActual.toISOString().split('T')[0];
                fechaVencimientoInput.value = fechaVencimiento;
            }
        }

        // Sistema de Almac√©n - Matriz de insumos editable
        let almacenInsumos = {
            // Estructura: [tipoUnidad][tipoSolucion][insumo] = cantidad
            'Tracto': {
                'VPC': {
                    'Cable 4 pin 5 m': 1,
                    'Cable 4 pin 7 m': 2,
                    'Cable 4 pin 15 m': 1,
                    '"Y" 4 pines': 4,
                    'Silicon': '1/10',
                    'Cinchos grande': 30,

                    'Cinta de tela': 1,
                    'Cinta de aislar': 1,
                    'Poliflex 3/8': 80,
                    'Cincho mediado': 40,
                    'Cincho con grapa': 6,
                    'Cable de 1 polo': 2,
                    'Poliflex 1/4': 2
                },
                'Sensor VPC': {
                    'Poliflex 1/4': 4,
                    'Sensor derecho VPC': 1,
                    'Sensor izquierda VPC': 1
                },
                'Sensor VPC izquierdo': {
                    'Poliflex 1/4': 2,
                    'Sensor izquierda VPC': 1
                },
                'Sensor VPC derecho': {
                    'Poliflex 1/4': 2,
                    'Sensor derecho VPC': 1
                },
                'Led de giro': {
                    'Cincho mediado': 10,
                    'Cincho con grapa': 2,
                    'Cable de 1 polo': 8,
                    'Poliflex 1/4': 26,
                    'Led de giro a la derecha': 2,
                    'Led de giro a la izquierda': 2
                },
                'Led de giro izquierdo': {
                    'Cincho mediado': 5,
                    'Cincho con grapa': 1,
                    'Cable de 1 polo': 4,
                    'Poliflex 1/4': 13,
                    'Led de giro a la izquierda': 1
                },
                'Led de giro derecho': {
                    'Cincho mediado': 5,
                    'Cincho con grapa': 1,
                    'Cable de 1 polo': 4,
                    'Poliflex 1/4': 13,
                    'Led de giro a la derecha': 1
                },
                'Alarma parlante estandar': {
                    'Tornillo 3/8': 2,
                    'Cinta de tela': '1/2',
                    'Poliflex 3/8': 8,
                    'Cincho mediado': 30,
                    'Pija brocante 5/16': 2,
                    'Cable 4 vias': 6,
                    'Tuerca 3/8': 2,
                    'Rondana 3/8': 2,
                    'Alarma parlante de 3 tonos': 1
                },
                'MDVR 4 Ch': {
                    'Cable 4 pin 3 m': 1,
                    'Cable 4 pin 7 m': 2,
                    'Cable 4 pin 15 m': 1,
                    'Cable 6 pin 5 m': 1,
                    'Silicon': '1/10',

                    'Cinta de aislar': 1,
                    'Poliflex 3/8': 80,
                    'Cincho mediado': 30,
                    'Cincho con grapa': 6,
                    'Poliflex 1/4': 5,
                    'SD 128 Gb': 1
                },
                'MDVR 8 Ch': {
                    'Cable 4 pin 3 m': 1,
                    'Cable 4 pin 7 m': 2,
                    'Cable 4 pin 15 m': 1,
                    'Cable 6 pin 5 m': 1,
                    'Silicon': '1/10',

                    'Cinta de aislar': 1,
                    'Poliflex 3/8': 80,
                    'Cincho mediado': 30,
                    'Cincho con grapa': 6,
                    'Poliflex 1/4': 5,
                    'SD 128 Gb': 1
                },
                'Rastreo basico': {

                    'Cinta de aislar': 15,
                    'Cincho mediado': 1,
                    'Cable de 1 polo': 3,
                    'Poliflex 1/4': 8,
                    'Relevador 2 pasos 2 tiros': 1,
                    'placa perforada': 1,
                    'Gabinete 5*7*3': 1
                },
                'Rastreo avanzado': {

                    'Cinta de aislar': 15,
                    'Cincho mediado': 1,
                    'Cable de 1 polo': 3,
                    'Poliflex 1/4': 8,
                    'Relevador 2 pasos 2 tiros': 1,
                    'placa perforada': 1,
                    'Gabinete 5*7*3': 1
                },
                'Rastreo satelital': {

                    'Cinta de aislar': 15,
                    'Cincho mediado': 1,
                    'Cable de 1 polo': 3,
                    'Poliflex 1/4': 8,
                    'Relevador 2 pasos 2 tiros': 1,
                    'placa perforada': 1,
                    'Gabinete 5*7*3': 1
                },
                'Dashcam': {
                    'Cable 4 pin 3 m': 1,
                    'Cinta de aislar': 5,
                    'Cincho mediado': 10,
                    'Cable de 1 polo': 1,
                    'Poliflex 1/4': 2
                },
                'Sideview': {
                    'Cable 4 pin 7 m': 4,
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 15,
                    'Cincho mediado': 60,
                    'Pija brocante 5/16': 16,
                    'Terminal de ojillo': 2,
                    'Cable 2 vias': 10,
                    'Cable 4 vias': 10,
                    'Camara sideview derecho': 1,
                    'Camara sideview izquierdo': 1,
                    'Sideview derecho': 1,
                    'Sideview izquierdo': 1
                },
                'Sideview izquierdo': {
                    'Cable 4 pin 7 m': 2,
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 7.5,
                    'Cincho mediado': 30,
                    'Pija brocante 5/16': 8,
                    'Terminal de ojillo': 1,
                    'Cable 2 vias': 5,
                    'Cable 4 vias': 5,
                    'Camara sideview izquierdo': 1,
                    'Sideview izquierdo': 1
                },
                'Sideview derecho': {
                    'Cable 4 pin 7 m': 2,
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 7.5,
                    'Cincho mediado': 30,
                    'Pija brocante 5/16': 8,
                    'Terminal de ojillo': 1,
                    'Cable 2 vias': 5,
                    'Cable 4 vias': 5,
                    'Camara sideview derecho': 1,
                    'Sideview derecho': 1
                },
                'Encadenamiento se√±ales': {
                    'Cable 4 pin 1 m': 5,
                    'Cable 4 pin 5 m': 1,
                    'Cable 4 pin 7 m': 1,
                    'Cable 4 pin 15 m': 2,
                    'Base Pollak': 7,
                    'Pollak Macho': 4,
                    'Pollak Hembra': 4,
                    'Silicon': '1/10',
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 30,
                    'Cincho mediado': 120,
                    'Cincho con grapa': 80,
                    'Pija brocante 5/16': 40,
                    'Cable 2 vias': 40,
                    'Cable 4 vias': 40,
                    'Espiral negro': 1,
                    'Espiral verde': 2,
                    '7 vias liso 2m': 1,
                    'Relevador 2 pasos 2 tiros': 5,
                    'placa perforada': 2.5,
                    'Gabinete 5*7*3': 4,
                    'Camara de reversa': 2
                },
                'Encadenamiento sencillo': {
                    'Cable 4 pin 1 m': 2,
                    'Cable 4 pin 5 m': 1,
                    'Cable 4 pin 7 m': 1,
                    'Cable 4 pin 15 m': 1,
                    'Base Pollak': 2,
                    'Pollak Macho': 2,
                    'Pollak Hembra': 2,
                    'Silicon': '1/10',
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 20,
                    'Cincho mediado': 80,
                    'Cincho con grapa': 55,
                    'Pija brocante 5/16': 27.5,
                    'Cable 2 vias': 27.5,
                    'Cable 4 vias': 27.5,
                    'Espiral negro': 1,
                    'Espiral verde': 1.5,
                    '7 vias liso 2m': 1,
                    'Relevador 2 pasos 2 tiros': 3.5,
                    'placa perforada': 1.75,
                    'Gabinete 5*7*3': 3,
                    'Camara de reversa': 1
                },
                'Encadenamiento full': {
                    'Cable 4 pin 1 m': 4,
                    'Cable 4 pin 5 m': 2,
                    'Cable 4 pin 7 m': 2,
                    'Cable 4 pin 15 m': 2,
                    'Base Pollak': 4,
                    'Pollak Macho': 4,
                    'Pollak Hembra': 4,
                    'Silicon': '1/10',
                    'Cinta de tela': 1,
                    'Poliflex 3/8': 40,
                    'Cincho mediado': 160,
                    'Cincho con grapa': 110,
                    'Pija brocante 5/16': 55,
                    'Cable 2 vias': 55,
                    'Cable 4 vias': 55,
                    'Espiral negro': 1,
                    'Espiral verde': 3,
                    '7 vias liso 2m': 1,
                    'Relevador 2 pasos 2 tiros': 7,
                    'placa perforada': 3.5,
                    'Gabinete 5*7*3': 6,
                    'Camara de reversa': 2
                },
                'Limitador de velocidad': {
                    'Cable 4 pin 3 m': 1,
                    'Cable 2 vias': 2,
                    'Silicon': '1/10',
                    'Cinta de aislar': 10,
                    'Cincho mediado': 15,
                    'Cable de 1 polo': 3,
                    'Poliflex 1/4': 5,
                    'Relevador 12v': 1
                },
                'Modulo sensor de cinturon seguridad': {
                    'Cable 4 pin 3 m': 1,
                    'Cable 2 vias': 1,
                    'Silicon': '1/10',
                    'Cinta de aislar': 5,
                    'Cincho mediado': 8,
                    'Cable de 1 polo': 2,
                    'Poliflex 1/4': 3
                },
                'Insider': {
                    'Cable 4 pin 3 m': 1,
                    'Silicon': '1/10',
                    'Cinta de aislar': 5,
                    'Cincho mediado': 5,
                    'Cable de 1 polo': 1,
                    'Poliflex 1/4': 2
                }
            },
            'Remolque': {
                'VPC': {
                    'Cable 4 pin 5 m': 1,
                    'Cable 4 pin 7 m': 2,
                    'Cable 4 pin 15 m': 1,
                    '"Y" 4 pines': 4,
                    'Silicon': '1/10',
                    'Cinchos grande': 30,

                    'Cinta de tela': 1,
                    'Cinta de aislar': 1,
                    'Poliflex 3/8': 80,
                    'Cincho mediado': 40,
                    'Cincho con grapa': 6,
                    'Cable de 1 polo': 2,
                    'Poliflex 1/4': 2
                },
                'Sideview': {
                    'Cable 4 pin 5 m': 2,
                    'Cable 4 pin 7 m': 1,
                    'Silicon': '1/10',
                    'Cinchos grande': 20,
                    'Cinta de aislar': 1,
                    'Poliflex 3/8': 40,
                    'Cincho mediado': 20,
                    'Cincho con grapa': 4,
                    'Cable de 1 polo': 1,
                    'Poliflex 1/4': 2
                },
                'Led de giro': {
                    'Cincho mediado': 10,
                    'Cincho con grapa': 2,
                    'Cable de 1 polo': 8,
                    'Poliflex 1/4': 26,
                    'Led de giro a la derecha': 2,
                    'Led de giro a la izquierda': 2
                }
            },
            'Motocicleta': {
                'Rastreo basico': {
                    'Cable 4 pin 3 m': 1,
                    'Cinta de aislar': 8,
                    'Cincho mediado': 5,
                    'Cable de 1 polo': 2,
                    'Poliflex 1/4': 3,
                    'Relevador 2 pasos 2 tiros': 1
                },
                'Rastreo avanzado': {
                    'Cable 4 pin 3 m': 1,
                    'Cinta de aislar': 8,
                    'Cincho mediado': 5,
                    'Cable de 1 polo': 2,
                    'Poliflex 1/4': 3,
                    'Relevador 2 pasos 2 tiros': 1
                },
                'Dashcam': {
                    'Cable 4 pin 3 m': 1,
                    'Cinta de aislar': 3,
                    'Cincho mediado': 5,
                    'Cable de 1 polo': 1,
                    'Poliflex 1/4': 2
                }
            }
        };

        // Funci√≥n para cargar tipos globales desde localStorage
        function cargarTiposGlobales() {
            try {
                const tiposGlobales = JSON.parse(localStorage.getItem('tipos_globales') || '{}');
                return {
                    vehiculos: tiposGlobales.vehiculos || [],
                    soluciones: tiposGlobales.soluciones || [],
                    insumos: tiposGlobales.insumos || []
                };
            } catch (error) {
                console.warn('Error cargando tipos globales:', error);
                return { vehiculos: [], soluciones: [], insumos: [] };
            }
        }

        // Funci√≥n para cargar almac√©n desde Supabase
        async function cargarAlmacenDesdeSupabase() {
            try {
                if (!modoCentralizado) {
                    console.log('‚ÑπÔ∏è Modo no centralizado, usando localStorage');
                    return;
                }

                console.log('üîÑ Cargando almac√©n desde Supabase...');
                const registros = await window.dataService.fetchAlmacenInsumos();
                
                // Convertir registros de Supabase al formato esperado
                const nuevoAlmacen = {};
                (registros || []).forEach(r => {
                    const tipoUnidad = r.tipoUnidad;
                    const tipoSolucion = r.tipoSolucion;
                    const insumos = r.insumos || {};
                    
                    if (!nuevoAlmacen[tipoUnidad]) {
                        nuevoAlmacen[tipoUnidad] = {};
                    }
                    nuevoAlmacen[tipoUnidad][tipoSolucion] = insumos;
                });
                
                // Actualizar la variable global almacenInsumos
                Object.keys(nuevoAlmacen).forEach(tipoUnidad => {
                    if (!almacenInsumos[tipoUnidad]) {
                        almacenInsumos[tipoUnidad] = {};
                    }
                    Object.keys(nuevoAlmacen[tipoUnidad]).forEach(tipoSolucion => {
                        almacenInsumos[tipoUnidad][tipoSolucion] = nuevoAlmacen[tipoUnidad][tipoSolucion];
                    });
                });
                
                console.log(`‚úÖ Almac√©n cargado desde Supabase: ${Object.keys(almacenInsumos).length} tipos de unidad`);
            } catch (error) {
                console.error('‚ùå Error cargando almac√©n desde Supabase:', error);
            }
        }

        // Cargar tipos globales
        const tiposGlobales = cargarTiposGlobales();
        console.log('üìã Tipos globales cargados:', tiposGlobales);

        // Lista de todos los insumos disponibles (combinar con tipos globales)
        const listaInsumosBase = [
            'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m', 
            'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', '"Y" 4 pines',
            'Base Pollak', 'Pollak Macho', 'Pollak Hembra', 'Tornillo hexagonal 5/16',
            'Tornillo 3/8', 'Silicon', 'Cinchos grande', 'Cinta de tela',
            'Cinta de aislar', 'Poliflex 3/8', 'Cincho mediado', 'Cincho con grapa',
            'Pija brocante 5/16', 'Cable de 1 polo', 'Terminal de ojillo', 'Poliflex 1/4',
            'Cable 2 vias', 'Cable 4 vias', 'Tuerca 5/16', 'Rondana 5/16', 'Tuerca 3/8',
            'Rondana 3/8', 'Espiral negro', 'Espiral verde', '7 vias liso 2m',
            'Relevador 2 pasos 2 tiros', 'placa perforada', 'Gabinete 5*7*3',
            'Relevador 12v', 'Relevador 24v', 'Portarelevador', 'Alarma parlante de 3 tonos',
            'Alarma parlante programable', 'Camara + radar', 'Camara con microfono',
            'Camara de reversa', 'Camara Digital (IP)', 'Camara exterior mini',
            'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC',
            'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo',
            'Dashcam ad2', 'Dashcam c6', 'Bocina', 'Bot√≥n balancin', 'Boton de panico',
            'Microfono', 'Sensor magnetico chico', 'Sensor magnetico grande', 'Insider',
            'Led de giro a la derecha', 'Led de giro a la izquierda', 'Limitador de velocidad',
            'Modulo sensor de cinturon seguridad', 'Monitor de VPC', 'SD 128 Gb', 'SD 256 Gb',
            'SD 512 Gb', 'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho',
            'Sideview izquierdo'
        ];
        
        // Combinar insumos base con tipos globales
        const listaInsumos = [...new Set([...listaInsumosBase, ...tiposGlobales.insumos])].sort();

        // Funci√≥n para actualizar selects de tipos de veh√≠culos
        function actualizarSelectsVehiculos() {
            const selectsVehiculos = document.querySelectorAll('select[name*="vehiculo_tipo"]');
            selectsVehiculos.forEach(select => {
                const valorActual = select.value;
                const opcionesBase = [
                    '1.5 ton', '2.5 ton', '3.5 ton', '4.5 ton', 'Autobus pasajeros',
                    'Motocicleta', 'Rab√≥n', 'Sedan', 'Sedan lujo', 'SUV',
                    'Torton', 'Tracto', 'Tracto Cabina sobre motor', 'Van pasajeros'
                ];
                const opcionesCompletas = [...new Set([...opcionesBase, ...tiposGlobales.vehiculos])].sort();
                
                select.innerHTML = '<option value="">Seleccionar tipo</option>' +
                    opcionesCompletas.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('');
                
                // Restaurar valor seleccionado si existe
                if (valorActual && opcionesCompletas.includes(valorActual)) {
                    select.value = valorActual;
                }
            });
        }

        // Funci√≥n para actualizar selects de tipos de soluciones
        function actualizarSelectsSoluciones() {
            const selectsSoluciones = document.querySelectorAll('select[name*="solucion_tipo"]');
            selectsSoluciones.forEach(select => {
                const valorActual = select.value;
                const opcionesBase = [
                    'Encadenamiento se√±ales', 'Insider', 'Led de giro', 'Limitador de velocidad',
                    'MDVR 4 Ch', 'MDVR 8 Ch', 'Modulo sensor cinturon', 'Rastreo avanzado',
                    'Rastreo basico', 'Rastreo satelital', 'Sensor VPC', 'Sideview', 'VPC'
                ];
                const opcionesCompletas = [...new Set([...opcionesBase, ...tiposGlobales.soluciones])].sort();
                
                select.innerHTML = '<option value="">Seleccionar soluci√≥n</option>' +
                    opcionesCompletas.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('');
                
                // Restaurar valor seleccionado si existe
                if (valorActual && opcionesCompletas.includes(valorActual)) {
                    select.value = valorActual;
                }
            });
        }

        // Funci√≥n para actualizar todos los selects
        function actualizarTodosLosSelects() {
            actualizarSelectsVehiculos();
            actualizarSelectsSoluciones();
        }

        // Cargar funciones de rastreo desde Supabase
        async function cargarFuncionesRastreo() {
            try {
                if (!modoCentralizado) {
                    console.log('‚ÑπÔ∏è Modo no centralizado, funciones de rastreo no disponibles');
                    return;
                }

                console.log('üîÑ Cargando funciones de rastreo desde Supabase...');
                funcionesRastreo = await window.dataService.fetchFuncionesRastreo();
                console.log(`‚úÖ Funciones de rastreo cargadas: ${funcionesRastreo.length}`);
            } catch (error) {
                console.error('‚ùå Error cargando funciones de rastreo:', error);
            }
        }

        // Cargar almac√©n desde Supabase o localStorage
        async function inicializarAlmacen() {
            if (modoCentralizado) {
                // Cargar desde Supabase
                await cargarAlmacenDesdeSupabase();
                // Cargar funciones de rastreo
                await cargarFuncionesRastreo();
            } else {
                // Cargar desde localStorage si existe
                const almacenGuardado = localStorage.getItem('almacen_insumos');
                if (almacenGuardado) {
                    try {
                        const almacenCargado = JSON.parse(almacenGuardado);
                        // Fusionar con el almac√©n por defecto
                        Object.keys(almacenCargado).forEach(tipoUnidad => {
                            if (!almacenInsumos[tipoUnidad]) {
                                almacenInsumos[tipoUnidad] = {};
                            }
                            Object.keys(almacenCargado[tipoUnidad]).forEach(tipoSolucion => {
                                almacenInsumos[tipoUnidad][tipoSolucion] = almacenCargado[tipoUnidad][tipoSolucion];
                            });
                        });
                        console.log('‚úì Almac√©n cargado desde localStorage');
                    } catch (error) {
                        console.error('Error al cargar almac√©n:', error);
                    }
                }
            }
        }

        // Inicializar almac√©n
        inicializarAlmacen();

        // Definici√≥n de categor√≠as de insumos
        const categoriasInsumos = {
            insumos: [
                'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m', 
                'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', '"Y" 4 pines', 
                'Base Pollak', 'Pollak Macho', 'Pollak Hembra', 'Tornillo hexagonal 5/16', 
                'Tornillo 3/8', 'Silicon', 'Cinchos grande', 'Cinta de tela', 
                'Cinta de aislar', 'Poliflex 3/8', 'Cincho mediado', 'Cincho con grapa', 
                'Pija brocante 5/16', 'Cable de 1 polo', 'Terminal de ojillo', 'Poliflex 1/4', 
                'Cable 2 vias', 'Cable 4 vias', 'Tuerca 5/16', 'Rondana 5/16', 'Tuerca 3/8', 
                'Rondana 3/8', 'Espiral negro', 'Espiral verde', '7 vias liso 2m', 
                'Relevador 2 pasos 2 tiros', 'placa perforada', 'Gabinete 5*7*3', 'Relevador 12v', 
                'Relevador 24v', 'Portarelevador', 'SD 128 Gb', 'SD 256 Gb', 'SD 512 Gb'
            ],
            accesorios: [
                'Alarma parlante de 3 tonos', 'Alarma parlante programable', 'Camara + radar', 
                'Camara con microfono', 'Camara de reversa', 'Camara Digital (IP)', 
                'Camara exterior mini', 'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC', 
                'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo', 
                'Led de giro a la derecha', 'Led de giro a la izquierda', 'Bocina', 'Bot√≥n balancin', 
                'Boton de panico', 'Microfono', 'Sensor magnetico chico', 'Sensor magnetico grande',
                'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho', 'Sideview izquierdo',
                'Camara frontal', 'Camara izquierda', 'Camara derecha'
            ],
            equipos: [
                'Dashcam ad2', 'Dashcam c6', 'GV310LAU', 'GV58LAU', 'GV75LAU', 'SMOC', 
                'MDVR 4 Ch', 'MDVR 8 Ch', 'Insider', 'Modulo sensor de cinturon seguridad', 
                'Limitador de velocidad', 'Monitor de VPC', 'Grabador de video 4 ch'
            ]
        };

        // Matriz de funciones de telemetr√≠a (formato CSV)
        const matrizTelemetriaCSV = `SOS simple,1,2,0,0,0,0,0,0,0
SOS llamada,1,0,0,0,0,0,1,1,0
SOS Bloqueo,1,0,0,0,0,0,0,0,0
Bloqueo normal,0,0,0,0,0,0,0,0,1
Bloqueo CC,0,0,0,0,0,0,0,0,1
Sensores juntos,0,8,0,0,0,0,0,0,1
Sensores independientes,0,0,2,0,0,0,0,0,0
Sensores y bloqueo,0,0,2,0,0,0,0,0,1
Audio bidireccional,0,0,0,0,0,0,1,1,0
Audio esp√≠a,0,0,0,0,0,0,1,0,0
sensor caja,0,12,0,1,0,0,0,0,0
habilitado,0,2,0,0,1,1,0,0,0`;

        // Headers de la matriz de telemetr√≠a
        const headersTelemetria = ['Boton membrana','Cable 2 vias','Sensor magnetico chico','Sensor magnetico grande','Teclado sencillo','Teclado din√°mico','Microfono','Bocina','Relevador'];

        // Funci√≥n para obtener insumos de rastreo desde el CSV actualizado
        function obtenerInsumosRastreo(funcionalidad) {
            // Buscar la funci√≥n en los datos de Supabase
            const funcion = funcionesRastreo.find(f => f.funcionalidad === funcionalidad);
            
            if (funcion && funcion.insumos) {
                console.log(`üì¶ Funci√≥n de rastreo encontrada en Supabase: ${funcionalidad}`, funcion.insumos);
                return funcion.insumos;
            }
            
            // Fallback a datos hardcodeados si no se encuentra en Supabase
            console.log(`‚ö†Ô∏è Funci√≥n de rastreo no encontrada en Supabase: ${funcionalidad}, usando fallback`);
            const insumosRastreoFallback = {
                'SOS simple': [
                    { nombre: 'Boton membrana', cantidad: 1 },
                    { nombre: 'Cable 2 vias', cantidad: 2 }
                ],
                'SOS llamada': [
                    { nombre: 'Boton membrana', cantidad: 1 },
                    { nombre: 'Microfono', cantidad: 1 },
                    { nombre: 'Bocina', cantidad: 1 }
                ],
                'SOS Bloqueo': [
                    { nombre: 'Boton membrana', cantidad: 1 }
                ],
                'Bloqueo normal': [
                    { nombre: 'Relevador', cantidad: 1 }
                ],
                'Bloqueo CC': [
                    { nombre: 'Relevador', cantidad: 1 }
                ],
                'Sensores juntos': [
                    { nombre: 'Cable 2 vias', cantidad: 8 },
                    { nombre: 'Relevador', cantidad: 1 }
                ],
                'Sensores independientes': [
                    { nombre: 'Sensor magnetico chico', cantidad: 2 }
                ],
                'Sensores y bloqueo': [
                    { nombre: 'Sensor magnetico chico', cantidad: 2 },
                    { nombre: 'Relevador', cantidad: 1 }
                ],
                'Audio bidireccional': [
                    { nombre: 'Microfono', cantidad: 1 },
                    { nombre: 'Bocina', cantidad: 1 }
                ],
                'Audio esp√≠a': [
                    { nombre: 'Microfono', cantidad: 1 }
                ],
                'sensor caja': [
                    { nombre: 'Cable 2 vias', cantidad: 12 },
                    { nombre: 'Sensor magnetico grande', cantidad: 1 }
                ],
                'habilitado': [
                    { nombre: 'Cable 2 vias', cantidad: 2 },
                    { nombre: 'Teclado sencillo', cantidad: 1 },
                    { nombre: 'Teclado din√°mico', cantidad: 1 }
                ]
            };
            
            return insumosRastreoFallback[funcionalidad] || [];
        }

        // Funci√≥n para obtener insumos sugeridos basados en tipo de unidad y soluci√≥n
        function obtenerInsumosSugeridos(tipoUnidad, tipoSolucion) {
            console.log(`Buscando en almac√©n: "${tipoUnidad}" + "${tipoSolucion}"`);
            
            // Verificar si existe la combinaci√≥n en el almac√©n
            if (almacenInsumos[tipoUnidad] && almacenInsumos[tipoUnidad][tipoSolucion]) {
                const insumosSolucion = almacenInsumos[tipoUnidad][tipoSolucion];
                const insumos = [];
                
                // Convertir objeto a array de insumos
                Object.keys(insumosSolucion).forEach(insumo => {
                    const cantidad = insumosSolucion[insumo];
                    if (cantidad && cantidad !== 0 && cantidad !== '0') {
                        insumos.push({
                            nombre: insumo,
                            cantidad: cantidad,
                            sugerido: true
                        });
                    }
                });
                
                console.log(`‚úì Encontrada combinaci√≥n en almac√©n: ${insumos.length} insumos`);
                return insumos;
            }
            
            console.log(`‚úó No se encontr√≥ combinaci√≥n: "${tipoUnidad}" + "${tipoSolucion}"`);
            return [];
        }

        // Funci√≥n para obtener accesorios de telemetr√≠a basados en funciones seleccionadas
        function obtenerAccesoriosTelemetria(funcionesSeleccionadas) {
            const lineas = matrizTelemetriaCSV.split('\n');
            let accesoriosConsolidados = {};
            
            funcionesSeleccionadas.forEach(funcion => {
                // Buscar la fila correspondiente a esta funci√≥n
                for (let i = 0; i < lineas.length; i++) {
                    const valores = lineas[i].split(',');
                    if (valores[0] === funcion) {
                        // Procesar cada accesorio (desde √≠ndice 1)
                        for (let j = 1; j < valores.length; j++) {
                            const cantidad = parseInt(valores[j]) || 0;
                            if (cantidad > 0) {
                                const headerIndex = j - 1; // Ajustar √≠ndice para headers
                                if (headerIndex < headersTelemetria.length) {
                                    const nombreAccesorio = headersTelemetria[headerIndex];
                                    
                                    // L√≥gica especial para relevador (m√°ximo 1 por unidad)
                                    if (nombreAccesorio === 'Relevador') {
                                        accesoriosConsolidados[nombreAccesorio] = 1;
                                    } else {
                                        // Sumar cantidades para otros accesorios
                                        if (accesoriosConsolidados[nombreAccesorio]) {
                                            accesoriosConsolidados[nombreAccesorio] += cantidad;
                                        } else {
                                            accesoriosConsolidados[nombreAccesorio] = cantidad;
                                        }
                                    }
                                }
                            }
                        }
                        break;
                    }
                }
            });
            
            // Convertir a array de objetos
            return Object.keys(accesoriosConsolidados).map(nombre => ({
                nombre: nombre,
                cantidad: accesoriosConsolidados[nombre],
                deTelemetria: true
            }));
        }

        // Funci√≥n para obtener la categor√≠a de un insumo
        function obtenerCategoriaInsumo(nombreInsumo) {
            if (categoriasInsumos.insumos.includes(nombreInsumo)) return 'insumos';
            if (categoriasInsumos.accesorios.includes(nombreInsumo)) return 'accesorios';
            if (categoriasInsumos.equipos.includes(nombreInsumo)) return 'equipos';
            return 'insumos'; // Default a insumos si no se encuentra
        }

        // Funci√≥n para generar equipos autom√°ticamente basados en las soluciones
        function generarEquiposAutomaticos(vehiculos) {
            let equiposAutomaticos = {};
            
            vehiculos.forEach((vehiculo, unidadIndex) => {
                const tipoUnidad = vehiculo.tipo || 'Tracto';
                
                // Equipos √∫nicos por unidad (evitar duplicados por m√∫ltiples soluciones en la misma unidad)
                let equiposUnicosEnUnidad = {
                    'Monitor de VPC': false,
                    'MDVR 4 Ch': false,
                    'MDVR 8 Ch': false,
                    'Dashcam': null // asegura una sola variante por unidad (AD2 o C6)
                };
                
                // Auto-sugerencia para motocicletas
                if (tipoUnidad === 'Motocicleta') {
                    equiposAutomaticos['GV75LAU'] = {
                        nombre: 'GV75LAU',
                        cantidad: (equiposAutomaticos['GV75LAU']?.cantidad || 0) + 1,
                        unidades: [...(equiposAutomaticos['GV75LAU']?.unidades || []), `Unidad ${unidadIndex + 1} (Motocicleta - Auto)`],
                        sugerido: true,
                        categoria: 'equipos'
                    };
                }
                
                if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                    vehiculo.soluciones.forEach(solucion => {
                        const tipoSolucion = solucion.tipo_solucion;
                        const configs = solucion.configuraciones || {};
                        
                        // L√≥gica para Dashcam
                        if (tipoSolucion === 'Dashcam') {
                            const equipoDashcam = (configs.ai === true || configs.ia === true) ? 'Dashcam ad2' : 'Dashcam c6';
                            // Evitar sugerir ambas variantes en la misma unidad
                            if (!equiposUnicosEnUnidad['Dashcam']) {
                                equiposAutomaticos[equipoDashcam] = {
                                    nombre: equipoDashcam,
                                    cantidad: (equiposAutomaticos[equipoDashcam]?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos[equipoDashcam]?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: 'equipos'
                                };
                                equiposUnicosEnUnidad['Dashcam'] = equipoDashcam;
                            }

                            // La memoria seleccionada se maneja en los insumos sugeridos (no como equipo autom√°tico)
                        }
                        
                        // L√≥gica para Rastreo
                        if (tipoSolucion === 'Rastreo avanzado') {
                            equiposAutomaticos['GV310LAU'] = {
                                nombre: 'GV310LAU',
                                cantidad: (equiposAutomaticos['GV310LAU']?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos['GV310LAU']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        } else if (tipoSolucion === 'Rastreo basico') {
                            const equipoGPS = configs.ip67 === true ? 'GV75LAU' : 'GV58LAU';
                            equiposAutomaticos[equipoGPS] = {
                                nombre: equipoGPS,
                                cantidad: (equiposAutomaticos[equipoGPS]?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos[equipoGPS]?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        } else if (tipoSolucion === 'Rastreo satelital') {
                            equiposAutomaticos['SMOC'] = {
                                nombre: 'SMOC',
                                cantidad: (equiposAutomaticos['SMOC']?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos['SMOC']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        }
                        
                        // L√≥gica para VPC y Encadenamiento (Monitor VPC) - UNO por unidad
                        if (['VPC', 'Encadenamiento se√±ales'].includes(tipoSolucion)) {
                            if (!equiposUnicosEnUnidad['Monitor de VPC']) {
                                equiposAutomaticos['Monitor de VPC'] = {
                                    nombre: 'Monitor de VPC',
                                    cantidad: (equiposAutomaticos['Monitor de VPC']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Monitor de VPC']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: 'equipos'
                                };
                                equiposUnicosEnUnidad['Monitor de VPC'] = true;
                            }
                        }
                        
                        // L√≥gica para MDVR - UNO por unidad
                        if (tipoSolucion === 'MDVR 4 Ch') {
                            if (!equiposUnicosEnUnidad['MDVR 4 Ch']) {
                                equiposAutomaticos['MDVR 4 Ch'] = {
                                    nombre: 'MDVR 4 Ch',
                                    cantidad: (equiposAutomaticos['MDVR 4 Ch']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['MDVR 4 Ch']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: 'equipos'
                                };
                                equiposUnicosEnUnidad['MDVR 4 Ch'] = true;
                            }
                        } else if (tipoSolucion === 'MDVR 8 Ch') {
                            if (!equiposUnicosEnUnidad['MDVR 8 Ch']) {
                                equiposAutomaticos['MDVR 8 Ch'] = {
                                    nombre: 'MDVR 8 Ch',
                                    cantidad: (equiposAutomaticos['MDVR 8 Ch']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['MDVR 8 Ch']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: 'equipos'
                                };
                                equiposUnicosEnUnidad['MDVR 8 Ch'] = true;
                            }
                        }
                        
                        // Verificar si hay grabaci√≥n en otras soluciones (VPC, Sideview, Encadenamiento)
                        if (['VPC', 'Sideview', 'Encadenamiento se√±ales'].includes(tipoSolucion) && configs.grabacion === true) {
                            if (!equiposUnicosEnUnidad['MDVR 4 Ch']) {
                                equiposAutomaticos['MDVR 4 Ch'] = {
                                    nombre: 'MDVR 4 Ch',
                                    cantidad: (equiposAutomaticos['MDVR 4 Ch']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['MDVR 4 Ch']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion} - Grabaci√≥n)`],
                                    sugerido: true,
                                    categoria: 'equipos'
                                };
                                equiposUnicosEnUnidad['MDVR 4 Ch'] = true;
                            }
                            // Marcar bandera para notificar soporte
                            try { cotizacionData.requiereSoporte = true; } catch(_) {}
                        }
                        
                        // Procesar configuraciones espec√≠ficas de VPC
                        if (tipoSolucion === 'VPC') {
                            // Procesar c√°maras VPC seleccionadas
                            if (configs.camara_izquierda === true) {
                                equiposAutomaticos['Camara lateral izquierda de VPC'] = {
                                    nombre: 'Camara lateral izquierda de VPC',
                                    cantidad: (equiposAutomaticos['Camara lateral izquierda de VPC']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Camara lateral izquierda de VPC']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - C√°mara Izquierda)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            if (configs.camara_derecha === true) {
                                equiposAutomaticos['Camara lateral derecha de VPC'] = {
                                    nombre: 'Camara lateral derecha de VPC',
                                    cantidad: (equiposAutomaticos['Camara lateral derecha de VPC']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Camara lateral derecha de VPC']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - C√°mara Derecha)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            if (configs.camara_reversa === true) {
                                equiposAutomaticos['Camara de reversa'] = {
                                    nombre: 'Camara de reversa',
                                    cantidad: (equiposAutomaticos['Camara de reversa']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Camara de reversa']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - C√°mara Reversa)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            if (configs.camara_frontal === true) {
                                equiposAutomaticos['Camara frontal'] = {
                                    nombre: 'Camara frontal',
                                    cantidad: (equiposAutomaticos['Camara frontal']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Camara frontal']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - C√°mara Frontal)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            // Procesar alarmas VPC seleccionadas
                            if (configs.alarma_parlante === true) {
                                equiposAutomaticos['Alarma parlante programable'] = {
                                    nombre: 'Alarma parlante programable',
                                    cantidad: (equiposAutomaticos['Alarma parlante programable']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Alarma parlante programable']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - Alarma Parlante)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            if (configs.boton_panico === true) {
                                equiposAutomaticos['Boton de panico'] = {
                                    nombre: 'Boton de panico',
                                    cantidad: (equiposAutomaticos['Boton de panico']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Boton de panico']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - Bot√≥n P√°nico)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                            
                            if (configs.microfono === true) {
                                equiposAutomaticos['Microfono'] = {
                                    nombre: 'Microfono',
                                    cantidad: (equiposAutomaticos['Microfono']?.cantidad || 0) + 1,
                                    unidades: [...(equiposAutomaticos['Microfono']?.unidades || []), `Unidad ${unidadIndex + 1} (VPC - Micr√≥fono)`],
                                    sugerido: true,
                                    categoria: 'accesorios'
                                };
                            }
                        }
                        
                        // Equipos directos
                        if (tipoSolucion === 'Insider') {
                            equiposAutomaticos['Insider'] = {
                                nombre: 'Insider',
                                cantidad: (equiposAutomaticos['Insider']?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos['Insider']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        }
                        
                        if (tipoSolucion === 'Limitador de velocidad') {
                            equiposAutomaticos['Limitador de velocidad'] = {
                                nombre: 'Limitador de velocidad',
                                cantidad: (equiposAutomaticos['Limitador de velocidad']?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos['Limitador de velocidad']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        }
                        
                        if (tipoSolucion === 'Modulo sensor cinturon') {
                            equiposAutomaticos['Modulo sensor de cinturon seguridad'] = {
                                nombre: 'Modulo sensor de cinturon seguridad',
                                cantidad: (equiposAutomaticos['Modulo sensor de cinturon seguridad']?.cantidad || 0) + 1,
                                unidades: [...(equiposAutomaticos['Modulo sensor de cinturon seguridad']?.unidades || []), `Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                sugerido: true,
                                categoria: 'equipos'
                            };
                        }
                    });
                }
            });
            
            return equiposAutomaticos;
        }

        // ===== VALIDACIONES DE ENTRADAS/SALIDAS GPS GV310LAU =====
        
        // Funci√≥n para validar entradas y salidas del GPS
        function validarEntradasSalidasGPS(unidadIndex, solucionIndex) {
            const vehiculo = cotizacionData.vehiculos[unidadIndex];
            const solucion = vehiculo.soluciones[solucionIndex];
            
            if (!solucion || solucion.tipo_solucion !== 'Rastreo avanzado') {
                return { valido: true };
            }
            
            const configs = solucion.configuraciones || {};
            const entradasUsadas = [];
            const salidasUsadas = [];
            
            // Mapear configuraciones a entradas/salidas
            if (configs.sos_simple || configs.sos_llamada || configs.sos_bloqueo) {
                entradasUsadas.push(1); // SOS usa entrada 1
            }
            
            if (configs.sensores_puertas === 'juntos') {
                entradasUsadas.push(2); // Sensores juntos usa entrada 2
            } else if (configs.sensores_puertas === 'independientes') {
                entradasUsadas.push(2, 3); // Sensores independientes usa entradas 2 y 3
            }
            
            if (configs.teclado_sencillo || configs.teclado_dinamico) {
                // Teclado usa entrada 3, pero si sensores independientes ya la usa, necesitamos otra entrada
                if (configs.sensores_puertas === 'independientes') {
                    // Si sensores independientes ya usa entrada 3, teclado no puede usarla
                    console.log('‚ö†Ô∏è Teclado no puede usarse con sensores independientes (ambos necesitan entrada 3)');
                } else {
                    entradasUsadas.push(3); // Teclado usa entrada 3
                }
            }
            
            if (configs.bloqueo_normal || configs.bloqueo_gradual || configs.bloqueo_cortacorriente) {
                salidasUsadas.push(1); // Bloqueo usa salida 1
            }
            
            if (configs.bloqueo_apertura) {
                if (configs.sensores_puertas === 'juntos') {
                    salidasUsadas.push(2); // Bloqueo por puertas juntos usa salida 2
                } else if (configs.sensores_puertas === 'independientes') {
                    salidasUsadas.push(2, 3); // Bloqueo por puertas independientes usa salidas 2 y 3
                }
            }
            
            console.log(`üîç DEBUG: Verificando deteccion_jammer: "${configs.deteccion_jammer}"`);
            
            if (configs.deteccion_jammer === 'alerta' || configs.deteccion_jammer === 'alerta_bloqueo') {
                console.log(`üîç DEBUG: Procesando detecci√≥n jammer: ${configs.deteccion_jammer}`);
                // Detecci√≥n jammer siempre usa una entrada
                const entradaLibre = [1, 2, 3].find(entrada => !entradasUsadas.includes(entrada));
                if (entradaLibre) {
                    entradasUsadas.push(entradaLibre);
                    console.log(`üîç DEBUG: Detecci√≥n jammer usando entrada ${entradaLibre}`);
                } else {
                    console.log('‚ö†Ô∏è No hay entradas libres para detecci√≥n jammer');
                }
                
                // Si es alerta y bloqueo, tambi√©n usa salida 3
                if (configs.deteccion_jammer === 'alerta_bloqueo') {
                    salidasUsadas.push(3);
                    console.log(`üîç DEBUG: Detecci√≥n jammer con bloqueo usando salida 3`);
                }
            } else {
                console.log(`üîç DEBUG: Detecci√≥n jammer no activa o valor inv√°lido: "${configs.deteccion_jammer}"`);
            }
            
            // Verificar si excede las capacidades del GPS (3 entradas, 3 salidas)
            const entradasUnicas = [...new Set(entradasUsadas)];
            const salidasUnicas = [...new Set(salidasUsadas)];
            
            console.log(`üîç DEBUG: Validaci√≥n GPS - Entradas usadas: [${entradasUnicas.join(', ')}], Salidas usadas: [${salidasUnicas.join(', ')}]`);
            console.log(`üîç DEBUG: Configuraciones actuales:`, configs);
            
            // Verificar si excede las capacidades (m√°s de 3 entradas o salidas)
            if (entradasUnicas.length > 3 || salidasUnicas.length > 3) {
                console.log(`‚ùå DEBUG: Excede capacidades - Entradas: ${entradasUnicas.length}/3, Salidas: ${salidasUnicas.length}/3`);
                return {
                    valido: false,
                    entradasUsadas: entradasUnicas,
                    salidasUsadas: salidasUnicas,
                    mensaje: 'Las configuraciones seleccionadas exceden las capacidades f√≠sicas del GPS GV310LAU (3 entradas, 3 salidas).'
                };
            }
            
            // Verificar conflictos espec√≠ficos que requieren Insider
            const conflictos = [];
            
            // Conflicto: Sensores independientes + Teclado (ambos necesitan entrada 3)
            if (configs.sensores_puertas === 'independientes' && (configs.teclado_sencillo || configs.teclado_dinamico)) {
                conflictos.push('Sensores independientes y teclado requieren la misma entrada (3)');
            }
            
            // Conflicto: Bloqueo con apertura independientes + Detecci√≥n jammer con bloqueo (ambos necesitan salida 3)
            if (configs.sensores_puertas === 'independientes' && configs.bloqueo_apertura && configs.deteccion_jammer === 'alerta_bloqueo') {
                conflictos.push('Bloqueo con apertura independientes y detecci√≥n jammer con bloqueo requieren la misma salida (3)');
            }
            
            // Si hay conflictos, mostrar modal
            if (conflictos.length > 0) {
                console.log(`‚ùå DEBUG: Conflictos detectados: ${conflictos.join(', ')}`);
                return {
                    valido: false,
                    entradasUsadas: entradasUnicas,
                    salidasUsadas: salidasUnicas,
                    mensaje: `Conflictos detectados: ${conflictos.join(', ')}. Se requiere un m√≥dulo Insider para resolver estos conflictos.`
                };
            }
            
            // Verificar si est√° al l√≠mite (exactamente 3 entradas o salidas)
            if (entradasUnicas.length === 3 || salidasUnicas.length === 3) {
                console.log(`‚ö†Ô∏è DEBUG: Al l√≠mite de capacidades - Entradas: ${entradasUnicas.length}/3, Salidas: ${salidasUnicas.length}/3`);
                // No es un error, pero es una advertencia
            }
            
            console.log(`‚úÖ DEBUG: Configuraci√≥n v√°lida - Entradas: ${entradasUnicas.length}/3, Salidas: ${salidasUnicas.length}/3`);
            return { valido: true };
        }
        
        // Funci√≥n para mostrar modal de advertencia
        function mostrarModalAdvertenciaGPS(unidadIndex, solucionIndex, validacion) {
            const modalHtml = `
                <div class="modal fade" id="modalAdvertenciaGPS" tabindex="-1" aria-labelledby="modalAdvertenciaGPSLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="modalAdvertenciaGPSLabel">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Advertencia - Capacidades del GPS
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-info-circle me-2"></i>Configuraci√≥n no compatible</h6>
                                    <p class="mb-0">${validacion.mensaje}</p>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Entradas utilizadas: ${validacion.entradasUsadas.length}/3</h6>
                                        <div class="d-flex flex-wrap gap-1">
                                            ${validacion.entradasUsadas.map(entrada => 
                                                `<span class="badge bg-primary">Entrada ${entrada}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Salidas utilizadas: ${validacion.salidasUsadas.length}/3</h6>
                                        <div class="d-flex flex-wrap gap-1">
                                            ${validacion.salidasUsadas.map(salida => 
                                                `<span class="badge bg-success">Salida ${salida}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <h6>Opciones disponibles:</h6>
                                <ul>
                                    <li><strong>Agregar m√≥dulo Insider:</strong> Permite expandir las capacidades del sistema</li>
                                    <li><strong>Editar configuraci√≥n:</strong> Modificar las opciones seleccionadas</li>
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-pencil-square me-1"></i>Editar configuraci√≥n
                                </button>
                                <button type="button" class="btn btn-warning" onclick="agregarModuloInsider(${unidadIndex}, ${solucionIndex})">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar m√≥dulo Insider
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente si existe
            const modalExistente = document.getElementById('modalAdvertenciaGPS');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            // Agregar nuevo modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAdvertenciaGPS'));
            modal.show();
        }
        
        // Funci√≥n para agregar m√≥dulo Insider
        function agregarModuloInsider(unidadIndex, solucionIndex) {
            const vehiculo = cotizacionData.vehiculos[unidadIndex];
            
            // Verificar si ya existe soluci√≥n Insider
            const yaExisteInsider = vehiculo.soluciones.some(sol => sol.tipo_solucion === 'Insider');
            
            if (!yaExisteInsider) {
                // Agregar soluci√≥n Insider
                const nuevaSolucionInsider = {
                    tipo_solucion: 'Insider',
                    configuraciones: {
                        // Configuraciones b√°sicas del m√≥dulo Insider
                        activo: true
                    }
                };
                
                vehiculo.soluciones.push(nuevaSolucionInsider);
                
                // Actualizar la interfaz
                actualizarInterfazSoluciones(unidadIndex);
                
                // Mostrar mensaje de confirmaci√≥n
                mostrarAlerta('M√≥dulo Insider agregado exitosamente', 'success');
            } else {
                mostrarAlerta('El m√≥dulo Insider ya est√° agregado para esta unidad', 'info');
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAdvertenciaGPS'));
            if (modal) {
                modal.hide();
            }
        }
        
        // Funci√≥n para aplicar reglas de exclusi√≥n
        function aplicarReglasExclusion(unidadIndex, solucionIndex, elementoModificado) {
            const vehiculo = cotizacionData.vehiculos[unidadIndex];
            const solucion = vehiculo.soluciones[solucionIndex];
            const configs = solucion.configuraciones || {};
            
            // Construir el prefijo correcto del ID
            const unidadId = unidadIndex + 1; // Convertir a base 1
            const solucionId = `wizard_unidad_${unidadId}_solucion_${solucionIndex + 1}`;
            
            console.log(`üîß DEBUG: Aplicando reglas de exclusi√≥n para ${solucionId}, elemento: ${elementoModificado}`);
            
            // Reglas de exclusi√≥n para SOS
            if (elementoModificado.includes('sos_')) {
                const sosSimple = document.getElementById(`${solucionId}_sos_simple`);
                const sosLlamada = document.getElementById(`${solucionId}_sos_llamada`);
                const sosBloqueo = document.getElementById(`${solucionId}_sos_bloqueo`);
                
                if (elementoModificado === 'sos_simple' && sosSimple && sosSimple.checked) {
                    // Si se selecciona SOS simple, deshabilitar SOS llamada
                    if (sosLlamada) {
                        sosLlamada.disabled = true;
                        if (sosLlamada.checked) {
                            sosLlamada.checked = false;
                            configs.sos_llamada = false;
                        }
                    }
                } else if (elementoModificado === 'sos_llamada' && sosLlamada && sosLlamada.checked) {
                    // Si se selecciona SOS llamada, deshabilitar SOS simple
                    if (sosSimple) {
                        sosSimple.disabled = true;
                        if (sosSimple.checked) {
                            sosSimple.checked = false;
                            configs.sos_simple = false;
                        }
                    }
                } else if (elementoModificado === 'sos_simple' && sosSimple && !sosSimple.checked) {
                    // Si se deselecciona SOS simple, habilitar SOS llamada
                    if (sosLlamada) {
                        sosLlamada.disabled = false;
                    }
                } else if (elementoModificado === 'sos_llamada' && sosLlamada && !sosLlamada.checked) {
                    // Si se deselecciona SOS llamada, habilitar SOS simple
                    if (sosSimple) {
                        sosSimple.disabled = false;
                    }
                }
            }
            
            // Reglas de exclusi√≥n para bloqueo
            if (elementoModificado.includes('bloqueo_')) {
                const bloqueoNormal = document.getElementById(`${solucionId}_bloqueo_normal`);
                const bloqueoGradual = document.getElementById(`${solucionId}_bloqueo_gradual`);
                const bloqueoCortacorriente = document.getElementById(`${solucionId}_bloqueo_cortacorriente`);
                
                if (elementoModificado === 'bloqueo_normal' && bloqueoNormal && bloqueoNormal.checked) {
                    if (bloqueoGradual) {
                        bloqueoGradual.disabled = true;
                        if (bloqueoGradual.checked) {
                            bloqueoGradual.checked = false;
                            configs.bloqueo_gradual = false;
                        }
                    }
                    if (bloqueoCortacorriente) {
                        bloqueoCortacorriente.disabled = true;
                        if (bloqueoCortacorriente.checked) {
                            bloqueoCortacorriente.checked = false;
                            configs.bloqueo_cortacorriente = false;
                        }
                    }
                } else if (elementoModificado === 'bloqueo_gradual' && bloqueoGradual && bloqueoGradual.checked) {
                    if (bloqueoNormal) {
                        bloqueoNormal.disabled = true;
                        if (bloqueoNormal.checked) {
                            bloqueoNormal.checked = false;
                            configs.bloqueo_normal = false;
                        }
                    }
                    if (bloqueoCortacorriente) {
                        bloqueoCortacorriente.disabled = true;
                        if (bloqueoCortacorriente.checked) {
                            bloqueoCortacorriente.checked = false;
                            configs.bloqueo_cortacorriente = false;
                        }
                    }
                } else if (elementoModificado === 'bloqueo_cortacorriente' && bloqueoCortacorriente && bloqueoCortacorriente.checked) {
                    if (bloqueoNormal) {
                        bloqueoNormal.disabled = true;
                        if (bloqueoNormal.checked) {
                            bloqueoNormal.checked = false;
                            configs.bloqueo_normal = false;
                        }
                    }
                    if (bloqueoGradual) {
                        bloqueoGradual.disabled = true;
                        if (bloqueoGradual.checked) {
                            bloqueoGradual.checked = false;
                            configs.bloqueo_gradual = false;
                        }
                    }
                } else if (elementoModificado === 'bloqueo_normal' && bloqueoNormal && !bloqueoNormal.checked) {
                    if (bloqueoGradual) bloqueoGradual.disabled = false;
                    if (bloqueoCortacorriente) bloqueoCortacorriente.disabled = false;
                } else if (elementoModificado === 'bloqueo_gradual' && bloqueoGradual && !bloqueoGradual.checked) {
                    if (bloqueoNormal) bloqueoNormal.disabled = false;
                    if (bloqueoCortacorriente) bloqueoCortacorriente.disabled = false;
                } else if (elementoModificado === 'bloqueo_cortacorriente' && bloqueoCortacorriente && !bloqueoCortacorriente.checked) {
                    if (bloqueoNormal) bloqueoNormal.disabled = false;
                    if (bloqueoGradual) bloqueoGradual.disabled = false;
                }
            }
            
            // Reglas de exclusi√≥n para audio en cabina
            if (elementoModificado.includes('audio_')) {
                const audioBidireccional = document.getElementById(`${solucionId}_audio_bidireccional`);
                const audioEspia = document.getElementById(`${solucionId}_audio_espia`);
                
                if (elementoModificado === 'audio_bidireccional' && audioBidireccional && audioBidireccional.checked) {
                    if (audioEspia) {
                        audioEspia.disabled = true;
                        if (audioEspia.checked) {
                            audioEspia.checked = false;
                            configs.audio_espia = false;
                        }
                    }
                } else if (elementoModificado === 'audio_espia' && audioEspia && audioEspia.checked) {
                    if (audioBidireccional) {
                        audioBidireccional.disabled = true;
                        if (audioBidireccional.checked) {
                            audioBidireccional.checked = false;
                            configs.audio_bidireccional = false;
                        }
                    }
                } else if (elementoModificado === 'audio_bidireccional' && audioBidireccional && !audioBidireccional.checked) {
                    if (audioEspia) audioEspia.disabled = false;
                } else if (elementoModificado === 'audio_espia' && audioEspia && !audioEspia.checked) {
                    if (audioBidireccional) audioBidireccional.disabled = false;
                }
            }
            
            // Reglas de exclusi√≥n para habilitado en cabina
            if (elementoModificado.includes('teclado_')) {
                const tecladoSencillo = document.getElementById(`${solucionId}_teclado_sencillo`);
                const tecladoDinamico = document.getElementById(`${solucionId}_teclado_dinamico`);
                
                if (elementoModificado === 'teclado_sencillo' && tecladoSencillo && tecladoSencillo.checked) {
                    if (tecladoDinamico) {
                        tecladoDinamico.disabled = true;
                        if (tecladoDinamico.checked) {
                            tecladoDinamico.checked = false;
                            configs.teclado_dinamico = false;
                        }
                    }
                } else if (elementoModificado === 'teclado_dinamico' && tecladoDinamico && tecladoDinamico.checked) {
                    if (tecladoSencillo) {
                        tecladoSencillo.disabled = true;
                        if (tecladoSencillo.checked) {
                            tecladoSencillo.checked = false;
                            configs.teclado_sencillo = false;
                        }
                    }
                } else if (elementoModificado === 'teclado_sencillo' && tecladoSencillo && !tecladoSencillo.checked) {
                    if (tecladoDinamico) tecladoDinamico.disabled = false;
                } else if (elementoModificado === 'teclado_dinamico' && tecladoDinamico && !tecladoDinamico.checked) {
                    if (tecladoSencillo) tecladoSencillo.disabled = false;
                }
            }
            
            // Reglas de exclusi√≥n para sensores de puertas
            if (elementoModificado === 'sensores_puertas') {
                const sensoresJuntos = document.getElementById(`${solucionId}_sensores_juntos`);
                const sensoresIndependientes = document.getElementById(`${solucionId}_sensores_independientes`);
                
                // Los sensores de puertas son radio buttons, por lo que son mutuamente excluyentes por naturaleza
                // Solo necesitamos actualizar la configuraci√≥n
                if (sensoresJuntos && sensoresJuntos.checked) {
                    configs.sensores_puertas = 'juntos';
                    console.log(`üîß DEBUG: Sensores configurados como juntos`);
                } else if (sensoresIndependientes && sensoresIndependientes.checked) {
                    configs.sensores_puertas = 'independientes';
                    console.log(`üîß DEBUG: Sensores configurados como independientes`);
                } else {
                    configs.sensores_puertas = null;
                    console.log(`üîß DEBUG: Sensores deseleccionados`);
                }
            }
            
            // Regla para bloqueo con apertura de puertas
            if (elementoModificado === 'bloqueo_apertura') {
                const bloqueoApertura = document.getElementById(`${solucionId}_bloqueo_apertura`);
                const sensoresJuntos = document.getElementById(`${solucionId}_sensores_juntos`);
                const sensoresIndependientes = document.getElementById(`${solucionId}_sensores_independientes`);
                
                if (bloqueoApertura && bloqueoApertura.checked) {
                    const tieneSensores = (sensoresJuntos && sensoresJuntos.checked) || 
                                        (sensoresIndependientes && sensoresIndependientes.checked);
                    
                    if (!tieneSensores) {
                        // No se puede seleccionar bloqueo con apertura sin sensores de puertas
                        bloqueoApertura.checked = false;
                        configs.bloqueo_apertura = false;
                        mostrarAlerta('Debe seleccionar sensores de puertas antes de activar el bloqueo con apertura', 'warning');
                    }
                }
            }
        }

        // Funci√≥n para manejar cambios en configuraciones
        function manejarCambioConfiguracion(solucionId, configKey, unidadIndex, solucionIndex) {
            console.log(`üîÑ DEBUG: Cambio en configuraci√≥n: ${configKey} para ${solucionId}`);
            
            // Verificar que cotizacionData.vehiculos est√© inicializado
            if (!cotizacionData.vehiculos || !Array.isArray(cotizacionData.vehiculos)) {
                console.warn('‚ö†Ô∏è cotizacionData.vehiculos no est√° inicializado, inicializando...');
                cotizacionData.vehiculos = [];
            }
            
            // Verificar que el √≠ndice de unidad sea v√°lido
            if (unidadIndex >= cotizacionData.vehiculos.length) {
                console.warn(`‚ö†Ô∏è Unidad ${unidadIndex} no existe, creando...`);
                // Crear veh√≠culo b√°sico si no existe
                cotizacionData.vehiculos[unidadIndex] = {
                    soluciones: []
                };
            }
            
            const vehiculo = cotizacionData.vehiculos[unidadIndex];
            
            // Verificar que el veh√≠culo tenga soluciones
            if (!vehiculo.soluciones || !Array.isArray(vehiculo.soluciones)) {
                console.warn(`‚ö†Ô∏è Soluciones no inicializadas para unidad ${unidadIndex}, inicializando...`);
                vehiculo.soluciones = [];
            }
            
            // Verificar que el √≠ndice de soluci√≥n sea v√°lido
            if (solucionIndex >= vehiculo.soluciones.length) {
                console.warn(`‚ö†Ô∏è Soluci√≥n ${solucionIndex} no existe para unidad ${unidadIndex}, creando...`);
                // Crear soluci√≥n b√°sica si no existe
                vehiculo.soluciones[solucionIndex] = {
                    tipo_solucion: '',
                    configuraciones: {}
                };
            }
            
            const solucion = vehiculo.soluciones[solucionIndex];
            
            if (!solucion.configuraciones) {
                solucion.configuraciones = {};
            }
            
            // Actualizar el tipo de soluci√≥n si es necesario
            const tipoSelect = document.getElementById(`${solucionId}_tipo`);
            if (tipoSelect && tipoSelect.value) {
                solucion.tipo_solucion = tipoSelect.value;
                console.log(`üîß DEBUG: Tipo de soluci√≥n actualizado: ${tipoSelect.value}`);
            }
            
            // Actualizar la configuraci√≥n en el objeto de datos
            const elemento = document.getElementById(`${solucionId}_${configKey}`);
            if (elemento) {
                if (elemento.type === 'checkbox') {
                    solucion.configuraciones[configKey] = elemento.checked;
                } else if (elemento.type === 'radio') {
                    if (elemento.checked) {
                        if (configKey === 'sensores_puertas') {
                            solucion.configuraciones[configKey] = elemento.value;
                        } else if (configKey === 'deteccion_jammer') {
                            solucion.configuraciones[configKey] = elemento.value;
                        } else if (configKey === 'audio_bidireccional') {
                            solucion.configuraciones[configKey] = true;
                            solucion.configuraciones['audio_espia'] = false;
                        } else if (configKey === 'audio_espia') {
                            solucion.configuraciones[configKey] = true;
                            solucion.configuraciones['audio_bidireccional'] = false;
                        } else if (configKey === 'teclado_sencillo') {
                            solucion.configuraciones[configKey] = true;
                            solucion.configuraciones['teclado_dinamico'] = false;
                        } else if (configKey === 'teclado_dinamico') {
                            solucion.configuraciones[configKey] = true;
                            solucion.configuraciones['teclado_sencillo'] = false;
                        }
                    }
                }
            }
            
            // Aplicar reglas de exclusi√≥n
            aplicarReglasExclusion(unidadIndex, solucionIndex, configKey);
            
            // Validar entradas y salidas del GPS
            const validacion = validarEntradasSalidasGPS(unidadIndex, solucionIndex);
            
            if (!validacion.valido) {
                console.log(`üö® DEBUG: Mostrando modal de advertencia GPS - ${validacion.mensaje}`);
                mostrarModalAdvertenciaGPS(unidadIndex, solucionIndex, validacion);
            } else {
                console.log(`‚úÖ DEBUG: Configuraci√≥n v√°lida, no se muestra modal`);
                console.log(`‚úÖ DEBUG: Configuraci√≥n v√°lida`);
            }
            
            // Actualizar la interfaz si es necesario
            actualizarInterfazSoluciones(unidadIndex);
        }

        // Funci√≥n para actualizar la interfaz de soluciones
        function actualizarInterfazSoluciones(unidadIndex) {
            console.log(`üîÑ DEBUG: Actualizando interfaz de soluciones para unidad ${unidadIndex + 1}`);
            
            // Esta funci√≥n se puede expandir para actualizar elementos espec√≠ficos de la UI
            // Por ahora, solo logueamos la actualizaci√≥n
            const vehiculo = cotizacionData.vehiculos[unidadIndex];
            console.log(`üìã DEBUG: Soluciones actuales para unidad ${unidadIndex + 1}:`, vehiculo.soluciones.map(s => s.tipo_solucion));
        }

        // Funci√≥n para mapear configuraciones de rastreo a funciones de telemetr√≠a
        function mapearConfiguracionAFuncion(configKey) {
            const mapeoConfiguraciones = {
                // SOS
                'sos_simple': 'SOS simple',
                'sos_llamada': 'SOS llamada', 
                'sos_bloqueo': 'SOS Bloqueo',
                
                // Bloqueos
                'bloqueo_normal': 'Bloqueo normal',
                'bloqueo_cc': 'Bloqueo CC',
                'bloqueo_gradual': 'Bloqueo normal', // Se mapea a bloqueo normal
                'bloqueo_cortacorriente': 'Bloqueo CC',
                
                // Sensores
                'sensores_juntos': 'Sensores juntos',
                'sensores_independientes': 'Sensores independientes',
                'sensores_y_bloqueo': 'Sensores y bloqueo',
                'sensar_puertas': 'sensor caja',
                
                // Audio
                'audio_bidireccional': 'Audio bidireccional',
                'audio_espia': 'Audio esp√≠a',
                'audio_en_cabina': 'Audio bidireccional', // Se mapea a bidireccional
                
                // Habilitado en cabina
                'habilitado_en_cabina': 'habilitado',
                'teclado_sencillo': 'habilitado',
                'teclado_dinamico': 'habilitado'
            };
            
            return mapeoConfiguraciones[configKey] || null;
        }

        // Funci√≥n para generar insumos sugeridos basados en las unidades y soluciones seleccionadas
        let generandoInsumos = false; // Flag para evitar ejecuciones m√∫ltiples
        let ultimaGeneracion = 0; // Timestamp de la √∫ltima generaci√≥n
        
        // Funci√≥n para detectar servicios necesarios seg√∫n las soluciones
        function detectarServiciosNecesarios(vehiculos) {
            const serviciosNecesarios = [];
            
            vehiculos.forEach((vehiculo, unidadIndex) => {
                if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                    vehiculo.soluciones.forEach(solucion => {
                        const tipoSolucion = solucion.tipo_solucion;
                        const configuraciones = solucion.configuraciones || {};
                        
                        // Detectar servicios seg√∫n las soluciones y configuraciones
                        if (configuraciones.hosting) {
                            // Servicios que requieren hosting
                            if (tipoSolucion === 'VPC' || tipoSolucion === 'Dashcam' || 
                                tipoSolucion === 'Encadenamiento de se√±ales' || tipoSolucion === 'Sideview' ||
                                tipoSolucion === 'MDVR 4 Ch' || tipoSolucion === 'MDVR 8 Ch') {
                                serviciosNecesarios.push({
                                    nombre: 'Datos video',
                                    periodicidad: 'mensual',
                                    cantidad: 1,
                                    unidad: unidadIndex + 1,
                                    solucion: tipoSolucion
                                });
                            } else if (tipoSolucion === 'Rastreo basico' || tipoSolucion === 'Rastreo avanzado') {
                                serviciosNecesarios.push({
                                    nombre: 'Datos rastreo basico',
                                    periodicidad: 'mensual',
                                    cantidad: 1,
                                    unidad: unidadIndex + 1,
                                    solucion: tipoSolucion
                                });
                            } else if (tipoSolucion === 'Rastreo satelital') {
                                serviciosNecesarios.push({
                                    nombre: 'Datos - Satelitales',
                                    periodicidad: 'anual',
                                    cantidad: 1,
                                    unidad: unidadIndex + 1,
                                    solucion: tipoSolucion
                                });
                                serviciosNecesarios.push({
                                    nombre: 'Activaci√≥n satelital',
                                    periodicidad: 'anual',
                                    cantidad: 1,
                                    unidad: unidadIndex + 1,
                                    solucion: tipoSolucion
                                });
                            }
                        }
                        
                        // Detectar servicios de voz
                        if (configuraciones.audio_bidireccional || configuraciones.audio_espia || 
                            configuraciones.sos_llamada) {
                            serviciosNecesarios.push({
                                nombre: 'Datos - Voz',
                                periodicidad: 'mensual',
                                cantidad: 1,
                                unidad: unidadIndex + 1,
                                solucion: tipoSolucion
                            });
                        }
                        
                        // Detectar servicios de rastreo avanzado
                        if (tipoSolucion === 'Rastreo avanzado' && configuraciones.hosting) {
                            // Reemplazar el servicio b√°sico con el avanzado
                            const index = serviciosNecesarios.findIndex(s => 
                                s.nombre === 'Datos rastreo basico' && s.unidad === unidadIndex + 1
                            );
                            if (index !== -1) {
                                serviciosNecesarios[index].nombre = 'Datos rastreo avanzado';
                            }
                        }
                    });
                }
            });
            
            return serviciosNecesarios;
        }
        
        // Funci√≥n para detectar SIMs necesarias seg√∫n los servicios
        function detectarSIMsNecesarias(vehiculos) {
            const simsNecesarias = [];
            
            vehiculos.forEach((vehiculo, unidadIndex) => {
                if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                    let tieneVideo = false;
                    let tieneVoz = false;
                    let tieneRastreo = false;
                    
                    vehiculo.soluciones.forEach(solucion => {
                        const tipoSolucion = solucion.tipo_solucion;
                        const configuraciones = solucion.configuraciones || {};
                        
                        if (configuraciones.hosting) {
                            if (tipoSolucion === 'VPC' || tipoSolucion === 'Dashcam' || 
                                tipoSolucion === 'Encadenamiento de se√±ales' || tipoSolucion === 'Sideview' ||
                                tipoSolucion === 'MDVR 4 Ch' || tipoSolucion === 'MDVR 8 Ch') {
                                tieneVideo = true;
                            } else if (tipoSolucion === 'Rastreo basico' || tipoSolucion === 'Rastreo avanzado') {
                                tieneRastreo = true;
                            }
                        }
                        
                        if (configuraciones.audio_bidireccional || configuraciones.audio_espia || 
                            configuraciones.sos_llamada) {
                            tieneVoz = true;
                        }
                    });
                    
                    // Agregar SIMs seg√∫n los servicios detectados
                    if (tieneVideo) {
                        simsNecesarias.push({
                            nombre: 'SIM video',
                            cantidad: 1,
                            unidad: unidadIndex + 1,
                            razon: 'Servicio de video'
                        });
                    }
                    
                    if (tieneVoz) {
                        simsNecesarias.push({
                            nombre: 'SIM voz',
                            cantidad: 1,
                            unidad: unidadIndex + 1,
                            razon: 'Servicio de voz'
                        });
                    }
                    
                    if (tieneRastreo) {
                        simsNecesarias.push({
                            nombre: 'SIM 5 Mb',
                            cantidad: 1,
                            unidad: unidadIndex + 1,
                            razon: 'Servicio de rastreo'
                        });
                    }
                }
            });
            
            return simsNecesarias;
        }
        
        async function generarInsumosSugeridos() {
            console.log('üîÑ DEBUG: Iniciando generarInsumosSugeridos()...');
            const container = document.getElementById('insumosSugeridosContainer');
            if (!container) {
                console.log('‚ùå DEBUG: Container insumosSugeridosContainer no encontrado');
                return;
            }
            
            const ahora = Date.now();
            
            if (generandoInsumos) {
                console.log('‚è≥ Ya se est√°n generando insumos, saltando...');
                return;
            }
            
            // Evitar generaciones muy frecuentes (menos de 2 segundos)
            if (ahora - ultimaGeneracion < 2000) {
                console.log('‚è≥ Generaci√≥n muy reciente, saltando...');
                return;
            }
            
            generandoInsumos = true;
            ultimaGeneracion = ahora;
            console.log('Generando insumos sugeridos...');
            
            // Asegurar que el almac√©n est√© cargado desde Supabase
            if (modoCentralizado) {
                await cargarAlmacenDesdeSupabase();
                // Tambi√©n recargar funciones de rastreo
                await cargarFuncionesRastreo();
            }
            
            // Obtener datos actuales
            guardarPasoActual();
            
            const vehiculos = cotizacionData.vehiculos || [];
            let todosLosInsumos = {};
            
            // Generar equipos autom√°ticos
            const equiposAutomaticos = generarEquiposAutomaticos(vehiculos);
            
            // Agregar equipos autom√°ticos a la lista de insumos
            Object.values(equiposAutomaticos).forEach(equipo => {
                todosLosInsumos[equipo.nombre] = {
                    nombre: equipo.nombre,
                    cantidad: equipo.cantidad,
                    unidades: equipo.unidades,
                    sugerido: true,
                    categoria: equipo.categoria || 'equipos' // Usar la categor√≠a definida en el equipo
                };
            });

            // Procesar cada unidad y sus soluciones
            vehiculos.forEach((vehiculo, unidadIndex) => {
                const tipoUnidad = vehiculo.tipo || 'Tracto'; // Default a Tracto si no hay tipo
                
                // Accesorios √∫nicos por unidad (evitar duplicados por m√∫ltiples soluciones en la misma unidad)
                let accesoriosUnicosEnUnidad = {};
                
                if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                    vehiculo.soluciones.forEach(solucion => {
                        const tipoSolucion = solucion.tipo_solucion;
                        const insumosSugeridos = obtenerInsumosSugeridos(tipoUnidad, tipoSolucion);

                        // Ajustes por reglas de negocio
                        let insumosAjustados = Array.isArray(insumosSugeridos) ? [...insumosSugeridos] : [];

                        // 0) Dashcam: limpiar variantes del almac√©n (AD2/C6) para no duplicar
                        if (tipoSolucion === 'Dashcam') {
                            insumosAjustados = insumosAjustados.filter(i => i.nombre !== 'Dashcam ad2' && i.nombre !== 'Dashcam c6');
                        }

                        // 1) Memoria seleccionada en Dashcam
                        if (tipoSolucion === 'Dashcam') {
                            const memoriaSel = solucion.configuraciones?.memoria;
                            if (memoriaSel === '128' || memoriaSel === '256' || memoriaSel === '512') {
                                insumosAjustados = insumosAjustados.filter(i => i.nombre !== 'SD 128 Gb' && i.nombre !== 'SD 256 Gb' && i.nombre !== 'SD 512 Gb');
                                insumosAjustados.push({ nombre: `SD ${memoriaSel} Gb`, cantidad: 1, sugerido: true });
                            }
                        }

                        // 2) Silicon solo para c√°maras laterales y encadenamiento
                        const permitirSilicon = (
                            tipoSolucion === 'Sideview' ||
                            (tipoSolucion && tipoSolucion.toLowerCase().startsWith('encadenamiento')) ||
                            (tipoSolucion === 'VPC' && (solucion.configuraciones?.camara_izquierda === true || solucion.configuraciones?.camara_derecha === true || solucion.configuraciones?.encadenamiento === true))
                        );
                        if (!permitirSilicon) {
                            insumosAjustados = insumosAjustados.filter(i => i.nombre !== 'Silicon');
                        }

                        // Consolidar insumos b√°sicos (sumar cantidades si se repiten)
                        insumosAjustados.forEach(insumo => {
                            const key = insumo.nombre;
                            const categoria = obtenerCategoriaInsumo(insumo.nombre);
                            
                            // Para accesorios, verificar si ya se agreg√≥ en esta unidad
                            if (categoria === 'accesorios') {
                                if (accesoriosUnicosEnUnidad[key]) {
                                    // Ya se agreg√≥ este accesorio en esta unidad, no duplicar
                                    return;
                                } else {
                                    // Marcar como agregado en esta unidad
                                    accesoriosUnicosEnUnidad[key] = true;
                                }
                            }
                            
                            if (todosLosInsumos[key]) {
                                // Si ya existe, sumar cantidades (convertir a n√∫mero si es posible)
                                const cantidadAnterior = parseFloat(todosLosInsumos[key].cantidad) || 0;
                                const cantidadNueva = parseFloat(insumo.cantidad) || 0;
                                
                                if (!isNaN(cantidadAnterior) && !isNaN(cantidadNueva)) {
                                    todosLosInsumos[key].cantidad = cantidadAnterior + cantidadNueva;
                                } else {
                                    // Si no se pueden convertir a n√∫meros, mantener como string
                                    todosLosInsumos[key].cantidad = `${todosLosInsumos[key].cantidad} + ${insumo.cantidad}`;
                                }
                                todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (${tipoSolucion})`);
                            } else {
                                todosLosInsumos[key] = {
                                    nombre: insumo.nombre,
                                    cantidad: insumo.cantidad,
                                    unidades: [`Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: categoria
                                };
                            }
                        });

                        // Procesar accesorios de telemetr√≠a para soluciones de rastreo
                        if (['Rastreo basico', 'Rastreo avanzado', 'Rastreo satelital'].includes(tipoSolucion)) {
                            const funcionesSeleccionadas = [];
                            
                            // Extraer funciones seleccionadas de las configuraciones
                            if (solucion.configuraciones) {
                                Object.keys(solucion.configuraciones).forEach(configKey => {
                                    const configValue = solucion.configuraciones[configKey];
                                    
                                    // Mapear configuraciones a funciones de telemetr√≠a
                                    if (configValue === true || configValue === 'true') {
                                        const funcionTelemetria = mapearConfiguracionAFuncion(configKey);
                                        if (funcionTelemetria) {
                                            funcionesSeleccionadas.push(funcionTelemetria);
                                        }
                                    }
                                });
                            }

                            // Obtener accesorios de telemetr√≠a
                            if (funcionesSeleccionadas.length > 0) {
                                const accesoriosTelemetria = obtenerAccesoriosTelemetria(funcionesSeleccionadas);
                                
                                // Agregar accesorios de telemetr√≠a a la lista de insumos
                                accesoriosTelemetria.forEach(accesorio => {
                                    const key = accesorio.nombre;
                                    if (todosLosInsumos[key]) {
                                        // L√≥gica especial para relevador (m√°ximo 1 por unidad)
                                        if (accesorio.nombre === 'Relevador') {
                                            todosLosInsumos[key].cantidad = 1;
                                        } else {
                                            todosLosInsumos[key].cantidad = parseFloat(todosLosInsumos[key].cantidad) + accesorio.cantidad;
                                        }
                                        todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (${tipoSolucion} - Telemetr√≠a)`);
                                    } else {
                                        todosLosInsumos[key] = {
                                            nombre: accesorio.nombre,
                                            cantidad: accesorio.cantidad,
                                            unidades: [`Unidad ${unidadIndex + 1} (${tipoSolucion} - Telemetr√≠a)`],
                                            sugerido: true,
                                            deTelemetria: true,
                                            categoria: obtenerCategoriaInsumo(accesorio.nombre)
                                        };
                                    }
                                });
                            }
                        }
                        
                        // Procesar insumos para soluciones compatibles de VPC
                        console.log(`üîç DEBUG: Verificando compatibles para soluci√≥n: ${tipoSolucion}`);
                        console.log(`üîç DEBUG: Configuraciones:`, solucion.configuraciones);
                        
                        if (tipoSolucion === 'VPC' && solucion.configuraciones) {
                            console.log(`‚úÖ DEBUG: Procesando compatibles de VPC para Unidad ${unidadIndex + 1}`);
                            const configs = solucion.configuraciones;
                            console.log(`üîë DEBUG: Claves disponibles en configuraciones:`, Object.keys(configs));
                            const solucionesCompatibles = [];
                            
                            // Identificar soluciones compatibles seleccionadas con configuraciones espec√≠ficas
                            if (configs.sensor_vpc === true) {
                                // Procesar sensores VPC con lados espec√≠ficos
                                const sensorCantidad = parseInt(configs.sensor_cantidad) || 1;
                                if (configs.sensor_izquierda === true) {
                                    solucionesCompatibles.push({
                                        nombre: 'Sensor VPC izquierdo',
                                        cantidad: sensorCantidad
                                    });
                                    console.log(`‚úÖ DEBUG: Sensor VPC izquierdo x${sensorCantidad}`);
                                }
                                if (configs.sensor_derecha === true) {
                                    solucionesCompatibles.push({
                                        nombre: 'Sensor VPC derecho',
                                        cantidad: sensorCantidad
                                    });
                                    console.log(`‚úÖ DEBUG: Sensor VPC derecho x${sensorCantidad}`);
                                }
                            }
                            
                            // Reglas: Silicon solo si hay c√°maras laterales o encadenamiento
                            if ((configs.camara_izquierda === true || configs.camara_derecha === true) || configs.encadenamiento === true) {
                                const keySilicon = 'Silicon';
                                const cantidadSilicon = '1/10';
                                if (!todosLosInsumos[keySilicon]) {
                                    todosLosInsumos[keySilicon] = {
                                        nombre: keySilicon,
                                        cantidad: cantidadSilicon,
                                        unidades: [`Unidad ${unidadIndex + 1} (${tipoSolucion} - Requisito instalaci√≥n c√°maras/encadenamiento)`],
                                        sugerido: true,
                                        categoria: obtenerCategoriaInsumo(keySilicon)
                                    };
                                }
                            }

                            if (configs.alarma_parlante_estandar === true) {
                                const alarmaCantidad = parseInt(configs.alarma_cantidad) || 1;
                                solucionesCompatibles.push({
                                    nombre: 'Alarma parlante estandar',
                                    cantidad: alarmaCantidad
                                });
                                console.log(`‚úÖ DEBUG: Alarma parlante x${alarmaCantidad}`);
                            }
                            
                            if (configs.led_giro === true) {
                                // Procesar leds de giro con lados espec√≠ficos
                                const ledCantidad = parseInt(configs.led_cantidad) || 1;
                                if (configs.led_izquierda === true) {
                                    solucionesCompatibles.push({
                                        nombre: 'Led de giro izquierdo',
                                        cantidad: ledCantidad
                                    });
                                    console.log(`‚úÖ DEBUG: Led de giro izquierdo x${ledCantidad}`);
                                }
                                if (configs.led_derecha === true) {
                                    solucionesCompatibles.push({
                                        nombre: 'Led de giro derecho',
                                        cantidad: ledCantidad
                                    });
                                    console.log(`‚úÖ DEBUG: Led de giro derecho x${ledCantidad}`);
                                }
                            }
                            
                            if (configs.encadenamiento === true) {
                                // Para encadenamiento, usar el tipo espec√≠fico
                                const tipoEncadenamiento = configs.tipo_encadenamiento || 'sencillo';
                                solucionesCompatibles.push({
                                    nombre: `Encadenamiento ${tipoEncadenamiento}`,
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Encadenamiento ${tipoEncadenamiento} detectado`);
                            }
                            
                            console.log(`üìã DEBUG: Soluciones compatibles encontradas:`, solucionesCompatibles);
                            
                            // Buscar insumos para cada soluci√≥n compatible
                            solucionesCompatibles.forEach(solucionCompatible => {
                                const nombreSolucion = solucionCompatible.nombre;
                                const cantidadSolucion = solucionCompatible.cantidad;
                                
                                console.log(`üîç DEBUG: Buscando insumos para: ${nombreSolucion} x${cantidadSolucion}`);
                                const insumosCompatible = obtenerInsumosSugeridos(tipoUnidad, nombreSolucion);
                                console.log(`üì¶ DEBUG: Insumos encontrados:`, insumosCompatible.length);
                                
                                if (insumosCompatible && insumosCompatible.length > 0) {
                                    insumosCompatible.forEach(insumo => {
                                        const key = insumo.nombre;
                                        const categoria = obtenerCategoriaInsumo(insumo.nombre);
                                        
                                        // Multiplicar la cantidad del insumo por la cantidad de la soluci√≥n
                                        // Manejar valores fraccionarios como strings
                                        let cantidadInsumo = insumo.cantidad;
                                        let cantidadFinal;
                                        if (typeof cantidadInsumo === 'string' && cantidadInsumo.includes('/')) {
                                            // Para valores como '1/2', '1/10', mantener como string
                                            cantidadFinal = cantidadInsumo;
                                        } else {
                                            // Para valores num√©ricos, multiplicar
                                            cantidadFinal = parseFloat(cantidadInsumo) * cantidadSolucion;
                                        }
                                        
                                        console.log(`‚ûï DEBUG: Agregando: ${insumo.nombre} (${categoria}) x${cantidadFinal}`);
                                        
                                        // Para accesorios, verificar si ya se agreg√≥ en esta unidad
                                        if (categoria === 'accesorios') {
                                            if (accesoriosUnicosEnUnidad[key]) {
                                                // Ya se agreg√≥ este accesorio en esta unidad, no duplicar
                                                console.log(`‚ö†Ô∏è DEBUG: Accesorio ya agregado: ${key}`);
                                                return;
                                            } else {
                                                // Marcar como agregado en esta unidad
                                                accesoriosUnicosEnUnidad[key] = true;
                                            }
                                        }
                                        
                                        if (todosLosInsumos[key]) {
                                            // Si ya existe, sumar cantidades
                                            if (typeof cantidadFinal === 'string' && cantidadFinal.includes('/')) {
                                                // Para valores fraccionarios, mantener el string
                                                todosLosInsumos[key].cantidad = cantidadFinal;
                                            } else {
                                                // Para valores num√©ricos, sumar
                                                todosLosInsumos[key].cantidad += cantidadFinal;
                                            }
                                            todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (VPC - ${nombreSolucion} x${cantidadSolucion})`);
                                            console.log(`üìä DEBUG: Sumando: ${key} = ${todosLosInsumos[key].cantidad}`);
                                        } else {
                                            // Crear nuevo insumo
                                            todosLosInsumos[key] = {
                                                nombre: insumo.nombre,
                                                cantidad: cantidadFinal,
                                                unidades: [`Unidad ${unidadIndex + 1} (VPC - ${nombreSolucion} x${cantidadSolucion})`],
                                                sugerido: true,
                                                categoria: categoria
                                            };
                                            console.log(`‚ú® DEBUG: Nuevo insumo: ${key} = ${cantidadFinal}`);
                                        }
                                    });
                                }
                            });
                        } else if (tipoSolucion === 'Sideview' && solucion.configuraciones) {
                            console.log(`‚úÖ DEBUG: Procesando compatibles de Sideview para Unidad ${unidadIndex + 1}`);
                            const configs = solucion.configuraciones;
                            console.log(`üîë DEBUG: Claves disponibles en configuraciones:`, Object.keys(configs));
                            const solucionesCompatibles = [];
                            
                            // Para Sideview, procesar lados espec√≠ficos
                            if (configs.izquierdo === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Sideview izquierdo',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Sideview izquierdo detectado`);
                            }
                            if (configs.derecho === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Sideview derecho',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Sideview derecho detectado`);
                            }
                            
                            console.log(`üìã DEBUG: Soluciones compatibles encontradas:`, solucionesCompatibles);
                            
                            // Buscar insumos para cada soluci√≥n compatible
                            solucionesCompatibles.forEach(solucionCompatible => {
                                const nombreSolucion = solucionCompatible.nombre;
                                const cantidadSolucion = solucionCompatible.cantidad;
                                
                                console.log(`üîç DEBUG: Buscando insumos para: ${nombreSolucion} x${cantidadSolucion}`);
                                const insumosCompatible = obtenerInsumosSugeridos(tipoUnidad, nombreSolucion);
                                console.log(`üì¶ DEBUG: Insumos encontrados:`, insumosCompatible.length);
                                
                                if (insumosCompatible && insumosCompatible.length > 0) {
                                    insumosCompatible.forEach(insumo => {
                                        const key = insumo.nombre;
                                        const categoria = obtenerCategoriaInsumo(insumo.nombre);
                                        
                                        // Multiplicar la cantidad del insumo por la cantidad de la soluci√≥n
                                        let cantidadInsumo = insumo.cantidad;
                                        let cantidadFinal;
                                        if (typeof cantidadInsumo === 'string' && cantidadInsumo.includes('/')) {
                                            cantidadFinal = cantidadInsumo;
                                        } else {
                                            cantidadFinal = parseFloat(cantidadInsumo) * cantidadSolucion;
                                        }
                                        
                                        console.log(`‚ûï DEBUG: Agregando: ${insumo.nombre} (${categoria}) x${cantidadFinal}`);
                                        
                                        // Para accesorios, verificar si ya se agreg√≥ en esta unidad
                                        if (categoria === 'accesorios') {
                                            if (accesoriosUnicosEnUnidad[key]) {
                                                console.log(`‚ö†Ô∏è DEBUG: Accesorio ya agregado: ${key}`);
                                                return;
                                            } else {
                                                accesoriosUnicosEnUnidad[key] = true;
                                            }
                                        }
                                        
                                        if (todosLosInsumos[key]) {
                                            if (typeof cantidadFinal === 'string' && cantidadFinal.includes('/')) {
                                                todosLosInsumos[key].cantidad = cantidadFinal;
                                            } else {
                                                todosLosInsumos[key].cantidad += cantidadFinal;
                                            }
                                            todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (Sideview - ${nombreSolucion} x${cantidadSolucion})`);
                                            console.log(`üìä DEBUG: Sumando: ${key} = ${todosLosInsumos[key].cantidad}`);
                                        } else {
                                            todosLosInsumos[key] = {
                                                nombre: insumo.nombre,
                                                cantidad: cantidadFinal,
                                                unidades: [`Unidad ${unidadIndex + 1} (Sideview - ${nombreSolucion} x${cantidadSolucion})`],
                                                sugerido: true,
                                                categoria: categoria
                                            };
                                            console.log(`‚ú® DEBUG: Nuevo insumo: ${key} = ${cantidadFinal}`);
                                        }
                                    });
                                }
                            });

                            // Regla: Silicon para Sideview (c√°maras laterales)
                            const keySiliconSV = 'Silicon';
                            const cantidadSiliconSV = '1/10';
                            if (!todosLosInsumos[keySiliconSV]) {
                                todosLosInsumos[keySiliconSV] = {
                                    nombre: keySiliconSV,
                                    cantidad: cantidadSiliconSV,
                                    unidades: [`Unidad ${unidadIndex + 1} (Sideview - C√°maras laterales)`],
                                    sugerido: true,
                                    categoria: obtenerCategoriaInsumo(keySiliconSV)
                                };
                            }
                        } else if (tipoSolucion === 'Rastreo avanzado' && solucion.configuraciones) {
                            console.log(`‚úÖ DEBUG: Procesando compatibles de Rastreo avanzado para Unidad ${unidadIndex + 1}`);
                            const configs = solucion.configuraciones;
                            console.log(`üîë DEBUG: Claves disponibles en configuraciones:`, Object.keys(configs));
                            const solucionesCompatibles = [];
                            
                            // Obtener cantidad de botones configurada
                            const cantidadBotones = configs.cantidad_botones || 1;
                            console.log(`üî¢ DEBUG: Cantidad de botones configurada: ${cantidadBotones}`);
                            
                            // Procesar funcionalidades de rastreo
                            if (configs.sos_simple === true) {
                                solucionesCompatibles.push({
                                    nombre: 'SOS simple',
                                    cantidad: cantidadBotones
                                });
                                console.log(`‚úÖ DEBUG: SOS simple detectado x${cantidadBotones}`);
                            }
                            if (configs.sos_llamada === true) {
                                solucionesCompatibles.push({
                                    nombre: 'SOS llamada',
                                    cantidad: cantidadBotones
                                });
                                console.log(`‚úÖ DEBUG: SOS llamada detectado x${cantidadBotones}`);
                            }
                            if (configs.sos_bloqueo === true) {
                                solucionesCompatibles.push({
                                    nombre: 'SOS Bloqueo',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: SOS Bloqueo detectado`);
                            }
                            
                            // Verificar si hay alg√∫n tipo de bloqueo para agregar relevador
                            let tieneBloqueo = false;
                            if (configs.bloqueo_normal === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Bloqueo normal',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Bloqueo normal detectado`);
                                tieneBloqueo = true;
                            }
                            if (configs.bloqueo_gradual === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Bloqueo gradual',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Bloqueo gradual detectado`);
                                tieneBloqueo = true;
                            }
                            if (configs.bloqueo_cortacorriente === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Bloqueo cortacorriente',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Bloqueo cortacorriente detectado`);
                                tieneBloqueo = true;
                            }
                            if (configs.bloqueo_cc === true) {
                                solucionesCompatibles.push({
                                    nombre: 'Bloqueo CC',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Bloqueo CC detectado`);
                                tieneBloqueo = true;
                            }
                            
                            // Procesar sensores
                            if (configs.sensores_puertas === 'juntos') {
                                solucionesCompatibles.push({
                                    nombre: 'Sensores juntos',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Sensores juntos detectado`);
                            } else if (configs.sensores_puertas === 'independientes') {
                                solucionesCompatibles.push({
                                    nombre: 'Sensores independientes',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Sensores independientes detectado`);
                            }
                            
                            // Procesar audio
                            if (configs.audio_cabina === 'bidireccional') {
                                solucionesCompatibles.push({
                                    nombre: 'Audio bidireccional',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Audio bidireccional detectado`);
                            } else if (configs.audio_cabina === 'espia') {
                                solucionesCompatibles.push({
                                    nombre: 'Audio esp√≠a',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Audio esp√≠a detectado`);
                            }
                            
                            // Procesar sensor de caja
                            if (configs.sensor_caja === true) {
                                solucionesCompatibles.push({
                                    nombre: 'sensor caja',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Sensor caja detectado`);
                            }
                            
                            // Procesar teclado
                            if (configs.teclado === 'sencillo') {
                                solucionesCompatibles.push({
                                    nombre: 'teclado_sencillo',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Teclado sencillo detectado`);
                            } else if (configs.teclado === 'dinamico') {
                                solucionesCompatibles.push({
                                    nombre: 'teclado_dinamico',
                                    cantidad: 1
                                });
                                console.log(`‚úÖ DEBUG: Teclado din√°mico detectado`);
                            }
                            
                            console.log(`üìã DEBUG: Soluciones compatibles encontradas:`, solucionesCompatibles);
                            
                            // Agregar bot√≥n membrana basado en la cantidad configurada
                            if (cantidadBotones > 0) {
                                const key = 'Boton membrana';
                                const categoria = 'accesorios';
                                
                                console.log(`üîò DEBUG: Agregando bot√≥n membrana x${cantidadBotones} por unidad`);
                                
                                if (todosLosInsumos[key]) {
                                    // Los botones se multiplican por unidad, no se suman
                                    todosLosInsumos[key].cantidad = cantidadBotones; // Se multiplicar√° despu√©s por cantidadUnidades
                                    todosLosInsumos[key].unidades = [`Unidad ${unidadIndex + 1} (Rastreo - Botones x${cantidadBotones})`];
                                    console.log(`üìä DEBUG: Configurando: ${key} = ${cantidadBotones} por unidad`);
                                } else {
                                    todosLosInsumos[key] = {
                                        nombre: 'Boton membrana',
                                        cantidad: cantidadBotones, // Se multiplicar√° despu√©s por cantidadUnidades
                                        unidades: [`Unidad ${unidadIndex + 1} (Rastreo - Botones x${cantidadBotones})`],
                                        sugerido: true,
                                        categoria: categoria
                                    };
                                    console.log(`‚ú® DEBUG: Nuevo insumo: ${key} = ${cantidadBotones} por unidad`);
                                }
                            }
                            
                            // Agregar relevador si hay alg√∫n tipo de bloqueo (1 por unidad)
                            if (tieneBloqueo) {
                                // Obtener voltaje de la unidad actual
                                const voltaje = vehiculo.voltaje || '12v'; // Default a 12v si no se especifica
                                const keyRelevador = voltaje === '24v' ? 'Relevador 24v' : 'Relevador 12v';
                                const keyPortarelevador = 'Portarelevador';
                                const categoria = 'insumos';
                                
                                console.log(`üîå DEBUG: Agregando relevador ${voltaje} x1 por unidad (hay bloqueo)`);
                                
                                // ELIMINAR TODOS los tipos de relevadores existentes para evitar duplicaci√≥n
                                Object.keys(todosLosInsumos).forEach(key => {
                                    if (key.includes('Relevador') && key !== keyRelevador) {
                                        console.log(`üóëÔ∏è DEBUG: Eliminando relevador duplicado: ${key}`);
                                        delete todosLosInsumos[key];
                                    }
                                });
                                
                                // Agregar relevador seg√∫n voltaje
                                todosLosInsumos[keyRelevador] = {
                                    nombre: keyRelevador,
                                    cantidad: 1, // Se multiplicar√° despu√©s por cantidadUnidades
                                    unidades: [`Unidad ${unidadIndex + 1} (Rastreo - Bloqueo x1)`],
                                    sugerido: true,
                                    categoria: categoria
                                };
                                console.log(`‚ú® DEBUG: Agregando relevador correcto: ${keyRelevador} = 1 por unidad`);
                                
                                // Agregar portarelevador autom√°ticamente
                                todosLosInsumos[keyPortarelevador] = {
                                    nombre: keyPortarelevador,
                                    cantidad: 1, // Se multiplicar√° despu√©s por cantidadUnidades
                                    unidades: [`Unidad ${unidadIndex + 1} (Rastreo - Bloqueo x1)`],
                                    sugerido: true,
                                    categoria: categoria
                                };
                                console.log(`‚ú® DEBUG: Agregando portarelevador: ${keyPortarelevador} = 1 por unidad`);
                            }
                            
                            // Buscar insumos para cada soluci√≥n compatible
                            solucionesCompatibles.forEach(solucionCompatible => {
                                const nombreSolucion = solucionCompatible.nombre;
                                const cantidadSolucion = solucionCompatible.cantidad;
                                
                                console.log(`üîç DEBUG: Buscando insumos para: ${nombreSolucion} x${cantidadSolucion}`);
                                const insumosCompatible = obtenerInsumosRastreo(nombreSolucion);
                                console.log(`üì¶ DEBUG: Insumos encontrados:`, insumosCompatible.length);
                                
                                if (insumosCompatible && insumosCompatible.length > 0) {
                                    insumosCompatible.forEach(insumo => {
                                        const key = insumo.nombre;
                                        const categoria = obtenerCategoriaInsumo(insumo.nombre);
                                        
                                        // Saltar TODOS los tipos de relevadores si ya los manejamos de manera especial
                                        if (key.includes('Relevador') && tieneBloqueo) {
                                            console.log(`‚è≠Ô∏è DEBUG: Saltando ${key} (ya manejado por bloqueo - voltaje ${vehiculo.voltaje || '12v'})`);
                                            return;
                                        }
                                        
                                        // Multiplicar la cantidad del insumo por la cantidad de la soluci√≥n
                                        let cantidadInsumo = insumo.cantidad;
                                        let cantidadFinal;
                                        if (typeof cantidadInsumo === 'string' && cantidadInsumo.includes('/')) {
                                            cantidadFinal = cantidadInsumo;
                                        } else {
                                            cantidadFinal = parseFloat(cantidadInsumo) * cantidadSolucion;
                                        }
                                        
                                        console.log(`‚ûï DEBUG: Agregando: ${insumo.nombre} (${categoria}) x${cantidadFinal}`);
                                        
                                        // Para accesorios, verificar si ya se agreg√≥ en esta unidad
                                        if (categoria === 'accesorios') {
                                            if (accesoriosUnicosEnUnidad[key]) {
                                                console.log(`‚ö†Ô∏è DEBUG: Accesorio ya agregado: ${key}`);
                                                return;
                                            } else {
                                                accesoriosUnicosEnUnidad[key] = true;
                                            }
                                        }
                                        
                                        if (todosLosInsumos[key]) {
                                            // Para botones, reemplazar en lugar de sumar
                                            if (key === 'Boton membrana') {
                                                todosLosInsumos[key].cantidad = cantidadFinal;
                                                console.log(`üìä DEBUG: Reemplazando botones: ${key} = ${cantidadFinal}`);
                                            } else if (typeof cantidadFinal === 'string' && cantidadFinal.includes('/')) {
                                                todosLosInsumos[key].cantidad = cantidadFinal;
                                            } else {
                                                todosLosInsumos[key].cantidad += cantidadFinal;
                                            }
                                            todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (Rastreo - ${nombreSolucion} x${cantidadSolucion})`);
                                            console.log(`üìä DEBUG: Sumando: ${key} = ${todosLosInsumos[key].cantidad}`);
                                        } else {
                                            todosLosInsumos[key] = {
                                                nombre: insumo.nombre,
                                                cantidad: cantidadFinal,
                                                unidades: [`Unidad ${unidadIndex + 1} (Rastreo - ${nombreSolucion} x${cantidadSolucion})`],
                                                sugerido: true,
                                                categoria: categoria
                                            };
                                            console.log(`‚ú® DEBUG: Nuevo insumo: ${key} = ${cantidadFinal}`);
                                        }
                                        
                                    });
                                }
                            });
                        } else {
                            console.log(`‚ùå DEBUG: No se procesan compatibles - tipoSolucion: ${tipoSolucion}, configuraciones:`, !!solucion.configuraciones);
                        }
                    });
                }
            });

            // Detectar servicios necesarios
            const serviciosNecesarios = detectarServiciosNecesarios(vehiculos);
            const simsNecesarias = detectarSIMsNecesarias(vehiculos);
            
            // Agregar SIMs como insumos
            simsNecesarias.forEach(sim => {
                const key = sim.nombre;
                if (todosLosInsumos[key]) {
                    todosLosInsumos[key].cantidad += sim.cantidad;
                    todosLosInsumos[key].unidades.push(`Unidad ${sim.unidad} (${sim.razon})`);
                } else {
                    todosLosInsumos[key] = {
                        nombre: sim.nombre,
                        cantidad: sim.cantidad,
                        unidades: [`Unidad ${sim.unidad} (${sim.razon})`],
                        sugerido: true,
                        categoria: 'insumos'
                    };
                }
            });
            
            // Guardar servicios en cotizacionData
            cotizacionData.serviciosSugeridos = serviciosNecesarios;
            
            // Aplicar reglas fijas por unidad y multiplicar por cantidad de unidades
            const cantidadUnidades = cotizacionData.cantidadLote || vehiculos.length;
            const tipoVenta = cotizacionData.tipoVenta || 'instalacion';
            console.log(`üî¢ DEBUG: Aplicando reglas para ${cantidadUnidades} unidades (lote: ${cotizacionData.cantidadLote}, vehiculos: ${vehiculos.length}, tipo: ${tipoVenta})`);
            
            // Insumos de excepci√≥n para venta sin instalaci√≥n
            const insumosExcepcion = [
                'Boton membrana',
                'Relevador 12v',
                'Boton de balancin'
            ];
            
            // Si es solo venta, filtrar solo insumos (mantener equipos y accesorios)
            if (tipoVenta === 'venta') {
                console.log(`üõí DEBUG: Modo venta - filtrando solo insumos, manteniendo equipos y accesorios`);
                const insumosFiltrados = {};
                
                Object.keys(todosLosInsumos).forEach(key => {
                    const insumo = todosLosInsumos[key];
                    
                    // Mantener todos los equipos y accesorios
                    if (insumo.categoria === 'equipos' || insumo.categoria === 'accesorios') {
                        insumosFiltrados[key] = insumo;
                        console.log(`‚úÖ DEBUG: Manteniendo ${insumo.categoria}: ${insumo.nombre}`);
                    }
                    // Para insumos, mantener solo los de excepci√≥n
                    else if (insumo.categoria === 'insumos') {
                        if (insumosExcepcion.some(excepcion => insumo.nombre.includes(excepcion))) {
                            insumosFiltrados[key] = insumo;
                            console.log(`‚úÖ DEBUG: Manteniendo insumo de excepci√≥n: ${insumo.nombre}`);
                        } else {
                            console.log(`‚ùå DEBUG: Eliminando insumo: ${insumo.nombre}`);
                        }
                    }
                    // Mantener otros tipos (por si acaso)
                    else {
                        insumosFiltrados[key] = insumo;
                        console.log(`‚úÖ DEBUG: Manteniendo ${insumo.categoria || 'desconocido'}: ${insumo.nombre}`);
                    }
                });
                
                // Reemplazar todosLosInsumos con los filtrados
                Object.keys(todosLosInsumos).forEach(key => delete todosLosInsumos[key]);
                Object.assign(todosLosInsumos, insumosFiltrados);
            }
            
            // Reglas fijas por unidad (solo para instalaci√≥n)
            // Nota: Se elimina 'Silicon' de las reglas fijas. Solo se sugiere
            // en soluciones con c√°maras laterales y encadenamiento de se√±al.
            const reglasFijas = tipoVenta === 'instalacion' ? {
                'Cinta de tela': 0.5,
                'Cinta de aislar': 0.5
            } : {};
            
            // Aplicar reglas fijas (por unidad)
            Object.keys(reglasFijas).forEach(insumo => {
                const cantidadPorUnidad = reglasFijas[insumo];
                const cantidadTotal = cantidadPorUnidad * cantidadUnidades;
                
                if (todosLosInsumos[insumo]) {
                    // Si ya existe, reemplazar con la cantidad calculada
                    todosLosInsumos[insumo].cantidad = cantidadTotal;
                    todosLosInsumos[insumo].unidades = [`Regla fija: ${cantidadPorUnidad} por unidad x ${cantidadUnidades} unidades`];
                    todosLosInsumos[insumo].reglaFija = true;
                    console.log(`üîß DEBUG: Regla fija aplicada: ${insumo} = ${cantidadPorUnidad} x ${cantidadUnidades} = ${cantidadTotal}`);
                } else {
                    // Si no existe, crear con la cantidad calculada
                    todosLosInsumos[insumo] = {
                        nombre: insumo,
                        cantidad: cantidadTotal,
                        unidades: [`Regla fija: ${cantidadPorUnidad} por unidad x ${cantidadUnidades} unidades`],
                        sugerido: true,
                        categoria: 'insumos',
                        reglaFija: true
                    };
                    console.log(`üîß DEBUG: Regla fija creada: ${insumo} = ${cantidadPorUnidad} x ${cantidadUnidades} = ${cantidadTotal}`);
                }
            });
            
            // Multiplicar todos los dem√°s insumos por la cantidad de unidades
            Object.keys(todosLosInsumos).forEach(key => {
                const insumo = todosLosInsumos[key];
                if (!insumo.reglaFija && typeof insumo.cantidad === 'number') {
                    const cantidadOriginal = insumo.cantidad;
                    insumo.cantidad = cantidadOriginal * cantidadUnidades;
                    console.log(`üî¢ DEBUG: Multiplicado: ${key} = ${cantidadOriginal} x ${cantidadUnidades} = ${insumo.cantidad}`);
                }
            });

            // Generar HTML para mostrar los insumos sugeridos
            if (Object.keys(todosLosInsumos).length === 0) {
                container.innerHTML = '<p class="text-muted">No se encontraron sugerencias de insumos. Aseg√∫rate de haber seleccionado unidades y soluciones.</p>';
                return;
            }

            // Organizar insumos por categor√≠a y tipo (autom√°tico vs sugerido)
            const insumosPorCategoria = {
                equipos: [],
                accesorios: [],
                insumos: []
            };
            
            const insumosAutomaticos = {
                equipos: [],
                accesorios: [],
                insumos: []
            };

            Object.values(todosLosInsumos).forEach(insumo => {
                const categoria = insumo.categoria || 'insumos';
                if (insumosPorCategoria[categoria]) {
                    insumosPorCategoria[categoria].push(insumo);
                    
                    // Separar autom√°ticos de sugeridos
                    if (insumo.sugerido === true) {
                        insumosAutomaticos[categoria].push(insumo);
                    }
                }
            });

            // Contar totales por categor√≠a
            const totalesPorCategoria = {
                equipos: insumosPorCategoria.equipos.length,
                accesorios: insumosPorCategoria.accesorios.length,
                insumos: insumosPorCategoria.insumos.length,
                servicios: serviciosNecesarios.length
            };

            let html = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightbulb"></i> Insumos Sugeridos Autom√°ticamente</h6>
                    <small>Basados en las unidades y soluciones seleccionadas. Organizados por categor√≠as.</small>
                    <div class="mt-2">
                        <span class="badge ${tipoVenta === 'instalacion' ? 'bg-success' : 'bg-warning'}">
                            ${tipoVenta === 'instalacion' ? 'Instalaci√≥n completa' : 'Solo venta de equipos'}
                        </span>
                        ${tipoVenta === 'venta' ? '<small class="text-muted ms-2">(Solo insumos de excepci√≥n)</small>' : ''}
                    </div>
                </div>

                <!-- Pesta√±as de categor√≠as -->
                <ul class="nav nav-tabs" id="categoriasTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="equipos-tab" data-bs-toggle="tab" data-bs-target="#equipos" 
                                type="button" role="tab" aria-controls="equipos" aria-selected="true">
                            <i class="bi bi-cpu"></i> Equipos <span class="badge ms-1" style="background-color: #fb930c;">${totalesPorCategoria.equipos}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="accesorios-tab" data-bs-toggle="tab" data-bs-target="#accesorios" 
                                type="button" role="tab" aria-controls="accesorios" aria-selected="false">
                            <i class="bi bi-puzzle"></i> Accesorios <span class="badge bg-success ms-1">${totalesPorCategoria.accesorios}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="insumos-tab" data-bs-toggle="tab" data-bs-target="#insumos" 
                                type="button" role="tab" aria-controls="insumos" aria-selected="false">
                            <i class="bi bi-tools"></i> Materia Prima <span class="badge bg-warning ms-1">${totalesPorCategoria.insumos}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="servicios-tab" data-bs-toggle="tab" data-bs-target="#servicios" 
                                type="button" role="tab" aria-controls="servicios" aria-selected="false">
                            <i class="bi bi-cloud"></i> Servicios <span class="badge bg-info ms-1">${totalesPorCategoria.servicios}</span>
                        </button>
                    </li>
                </ul>

                <!-- Contenido de las pesta√±as -->
                <div class="tab-content" id="categoriasTabContent">
            `;

            // Generar contenido para cada categor√≠a
            ['equipos', 'accesorios', 'insumos', 'servicios'].forEach((categoria, categoriaIndex) => {
                const isActive = categoriaIndex === 0 ? 'show active' : '';
                const iconosCategoria = {
                    equipos: '<i class="bi bi-cpu me-1" style="color: #fb930c;"></i>',
                    accesorios: '<i class="bi bi-puzzle text-success me-1"></i>',
                    insumos: '<i class="bi bi-tools text-warning me-1"></i>',
                    servicios: '<i class="bi bi-cloud text-info me-1"></i>'
                };

                // Manejar servicios de manera especial
                if (categoria === 'servicios') {
                    html += `
                        <div class="tab-pane fade ${isActive}" id="${categoria}" role="tabpanel" aria-labelledby="${categoria}-tab">
                            <div class="mb-4">
                                <h6 style="color: #17a2b8;">
                                    ${iconosCategoria[categoria]} Servicios de Datos Sugeridos
                                    <span class="badge ms-2" style="background-color: #17a2b8;">${serviciosNecesarios.length}</span>
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="50">Usar</th>
                                                <th>Servicio</th>
                                                <th width="120">Periodicidad</th>
                                                <th width="80">Cantidad</th>
                                                <th>Aplicado en</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    if (serviciosNecesarios.length === 0) {
                        html += `
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="bi bi-info-circle"></i> No se requieren servicios de datos
                                </td>
                            </tr>
                        `;
                    } else {
                        serviciosNecesarios.forEach(servicio => {
                            const servicioId = `servicio_${servicio.nombre.replace(/\s+/g, '_').toLowerCase()}_${servicio.unidad}`;
                            html += `
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input servicio-checkbox" type="checkbox" 
                                                   id="${servicioId}" value="${servicio.nombre}" checked>
                                        </div>
                                    </td>
                                    <td><strong>${servicio.nombre}</strong></td>
                                    <td>
                                        <span class="badge ${servicio.periodicidad === 'anual' ? 'bg-danger' : 'bg-primary'}">
                                            ${servicio.periodicidad}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-secondary">${servicio.cantidad}</span></td>
                                    <td>
                                        <small class="text-muted">
                                            Unidad ${servicio.unidad} (${servicio.solucion})
                                        </small>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row mt-2 mb-3">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="seleccionarCategoria('${categoria}', true)">
                                        <i class="bi bi-check-all"></i> Seleccionar Servicios
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="seleccionarCategoria('${categoria}', false)">
                                        <i class="bi bi-x-square"></i> Deseleccionar Servicios
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return; // Salir del bucle para servicios
                }
                
                // Separar autom√°ticos de sugeridos por matriz
                const automaticos = insumosAutomaticos[categoria];
                const sugeridos = insumosPorCategoria[categoria].filter(insumo => !insumo.sugerido);
                
                html += `
                    <div class="tab-pane fade ${isActive}" id="${categoria}" role="tabpanel" aria-labelledby="${categoria}-tab">
                `;
                
                // Secci√≥n de autom√°ticos
                if (automaticos.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h6 style="color: #fb930c;">
                                <i class="bi bi-magic"></i> ${categoria.charAt(0).toUpperCase() + categoria.slice(1)} Autom√°ticos
                                <span class="badge ms-2" style="background-color: #fb930c;">${automaticos.length}</span>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="50">Usar</th>
                                            <th>Nombre</th>
                                            <th width="80">Cantidad</th>
                                            <th>Aplicado en</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    automaticos.forEach((insumo, index) => {
                        const esTelemetria = insumo.deTelemetria;
                        const iconoTipo = esTelemetria ? '<i class="bi bi-broadcast text-warning me-1" title="Telemetr√≠a"></i>' : iconosCategoria[categoria];
                        const colorBadge = esTelemetria ? 'bg-warning' : (categoria === 'equipos' ? 'style="background-color: #fb930c;"' : (categoria === 'accesorios' ? 'bg-success' : 'bg-warning'));
                        const globalIndex = Object.values(todosLosInsumos).findIndex(item => item.nombre === insumo.nombre);
                        
                        html += `
                            <tr ${esTelemetria ? 'class="table-warning"' : ''}>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input sugerido-checkbox" type="checkbox" id="sugerido_${globalIndex}" 
                                               name="insumo_sugerido_${globalIndex}" value="${insumo.nombre}" checked>
                                    </div>
                                </td>
                                <td>
                                    ${iconoTipo}
                                    <strong>${insumo.nombre}</strong>
                                    ${esTelemetria ? '<span class="badge bg-warning ms-1">Telemetr√≠a</span>' : ''}
                                </td>
                                <td>
                                    <span class="badge ${colorBadge}">${insumo.cantidad}</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        ${insumo.unidades ? insumo.unidades.join('<br>') : 'N/A'}
                                    </small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Secci√≥n de sugeridos por matriz
                if (sugeridos.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h6 class="text-secondary">
                                <i class="bi bi-lightbulb"></i> ${categoria.charAt(0).toUpperCase() + categoria.slice(1)} Sugeridos por Matriz
                                <span class="badge bg-secondary ms-2">${sugeridos.length}</span>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="50">Usar</th>
                                            <th>Nombre</th>
                                            <th width="80">Cantidad</th>
                                            <th>Aplicado en</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    sugeridos.forEach((insumo, index) => {
                        const esTelemetria = insumo.deTelemetria;
                        const iconoTipo = esTelemetria ? '<i class="bi bi-broadcast text-warning me-1" title="Telemetr√≠a"></i>' : iconosCategoria[categoria];
                        const colorBadge = esTelemetria ? 'bg-warning' : (categoria === 'equipos' ? 'style="background-color: #fb930c;"' : (categoria === 'accesorios' ? 'bg-success' : 'bg-warning'));
                        const globalIndex = Object.values(todosLosInsumos).findIndex(item => item.nombre === insumo.nombre);
                        
                        html += `
                            <tr ${esTelemetria ? 'class="table-warning"' : ''}>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input sugerido-checkbox" type="checkbox" id="sugerido_${globalIndex}" 
                                               name="insumo_sugerido_${globalIndex}" value="${insumo.nombre}" checked>
                                    </div>
                                </td>
                                <td>
                                    ${iconoTipo}
                                    <strong>${insumo.nombre}</strong>
                                    ${esTelemetria ? '<span class="badge bg-warning ms-1">Telemetr√≠a</span>' : ''}
                                </td>
                                <td>
                                    <span class="badge ${colorBadge}">${insumo.cantidad}</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        ${insumo.unidades ? insumo.unidades.join('<br>') : 'N/A'}
                                    </small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                html += `
                    </div>
                `;

                // Botones de selecci√≥n por categor√≠a
                html += `
                        <div class="row mt-2 mb-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="seleccionarCategoria('${categoria}', true)">
                                    <i class="bi bi-check-all"></i> Seleccionar ${categoria === 'insumos' ? 'Materia Prima' : (categoria.charAt(0).toUpperCase() + categoria.slice(1))}
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="seleccionarCategoria('${categoria}', false)">
                                    <i class="bi bi-x-square"></i> Deseleccionar ${categoria === 'insumos' ? 'Materia Prima' : (categoria.charAt(0).toUpperCase() + categoria.slice(1))}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>

                <!-- Botones generales -->
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-success me-2" onclick="seleccionarTodosSugeridos(true)">
                            <i class="bi bi-check-all"></i> Seleccionar Todo
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodosSugeridos(false)">
                            <i class="bi bi-x-square"></i> Deseleccionar Todo
                        </button>
                    </div>
                </div>
            `;

            console.log('üîÑ DEBUG: Actualizando contenedor con HTML generado...');
            console.log('üîÑ DEBUG: HTML generado:', html.substring(0, 200) + '...');
            container.innerHTML = html;
            
            // Liberar el flag
            generandoInsumos = false;
            console.log('‚úÖ Generaci√≥n de insumos completada');
        }

        // Funci√≥n para seleccionar/deseleccionar todos los insumos sugeridos
        function seleccionarTodosSugeridos(seleccionar) {
            const checkboxes = document.querySelectorAll('.sugerido-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = seleccionar;
            });
        }

        // Funci√≥n para seleccionar/deseleccionar por categor√≠a
        function seleccionarCategoria(categoria, seleccionar) {
            const tabPane = document.getElementById(categoria);
            if (tabPane) {
                const checkboxes = tabPane.querySelectorAll('.sugerido-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = seleccionar;
                });
            }
        }

        // Funci√≥n legacy para compatibilidad
        function toggleAllSugeridos(masterCheckbox) {
            seleccionarTodosSugeridos(masterCheckbox.checked);
        }

        // Array para almacenar insumos adicionales
        let insumosAdicionalesSeleccionados = [];

        // Funci√≥n para agregar insumo adicional
        function agregarInsumoAdicional() {
            const selectInsumo = document.getElementById('selectInsumoAdicional');
            const cantidadInput = document.getElementById('cantidadInsumoAdicional');
            
            const insumoNombre = selectInsumo.value;
            const cantidad = parseFloat(cantidadInput.value);
            
            if (!insumoNombre || !cantidad || cantidad <= 0) {
                alert('Por favor selecciona un insumo y especifica una cantidad v√°lida.');
                return;
            }
            
            // Verificar si ya existe el insumo
            const existeIndex = insumosAdicionalesSeleccionados.findIndex(item => item.nombre === insumoNombre);
            
            if (existeIndex >= 0) {
                // Si existe, sumar la cantidad
                insumosAdicionalesSeleccionados[existeIndex].cantidad += cantidad;
            } else {
                // Si no existe, agregarlo
                insumosAdicionalesSeleccionados.push({
                    nombre: insumoNombre,
                    cantidad: cantidad
                });
            }
            
            // Limpiar campos
            selectInsumo.value = '';
            cantidadInput.value = '';
            
            // Actualizar visualizaci√≥n
            actualizarVisualizacionInsumosAdicionales();
        }

        // Funci√≥n para actualizar la visualizaci√≥n de insumos adicionales
        function actualizarVisualizacionInsumosAdicionales() {
            const container = document.getElementById('insumosAdicionalesContainer');
            
            if (insumosAdicionalesSeleccionados.length === 0) {
                container.innerHTML = '<p class="text-muted small">No hay insumos adicionales agregados.</p>';
                return;
            }
            
            let html = '<div class="list-group list-group-flush">';
            insumosAdicionalesSeleccionados.forEach((insumo, index) => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <div>
                            <strong class="text-info">${insumo.nombre}</strong>
                            <span class="badge bg-info ms-2">${insumo.cantidad}</span>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="eliminarInsumoAdicional(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Funci√≥n para eliminar insumo adicional
        function eliminarInsumoAdicional(index) {
            insumosAdicionalesSeleccionados.splice(index, 1);
            actualizarVisualizacionInsumosAdicionales();
        }

        // Datos maestros
        const descuentosPorCliente = {
            "Distribuidor A": 25,
            "Distribuidor B": 20,
            "Distribuidor C": 15,
            "Cliente final A": 10,
            "Cliente final B": 5,
            "Cliente final C": 0,
            "Cliente corporativo A": 30,
            "Cliente corporativo B": 20,
            "Cliente corporativo C": 10,
            "Integrador A": 25,
            "Integrador B": 20,
            "Integrador C": 15
        };

        const solucionesMaestras = [
            {
                id: 'vpc',
                nombre: 'VPC',
                descripcion: 'Sistema de video para veh√≠culos',
                configuraciones: ['camara_izquierda', 'camara_derecha', 'camara_reversa', 'camara_frontal', 'grabacion', 'transmision']
            },
            {
                id: 'sensor_vpc',
                nombre: 'Sensor VPC',
                descripcion: 'Sensores para sistema VPC'
            },
            {
                id: 'led_giro',
                nombre: 'Led de giro',
                descripcion: 'Luces LED direccionales'
            },
            {
                id: 'alarma_parlante_estandar',
                nombre: 'Alarma parlante est√°ndar',
                descripcion: 'Sistema de alarma con parlante'
            },
            {
                id: 'alarma_parlante_programable',
                nombre: 'Alarma parlante programable',
                descripcion: 'Sistema de alarma programable'
            },
            {
                id: 'encadenamiento_se√±ales',
                nombre: 'Encadenamiento se√±ales',
                descripcion: 'Sistema de encadenamiento de se√±ales'
            },
            {
                id: 'mvr4_ch',
                nombre: 'MVR/4 Ch',
                descripcion: 'Sistema de grabaci√≥n 4 canales'
            },
            {
                id: 'mvr8_ch',
                nombre: 'MVR/8 Ch',
                descripcion: 'Sistema de grabaci√≥n 8 canales'
            },
            {
                id: 'sideview',
                nombre: 'Sideview',
                descripcion: 'Sistema de vista lateral'
            },
            {
                id: 'dashcam',
                nombre: 'Dashcam',
                descripcion: 'C√°mara frontal para veh√≠culo'
            },
            {
                id: 'rastreo_basico',
                nombre: 'Rastreo b√°sico',
                descripcion: 'Sistema b√°sico de rastreo GPS',
                configuraciones: ['sos_simple', 'sos_llamada', 'bloqueo_normal', 'sensores_juntos', 'alerta']
            },
            {
                id: 'rastreo_avanzado',
                nombre: 'Rastreo avanzado',
                descripcion: 'Sistema avanzado de rastreo GPS',
                configuraciones: ['sos_simple', 'sos_llamada', 'sos_bloqueo', 'bloqueo_normal', 'bloqueo_cc', 'sensores_juntos', 'sensores_independientes', 'sensores_y_bloqueo', 'audio_bidireccional', 'audio_espia', 'alerta', 'alerta_y_bloqueo']
            },
            {
                id: 'rastreo_satelital',
                nombre: 'Rastreo satelital',
                descripcion: 'Sistema satelital de rastreo'
            },
            {
                id: 'insider',
                nombre: 'Insider',
                descripcion: 'Sistema insider'
            },
            {
                id: 'limitador_velocidad',
                nombre: 'Limitador de velocidad',
                descripcion: 'Sistema limitador de velocidad'
            },
            {
                id: 'modulo_sensor_cinturon',
                nombre: 'M√≥dulo sensor cintur√≥n',
                descripcion: 'Sensor de cintur√≥n de seguridad'
            }
        ];

        const insumosMaestros = [
            'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m', 'Cable 4 pin 15 m', 'Cable 4 pin 30 m',
            'Cable 6 pin 5 m', '"Y" 4 pines', 'Base Pollak', 'Base Macho Pollak', 'Base Hembra', 'Tornillo hexagonal 5/16',
            'Tornillo 3/8', 'Silicon', 'Cinchos grande', 'Cinta de tela', 'Cinta de aislar', 'Poliflex 3/8',
            'Cincho mediado', 'Cincho con grapa', 'Pija brocante 5/16', 'Cable de 1 polo', 'Terminal de ojillo', 'Poliflex 1/4',
            'Cable 2 vias', 'Cable 4 vias', 'Tuerca 5/16', 'Rondana 5/16', 'Espiral negro', 'Espiral verde',
            'Relevador 2 pasos 2 tiros', 'placa perforada', 'Gabinete 5*7*3', 'Relevador 12v', 'Relevador 24v', 'Portarelevador'
        ];

        const serviciosMaestros = [
            'Hosting', 'Datos rastreo basico', 'Datos rastreo avanzado', 'Datos - Voz', 'Datos video'
        ];

        const accesoriosMaestros = [
            'Bocina', 'Bot√≥n balancin', 'Boton de panico', 'Microfono', 'Sensor magnetico chico', 'Sensor magnetico grande', 'Interfaz de leds'
        ];

        // Funci√≥n establecerFechaVencimiento movida al inicio del script

        // Funci√≥n para manejar opciones de encadenamiento
        function toggleEncadenamientoOptions(solucionId) {
            const checkbox = document.getElementById(`${solucionId}_encadenamiento`);
            const options = document.getElementById(`${solucionId}_encadenamiento_options`);
            
            if (checkbox && options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
                
                // Limpiar selecciones si se desmarca
                if (!checkbox.checked) {
                    const radios = options.querySelectorAll('input[type="radio"]');
                    radios.forEach(radio => radio.checked = false);
                }
            }
        }

        // Funciones para manejar opciones espec√≠ficas
        function toggleSensorVpcOptions(solucionId) {
            const checkbox = document.getElementById(`${solucionId}_sensor_vpc`);
            const options = document.getElementById(`${solucionId}_sensor_vpc_options`);
            if (checkbox && options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function toggleAlarmaOptions(solucionId) {
            const checkbox = document.getElementById(`${solucionId}_alarma_parlante_estandar`);
            const options = document.getElementById(`${solucionId}_alarma_options`);
            if (checkbox && options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function toggleLedOptions(solucionId) {
            const checkbox = document.getElementById(`${solucionId}_led_giro`);
            const options = document.getElementById(`${solucionId}_led_options`);
            if (checkbox && options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function toggleCanalIPExtra(solucionId) {
            const checkbox = document.getElementById(`${solucionId}_canal_ip_extra`);
            const container = document.getElementById(`${solucionId}_canal_ip_container`);
            const select = document.querySelector(`[name="${solucionId}_canal_ip_tipo"]`);
            
            if (checkbox && container && select) {
                container.style.display = checkbox.checked ? 'block' : 'none';
                select.disabled = !checkbox.checked;
                if (checkbox.checked) {
                    select.value = 'digital'; // Poner c√°mara IP por defecto
                }
            }
        }

        function toggleJammerTime(solucionId) {
            const jammerRadios = document.querySelectorAll(`[name="${solucionId}_jammer"]:checked`);
            const timeContainer = document.getElementById(`${solucionId}_jammer_time_container`);
            
            if (timeContainer) {
                const hasJammerSelected = jammerRadios.length > 0;
                timeContainer.style.display = hasJammerSelected ? 'block' : 'none';
            }
        }

        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'info') {
            // Crear elemento de alerta
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alerta.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Agregar al body
            document.body.appendChild(alerta);
            
            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.remove();
                }
            }, 4000);
        }

        // Funci√≥n para cargar datos de edici√≥n
        function cargarDatosEdicion() {
            const urlParams = new URLSearchParams(window.location.search);
            const editarId = urlParams.get('editar');
            const datosEdicion = localStorage.getItem('cotizacion_editar');
            
            if (editarId && datosEdicion) {
                try {
                    const cotizacion = JSON.parse(datosEdicion);
                    console.log('Cargando datos para editar:', cotizacion);
                    
                    // Cargar datos del cliente con validaciones
                    const clienteNombre = document.getElementById('cliente_nombre');
                    const empresa = document.getElementById('empresa');
                    const tipoCliente = document.getElementById('tipo_cliente');
                    const descuento = document.getElementById('descuento');
                    const fechaVencimiento = document.getElementById('fecha_vencimiento');
                    const urgente = document.getElementById('urgente');
                    const diasSeguimiento = document.getElementById('dias_seguimiento');
                    const observaciones = document.getElementById('observaciones');
                    
                    if (cotizacion.cliente_nombre && clienteNombre) {
                        clienteNombre.value = cotizacion.cliente_nombre;
                    }
                    if (cotizacion.empresa && empresa) {
                        empresa.value = cotizacion.empresa;
                    }
                    if (cotizacion.tipo_cliente && tipoCliente) {
                        tipoCliente.value = cotizacion.tipo_cliente;
                    }
                    if (cotizacion.descuento && descuento) {
                        descuento.value = cotizacion.descuento;
                    }
                    if (cotizacion.fecha_vencimiento && fechaVencimiento) {
                        fechaVencimiento.value = cotizacion.fecha_vencimiento;
                    }
                    if (cotizacion.urgente && urgente) {
                        urgente.value = cotizacion.urgente;
                    }
                    if (cotizacion.observaciones && observaciones) {
                        observaciones.value = cotizacion.observaciones;
                    }
                    
                    // Limpiar unidades por defecto
                    const unidadesContainer = document.getElementById('unidadesVehiculoContainer');
                    if (unidadesContainer) {
                        unidadesContainer.innerHTML = '';
                    }
                    
                    // Cargar unidades existentes
                    if (cotizacion.unidades && cotizacion.unidades.length > 0) {
                        // Obtener solo unidades √∫nicas (evitar duplicados de lote)
                        const unidadesUnicas = [];
                        const loteDetectado = cotizacion.unidades.some(u => u.esLote);
                        
                        if (loteDetectado) {
                            // Si hay lote, solo tomar la primera unidad
                            unidadesUnicas.push(cotizacion.unidades[0]);
                        } else {
                            // Si no hay lote, tomar todas las unidades
                            unidadesUnicas.push(...cotizacion.unidades);
                        }
                        
                        console.log('Cargando unidades √∫nicas:', unidadesUnicas);
                        
                        unidadesUnicas.forEach((unidad, index) => {
                            setTimeout(() => {
                                agregarUnidadVehiculo();
                                const unidadDiv = document.querySelector('.unidad-vehiculo-item:last-child');
                                
                                if (unidadDiv) {
                                    console.log(`Cargando datos de unidad ${index + 1}:`, unidad);
                                    
                                    // Llenar datos de la unidad con validaciones
                                    const marca = unidadDiv.querySelector('[name^="vehiculo_marca_"]');
                                    const tipo = unidadDiv.querySelector('[name^="vehiculo_tipo_"]');
                                    const modelo = unidadDiv.querySelector('[name^="vehiculo_modelo_"]');
                                    const anio = unidadDiv.querySelector('[name^="vehiculo_a√±o_"]');
                                    const combustible = unidadDiv.querySelector('[name^="vehiculo_combustible_"]');
                                    const voltaje = unidadDiv.querySelector('[name^="vehiculo_voltaje_"]');
                                    
                                    if (marca) marca.value = unidad.marca || '';
                                    if (tipo) tipo.value = unidad.tipo_unidad || unidad.tipo || '';
                                    if (modelo) modelo.value = unidad.modelo || '';
                                    if (anio) anio.value = unidad.anio || unidad.a√±o || '';
                                    if (combustible) combustible.value = unidad.combustible || '';
                                    if (voltaje) voltaje.value = unidad.voltaje || '';
                                    
                                    // Cargar soluciones de esta unidad
                                    if (unidad.soluciones && unidad.soluciones.length > 0) {
                                        const unidadId = index + 1;
                                        const solucionesContainer = unidadDiv.querySelector('.soluciones-unidad-container-' + unidadId);
                                        
                                        console.log(`Cargando ${unidad.soluciones.length} soluciones para unidad ${unidadId}`);
                                        
                                        if (solucionesContainer) {
                                            solucionesContainer.innerHTML = '';
                                            
                                            unidad.soluciones.forEach((solucion, solIndex) => {
                                                setTimeout(() => {
                                                    console.log(`Agregando soluci√≥n ${solIndex + 1}:`, solucion);
                                                    agregarSolucionAUnidadWizard(null, unidadId);
                                                    
                                                    const solucionDiv = solucionesContainer.querySelector('.solucion-item:last-child');
                                                    if (solucionDiv) {
                                                        const tipoSelect = solucionDiv.querySelector('.solucion-tipo');
                                                        if (tipoSelect) {
                                                            tipoSelect.value = solucion.tipo_solucion || solucion.tipo || '';
                                                            
                                                            // Disparar evento para cargar configuraciones
                                                            mostrarConfiguracionesSolucionWizard(tipoSelect);
                                                            
                                                            // Cargar configuraciones despu√©s de un delay
                                                            setTimeout(() => {
                                                                if (solucion.configuraciones) {
                                                                    console.log('Cargando configuraciones:', solucion.configuraciones);
                                                                    Object.keys(solucion.configuraciones).forEach(configKey => {
                                                                        const configValue = solucion.configuraciones[configKey];
                                                                        
                                                                        // Buscar el elemento por nombre que contenga la clave
                                                                        const elementos = solucionDiv.querySelectorAll(`[name*="${configKey}"]`);
                                                                        
                                                                        elementos.forEach(elemento => {
                                                                            if (elemento.type === 'checkbox' && configValue === true) {
                                                                                elemento.checked = true;
                                                                                console.log(`Marcando checkbox: ${configKey}`);
                                                                                
                                                                                // Disparar evento onchange si existe
                                                                                if (elemento.onchange) {
                                                                                    elemento.onchange();
                                                                                }
                                                                            } else if (elemento.type === 'radio' && configValue === elemento.value) {
                                                                                elemento.checked = true;
                                                                                console.log(`Marcando radio: ${configKey} = ${configValue}`);
                                                                                
                                                                                // Disparar evento onchange si existe
                                                                                if (elemento.onchange) {
                                                                                    elemento.onchange();
                                                                                }
                                                                            } else if (elemento.tagName === 'SELECT' && configValue) {
                                                                                elemento.value = configValue;
                                                                                console.log(`Estableciendo select: ${configKey} = ${configValue}`);
                                                                            } else if (elemento.type === 'number' && configValue) {
                                                                                elemento.value = configValue;
                                                                                console.log(`Estableciendo n√∫mero: ${configKey} = ${configValue}`);
                                                                            } else if (elemento.tagName === 'TEXTAREA' && configValue) {
                                                                                elemento.value = configValue;
                                                                                console.log(`Estableciendo textarea: ${configKey} = ${configValue}`);
                                                                            }
                                                                        });
                                                                    });
                                                                }
                                                            }, 500);
                                                        }
                                                    }
                                                }, solIndex * 300);
                                            });
                                        }
                                    }
                                }
                            }, index * 800);
                        });
                        
                        // Si hay cantidad de lote, establecerla
                        if (cotizacion.cantidadLote) {
                            setTimeout(() => {
                                const cantidadLoteInput = document.getElementById('cantidadUnidadesLote');
                                if (cantidadLoteInput) {
                                    cantidadLoteInput.value = cotizacion.cantidadLote;
                                }
                            }, 1000);
                        }
                        
                        // Si hay tipo de venta, establecerlo
                        if (cotizacion.tipoVenta) {
                            setTimeout(() => {
                                const tipoVentaSelect = document.getElementById('tipoVenta');
                                if (tipoVentaSelect) {
                                    tipoVentaSelect.value = cotizacion.tipoVenta;
                                }
                            }, 1000);
                        }
                    }
                    
                    // Cargar insumos, servicios y accesorios
                    setTimeout(() => {
                        if (cotizacion.insumos && cotizacion.insumos.length > 0) {
                            cotizacion.insumos.forEach(insumo => {
                                const checkbox = document.querySelector(`[id*="insumo_${insumo.replace(/\s+/g, '_').replace(/"/g, '').replace(/\//g, '_')}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        
                        if (cotizacion.servicios && cotizacion.servicios.length > 0) {
                            cotizacion.servicios.forEach(servicio => {
                                const checkbox = document.querySelector(`[id*="servicio_${servicio.replace(/\s+/g, '_').replace(/-/g, '_')}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        
                        if (cotizacion.accesorios && cotizacion.accesorios.length > 0) {
                            cotizacion.accesorios.forEach(accesorio => {
                                const checkbox = document.querySelector(`[id*="accesorio_${accesorio.replace(/\s+/g, '_')}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }, 2000);
                    
                    // Actualizar t√≠tulo (wizard header)
                    const header = document.querySelector('.wizard-header h2') || document.querySelector('h2');
                    if (header) header.textContent = 'Editar Cotizaci√≥n - ' + (cotizacion.folio || 'Wizard');
                    
                    mostrarAlerta('Datos cargados para edici√≥n', 'success');
                    
                } catch (error) {
                    console.error('Error cargando datos de edici√≥n:', error);
                    mostrarAlerta('Error al cargar los datos para editar', 'danger');
                }
            }
        }

        // Sistema de debugging para diagn√≥stico de c√°lculos
        function mostrarDebugCalculos() {
            console.log('=== INICIO DEBUG DE C√ÅLCULOS ===');
            
            // Obtener datos actuales
            guardarPasoActual();
            const vehiculos = cotizacionData.vehiculos || [];
            
            console.log('1. DATOS DE ENTRADA:');
            console.log('Veh√≠culos configurados:', vehiculos.length);
            vehiculos.forEach((vehiculo, index) => {
                console.log(`  Unidad ${index + 1}:`, {
                    tipo: vehiculo.tipo,
                    soluciones: vehiculo.soluciones?.map(s => s.tipo_solucion) || []
                });
            });
            
            console.log('2. PROCESAMIENTO PASO A PASO:');
            let todosLosInsumos = {};
            let debugInfo = {
                equiposAutomaticos: {},
                insumosPorSolucion: {},
                accesoriosTelemetria: {},
                consolidacion: {}
            };
            
            // Debug equipos autom√°ticos
            const equiposAutomaticos = generarEquiposAutomaticos(vehiculos);
            debugInfo.equiposAutomaticos = equiposAutomaticos;
            console.log('2.1 Equipos autom√°ticos generados:', equiposAutomaticos);
            
            // Debug insumos por soluci√≥n
            vehiculos.forEach((vehiculo, unidadIndex) => {
                const tipoUnidad = vehiculo.tipo || 'Tracto';
                console.log(`2.2 Procesando Unidad ${unidadIndex + 1} (${tipoUnidad}):`);
                
                if (vehiculo.soluciones && vehiculo.soluciones.length > 0) {
                    vehiculo.soluciones.forEach((solucion, solIndex) => {
                        const tipoSolucion = solucion.tipo_solucion;
                        const insumosSugeridos = obtenerInsumosSugeridos(tipoUnidad, tipoSolucion);
                        
                        const clave = `U${unidadIndex + 1}_S${solIndex + 1}_${tipoSolucion}`;
                        debugInfo.insumosPorSolucion[clave] = {
                            tipoUnidad,
                            tipoSolucion,
                            insumos: insumosSugeridos,
                            cantidad: insumosSugeridos.length
                        };
                        
                        console.log(`    Soluci√≥n ${solIndex + 1} (${tipoSolucion}):`, insumosSugeridos.length, 'insumos');
                        insumosSugeridos.forEach(insumo => {
                            console.log(`      - ${insumo.nombre}: ${insumo.cantidad}`);
                        });
                        
                        // Consolidar en todosLosInsumos
                        insumosSugeridos.forEach(insumo => {
                            const key = insumo.nombre;
                            if (todosLosInsumos[key]) {
                                const cantidadAnterior = parseFloat(todosLosInsumos[key].cantidad) || 0;
                                const cantidadNueva = parseFloat(insumo.cantidad) || 0;
                                
                                if (!isNaN(cantidadAnterior) && !isNaN(cantidadNueva)) {
                                    todosLosInsumos[key].cantidad = cantidadAnterior + cantidadNueva;
                                } else {
                                    // Si no se pueden convertir a n√∫meros, mantener como string
                                    todosLosInsumos[key].cantidad = `${todosLosInsumos[key].cantidad} + ${insumo.cantidad}`;
                                }
                                todosLosInsumos[key].unidades.push(`Unidad ${unidadIndex + 1} (${tipoSolucion})`);
                                console.log(`      ‚úì SUMA: ${key} = ${cantidadAnterior} + ${cantidadNueva} = ${todosLosInsumos[key].cantidad}`);
                            } else {
                                todosLosInsumos[key] = {
                                    nombre: insumo.nombre,
                                    cantidad: insumo.cantidad,
                                    unidades: [`Unidad ${unidadIndex + 1} (${tipoSolucion})`],
                                    sugerido: true,
                                    categoria: obtenerCategoriaInsumo(insumo.nombre)
                                };
                                console.log(`      ‚úì NUEVO: ${key} = ${insumo.cantidad}`);
                            }
                        });
                    });
                }
            });
            
            console.log('3. RESULTADO FINAL CONSOLIDADO:');
            Object.values(todosLosInsumos).forEach(insumo => {
                console.log(`  ${insumo.nombre}: ${insumo.cantidad} (${insumo.unidades.length} fuentes)`);
            });
            
            console.log('4. COMPARACI√ìN POR CATEGOR√çAS:');
            const insumosPorCategoria = {
                equipos: [],
                accesorios: [],
                insumos: []
            };
            
            Object.values(todosLosInsumos).forEach(insumo => {
                const categoria = insumo.categoria || 'insumos';
                insumosPorCategoria[categoria].push(insumo);
            });
            
            console.log('  Equipos:', insumosPorCategoria.equipos.length);
            console.log('  Accesorios:', insumosPorCategoria.accesorios.length);
            console.log('  Materia Prima:', insumosPorCategoria.insumos.length);
            
            console.log('=== FIN DEBUG DE C√ÅLCULOS ===');
            
            // Mostrar modal con resumen
            mostrarModalDebug(debugInfo, todosLosInsumos);
        }
        
        function mostrarModalDebug(debugInfo, todosLosInsumos) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üêõ Debug de C√°lculos de Insumos</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <p><strong>Revisar en la consola del navegador (F12 ‚Üí Console) para ver detalles completos.</strong></p>
                            
                            <h6>Resumen de Problemas Potenciales:</h6>
                            <div class="alert alert-info">
                                <ul class="mb-0">
                                    <li><strong>Duplicaciones:</strong> Busca elementos que aparezcan m√∫ltiples veces</li>
                                    <li><strong>Cantidades incorrectas:</strong> Verifica sumas en la consola</li>
                                    <li><strong>Categorizaci√≥n:</strong> Revisa si los elementos est√°n en la categor√≠a correcta</li>
                                </ul>
                            </div>
                            
                            <h6>Insumos Consolidados (${Object.keys(todosLosInsumos).length} total):</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Insumo</th>
                                            <th>Cantidad</th>
                                            <th>Categor√≠a</th>
                                            <th>Fuentes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.values(todosLosInsumos).map(insumo => `
                                            <tr>
                                                <td>${insumo.nombre}</td>
                                                <td><span class="badge" style="background-color: #fb930c;">${insumo.cantidad}</span></td>
                                                <td><span class="badge bg-secondary">${insumo.categoria}</span></td>
                                                <td><small>${insumo.unidades.join(', ')}</small></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await cargarPreciosCache();
            cargarInsumos();
            cargarServicios();
            cargarAccesorios();
            cargarProgreso();
            
            // Actualizar selects con tipos globales
            actualizarTodosLosSelects();
            
            // Suscribirse a cambios en tiempo real de precios
            if (modoCentralizado && window.dataService && window.dataService.subscribePreciosElementos) {
                console.log('üîÑ Suscribi√©ndose a cambios de precios en tiempo real...');
                window.dataService.subscribePreciosElementos((payload) => {
                    console.log('üí≤ Cambio en precios detectado:', payload);
                    // Recargar precios cuando hay cambios
                    cargarPreciosCache().then(() => {
                        console.log('‚úÖ Precios actualizados en tiempo real');
                        // Recalcular total si estamos en una cotizaci√≥n
                        if (typeof calcularTotalCotizacion === 'function') {
                            const unidades = document.getElementById('unidades')?.value || 1;
                            const cotizacionData = obtenerDatosCotizacion();
                            if (cotizacionData) {
                                calcularTotalCotizacion(unidades, cotizacionData);
                            }
                        }
                    });
                });
            }
            
            // Generar fecha de vencimiento autom√°tica (15 d√≠as desde hoy) - ACTUALIZADO
            const fechaVencimiento = new Date();
            fechaVencimiento.setDate(fechaVencimiento.getDate() + 15);
            document.getElementById('fecha_vencimiento').value = fechaVencimiento.toISOString().split('T')[0];
            
            // Verificar si estamos en modo edici√≥n
            const urlParams = new URLSearchParams(window.location.search);
            const editarId = urlParams.get('editar');
            
            if (!editarId) {
                // Solo agregar unidad por defecto si NO hay borrador con unidades
                const progreso = localStorage.getItem('cotizacion_progreso');
                let tieneUnidades = false;
                try {
                    if (progreso) {
                        const tmp = JSON.parse(progreso);
                        tieneUnidades = Array.isArray(tmp?.vehiculos) && tmp.vehiculos.length > 0;
                    }
                } catch (_) { /* ignorar */ }
                if (!tieneUnidades) {
                    agregarUnidadVehiculo();
                }
            }
            
            // Establecer fecha con m√∫ltiples intentos
            setTimeout(establecerFechaVencimiento, 300);
            setTimeout(establecerFechaVencimiento, 800);
            setTimeout(establecerFechaVencimiento, 1500);
            
            // Cargar datos de edici√≥n si aplica
            setTimeout(cargarDatosEdicion, 1000);
        });

        // Navegaci√≥n del wizard (funciones movidas al inicio del script)

        function mostrarPaso(step) {
            console.log(`üîÑ DEBUG: Mostrando paso ${step}...`);
            // Ocultar todos los pasos
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar paso actual
            document.getElementById(`step${step}`).classList.add('active');
            
            // Actualizar indicadores
            document.querySelectorAll('.step').forEach((el, index) => {
                el.classList.remove('active', 'completed', 'inactive');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                } else {
                    el.classList.add('inactive');
                }
            });
            
            // Actualizar botones
            document.getElementById('prevBtn').disabled = step === 1;
            const nextBtn = document.getElementById('nextBtn');
            if (step === 4) {
                nextBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Cotizaci√≥n';
                nextBtn.onclick = crearCotizacionFinal;
            } else {
                nextBtn.innerHTML = 'Siguiente<i class="bi bi-arrow-right ms-1"></i>';
                nextBtn.onclick = nextStep;
            }
            
            // Establecer fecha cuando se muestra el paso 1
            if (step === 1) {
                setTimeout(establecerFechaVencimiento, 100);
            }
            
            // Cargar insumos cuando se muestra el paso 3
            if (step === 3) {
                console.log('üîÑ DEBUG: Mostrando paso 3, actualizando tabla de insumos...');
                setTimeout(() => {
                    cargarInsumos();
                    cargarServicios();
                    cargarAccesorios();
                    // Actualizar la tabla de insumos sugeridos
                    console.log('üîÑ DEBUG: Llamando a generarInsumosSugeridos() desde paso 3...');
                    generarInsumosSugeridos();
                }, 100);
            }
            
            document.getElementById('currentStep').textContent = step;
        }

        function actualizarProgreso() {
            const progress = (currentStepNumber / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function validarPasoActual() {
            switch(currentStepNumber) {
                case 1:
                    return document.getElementById('cliente_nombre').value.trim() !== '';
                case 2:
                    return document.querySelectorAll('.unidad-vehiculo-item').length > 0;
                default:
                    return true;
            }
        }

        function guardarPasoActual() {
            // Guardar datos del paso actual
            switch(currentStepNumber) {
                case 1:
                    cotizacionData.cliente = {
                        nombre: document.getElementById('cliente_nombre').value,
                        empresa: document.getElementById('cliente_empresa').value,
                        tipo: document.getElementById('tipo_cliente').value,
                        descuento: document.getElementById('descuento').value,
                        fecha_vencimiento: document.getElementById('fecha_vencimiento').value,
                        urgente: document.getElementById('urgente').value,
                        dias_seguimiento: document.getElementById('dias_seguimiento').value || '7',
                        observaciones: document.getElementById('observaciones').value
                    };
                    break;
                case 2:
                    cotizacionData.vehiculos = [];
                    
                    // Obtener cantidad de lote si est√° especificada
                    const cantidadLote = document.getElementById('cantidadUnidadesLote')?.value;
                    cotizacionData.cantidadLote = cantidadLote ? parseInt(cantidadLote) : null;
                    
                    // Obtener tipo de venta
                    const tipoVenta = document.getElementById('tipoVenta')?.value;
                    cotizacionData.tipoVenta = tipoVenta || 'instalacion';
                    
                    document.querySelectorAll('.unidad-vehiculo-item').forEach((item, index) => {
                        const vehiculo = {
                            marca: item.querySelector('[name^="vehiculo_marca_"]').value,
                            tipo: item.querySelector('[name^="vehiculo_tipo_"]').value,
                            combustible: item.querySelector('[name^="vehiculo_combustible_"]').value,
                            voltaje: item.querySelector('[name^="vehiculo_voltaje_"]').value,
                            modelo: item.querySelector('[name^="vehiculo_modelo_"]').value,
                            a√±o: item.querySelector('[name^="vehiculo_a√±o_"]').value,
                            soluciones: [],
                            cantidadLote: index === 0 ? cotizacionData.cantidadLote : null // Solo la primera unidad lleva la cantidad de lote
                        };
                        
                        // Obtener soluciones para esta unidad
                        const unidadId = index + 1; // El ID de la unidad basado en el √≠ndice
                        const solucionesContainer = document.querySelector(`.soluciones-unidad-container-${unidadId}`);
                        if (solucionesContainer) {
                            const solucionesItems = solucionesContainer.querySelectorAll('.solucion-item');
                            solucionesItems.forEach(solucionItem => {
                                const tipoSelect = solucionItem.querySelector('.solucion-tipo');
                                if (tipoSelect && tipoSelect.value) {
                                    const solucion = {
                                        tipo_solucion: tipoSelect.value,
                                        configuraciones: {}
                                    };
                                    
                                    // Obtener todas las configuraciones
                                    const configuracionesContainer = solucionItem.querySelector('.configuraciones-solucion');
                                    if (configuracionesContainer) {
                                        // Checkboxes marcados
                                        const checkboxes = configuracionesContainer.querySelectorAll('input[type="checkbox"]:checked');
                                        checkboxes.forEach(checkbox => {
                                            const configName = checkbox.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                            solucion.configuraciones[configName] = true;
                                        });
                                        
                                        // Radio buttons seleccionados
                                        const radios = configuracionesContainer.querySelectorAll('input[type="radio"]:checked');
                                        radios.forEach(radio => {
                                            const configName = radio.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                            solucion.configuraciones[configName] = radio.value;
                                        });
                                        
                                        // Selects con valores
                                        const selects = configuracionesContainer.querySelectorAll('select');
                                        selects.forEach(select => {
                                            if (select.value) {
                                                const configName = select.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                                solucion.configuraciones[configName] = select.value;
                                            }
                                        });
                                        
                                        // Inputs num√©ricos con valores
                                        const numberInputs = configuracionesContainer.querySelectorAll('input[type="number"]');
                                        numberInputs.forEach(input => {
                                            if (input.value) {
                                                const configName = input.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                                solucion.configuraciones[configName] = input.value;
                                            }
                                        });
                                        
                                        // Textareas con contenido
                                        const textareas = configuracionesContainer.querySelectorAll('textarea');
                                        textareas.forEach(textarea => {
                                            if (textarea.value.trim()) {
                                                const configName = textarea.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                                solucion.configuraciones[configName] = textarea.value.trim();
                                            }
                                        });
                                    }
                                    
                                    vehiculo.soluciones.push(solucion);
                                }
                            });
                        }
                        
                        cotizacionData.vehiculos.push(vehiculo);
                    });
                    break;
                case 3:
                    cotizacionData.insumos = [];
                    cotizacionData.insumosSugeridos = [];
                    cotizacionData.servicios = [];
                    cotizacionData.accesorios = [];
                    cotizacionData.accesoriosSugeridos = [];
                    
                    // Guardar insumos sugeridos seleccionados
                    document.querySelectorAll('[name^="insumo_sugerido_"]:checked').forEach(checkbox => {
                        // Buscar la cantidad en la tabla de insumos sugeridos
                        const row = checkbox.closest('tr');
                        // Buscar espec√≠ficamente el badge de cantidad (no el de telemetr√≠a)
                        const cantidadBadge = row.querySelector('td:nth-child(3) .badge');
                        const cantidadText = cantidadBadge ? cantidadBadge.textContent.trim() : '1';
                        
                        // Usar parseFloat para manejar decimales correctamente
                        const cantidad = parseFloat(cantidadText) || 1;
                        
                        cotizacionData.insumosSugeridos.push({
                            nombre: checkbox.value,
                            cantidad: cantidad,
                            sugerido: true
                        });
                        
                        console.log(`üíæ Guardando insumo: ${checkbox.value} = ${cantidad} (texto: "${cantidadText}")`);
                    });
                    
                    // Guardar insumos adicionales
                    cotizacionData.insumos = [...insumosAdicionalesSeleccionados];
                    
                    serviciosMaestros.forEach(servicio => {
                        const checkbox = document.getElementById(`servicio_${servicio.replace(/\s+/g, '_')}`);
                        if (checkbox && checkbox.checked) {
                            cotizacionData.servicios.push(servicio);
                        }
                    });
                    
                    accesoriosMaestros.forEach(accesorio => {
                        const checkbox = document.getElementById(`accesorio_${accesorio.replace(/\s+/g, '_')}`);
                        if (checkbox && checkbox.checked) {
                            cotizacionData.accesorios.push(accesorio);
                        }
                    });
                    
                    // Guardar accesorios sugeridos
                    const accesoriosSugeridosCheckboxes = document.querySelectorAll('.accesorio-sugerido-checkbox:checked');
                    accesoriosSugeridosCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        // Buscar espec√≠ficamente el badge de cantidad (no el de telemetr√≠a)
                        const cantidadBadge = row.querySelector('td:nth-child(3) .badge');
                        const cantidadText = cantidadBadge ? cantidadBadge.textContent.trim() : '1';
                        
                        // Usar parseFloat para manejar decimales correctamente
                        const cantidad = parseFloat(cantidadText) || 1;
                        
                        cotizacionData.accesoriosSugeridos.push({
                            nombre: checkbox.value,
                            cantidad: cantidad,
                            sugerido: true
                        });
                        
                        console.log(`üíæ Guardando accesorio: ${checkbox.value} = ${cantidad} (texto: "${cantidadText}")`);
                    });
                    break;
            }
            
            // Auto-guardar
            localStorage.setItem('cotizacion_progreso', JSON.stringify(cotizacionData));
            mostrarAutoGuardado();
        }

        function cargarProgreso() {
            const progreso = localStorage.getItem('cotizacion_progreso');
            if (!progreso) return;
            try {
                cotizacionData = JSON.parse(progreso);
            } catch (_) { return; }

            // Paso 1: Cliente
            if (cotizacionData.cliente) {
                const c = cotizacionData.cliente;
                const el = (id) => document.getElementById(id);
                if (el('cliente_nombre')) el('cliente_nombre').value = c.nombre || '';
                if (el('cliente_empresa')) el('cliente_empresa').value = c.empresa || '';
                if (el('tipo_cliente')) el('tipo_cliente').value = c.tipo || '';
                actualizarDescuento();
                if (el('descuento') && c.descuento !== undefined && c.descuento !== null) el('descuento').value = c.descuento;
                if (el('fecha_vencimiento')) el('fecha_vencimiento').value = c.fecha_vencimiento || '';
                if (el('urgente')) el('urgente').value = c.urgente || 'baja';
                if (el('dias_seguimiento')) el('dias_seguimiento').value = c.dias_seguimiento || '7';
                if (el('observaciones')) el('observaciones').value = c.observaciones || '';
            }

            // Paso 2: Tipo de venta y Unidades/Soluciones
            const setTipoVenta = () => {
                const tv = document.getElementById('tipoVenta');
                if (tv && cotizacionData.tipoVenta) tv.value = cotizacionData.tipoVenta;
            };
            setTipoVenta();

            const contUnidades = document.getElementById('unidadesVehiculoContainer');
            if (contUnidades && Array.isArray(cotizacionData.vehiculos) && cotizacionData.vehiculos.length > 0) {
                contUnidades.innerHTML = '';
                unidadVehiculoCounter = 1;
                cotizacionData.vehiculos.forEach((vehiculo, idx) => {
                    agregarUnidadVehiculo();
                    const unidad = contUnidades.lastElementChild;
                    // Set b√°sicos
                    const setByNameLike = (prefix, value) => {
                        const input = unidad.querySelector(`[name^="${prefix}"]`);
                        if (input && value !== undefined && value !== null) input.value = value;
                    };
                    setByNameLike('vehiculo_marca_', vehiculo.marca || '');
                    setByNameLike('vehiculo_tipo_', vehiculo.tipo || vehiculo.tipo_unidad || '');
                    setByNameLike('vehiculo_modelo_', vehiculo.modelo || '');
                    setByNameLike('vehiculo_a√±o_', vehiculo.a√±o || vehiculo.anio || '');
                    setByNameLike('vehiculo_combustible_', vehiculo.combustible || '');
                    setByNameLike('vehiculo_voltaje_', vehiculo.voltaje || '');

                    // Soluciones de la unidad
                    const unidadId = idx + 1;
                    if (Array.isArray(vehiculo.soluciones)) {
                        const containerSol = unidad.querySelector(`.soluciones-unidad-container-${unidadId}`);
                        vehiculo.soluciones.forEach((sol) => {
                            agregarSolucionAUnidadWizard(null, unidadId);
                            const allSol = (containerSol || unidad).querySelectorAll('.solucion-item');
                            const nueva = allSol[allSol.length - 1];
                            const sel = nueva.querySelector('.solucion-tipo');
                            if (sel) {
                                sel.value = sol.tipo_solucion || sol.tipo || '';
                                mostrarConfiguracionesSolucionWizard(sel);
                                // Aplicar configuraciones
                                const cfg = sol.configuraciones || {};
                                Object.keys(cfg).forEach((k) => {
                                    const val = cfg[k];
                                    // Buscar input/select por sufijo de nombre
                                    const candidate = nueva.querySelector(`[name$="_${k}"]`);
                                    if (!candidate) return;
                                    if (candidate.type === 'checkbox') {
                                        candidate.checked = !!val;
                                    } else if (candidate.type === 'radio') {
                                        const radio = nueva.querySelector(`[name$="_${k}"][value="${val}"]`);
                                        if (radio) radio.checked = true;
                                    } else {
                                        candidate.value = val;
                                    }
                                });
                            }
                        });
                    }
                });
                // Cantidad de lote
                const cant = document.getElementById('cantidadUnidadesLote');
                if (cant && cotizacionData.cantidadLote) cant.value = cotizacionData.cantidadLote;
            }
        }

        function mostrarAutoGuardado() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        async function guardarBorradorSupabase() {
            // Generar/recuperar ID de borrador consistente
            let draftId = localStorage.getItem('cotizacion_progreso_id');
            if (!draftId) {
                draftId = `DRAFT-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
                localStorage.setItem('cotizacion_progreso_id', draftId);
            }

            // Asegurar que vehiculos y soluciones est√©n sincronizados desde el DOM
            try {
                sincronizarVehiculosYSolucionesDesdeDOM();
            } catch (_) {}

            // Construir objeto de cotizaci√≥n (borrador)
            const draft = construirBorradorDesdeDatos(cotizacionData, draftId);
            // Upsert en Supabase
            await window.dataService.upsertCotizacion(draft);
        }

        function construirBorradorDesdeDatos(data, draftId) {
            const cliente = data.cliente || {};
            // Mapear vehiculos a "unidades" b√°sicas del borrador
            const unidades = Array.isArray(data.vehiculos) ? data.vehiculos.map(v => ({
                marca: v.marca || '',
                tipo_unidad: v.tipo || v.tipo_unidad || '',
                modelo: v.modelo || '',
                anio: v.a√±o || v.anio || '',
                combustible: v.combustible || '',
                voltaje: v.voltaje || '',
                soluciones: Array.isArray(v.soluciones) ? v.soluciones : []
            })) : [];

            // Intentar calcular total si hay precios en cache; si falla, 0
            let total = 0;
            try { total = calcularTotalCotizacion(unidades, data) || 0; } catch (_) { total = 0; }

            const draft = {
                id: draftId,
                estado: 'borrador',
                fecha_cotizacion: new Date().toISOString().split('T')[0],
                cliente_nombre: cliente.nombre || '',
                empresa: cliente.empresa || '',
                tipo_cliente: cliente.tipo || '',
                descuento: cliente.descuento || 0,
                fecha_vencimiento: cliente.fecha_vencimiento || '',
                urgente: cliente.urgente || 'baja',
                dias_seguimiento: cliente.dias_seguimiento || '7',
                observaciones: cliente.observaciones || '',
                tipoVenta: data.tipoVenta || 'instalacion',
                cantidadLote: data.cantidadLote || null,
                unidades,
                soluciones: data.soluciones || [],
                insumos: data.insumos || [],
                servicios: data.servicios || [],
                accesorios: data.accesorios || [],
                insumosSugeridos: data.insumosSugeridos || [],
                accesoriosSugeridos: data.accesoriosSugeridos || [],
                equiposAutomaticos: data.equiposAutomaticos || {},
                equipos: data.equipos || {},
                // Campos de progreso de ventas
                fecha_envio: null,
                fecha_seguimiento: null,
                fecha_aceptacion: null,
                fecha_rechazo: null,
                fecha_instalacion: null,
                fecha_facturacion: null,
                observaciones_rechazo: null,
                facturada: false,
                total: Number(total) || 0
            };
            return draft;
        }

        // Fuerza una recolecci√≥n de unidades y soluciones desde el DOM (independiente del paso activo)
        function sincronizarVehiculosYSolucionesDesdeDOM() {
            const cantidadLoteInput = document.getElementById('cantidadUnidadesLote');
            const tipoVentaSelect = document.getElementById('tipoVenta');
            const cantidadLote = cantidadLoteInput && cantidadLoteInput.value ? parseInt(cantidadLoteInput.value) : null;
            const tipoVenta = tipoVentaSelect && tipoVentaSelect.value ? tipoVentaSelect.value : (cotizacionData.tipoVenta || 'instalacion');
            cotizacionData.cantidadLote = cantidadLote;
            cotizacionData.tipoVenta = tipoVenta;

            const nuevasUnidades = [];
            const items = document.querySelectorAll('.unidad-vehiculo-item');
            items.forEach((item, index) => {
                const vehiculo = {
                    marca: item.querySelector('[name^="vehiculo_marca_"]').value,
                    tipo: item.querySelector('[name^="vehiculo_tipo_"]').value,
                    combustible: item.querySelector('[name^="vehiculo_combustible_"]').value,
                    voltaje: item.querySelector('[name^="vehiculo_voltaje_"]').value,
                    modelo: item.querySelector('[name^="vehiculo_modelo_"]').value,
                    a√±o: item.querySelector('[name^="vehiculo_a√±o_"]').value,
                    soluciones: [],
                    cantidadLote: index === 0 ? cotizacionData.cantidadLote : null
                };
                const unidadId = index + 1;
                const solucionesContainer = document.querySelector(`.soluciones-unidad-container-${unidadId}`);
                if (solucionesContainer) {
                    const solucionesItems = solucionesContainer.querySelectorAll('.solucion-item');
                    solucionesItems.forEach(solucionItem => {
                        const tipoSelect = solucionItem.querySelector('.solucion-tipo');
                        if (tipoSelect && tipoSelect.value) {
                            const solucion = { tipo_solucion: tipoSelect.value, configuraciones: {} };
                            const configuracionesContainer = solucionItem.querySelector('.configuraciones-solucion');
                            if (configuracionesContainer) {
                                const checkboxes = configuracionesContainer.querySelectorAll('input[type="checkbox"]:checked');
                                checkboxes.forEach(checkbox => {
                                    const configName = checkbox.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                    solucion.configuraciones[configName] = true;
                                });
                                const radios = configuracionesContainer.querySelectorAll('input[type="radio"]:checked');
                                radios.forEach(radio => {
                                    const configName = radio.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                    solucion.configuraciones[configName] = radio.value;
                                });
                                const selects = configuracionesContainer.querySelectorAll('select');
                                selects.forEach(select => {
                                    if (select.value) {
                                        const configName = select.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                        solucion.configuraciones[configName] = select.value;
                                    }
                                });
                                const numberInputs = configuracionesContainer.querySelectorAll('input[type="number"]');
                                numberInputs.forEach(input => {
                                    if (input.value) {
                                        const configName = input.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                        solucion.configuraciones[configName] = input.value;
                                    }
                                });
                                const textareas = configuracionesContainer.querySelectorAll('textarea');
                                textareas.forEach(textarea => {
                                    if (textarea.value.trim()) {
                                        const configName = textarea.name.replace(`${tipoSelect.name.replace('_tipo', '')}_`, '');
                                        solucion.configuraciones[configName] = textarea.value.trim();
                                    }
                                });
                            }
                            vehiculo.soluciones.push(solucion);
                        }
                    });
                }
                nuevasUnidades.push(vehiculo);
            });
            cotizacionData.vehiculos = nuevasUnidades;
        }

        // Funci√≥n actualizarDescuento movida al inicio del script

        function agregarUnidadVehiculo() {
            const container = document.getElementById('unidadesVehiculoContainer');
            const unidadDiv = document.createElement('div');
            unidadDiv.className = 'unidad-vehiculo-item';
            unidadDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0" style="color: #fb930c;">Unidad #${unidadVehiculoCounter}</h6>
                    <div>
                        ${unidadVehiculoCounter > 1 ? `
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="copiarUnidadAnteriorWizard(this)">
                                <i class="bi bi-copy"></i> Copiar Anterior
                            </button>
                        ` : ''}
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarUnidadVehiculo(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label fw-bold" for="vehiculo_tipo_${unidadVehiculoCounter}">Tipo de Unidad</label>
                        <select class="form-select" id="vehiculo_tipo_${unidadVehiculoCounter}" name="vehiculo_tipo_${unidadVehiculoCounter}">
                            <option value="">Seleccionar tipo</option>
                            <option value="1.5 ton">1.5 ton</option>
                            <option value="2.5 ton">2.5 ton</option>
                            <option value="3.5 ton">3.5 ton</option>
                            <option value="4.5 ton">4.5 ton</option>
                            <option value="Autobus pasajeros">Autobus pasajeros</option>
                            <option value="Motocicleta">Motocicleta</option>
                            <option value="Rab√≥n">Rab√≥n</option>
                            <option value="Sedan">Sedan</option>
                            <option value="Sedan lujo">Sedan lujo</option>
                            <option value="SUV">SUV</option>
                            <option value="Torton">Torton</option>
                            <option value="Tracto">Tracto</option>
                            <option value="Tracto Cabina sobre motor">Tracto Cabina sobre motor</option>
                            <option value="Van pasajeros">Van pasajeros</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold" for="vehiculo_marca_${unidadVehiculoCounter}">Marca del Veh√≠culo</label>
                        <select class="form-select" id="vehiculo_marca_${unidadVehiculoCounter}" name="vehiculo_marca_${unidadVehiculoCounter}">
                            <option value="">Seleccionar marca</option>
                            <option value="DAF">DAF</option>
                            <option value="Ford">Ford</option>
                            <option value="Foton">Foton</option>
                            <option value="Freightliner">Freightliner</option>
                            <option value="Hino">Hino</option>
                            <option value="International">International</option>
                            <option value="Isuzu">Isuzu</option>
                            <option value="Kenworth">Kenworth</option>
                            <option value="MACK">MACK</option>
                            <option value="MAN">MAN</option>
                            <option value="Mercedes">Mercedes</option>
                            <option value="Nissan">Nissan</option>
                            <option value="otro">Otro</option>
                            <option value="Scania">Scania</option>
                            <option value="Shacman">Shacman</option>
                            <option value="Volvo">Volvo</option>
                            <option value="VW">VW</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold" for="vehiculo_combustible_${unidadVehiculoCounter}">Combustible</label>
                        <select class="form-select" id="vehiculo_combustible_${unidadVehiculoCounter}" name="vehiculo_combustible_${unidadVehiculoCounter}">
                            <option value="">Seleccionar</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electrico">El√©ctrico</option>
                            <option value="Gas LP">Gas LP</option>
                            <option value="Gasolina">Gasolina</option>
                            <option value="Hibrido">H√≠brido</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold" for="vehiculo_voltaje_${unidadVehiculoCounter}">Voltaje</label>
                        <select class="form-select" id="vehiculo_voltaje_${unidadVehiculoCounter}" name="vehiculo_voltaje_${unidadVehiculoCounter}">
                            <option value="">Voltaje</option>
                            <option value="12v">12v</option>
                            <option value="24v">24v</option>
                            <option value="36v">36v</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label fw-bold" for="vehiculo_modelo_${unidadVehiculoCounter}">Modelo</label>
                        <input type="text" class="form-control" id="vehiculo_modelo_${unidadVehiculoCounter}" name="vehiculo_modelo_${unidadVehiculoCounter}" placeholder="Modelo">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label fw-bold" for="vehiculo_a√±o_${unidadVehiculoCounter}">A√±o</label>
                        <input type="number" class="form-control" id="vehiculo_a√±o_${unidadVehiculoCounter}" name="vehiculo_a√±o_${unidadVehiculoCounter}" min="1990" max="2025" placeholder="A√±o">
                    </div>
                </div>
                
                <!-- Secci√≥n de soluciones para esta unidad -->
                <div class="mt-4 border-top pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-success mb-0">üîß Soluciones para esta unidad</h6>
                        <div>
                            ${unidadVehiculoCounter > 1 ? `
                                <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="copiarSolucionesDeUnidadAnterior(${unidadVehiculoCounter})">
                                    <i class="bi bi-copy"></i> Copiar de Unidad Anterior
                                </button>
                            ` : ''}
                            <button type="button" class="btn btn-sm btn-success" onclick="agregarSolucionAUnidadWizard(this, ${unidadVehiculoCounter})">
                                <i class="bi bi-plus"></i> Agregar Soluci√≥n
                            </button>
                        </div>
                    </div>
                    <div class="soluciones-unidad-container-${unidadVehiculoCounter}">
                        <p class="text-muted">No hay soluciones agregadas. Haz clic en "Agregar Soluci√≥n" para comenzar.</p>
                    </div>
                </div>
            `;
            container.appendChild(unidadDiv);
            unidadVehiculoCounter++;
            
            // Actualizar selects con tipos globales
            setTimeout(() => {
                actualizarTodosLosSelects();
            }, 100);
        }

        function eliminarUnidadVehiculo(button) {
            button.closest('.unidad-vehiculo-item').remove();
        }



        function toggleSolution(solutionId) {
            const checkbox = document.getElementById(`sol_${solutionId}`);
            const card = checkbox.closest('.solution-card');
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                card.classList.add('selected');
                if (!selectedSolutions.includes(solutionId)) {
                    selectedSolutions.push(solutionId);
                }
            } else {
                card.classList.remove('selected');
                selectedSolutions = selectedSolutions.filter(id => id !== solutionId);
            }
            
            actualizarConfiguraciones();
        }

        function actualizarConfiguraciones() {
            const container = document.getElementById('configuracionContainer');
            container.innerHTML = '';
            
            if (selectedSolutions.length === 0) {
                container.innerHTML = `
                    <p class="text-muted text-center py-5">
                        Selecciona un tipo de soluci√≥n en el paso anterior para ver las opciones de configuraci√≥n.
                    </p>
                `;
                return;
            }
            
            selectedSolutions.forEach(solutionId => {
                const solucion = solucionesMaestras.find(s => s.id === solutionId);
                if (solucion && solucion.configuraciones) {
                    const configDiv = document.createElement('div');
                    configDiv.className = 'config-section active mb-4';
                    configDiv.innerHTML = `
                        <h5 class="mb-3" style="color: #fb930c;">${solucion.nombre}</h5>
                        <div class="row">
                            ${solucion.configuraciones.map(config => `
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="config_${solutionId}_${config}">
                                        <label class="form-check-label" for="config_${solutionId}_${config}">
                                            ${config.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(configDiv);
                }
            });
        }

        function cargarInsumos() {
            const selectInsumo = document.getElementById('selectInsumoAdicional');
            if (!selectInsumo) {
                console.error('Select selectInsumoAdicional no encontrado');
                return;
            }
            
            // Limpiar opciones existentes (excepto la primera)
            selectInsumo.innerHTML = '<option value="">Seleccionar insumo adicional...</option>';
            
            // Ordenar insumos alfab√©ticamente y llenar el dropdown
            const insumosOrdenados = [...insumosMaestros].sort();
            insumosOrdenados.forEach(insumo => {
                const option = document.createElement('option');
                option.value = insumo;
                option.textContent = insumo;
                selectInsumo.appendChild(option);
            });
            
            // Inicializar visualizaci√≥n vac√≠a
            actualizarVisualizacionInsumosAdicionales();
        }

        function cargarServicios() {
            const container = document.getElementById('serviciosContainer');
            if (!container) {
                console.error('Container serviciosContainer no encontrado');
                return;
            }
            
            container.innerHTML = '';
            
            serviciosMaestros.forEach(servicio => {
                const item = document.createElement('div');
                item.className = 'form-check mb-2';
                item.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="servicio_${servicio.replace(/\s+/g, '_').replace(/-/g, '_')}">
                    <label class="form-check-label" for="servicio_${servicio.replace(/\s+/g, '_').replace(/-/g, '_')}">
                        ${servicio}
                    </label>
                `;
                container.appendChild(item);
            });
        }

        function cargarAccesorios() {
            const container = document.getElementById('accesoriosContainer');
            if (!container) {
                console.error('Container accesoriosContainer no encontrado');
                return;
            }
            
            container.innerHTML = '';
            
            accesoriosMaestros.forEach(accesorio => {
                const item = document.createElement('div');
                item.className = 'form-check mb-2';
                item.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="accesorio_${accesorio.replace(/\s+/g, '_')}">
                    <label class="form-check-label" for="accesorio_${accesorio.replace(/\s+/g, '_')}">
                        ${accesorio}
                    </label>
                `;
                container.appendChild(item);
            });
        }

        function generarResumen() {
            const container = document.getElementById('resumenContainer');
            const tempData = JSON.parse(localStorage.getItem('cotizacion_temp')) || {};
            container.innerHTML = '';

            // Cliente
            if (tempData.cliente_nombre || cotizacionData.cliente) {
                const clienteDiv = document.createElement('div');
                clienteDiv.className = 'resumen-item';
                clienteDiv.innerHTML = `
                    <h5 style="color: #fb930c;"><i class="bi bi-person-badge me-2"></i>Cliente</h5>
                    <p><strong>Nombre:</strong> ${tempData.cliente_nombre || cotizacionData.cliente?.nombre || 'No especificado'}</p>
                    <p><strong>Empresa:</strong> ${tempData.empresa || cotizacionData.cliente?.empresa || 'N/A'}</p>
                    <p><strong>Tipo:</strong> ${tempData.tipo_cliente || cotizacionData.cliente?.tipo || 'No especificado'} (${tempData.descuento || cotizacionData.cliente?.descuento || 0}% descuento)</p>
                    ${tempData.observaciones ? `<p><strong>Observaciones:</strong> ${tempData.observaciones}</p>` : ''}
                `;
                container.appendChild(clienteDiv);
            }

            // Veh√≠culos/Unidades
            const vehiculos = tempData.unidades || cotizacionData.vehiculos || [];
            if (vehiculos.length > 0) {
                // Calcular total de unidades considerando lotes
                let totalUnidades = 0;
                const cantidadLote = cotizacionData.cantidadLote || tempData.cantidadLote;
                
                vehiculos.forEach((vehiculo, index) => {
                    if (index === 0 && cantidadLote && cantidadLote > 1) {
                        totalUnidades += cantidadLote;
                    } else if (!vehiculo.esLote) {
                        totalUnidades += 1;
                    } else if (index === 0) {
                        totalUnidades += 1;
                    }
                });
                
                const vehiculosDiv = document.createElement('div');
                vehiculosDiv.className = 'resumen-item';
                
                // Detectar si es lote con unidades id√©nticas
                const esLoteIdentico = cantidadLote && cantidadLote > 1;
                
                if (esLoteIdentico) {
                    // Mostrar formato compacto para lotes
                    const unidadModelo = vehiculos[0];
                    vehiculosDiv.innerHTML = `
                        <h5 style="color: #fb930c;"><i class="bi bi-truck me-2"></i>Cotizaci√≥n en Lote</h5>
                        <div class="alert alert-success">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-2"><i class="bi bi-layers me-1"></i>Cantidad: ${cantidadLote} unidades id√©nticas</h6>
                                    <p class="mb-1"><strong>Modelo:</strong> ${unidadModelo.marca || 'Sin marca'} ${unidadModelo.tipo_unidad || unidadModelo.tipo || 'Sin tipo'} ${unidadModelo.modelo || ''} ${unidadModelo.anio || unidadModelo.a√±o || ''}</p>
                                    <p class="mb-1"><strong>Especificaciones:</strong> ${unidadModelo.combustible || 'Sin combustible'} - ${unidadModelo.voltaje || 'Sin voltaje'}</p>
                                    <p class="mb-0"><strong>Tipo de Venta:</strong> 
                                        <span class="badge ${cotizacionData.tipoVenta === 'instalacion' ? 'bg-success' : 'bg-warning'}">
                                            ${cotizacionData.tipoVenta === 'instalacion' ? 'Instalaci√≥n por nuestro personal' : 'Solo venta de equipos'}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge fs-6" style="background-color: #fb930c;">${cantidadLote}x</span>
                                </div>
                            </div>
                            ${unidadModelo.soluciones && unidadModelo.soluciones.length > 0 ? `
                                <hr class="my-2">
                                <div class="mt-2">
                                    <strong class="text-success"><i class="bi bi-gear me-1"></i>Soluciones por unidad:</strong>
                                    <div class="mt-2">
                                        ${unidadModelo.soluciones.map(sol => `
                                            <div class="mb-2 p-2 bg-white rounded border-start border-success border-3">
                                                <span class="badge bg-secondary me-2">${sol.tipo_solucion || 'Sin especificar'}</span>
                                                ${sol.configuraciones && Object.keys(sol.configuraciones).length > 0 ? `
                                                    <div class="ms-3 mt-1">
                                                        <small class="text-muted">
                                                            <strong>Configuraciones:</strong><br>
                                                            ${Object.keys(sol.configuraciones).filter(k => sol.configuraciones[k]).map(k => {
                                                                const value = sol.configuraciones[k];
                                                                const formattedKey = k.replace(/_/g, ' ')
                                                                    .replace(/\b\w/g, l => l.toUpperCase())
                                                                    .replace('Sensor Vpc', 'Sensor VPC')
                                                                    .replace(' Vpc', ' VPC');
                                                                
                                                                if (typeof value === 'boolean' && value) {
                                                                    return `‚Ä¢ ${formattedKey}`;
                                                                } else if (typeof value === 'string' && value !== 'true') {
                                                                    return `‚Ä¢ ${formattedKey}: ${value}`;
                                                                } else if (typeof value === 'number') {
                                                                    return `‚Ä¢ ${formattedKey}: ${value}`;
                                                                }
                                                                return null;
                                                            }).filter(item => item !== null).join('<br>')}
                                                        </small>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    // Mostrar formato detallado para unidades individuales
                    vehiculosDiv.innerHTML = `
                        <h5 style="color: #fb930c;"><i class="bi bi-truck me-2"></i>Unidades (${totalUnidades})</h5>
                        ${vehiculos.map((vehiculo, index) => `
                            <div class="mb-3 border rounded p-2">
                                <strong>Unidad ${index + 1}:</strong> ${vehiculo.marca || 'Sin marca'} ${vehiculo.tipo_unidad || vehiculo.tipo || 'Sin tipo'} ${vehiculo.modelo || ''} ${vehiculo.anio || vehiculo.a√±o || ''} - ${vehiculo.combustible || 'Sin combustible'} ${vehiculo.voltaje || ''}
                                ${vehiculo.soluciones && vehiculo.soluciones.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-muted"><strong>Soluciones:</strong></small>
                                        ${vehiculo.soluciones.map(sol => `
                                            <div class="mb-2">
                                                <span class="badge bg-secondary me-2">${sol.tipo_solucion || 'Sin especificar'}</span>
                                                ${sol.configuraciones && Object.keys(sol.configuraciones).length > 0 ? `
                                                    <div class="ms-3 mt-1">
                                                        <small class="text-muted">
                                                            <strong>Configuraciones:</strong><br>
                                                            ${Object.keys(sol.configuraciones).filter(k => sol.configuraciones[k]).map(k => {
                                                                const value = sol.configuraciones[k];
                                                                const formattedKey = k.replace(/_/g, ' ')
                                                                    .replace(/\b\w/g, l => l.toUpperCase())
                                                                    .replace('Sensor Vpc', 'Sensor VPC')
                                                                    .replace(' Vpc', ' VPC');
                                                                
                                                                if (typeof value === 'boolean' && value) {
                                                                    return `‚Ä¢ ${formattedKey}`;
                                                                } else if (typeof value === 'string' && value !== 'true') {
                                                                    return `‚Ä¢ ${formattedKey}: ${value}`;
                                                                } else if (typeof value === 'number') {
                                                                    return `‚Ä¢ ${formattedKey}: ${value}`;
                                                                }
                                                                return null;
                                                            }).filter(item => item !== null).join('<br>')}
                                                        </small>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    `;
                }
                
                container.appendChild(vehiculosDiv);
            }

            // Soluciones globales (si las hay)
            const solucionesGlobales = tempData.soluciones || cotizacionData.soluciones || [];
            if (solucionesGlobales.length > 0 && !tempData.unidades) {
                const solucionesDiv = document.createElement('div');
                solucionesDiv.className = 'resumen-item';
                const solucionesNombres = solucionesGlobales.map(id => {
                    const solucion = solucionesMaestras.find(s => s.id === id);
                    return solucion ? solucion.nombre : id;
                }).join(', ');
                solucionesDiv.innerHTML = `
                    <h5 style="color: #fb930c;"><i class="bi bi-gear me-2"></i>Soluciones</h5>
                    <p>${solucionesNombres}</p>
                `;
                container.appendChild(solucionesDiv);
            }

            // Equipos y Accesorios Autom√°ticos (recalcular desde las soluciones)
            const vehiculosParaEquipos = tempData.unidades || cotizacionData.vehiculos || [];
            const equiposAutomaticos = generarEquiposAutomaticos(vehiculosParaEquipos);
            const cantidadLoteEquipos = cotizacionData.cantidadLote || 1;

            // Separar por categor√≠as
            const equiposReales = Object.values(equiposAutomaticos).filter(equipo => equipo.categoria === 'equipos');
            const accesoriosReales = Object.values(equiposAutomaticos).filter(equipo => equipo.categoria === 'accesorios');
            const insumosReales = Object.values(equiposAutomaticos).filter(equipo => equipo.categoria === 'insumos');

            // Mostrar Equipos Autom√°ticos
            if (equiposReales.length > 0) {
                const equiposDiv = document.createElement('div');
                equiposDiv.className = 'resumen-item';
                
                let htmlEquipos = `<h5 style="color: #fb930c;"><i class="bi bi-cpu me-2"></i>Equipos Autom√°ticos</h5>`;
                
                if (cantidadLoteEquipos > 1) {
                    htmlEquipos += `<div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Cantidades ajustadas para ${cantidadLoteEquipos} unidades en lote</strong>
                    </div>`;
                }
                
                htmlEquipos += `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Equipo</th>
                                    <th>Cantidad Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${equiposReales.map(equipo => {
                                    const cantidadTotal = equipo.cantidad * cantidadLoteEquipos;
                                    
                                    return `
                                        <tr>
                                            <td><span class="badge" style="background-color: #fb930c;">${equipo.nombre}</span></td>
                                            <td><strong>${cantidadTotal}</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                equiposDiv.innerHTML = htmlEquipos;
                container.appendChild(equiposDiv);
            }

            // Mostrar Accesorios Autom√°ticos
            if (accesoriosReales.length > 0) {
                const accesoriosDiv = document.createElement('div');
                accesoriosDiv.className = 'resumen-item';
                
                let htmlAccesorios = `<h5 class="text-success"><i class="bi bi-gear me-2"></i>Accesorios Autom√°ticos</h5>`;
                
                if (cantidadLoteEquipos > 1) {
                    htmlAccesorios += `<div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Cantidades ajustadas para ${cantidadLoteEquipos} unidades en lote</strong>
                    </div>`;
                }
                
                htmlAccesorios += `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Accesorio</th>
                                    <th>Cantidad Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accesoriosReales.map(accesorio => {
                                    const cantidadTotal = accesorio.cantidad * cantidadLoteEquipos;
                                    
                                    return `
                                        <tr>
                                            <td><span class="badge bg-success">${accesorio.nombre}</span></td>
                                            <td><strong>${cantidadTotal}</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                accesoriosDiv.innerHTML = htmlAccesorios;
                container.appendChild(accesoriosDiv);
            }

            // Mostrar Insumos Autom√°ticos (Materia Prima)
            if (insumosReales.length > 0) {
                const insumosDiv = document.createElement('div');
                insumosDiv.className = 'resumen-item';
                
                let htmlInsumos = `<h5 class="text-warning"><i class="bi bi-hammer me-2"></i>Insumos Autom√°ticos (Materia Prima)</h5>`;
                
                if (cantidadLoteEquipos > 1) {
                    htmlInsumos += `<div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Cantidades ajustadas para ${cantidadLoteEquipos} unidades en lote</strong>
                    </div>`;
                }
                
                htmlInsumos += `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${insumosReales.map(insumo => {
                                    const cantidadTotal = insumo.cantidad * cantidadLoteEquipos;
                                    
                                    return `
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">${insumo.nombre}</span></td>
                                            <td><strong>${cantidadTotal}</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                insumosDiv.innerHTML = htmlInsumos;
                container.appendChild(insumosDiv);
            }

            // Insumos Sugeridos y Adicionales (con multiplicaci√≥n por lotes)
            const insumosSugeridos = cotizacionData.insumosSugeridos || [];
            const insumosAdicionales = cotizacionData.insumos || [];
            const cantidadLoteInsumos = cotizacionData.cantidadLote || 1;
            
            if (insumosSugeridos.length > 0 || insumosAdicionales.length > 0) {
                const insumosDiv = document.createElement('div');
                insumosDiv.className = 'resumen-item';
                
                let totalInsumos = 0;
                let html = `<h5 style="color: #fb930c;"><i class="bi bi-box me-2"></i>Insumos</h5>`;
                
                if (cantidadLoteInsumos > 1) {
                    html += `<div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Cantidades multiplicadas por ${cantidadLoteInsumos} unidades en lote</strong>
                    </div>`;
                }
                
                if (insumosSugeridos.length > 0) {
                    totalInsumos += insumosSugeridos.length;
                    html += `
                        <h6 class="text-success mt-3">
                            <i class="bi bi-lightbulb me-1"></i>Sugeridos Autom√°ticamente (${insumosSugeridos.length} tipos)
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Insumo</th>
                                        <th>Cantidad Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${insumosSugeridos.map(insumo => {
                                        // Usar la cantidad ya calculada y guardada
                                        const cantidadTotal = insumo.cantidad || 0;
                                        
                                        return `
                                            <tr>
                                                <td><span class="badge bg-success">${insumo.nombre}</span></td>
                                                <td><strong>${cantidadTotal}</strong></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                if (insumosAdicionales.length > 0) {
                    totalInsumos += insumosAdicionales.length;
                    html += `
                        <h6 class="text-info mt-3">
                            <i class="bi bi-plus-circle me-1"></i>Adicionales (${insumosAdicionales.length} tipos)
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Insumo</th>
                                        <th>Cantidad Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${insumosAdicionales.map(insumo => {
                                        const cantidadTotal = (insumo.cantidad || 1) * cantidadLoteInsumos;
                                        return `
                                            <tr>
                                                <td><span class="badge bg-info">${insumo.nombre}</span></td>
                                                <td><strong>${cantidadTotal}</strong></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                html += `<div class="alert alert-secondary mt-3">
                    <strong><i class="bi bi-calculator me-2"></i>Total de tipos de insumos: ${totalInsumos}</strong>
                </div>`;
                
                insumosDiv.innerHTML = html;
                container.appendChild(insumosDiv);
            }

            // Servicios de Datos Sugeridos
            const serviciosSugeridos = cotizacionData.serviciosSugeridos || [];
            if (serviciosSugeridos.length > 0) {
                const serviciosDiv = document.createElement('div');
                serviciosDiv.className = 'resumen-item';
                
                // Agrupar servicios por nombre y periodicidad
                const serviciosAgrupados = {};
                serviciosSugeridos.forEach(servicio => {
                    const key = `${servicio.nombre}_${servicio.periodicidad}`;
                    if (!serviciosAgrupados[key]) {
                        serviciosAgrupados[key] = {
                            nombre: servicio.nombre,
                            periodicidad: servicio.periodicidad,
                            cantidad: 0,
                            unidades: []
                        };
                    }
                    serviciosAgrupados[key].cantidad += servicio.cantidad;
                    serviciosAgrupados[key].unidades.push(servicio.unidad);
                });
                
                const serviciosUnicos = Object.values(serviciosAgrupados);
                
                serviciosDiv.innerHTML = `
                    <h5 style="color: #fb930c;"><i class="bi bi-cloud me-2"></i>Servicios de Datos Sugeridos (${serviciosUnicos.length})</h5>
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Servicios detectados autom√°ticamente seg√∫n las soluciones seleccionadas</strong>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Periodicidad</th>
                                    <th>Cantidad</th>
                                    <th>Aplicado en</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviciosUnicos.map(servicio => `
                                    <tr>
                                        <td><span class="badge bg-primary">${servicio.nombre}</span></td>
                                        <td>
                                            <span class="badge ${servicio.periodicidad === 'anual' ? 'bg-danger' : 'bg-info'}">
                                                ${servicio.periodicidad}
                                            </span>
                                        </td>
                                        <td><strong>${servicio.cantidad}</strong></td>
                                        <td>
                                            <small class="text-muted">
                                                Unidades: ${servicio.unidades.join(', ')}
                                            </small>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(serviciosDiv);
            }

            // Accesorios
            const accesorios = cotizacionData.accesorios || [];
            if (accesorios.length > 0) {
                const accesoriosDiv = document.createElement('div');
                accesoriosDiv.className = 'resumen-item';
                accesoriosDiv.innerHTML = `
                    <h5 style="color: #fb930c;"><i class="bi bi-plus-square me-2"></i>Accesorios (${accesorios.length})</h5>
                    <div class="row">
                        ${accesorios.map(accesorio => `
                            <div class="col-md-6 mb-1">
                                <span class="badge bg-info me-1">${accesorio}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(accesoriosDiv);
            }

            // Dashboard de totales eliminado por solicitud del usuario
        }

        // Funci√≥n guardarBorrador movida al inicio del script

        async function crearCotizacionFinal() {
            // Recopilar todos los datos finales
            guardarPasoActual();
            
            // Verificar si estamos en modo edici√≥n
            const urlParams = new URLSearchParams(window.location.search);
            const editarId = urlParams.get('editar');
            const datosEdicion = localStorage.getItem('cotizacion_editar');
            
            // Procesar unidades considerando cantidad de lote
            let unidadesFinales = [];
            
            cotizacionData.vehiculos.forEach((vehiculo, index) => {
                const unidadBase = {
                    marca: vehiculo.marca,
                    tipo_unidad: vehiculo.tipo,
                    modelo: vehiculo.modelo,
                    anio: vehiculo.a√±o,
                    combustible: vehiculo.combustible,
                    voltaje: vehiculo.voltaje,
                    soluciones: vehiculo.soluciones || []
                };
                
                // Si es la primera unidad y tiene cantidad de lote, multiplicar
                if (index === 0 && vehiculo.cantidadLote && vehiculo.cantidadLote > 1) {
                    for (let i = 0; i < vehiculo.cantidadLote; i++) {
                        unidadesFinales.push({
                            ...unidadBase,
                            numeroUnidad: i + 1,
                            esLote: true
                        });
                    }
                } else {
                    unidadesFinales.push(unidadBase);
                }
            });
            
            let cotizacionFinal;
            
            if (editarId && datosEdicion) {
                // Modo edici√≥n: actualizar cotizaci√≥n existente
                const cotizacionOriginal = JSON.parse(datosEdicion);
                cotizacionFinal = {
                    ...cotizacionOriginal, // Mantener ID, folio y fecha original
                    cliente_nombre: cotizacionData.cliente.nombre,
                    empresa: cotizacionData.cliente.empresa,
                    tipo_cliente: cotizacionData.cliente.tipo,
                    descuento: cotizacionData.cliente.descuento,
                    fecha_vencimiento: cotizacionData.cliente.fecha_vencimiento,
                    urgente: cotizacionData.cliente.urgente,
                    tipoVenta: cotizacionData.tipoVenta || cotizacionOriginal.tipoVenta || 'instalacion',
                    observaciones: cotizacionData.cliente.observaciones,
                    unidades: unidadesFinales,
                    cantidadLote: cotizacionData.cantidadLote,
                    // Mantener soluciones globales por compatibilidad
                    soluciones: cotizacionData.soluciones || [],
                    configuraciones: cotizacionData.configuraciones || {},
                    insumos: cotizacionData.insumos || [],
                    servicios: cotizacionData.servicios || [],
                    accesorios: cotizacionData.accesorios || [],
                    // Datos generados autom√°ticamente
                    insumosSugeridos: cotizacionData.insumosSugeridos || [],
                    accesoriosSugeridos: cotizacionData.accesoriosSugeridos || [],
                    equiposAutomaticos: cotizacionData.equiposAutomaticos || {},
                    fecha_modificacion: new Date().toISOString().split("T")[0]
                };
                
                // Si es un draft (id empieza con DRAFT o no tiene folio), convertir a cotizaci√≥n con folio nuevo
                if (!cotizacionFinal.folio || String(cotizacionFinal.id || '').startsWith('DRAFT-')) {
                    cotizacionFinal.folio = `COT-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`;
                    // opcional: remover prefijo draft del id para permitir estados operativos
                    cotizacionFinal.id = undefined;
                }

                // Guardar actualizaci√≥n en Supabase o localStorage
                try {
                    if (modoCentralizado) {
                        // Si venimos de un draft, eliminar el draft antiguo por id o folio
                        const draftId = localStorage.getItem('cotizacion_progreso_id');
                        let deleteKey = draftId;
                        if (!deleteKey) {
                            if (editarId && String(editarId).startsWith('DRAFT-')) deleteKey = editarId;
                            else if (cotizacionOriginal && cotizacionOriginal.id && String(cotizacionOriginal.id).startsWith('DRAFT-')) deleteKey = cotizacionOriginal.id;
                        }
                        await window.dataService.upsertCotizacion(cotizacionFinal);
                        if (deleteKey) {
                            try { await window.dataService.deleteCotizacionByIdOrFolio(deleteKey); } catch (_) {}
                        }
                    } else {
                        let cotizacionesExistentes = JSON.parse(localStorage.getItem('cotizaciones_guardadas') || '[]');
                        const index = cotizacionesExistentes.findIndex(c => c.id == editarId);
                        if (index !== -1) {
                            cotizacionesExistentes[index] = cotizacionFinal;
                        } else {
                            cotizacionesExistentes.push(cotizacionFinal);
                        }
                        localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizacionesExistentes));
                    }
                } catch (e) {
                    console.error('‚ùå Error actualizando cotizaci√≥n en Supabase:', e);
                }
                
                // Limpiar datos de edici√≥n
                localStorage.removeItem('cotizacion_editar');
                
                alert('¬°Cotizaci√≥n actualizada exitosamente!');
            } else {
                // Modo creaci√≥n: nueva cotizaci√≥n
                cotizacionFinal = {
                    id: undefined,
                    folio: `COT-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, "0")}`,
                    cliente_nombre: cotizacionData.cliente.nombre,
                    empresa: cotizacionData.cliente.empresa,
                    tipo_cliente: cotizacionData.cliente.tipo,
                    descuento: cotizacionData.cliente.descuento,
                    fecha_vencimiento: cotizacionData.cliente.fecha_vencimiento,
                    urgente: cotizacionData.cliente.urgente,
                    tipoVenta: cotizacionData.tipoVenta || 'instalacion',
                    observaciones: cotizacionData.cliente.observaciones,
                    estado: "borrador",
                    fecha_cotizacion: new Date().toISOString().split("T")[0],
                    total: calcularTotalCotizacion(unidadesFinales, cotizacionData),
                    unidades: unidadesFinales,
                    cantidadLote: cotizacionData.cantidadLote,
                    // Mantener soluciones globales por compatibilidad
                    soluciones: cotizacionData.soluciones || [],
                    configuraciones: cotizacionData.configuraciones || {},
                    insumos: cotizacionData.insumos || [],
                    servicios: cotizacionData.servicios || [],
                    accesorios: cotizacionData.accesorios || [],
                    // Datos generados autom√°ticamente
                    insumosSugeridos: cotizacionData.insumosSugeridos || [],
                    accesoriosSugeridos: cotizacionData.accesoriosSugeridos || [],
                    equiposAutomaticos: cotizacionData.equiposAutomaticos || {},
                    equipos: cotizacionData.equipos || {},
                    // Campos de progreso de ventas
                    dias_seguimiento: cotizacionData.cliente?.dias_seguimiento || '7',
                    fecha_envio: null,
                    fecha_seguimiento: null,
                    fecha_aceptacion: null,
                    fecha_rechazo: null,
                    fecha_instalacion: null,
                    fecha_facturacion: null,
                    observaciones_rechazo: null,
                    facturada: false
                };
                
                console.log('üîç DEBUG COTIZACION FINAL - equiposAutomaticos:', cotizacionData.equiposAutomaticos);
                console.log('üîç DEBUG COTIZACION FINAL - equipos:', cotizacionData.equipos);
                console.log('üîç DEBUG COTIZACION FINAL - cotizacionFinal completa:', cotizacionFinal);
                
                // Guardar en Supabase o localStorage
                try {
                    if (modoCentralizado) {
                        // Insertar primero
                        await window.dataService.upsertCotizacion(cotizacionFinal);
                        // Eliminar draft si exist√≠a
                        const draftId = localStorage.getItem('cotizacion_progreso_id');
                        const deleteKey = draftId;
                        if (deleteKey) {
                            try { await window.dataService.deleteCotizacionByIdOrFolio(deleteKey); } catch (_) {}
                        }
                    } else {
                        let cotizacionesExistentes = JSON.parse(localStorage.getItem('cotizaciones_guardadas') || '[]');
                        cotizacionesExistentes.push(cotizacionFinal);
                        localStorage.setItem('cotizaciones_guardadas', JSON.stringify(cotizacionesExistentes));
                    }
                } catch (e) {
                    console.error('‚ùå Error creando cotizaci√≥n en Supabase:', e);
                }
                
                alert('¬°Cotizaci√≥n creada exitosamente!');
            }
            
            // Limpiar progreso y draftId
            localStorage.removeItem('cotizacion_progreso');
            localStorage.removeItem('cotizacion_progreso_id');
            
            // Redirigir a la lista
            window.location.href = 'cotizaciones-completo.html';
        }
        // ===== NUEVAS FUNCIONES PARA SOLUCIONES POR UNIDAD =====
        
        function copiarSolucionesDeUnidadAnterior(unidadActualId) {
            // Buscar la unidad anterior
            const unidadAnteriorId = unidadActualId - 1;
            const containerAnterior = document.querySelector(`.soluciones-unidad-container-${unidadAnteriorId}`);
            const containerActual = document.querySelector(`.soluciones-unidad-container-${unidadActualId}`);
            
            if (!containerAnterior || !containerActual) {
                mostrarAlerta('No se puede copiar: unidad anterior no encontrada', 'danger');
                return;
            }
            
            const solucionesAnteriores = containerAnterior.querySelectorAll('.solucion-item');
            if (solucionesAnteriores.length === 0) {
                mostrarAlerta('La unidad anterior no tiene soluciones para copiar', 'warning');
                return;
            }
            
            // Limpiar soluciones actuales
            containerActual.innerHTML = '';
            
            // Copiar cada soluci√≥n de la unidad anterior
            solucionesAnteriores.forEach((solucionAnterior, index) => {
                // Crear nueva soluci√≥n
                agregarSolucionAUnidadWizard(null, unidadActualId);
                
                // Obtener la nueva soluci√≥n creada
                const nuevasSoluciones = containerActual.querySelectorAll('.solucion-item');
                const nuevaSolucion = nuevasSoluciones[nuevasSoluciones.length - 1];
                
                // Copiar tipo de soluci√≥n
                const tipoAnterior = solucionAnterior.querySelector('.solucion-tipo');
                const tipoNuevo = nuevaSolucion.querySelector('.solucion-tipo');
                if (tipoAnterior && tipoNuevo) {
                    tipoNuevo.value = tipoAnterior.value;
                    
                    // Disparar el evento change para mostrar configuraciones
                    mostrarConfiguracionesSolucionWizard(tipoNuevo);
                    
                    // Copiar configuraciones despu√©s de un peque√±o delay
                    setTimeout(() => {
                        const checkboxesAnteriores = solucionAnterior.querySelectorAll('input[type="checkbox"]:checked');
                        checkboxesAnteriores.forEach(checkbox => {
                            const nombre = checkbox.name.split('_').slice(-1)[0];
                            const checkboxNuevo = nuevaSolucion.querySelector(`input[name$="_${nombre}"]`);
                            if (checkboxNuevo) {
                                checkboxNuevo.checked = true;
                            }
                        });
                    }, 200);
                }
            });
            
            mostrarAlerta(`${solucionesAnteriores.length} soluciones copiadas de la unidad anterior`, 'success');
        }

        function copiarUnidadAnteriorWizard(button) {
            const unidadActual = button.closest('.unidad-vehiculo-item');
            const todasLasUnidades = document.querySelectorAll('.unidad-vehiculo-item');
            const indiceActual = Array.from(todasLasUnidades).indexOf(unidadActual);
            
            if (indiceActual > 0) {
                const unidadAnterior = todasLasUnidades[indiceActual - 1];
                
                // Obtener el n√∫mero de la unidad actual
                const numeroUnidadActual = unidadActual.querySelector('h6').textContent.replace('Unidad #', '');
                
                // Copiar valores de campos b√°sicos
                const campos = ['marca', 'tipo', 'combustible', 'voltaje'];
                campos.forEach(campo => {
                    const selectAnterior = unidadAnterior.querySelector(`select[name*="vehiculo_${campo}"]`);
                    const selectActual = unidadActual.querySelector(`select[name*="vehiculo_${campo}"]`);
                    if (selectAnterior && selectActual) {
                        selectActual.value = selectAnterior.value;
                    }
                });
                
                // Copiar modelo y a√±o
                const modeloAnterior = unidadAnterior.querySelector('input[name*="vehiculo_modelo"]');
                const modeloActual = unidadActual.querySelector('input[name*="vehiculo_modelo"]');
                if (modeloAnterior && modeloActual) {
                    modeloActual.value = modeloAnterior.value;
                }
                
                const anioAnterior = unidadAnterior.querySelector('input[name*="vehiculo_anio"]');
                const anioActual = unidadActual.querySelector('input[name*="vehiculo_anio"]');
                if (anioAnterior && anioActual) {
                    anioActual.value = anioAnterior.value;
                }
                
                mostrarAlerta('Datos copiados de la unidad anterior', 'success');
            }
        }
        
        function copiarUnidadAnterior(button) {
            const unidadActual = button.closest('.unidad-vehiculo-item');
            const todasLasUnidades = document.querySelectorAll('.unidad-vehiculo-item');
            const indiceActual = Array.from(todasLasUnidades).indexOf(unidadActual);
            
            if (indiceActual > 0) {
                const unidadAnterior = todasLasUnidades[indiceActual - 1];
                
                // Copiar valores de campos b√°sicos
                const campos = ['marca', 'tipo', 'combustible', 'voltaje'];
                campos.forEach(campo => {
                    const selectAnterior = unidadAnterior.querySelector(`select[name*="vehiculo_${campo}"]`);
                    const selectActual = unidadActual.querySelector(`select[name*="vehiculo_${campo}"]`);
                    if (selectAnterior && selectActual) {
                        selectActual.value = selectAnterior.value;
                    }
                });
                
                // Copiar modelo
                const modeloAnterior = unidadAnterior.querySelector('input[name*="vehiculo_modelo"]');
                const modeloActual = unidadActual.querySelector('input[name*="vehiculo_modelo"]');
                if (modeloAnterior && modeloActual) {
                    modeloActual.value = modeloAnterior.value;
                }
                
                mostrarAlerta('Datos copiados de la unidad anterior', 'success');
            }
        }
        
        function agregarSolucionAUnidadWizard(button, unidadId) {
            const container = document.querySelector(`.soluciones-unidad-container-${unidadId}`);
            if (!container) return;
            
            // Si es la primera soluci√≥n, limpiar el mensaje
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }
            
            const solucionIndex = container.children.length + 1;
            const solucionId = `wizard_unidad_${unidadId}_solucion_${solucionIndex}`;
            
            const solucionDiv = document.createElement('div');
            solucionDiv.className = 'solucion-item border rounded p-3 mb-3 bg-light';
            solucionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-info mb-0">Soluci√≥n ${solucionIndex}</h6>
                    <div>

                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarSolucionWizard(this)">Eliminar</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="${solucionId}_tipo">Tipo de Soluci√≥n</label>
                        <select class="form-select solucion-tipo" id="${solucionId}_tipo" name="${solucionId}_tipo" onchange="mostrarConfiguracionesSolucionWizard(this)">
                            <option value="">Seleccionar soluci√≥n</option>
                            <option value="Alarma parlante estandar">Alarma parlante estandar</option>
                            <option value="Alarma parlante programable">Alarma parlante programable</option>
                            <option value="Dashcam">Dashcam</option>
                            <option value="Encadenamiento se√±ales">Encadenamiento se√±ales</option>
                            <option value="Insider">Insider</option>
                            <option value="Led de giro">Led de giro</option>
                            <option value="Limitador de velocidad">Limitador de velocidad</option>
                            <option value="MDVR 4 Ch">MDVR 4 Ch</option>
                            <option value="MDVR 8 Ch">MDVR 8 Ch</option>
                            <option value="Modulo sensor cinturon">Modulo sensor cinturon</option>
                            <option value="Rastreo avanzado">Rastreo avanzado</option>
                            <option value="Rastreo basico">Rastreo basico</option>
                            <option value="Rastreo satelital">Rastreo satelital</option>
                            <option value="Sensor VPC">Sensor VPC</option>
                            <option value="Sideview">Sideview</option>
                            <option value="VPC">VPC</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="configuraciones-solucion">
                            <p class="text-muted">Selecciona un tipo de soluci√≥n para ver las configuraciones disponibles.</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(solucionDiv);
            
            // Actualizar selects con tipos globales
            setTimeout(() => {
                actualizarTodosLosSelects();
            }, 100);
        }
        
        function copiarSolucionAnteriorWizard(button) {
            const solucionActual = button.closest('.solucion-item');
            const container = solucionActual.parentElement;
            const soluciones = container.querySelectorAll('.solucion-item');
            const indiceActual = Array.from(soluciones).indexOf(solucionActual);
            
            if (indiceActual > 0) {
                const solucionAnterior = soluciones[indiceActual - 1];
                
                // Copiar tipo de soluci√≥n
                const tipoAnterior = solucionAnterior.querySelector('.solucion-tipo');
                const tipoActual = solucionActual.querySelector('.solucion-tipo');
                if (tipoAnterior && tipoActual) {
                    tipoActual.value = tipoAnterior.value;
                    mostrarConfiguracionesSolucionWizard(tipoActual);
                }
                
                // Copiar configuraciones
                setTimeout(() => {
                    const checkboxesAnteriores = solucionAnterior.querySelectorAll('input[type="checkbox"]:checked');
                    checkboxesAnteriores.forEach(checkbox => {
                        const nombre = checkbox.name.split('_').slice(-1)[0];
                        const checkboxActual = solucionActual.querySelector(`input[name$="_${nombre}"]`);
                        if (checkboxActual) {
                            checkboxActual.checked = true;
                        }
                    });
                }, 100);
                
                mostrarAlerta('Configuraci√≥n copiada de la soluci√≥n anterior', 'success');
            }
        }
        
        function mostrarConfiguracionesSolucionWizard(select) {
            const solucionItem = select.closest('.solucion-item');
            const container = solucionItem.querySelector('.configuraciones-solucion');
            const tipoSolucion = select.value;
            const solucionId = select.name.replace('_tipo', '');
            
            // Extraer √≠ndices del solucionId (formato: wizard_unidad_${unidadId}_solucion_${solucionIndex})
            const match = solucionId.match(/wizard_unidad_(\d+)_solucion_(\d+)/);
            const unidadIndex = match ? parseInt(match[1]) - 1 : 0; // Convertir a √≠ndice base 0
            const solucionIndex = match ? parseInt(match[2]) - 1 : 0; // Convertir a √≠ndice base 0
            
            console.log(`üîß DEBUG: Configurando soluci√≥n - Unidad: ${unidadIndex + 1}, Soluci√≥n: ${solucionIndex + 1}`);
            
            if (!tipoSolucion) {
                container.innerHTML = '<p class="text-muted">Selecciona un tipo de soluci√≥n para ver las configuraciones disponibles.</p>';
                return;
            }
            
            let configuracionesHtml = '';
            
            switch (tipoSolucion) {
                case 'VPC':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">C√°maras</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_izquierda" id="${solucionId}_camara_izquierda">
                                    <label class="form-check-label" for="${solucionId}_camara_izquierda">C√°mara Izquierda</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_derecha" id="${solucionId}_camara_derecha">
                                    <label class="form-check-label" for="${solucionId}_camara_derecha">C√°mara Derecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_reversa" id="${solucionId}_camara_reversa">
                                    <label class="form-check-label" for="${solucionId}_camara_reversa">C√°mara de Reversa</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_frontal" id="${solucionId}_camara_frontal">
                                    <label class="form-check-label" for="${solucionId}_camara_frontal">C√°mara Frontal</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_grabacion" id="${solucionId}_grabacion">
                                    <label class="form-check-label" for="${solucionId}_grabacion">Grabaci√≥n</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Compatibles</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sensor_vpc" id="${solucionId}_sensor_vpc" onchange="toggleSensorVpcOptions('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_sensor_vpc">Sensor VPC</label>
                                </div>
                                <div id="${solucionId}_sensor_vpc_options" class="ms-3 mt-2" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_sensor_derecha" id="${solucionId}_sensor_derecha">
                                                <label class="form-check-label" for="${solucionId}_sensor_derecha">Derecha</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_sensor_izquierda" id="${solucionId}_sensor_izquierda">
                                                <label class="form-check-label" for="${solucionId}_sensor_izquierda">Izquierda</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Cantidad por lado</label>
                                            <input type="number" class="form-control form-control-sm" name="${solucionId}_sensor_cantidad" min="1" max="10" placeholder="Ej: 2">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_alarma_parlante_estandar" id="${solucionId}_alarma_parlante_estandar" onchange="toggleAlarmaOptions('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_alarma_parlante_estandar">Alarma parlante est√°ndar</label>
                                </div>
                                <div id="${solucionId}_alarma_options" class="ms-3 mt-2" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_alarma_derecha" id="${solucionId}_alarma_derecha">
                                                <label class="form-check-label" for="${solucionId}_alarma_derecha">Derecha</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_alarma_izquierda" id="${solucionId}_alarma_izquierda">
                                                <label class="form-check-label" for="${solucionId}_alarma_izquierda">Izquierda</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_alarma_reversa" id="${solucionId}_alarma_reversa">
                                                <label class="form-check-label" for="${solucionId}_alarma_reversa">Reversa</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" class="form-control form-control-sm" name="${solucionId}_alarma_cantidad" min="1" max="10" placeholder="Ej: 1">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_led_giro" id="${solucionId}_led_giro" onchange="toggleLedOptions('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_led_giro">Led de giro</label>
                                </div>
                                <div id="${solucionId}_led_options" class="ms-3 mt-2" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_led_derecha" id="${solucionId}_led_derecha">
                                                <label class="form-check-label" for="${solucionId}_led_derecha">Derecha</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="${solucionId}_led_izquierda" id="${solucionId}_led_izquierda">
                                                <label class="form-check-label" for="${solucionId}_led_izquierda">Izquierda</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Cantidad por lado</label>
                                            <input type="number" class="form-control form-control-sm" name="${solucionId}_led_cantidad" min="1" max="20" placeholder="Ej: 4">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_encadenamiento" id="${solucionId}_encadenamiento" onchange="toggleEncadenamientoOptions('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_encadenamiento">Encadenamiento se√±ales</label>
                                </div>
                                <div id="${solucionId}_encadenamiento_options" class="ms-3 mt-2" style="display: none;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="${solucionId}_tipo_encadenamiento" id="${solucionId}_encadenamiento_sencillo" value="sencillo">
                                        <label class="form-check-label" for="${solucionId}_encadenamiento_sencillo">Sencillo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="${solucionId}_tipo_encadenamiento" id="${solucionId}_encadenamiento_full" value="full">
                                        <label class="form-check-label" for="${solucionId}_encadenamiento_full">Full</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Sensor VPC':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-6">
                                <h6 style="color: #fb930c;">Posici√≥n</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_derecha" id="${solucionId}_derecha">
                                    <label class="form-check-label" for="${solucionId}_derecha">Derecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_izquierda" id="${solucionId}_izquierda">
                                    <label class="form-check-label" for="${solucionId}_izquierda">Izquierda</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Cantidad por lado</label>
                                <input type="number" class="form-control" name="${solucionId}_cantidad" min="1" max="10" placeholder="Ej: 2">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Led de giro':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-6">
                                <h6 style="color: #fb930c;">Posici√≥n</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_derecha" id="${solucionId}_derecha">
                                    <label class="form-check-label" for="${solucionId}_derecha">Derecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_izquierda" id="${solucionId}_izquierda">
                                    <label class="form-check-label" for="${solucionId}_izquierda">Izquierda</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Cantidad por lado</label>
                                <input type="number" class="form-control" name="${solucionId}_cantidad" min="1" max="20" placeholder="Ej: 4">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Alarma parlante estandar':
                case 'Alarma parlante programable':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-6">
                                <h6 style="color: #fb930c;">Posici√≥n</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_derecha" id="${solucionId}_derecha">
                                    <label class="form-check-label" for="${solucionId}_derecha">Derecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_izquierda" id="${solucionId}_izquierda">
                                    <label class="form-check-label" for="${solucionId}_izquierda">Izquierda</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_reversa" id="${solucionId}_reversa">
                                    <label class="form-check-label" for="${solucionId}_reversa">Reversa</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control" name="${solucionId}_cantidad" min="1" max="10" placeholder="Ej: 1">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Encadenamiento se√±ales':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Tipo de Encadenamiento</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_tipo" id="${solucionId}_sencillo" value="sencillo">
                                    <label class="form-check-label" for="${solucionId}_sencillo">Sencillo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_tipo" id="${solucionId}_full" value="full">
                                    <label class="form-check-label" for="${solucionId}_full">Full</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_grabacion" id="${solucionId}_grabacion">
                                    <label class="form-check-label" for="${solucionId}_grabacion">Grabaci√≥n</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'MDVR 4 Ch':
                case 'MDVR 8 Ch':
                    const canales = tipoSolucion.includes('4') ? 4 : 8;
                    configuracionesHtml = `
                        <div class="mb-3">
                            <label class="form-label"><strong>Canales (${canales})</strong></label>
                            <div class="row">
                    `;
                    
                    for(let i = 1; i <= canales; i++) {
                        configuracionesHtml += `
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Canal ${i}</label>
                                <select class="form-select form-select-sm" name="${solucionId}_canal_${i}">
                                    <option value="">Sin c√°mara</option>
                                    <option value="radar">C√°mara radar</option>
                                    <option value="microfono">C√°mara con micr√≥fono</option>
                                    <option value="reversa">C√°mara de reversa</option>
                                    <option value="digital">C√°mara Digital (IP)</option>
                                    <option value="exterior_mini">C√°mara exterior mini</option>
                                    <option value="lateral_derecha">C√°mara lateral derecha de VPC</option>
                                    <option value="lateral_izquierda">C√°mara lateral izquierda de VPC</option>
                                </select>
                            </div>
                        `;
                    }
                    
                    configuracionesHtml += `
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="${solucionId}_canal_ip_extra" id="${solucionId}_canal_ip_extra" onchange="toggleCanalIPExtra('${solucionId}')">
                            <label class="form-check-label" for="${solucionId}_canal_ip_extra">Canal extra para c√°mara IP</label>
                        </div>
                        <div id="${solucionId}_canal_ip_container" class="mt-2" style="display: none;">
                            <select class="form-select" name="${solucionId}_canal_ip_tipo" disabled>
                                <option value="digital" selected>C√°mara Digital (IP)</option>
                            </select>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h6 style="color: #fb930c;">Hosting</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Sideview':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Posici√≥n</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_izquierdo" id="${solucionId}_izquierdo">
                                    <label class="form-check-label" for="${solucionId}_izquierdo">Izquierdo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_derecho" id="${solucionId}_derecho">
                                    <label class="form-check-label" for="${solucionId}_derecho">Derecho</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_grabacion" id="${solucionId}_grabacion">
                                    <label class="form-check-label" for="${solucionId}_grabacion">Grabaci√≥n</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Servicios</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Dashcam':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Inteligencia Artificial</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_ia" id="${solucionId}_ia">
                                    <label class="form-check-label" for="${solucionId}_ia">Con IA</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Transmisi√≥n</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Memoria</label>
                                <select class="form-select" name="${solucionId}_memoria">
                                    <option value="">Seleccionar</option>
                                    <option value="128">128 GB</option>
                                    <option value="256">256 GB</option>
                                    <option value="512">512 GB</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Rastreo basico':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos" id="${solucionId}_sos">
                                    <label class="form-check-label" for="${solucionId}_sos">SOS</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo" id="${solucionId}_bloqueo">
                                    <label class="form-check-label" for="${solucionId}_bloqueo">Bloqueo</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Resistencia</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_ip67" id="${solucionId}_ip67">
                                    <label class="form-check-label" for="${solucionId}_ip67">IP67 (a prueba de agua)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Hosting</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Rastreo avanzado':
                    configuracionesHtml = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">SOS</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos_simple" id="${solucionId}_sos_simple" onchange="manejarCambioConfiguracion('${solucionId}', 'sos_simple', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_sos_simple">SOS simple</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos_llamada" id="${solucionId}_sos_llamada" onchange="manejarCambioConfiguracion('${solucionId}', 'sos_llamada', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_sos_llamada">SOS llamada</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos_bloqueo" id="${solucionId}_sos_bloqueo" onchange="manejarCambioConfiguracion('${solucionId}', 'sos_bloqueo', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_sos_bloqueo">SOS Bloqueo</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Bloqueo</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_normal" id="${solucionId}_bloqueo_normal" onchange="manejarCambioConfiguracion('${solucionId}', 'bloqueo_normal', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_normal">Bloqueo normal</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_gradual" id="${solucionId}_bloqueo_gradual" onchange="manejarCambioConfiguracion('${solucionId}', 'bloqueo_gradual', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_gradual">Bloqueo gradual</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_cortacorriente" id="${solucionId}_bloqueo_cortacorriente" onchange="manejarCambioConfiguracion('${solucionId}', 'bloqueo_cortacorriente', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_cortacorriente">Bloqueo cortacorriente</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Sensores de Puertas</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_sensores_puertas" id="${solucionId}_sensores_juntos" value="juntos" onchange="manejarCambioConfiguracion('${solucionId}', 'sensores_puertas', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_sensores_juntos">Sensores juntos</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_sensores_puertas" id="${solucionId}_sensores_independientes" value="independientes" onchange="manejarCambioConfiguracion('${solucionId}', 'sensores_puertas', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_sensores_independientes">Sensores independientes</label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_apertura" id="${solucionId}_bloqueo_apertura" onchange="manejarCambioConfiguracion('${solucionId}', 'bloqueo_apertura', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_apertura">Bloqueo con apertura de puertas</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Audio en Cabina</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_audio_cabina" id="${solucionId}_audio_bidireccional" value="bidireccional" onchange="manejarCambioConfiguracion('${solucionId}', 'audio_bidireccional', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_audio_bidireccional">Audio bidireccional</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_audio_cabina" id="${solucionId}_audio_espia" value="espia" onchange="manejarCambioConfiguracion('${solucionId}', 'audio_espia', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_audio_espia">Audio esp√≠a</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Detecci√≥n de Jammer</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_jammer" id="${solucionId}_jammer_alerta" value="alerta" onchange="manejarCambioConfiguracion('${solucionId}', 'deteccion_jammer', ${unidadIndex}, ${solucionIndex}); toggleJammerTime('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_jammer_alerta">Alerta</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_jammer" id="${solucionId}_jammer_alerta_bloqueo" value="alerta_bloqueo" onchange="manejarCambioConfiguracion('${solucionId}', 'deteccion_jammer', ${unidadIndex}, ${solucionIndex}); toggleJammerTime('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_jammer_alerta_bloqueo">Alerta y bloqueo</label>
                                </div>
                                <div id="${solucionId}_jammer_time_container" class="mt-2" style="display: none;">
                                    <label class="form-label">Tiempo de detecci√≥n</label>
                                    <select class="form-select" name="${solucionId}_jammer_tiempo">
                                        <option value="">Seleccionar</option>
                                        <option value="3">3 minutos</option>
                                        <option value="5">5 minutos</option>
                                        <option value="7">7 minutos</option>
                                        <option value="10">10 minutos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Habilitado en Cabina</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_teclado" id="${solucionId}_teclado_sencillo" value="sencillo" onchange="manejarCambioConfiguracion('${solucionId}', 'teclado_sencillo', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_teclado_sencillo">Teclado sencillo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${solucionId}_teclado" id="${solucionId}_teclado_dinamico" value="dinamico" onchange="manejarCambioConfiguracion('${solucionId}', 'teclado_dinamico', ${unidadIndex}, ${solucionIndex})">
                                    <label class="form-check-label" for="${solucionId}_teclado_dinamico">Teclado din√°mico</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Cantidad de Botones de P√°nico</label>
                                <input type="number" class="form-control" name="${solucionId}_cantidad_botones" id="${solucionId}_cantidad_botones" min="1" max="10" value="1">
                                <div class="form-text">N√∫mero de botones de p√°nico por unidad (por defecto: 1)</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Funcionalidad adicional</label>
                                <textarea class="form-control" name="${solucionId}_funcionalidad_adicional" rows="2" placeholder="Describe cualquier funcionalidad adicional requerida..."></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h6 style="color: #fb930c;">Hosting</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Rastreo satelital':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos" id="${solucionId}_sos">
                                    <label class="form-check-label" for="${solucionId}_sos">SOS</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Hosting</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Insider':
                    configuracionesHtml = `
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n de funcionalidad SmartHulk</label>
                            <textarea class="form-control" name="${solucionId}_descripcion" rows="3" placeholder="Describe las funcionalidades espec√≠ficas del SmartHulk que se requieren..."></textarea>
                            <div class="form-text">El Insider (SmartHulk) tiene m√∫ltiples funcionalidades. Especifica cu√°les se necesitan.</div>
                        </div>
                    `;
                    break;
                    
                case 'Limitador de velocidad':
                    configuracionesHtml = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="${solucionId}_incluir" id="${solucionId}_incluir" checked>
                            <label class="form-check-label" for="${solucionId}_incluir">Incluir Limitador de velocidad</label>
                        </div>
                    `;
                    break;
                    
                case 'Modulo sensor cinturon':
                    configuracionesHtml = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="${solucionId}_incluir" id="${solucionId}_incluir" checked>
                            <label class="form-check-label" for="${solucionId}_incluir">Incluir M√≥dulo sensor cintur√≥n</label>
                        </div>
                    `;
                    break;
                    
                default:
                    configuracionesHtml = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="${solucionId}_incluir" id="${solucionId}_incluir">
                            <label class="form-check-label" for="${solucionId}_incluir">Incluir ${tipoSolucion}</label>
                        </div>
                    `;
            }
            
            container.innerHTML = configuracionesHtml;
        }
        
        function eliminarSolucionWizard(button) {
            const solucionItem = button.closest('.solucion-item');
            const container = solucionItem.parentElement;
            solucionItem.remove();
            
            // Si no quedan soluciones, mostrar mensaje
            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay soluciones agregadas. Haz clic en "Agregar Soluci√≥n" para comenzar.</p>';
            } else {
                // Renumerar soluciones
                const soluciones = container.querySelectorAll('.solucion-item');
                soluciones.forEach((solucion, index) => {
                    const titulo = solucion.querySelector('h6');
                    titulo.textContent = `Soluci√≥n ${index + 1}`;
                });
            }
        }
        
        function agregarSolucionAUnidad(button) {
            const unidadItem = button.closest('.unidad-vehiculo-item');
            const container = unidadItem.querySelector('.soluciones-unidad-container');
            const unidadId = unidadItem.querySelector('h6').textContent.replace('Unidad #', '');
            
            if (!container) return;
            
            // Si es la primera soluci√≥n, limpiar el mensaje
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }
            
            const solucionIndex = container.children.length + 1;
            const solucionId = `unidad_${unidadId}_solucion_${solucionIndex}`;
            
            const solucionDiv = document.createElement('div');
            solucionDiv.className = 'solucion-item border rounded p-3 mb-3';
            solucionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-info mb-0">Soluci√≥n ${solucionIndex}</h6>
                    <div>
                        ${solucionIndex > 1 ? '<button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="copiarSolucionAnterior(this)">Copiar Anterior</button>' : ''}
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarSolucion(this)">Eliminar</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tipo de Soluci√≥n</label>
                        <select class="form-select solucion-tipo" name="${solucionId}_tipo" onchange="mostrarConfiguracionesSolucion(this)">
                            <option value="">Seleccionar soluci√≥n</option>
                            <option value="Rastreo">Rastreo</option>
                            <option value="VPC">VPC</option>
                            <option value="Telemetr√≠a">Telemetr√≠a</option>
                            <option value="Control de Combustible">Control de Combustible</option>
                            <option value="Videovigilancia">Videovigilancia</option>
                            <option value="Control de Temperatura">Control de Temperatura</option>
                            <option value="Bot√≥n de P√°nico">Bot√≥n de P√°nico</option>
                            <option value="Bloqueo de Motor">Bloqueo de Motor</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="configuraciones-solucion">
                            <p class="text-muted">Selecciona un tipo de soluci√≥n para ver las configuraciones disponibles.</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(solucionDiv);
        }
        
        function copiarSolucionAnterior(button) {
            const solucionActual = button.closest('.solucion-item');
            const container = solucionActual.parentElement;
            const soluciones = container.querySelectorAll('.solucion-item');
            const indiceActual = Array.from(soluciones).indexOf(solucionActual);
            
            if (indiceActual > 0) {
                const solucionAnterior = soluciones[indiceActual - 1];
                
                // Copiar tipo de soluci√≥n
                const tipoAnterior = solucionAnterior.querySelector('.solucion-tipo');
                const tipoActual = solucionActual.querySelector('.solucion-tipo');
                if (tipoAnterior && tipoActual) {
                    tipoActual.value = tipoAnterior.value;
                    mostrarConfiguracionesSolucion(tipoActual);
                }
                
                // Copiar configuraciones
                setTimeout(() => {
                    const checkboxesAnteriores = solucionAnterior.querySelectorAll('input[type="checkbox"]:checked');
                    checkboxesAnteriores.forEach(checkbox => {
                        const nombre = checkbox.name.split('_').slice(-1)[0]; // Obtener el √∫ltimo segmento del name
                        const checkboxActual = solucionActual.querySelector(`input[name$="_${nombre}"]`);
                        if (checkboxActual) {
                            checkboxActual.checked = true;
                        }
                    });
                }, 100);
                
                mostrarAlerta('Configuraci√≥n copiada de la soluci√≥n anterior', 'success');
            }
        }
        
        function mostrarConfiguracionesSolucion(select) {
            const solucionItem = select.closest('.solucion-item');
            const container = solucionItem.querySelector('.configuraciones-solucion');
            const tipoSolucion = select.value;
            const solucionId = select.name.replace('_tipo', '');
            
            if (!tipoSolucion) {
                container.innerHTML = '<p class="text-muted">Selecciona un tipo de soluci√≥n para ver las configuraciones disponibles.</p>';
                return;
            }
            
            let configuracionesHtml = '';
            
            switch (tipoSolucion) {
                case 'VPC':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">C√°maras</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_izquierda" id="${solucionId}_camara_izquierda">
                                    <label class="form-check-label" for="${solucionId}_camara_izquierda">C√°mara Izquierda</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_derecha" id="${solucionId}_camara_derecha">
                                    <label class="form-check-label" for="${solucionId}_camara_derecha">C√°mara Derecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_reversa" id="${solucionId}_camara_reversa">
                                    <label class="form-check-label" for="${solucionId}_camara_reversa">C√°mara de Reversa</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_camara_frontal" id="${solucionId}_camara_frontal">
                                    <label class="form-check-label" for="${solucionId}_camara_frontal">C√°mara Frontal</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Funciones</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_grabacion" id="${solucionId}_grabacion">
                                    <label class="form-check-label" for="${solucionId}_grabacion">Grabaci√≥n</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_hosting" id="${solucionId}_hosting">
                                    <label class="form-check-label" for="${solucionId}_hosting">Hosting</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 style="color: #fb930c;">Compatibles</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sensor_vpc" id="${solucionId}_sensor_vpc">
                                    <label class="form-check-label" for="${solucionId}_sensor_vpc">Sensor VPC</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_alarma_parlante_estandar" id="${solucionId}_alarma_parlante_estandar">
                                    <label class="form-check-label" for="${solucionId}_alarma_parlante_estandar">Alarma parlante est√°ndar</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_led_giro" id="${solucionId}_led_giro">
                                    <label class="form-check-label" for="${solucionId}_led_giro">Led de giro</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_encadenamiento" id="${solucionId}_encadenamiento" onchange="toggleEncadenamientoOptions('${solucionId}')">
                                    <label class="form-check-label" for="${solucionId}_encadenamiento">Encadenamiento se√±ales</label>
                                </div>
                                <div id="${solucionId}_encadenamiento_options" class="ms-3 mt-2" style="display: none;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="${solucionId}_tipo_encadenamiento" id="${solucionId}_encadenamiento_sencillo" value="sencillo">
                                        <label class="form-check-label" for="${solucionId}_encadenamiento_sencillo">Sencillo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="${solucionId}_tipo_encadenamiento" id="${solucionId}_encadenamiento_full" value="full">
                                        <label class="form-check-label" for="${solucionId}_encadenamiento_full">Full</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Rastreo':
                    configuracionesHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Funciones Telemetr√≠a</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos_simple" id="${solucionId}_sos_simple">
                                    <label class="form-check-label" for="${solucionId}_sos_simple">SOS Simple</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sos_llamada" id="${solucionId}_sos_llamada">
                                    <label class="form-check-label" for="${solucionId}_sos_llamada">SOS Llamada</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_normal" id="${solucionId}_bloqueo_normal">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_normal">Bloqueo Normal</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_bloqueo_cc" id="${solucionId}_bloqueo_cc">
                                    <label class="form-check-label" for="${solucionId}_bloqueo_cc">Bloqueo CC</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 style="color: #fb930c;">Sensores y Audio</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sensores_juntos" id="${solucionId}_sensores_juntos">
                                    <label class="form-check-label" for="${solucionId}_sensores_juntos">Sensores Juntos</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_sensores_independientes" id="${solucionId}_sensores_independientes">
                                    <label class="form-check-label" for="${solucionId}_sensores_independientes">Sensores Independientes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_audio_bidireccional" id="${solucionId}_audio_bidireccional">
                                    <label class="form-check-label" for="${solucionId}_audio_bidireccional">Audio Bidireccional</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${solucionId}_audio_espia" id="${solucionId}_audio_espia">
                                    <label class="form-check-label" for="${solucionId}_audio_espia">Audio Esp√≠a</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    configuracionesHtml = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="${solucionId}_activado" id="${solucionId}_activado" checked>
                            <label class="form-check-label" for="${solucionId}_activado">Activar ${tipoSolucion}</label>
                        </div>
                    `;
            }
            
            container.innerHTML = configuracionesHtml;
        }
        
        function eliminarSolucion(button) {
            const solucionItem = button.closest('.solucion-item');
            const container = solucionItem.parentElement;
            solucionItem.remove();
            
            // Si no quedan soluciones, mostrar mensaje
            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay soluciones agregadas. Haz clic en "Agregar Soluci√≥n" para comenzar.</p>';
            } else {
                // Renumerar soluciones
                const soluciones = container.querySelectorAll('.solucion-item');
                soluciones.forEach((solucion, index) => {
                    const titulo = solucion.querySelector('h6');
                    titulo.textContent = `Soluci√≥n ${index + 1}`;
                });
            }
        }
        
        // ===== FUNCI√ìN PARA COTIZACI√ìN EN LOTE =====
        
        function mostrarModalCotizacionLote() {
            const modalHtml = `
                <div class="modal fade" id="modalCotizacionLote" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="bi bi-stack me-2"></i>Cotizaci√≥n en Lote
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Cantidad de Unidades</label>
                                    <input type="number" class="form-control" id="cantidadLote" min="2" max="1000" placeholder="Ej: 10, 20, 50, 100">
                                    <div class="form-text">Especifica cu√°ntas unidades id√©nticas deseas cotizar</div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Nota:</strong> Se crear√° una cotizaci√≥n con la cantidad especificada de unidades id√©nticas. 
                                    Podr√°s configurar los detalles de la unidad modelo en el siguiente paso.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-warning" onclick="iniciarCotizacionLote()">
                                    <i class="bi bi-arrow-right me-1"></i>Continuar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente
            const modalExistente = document.getElementById("modalCotizacionLote");
            if (modalExistente) {
                modalExistente.remove();
            }
            
            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById("modalCotizacionLote"));
            modal.show();
        }
        
        function iniciarCotizacionLote() {
            const cantidad = parseInt(document.getElementById('cantidadLote').value);
            
            if (!cantidad || cantidad < 2) {
                mostrarAlerta('Por favor ingresa una cantidad v√°lida (m√≠nimo 2)', 'danger');
                return;
            }
            
            if (cantidad > 1000) {
                mostrarAlerta('La cantidad m√°xima es 1000 unidades', 'danger');
                return;
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("modalCotizacionLote"));
            modal.hide();
            
            // Limpiar datos temporales y marcar como lote
            localStorage.removeItem('cotizacion_temp');
            localStorage.setItem('cotizacion_lote_cantidad', cantidad.toString());
            
            // Ir al wizard
            window.location.href = 'cotizaciones-wizard-corregido.html';
        }



    </script>

    <!-- Modal de Debug -->
    <div class="modal fade" id="modalDebug" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-bug me-2"></i>Debug de C√°lculos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="debugContent">
                        <!-- Contenido del debug se llena din√°micamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>



</body>
</html>
