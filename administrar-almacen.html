<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Almac√©n - Sistema de Trazabilidad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .dashboard-card h2 {
            font-size: 3rem;
            font-weight: bold;
            margin: 0;
        }
        .dashboard-card p {
            margin: 0;
            font-size: 1.1rem;
        }
        .bg-gradient-purple { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-blue { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-green { background: linear-gradient(135deg, #fb930c 0%, #f39c12 100%); }
        .bg-gradient-orange { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        
        .sidebar {
            background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="text-center mb-4">
                    <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="60" class="mb-3">
                    <h3 class="text-white">
                        <i class="bi bi-gear"></i> Panel de Control
                    </h3>
                </div>
                
                <button class="btn btn-success" onclick="agregarNuevaCombinacion()">
                    <i class="bi bi-plus-circle"></i> Nueva Combinaci√≥n
                </button>
                
                <button class="btn btn-info" onclick="mostrarModalCargaMasiva()">
                    <i class="bi bi-upload"></i> Carga Masiva
                </button>
                
                <button class="btn btn-warning" onclick="mostrarModalFuncionesRastreo()">
                    <i class="bi bi-gear"></i> Funciones Rastreo
                </button>

                
                <div class="mt-4">
                    <a href="./cotizaciones-completo.html" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Volver al Sistema Principal
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Header -->
                <nav class="navbar navbar-dark bg-dark">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="40" class="me-3">
                            <span class="navbar-brand mb-0 h1">
                                <i class="bi bi-boxes"></i> Sistema de Trazabilidad
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="./cotizaciones-completo.html" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Principal
                            </a>
                            <button class="btn btn-outline-light btn-sm" id="btnLogout">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Dashboard -->
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-purple">
                                <h2 id="totalCombinaciones">0</h2>
                                <p>Combinaciones</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-blue">
                                <h2 id="totalInsumos">0</h2>
                                <p>Insumos √önicos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-green">
                                <h2 id="totalTiposUnidad">0</h2>
                                <p>Tipos de Unidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-orange">
                                <h2 id="totalTiposSolucion">0</h2>
                                <p>Tipos de Soluci√≥n</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <h5><i class="bi bi-funnel"></i> Filtros</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filtroTipoUnidad" class="form-label">Tipo de Unidad:</label>
                                <select class="form-select" id="filtroTipoUnidad" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                                <select class="form-select" id="filtroTipoSolucion" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroInsumo" class="form-label">Buscar Insumo:</label>
                                <input type="text" class="form-control" id="filtroInsumo" placeholder="Escriba para buscar..." onkeyup="aplicarFiltros()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                                </button>
                                <span class="badge bg-info ms-2" id="resultadosFiltro">Mostrando todas las combinaciones</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Matriz -->
                    <div class="card">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #fb930c, #e67e22);">
                            <h4><i class="bi bi-grid-3x3-gap"></i> Matriz de Insumos</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Tipo Unidad</th>
                                            <th>Tipo Soluci√≥n</th>
                                            <th>Insumos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaAlmacen">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Combinaci√≥n -->
    <div class="modal fade" id="modalEditarCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Combinaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <input type="text" class="form-control" id="editTipoUnidad" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                            <input type="text" class="form-control" id="editTipoSolucion" readonly>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Insumos y Cantidades:</label>
                        <div id="editInsumos">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicionCombinacion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Combinaci√≥n -->
    <div class="modal fade" id="modalNuevaCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Combinaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="nuevoTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <div class="input-group">
                                <select class="form-select" id="nuevoTipoUnidad">
                                    <option value="">Seleccionar tipo de unidad...</option>
                                </select>
                                <button class="btn btn-outline-success" type="button" onclick="mostrarModalNuevoTipo('vehiculo')" title="Agregar nuevo tipo de veh√≠culo">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevoTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                            <div class="input-group">
                                <select class="form-select" id="nuevoTipoSolucion">
                                    <option value="">Seleccionar tipo de soluci√≥n...</option>
                                </select>
                                <button class="btn btn-outline-success" type="button" onclick="mostrarModalNuevoTipo('solucion')" title="Agregar nuevo tipo de soluci√≥n">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Insumos y Cantidades:</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="mostrarModalNuevoInsumo()" title="Agregar nuevo insumo">
                                <i class="bi bi-plus-circle"></i> Nuevo Insumo
                            </button>
                        </div>
                        <div id="nuevoInsumos"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="agregarInsumoNueva()">
                        <i class="bi bi-plus"></i> Agregar Insumo
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarNuevaCombinacion()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nuevo Tipo de Veh√≠culo/Soluci√≥n/Insumo -->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevoTipoTitulo">Agregar Nuevo Tipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoTipoNombre" class="form-label" id="modalNuevoTipoLabel">Nombre del nuevo tipo:</label>
                        <input type="text" class="form-control" id="nuevoTipoNombre" placeholder="Ingrese el nombre del nuevo tipo">
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <span id="modalNuevoTipoDescripcion">Este nuevo tipo estar√° disponible inmediatamente para usar en las combinaciones.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarNuevoTipo()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nuevo Insumo -->
    <div class="modal fade" id="modalNuevoInsumo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Insumo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoInsumoNombre" class="form-label">Nombre del nuevo insumo:</label>
                        <input type="text" class="form-control" id="nuevoInsumoNombre" placeholder="Ej. Cable especial 10m">
                    </div>
                    <div class="mb-3">
                        <label for="nuevoInsumoCategoria" class="form-label">Categor√≠a (opcional):</label>
                        <select class="form-select" id="nuevoInsumoCategoria">
                            <option value="">Sin categor√≠a</option>
                            <option value="Cables y conectores">Cables y conectores</option>
                            <option value="Materiales b√°sicos">Materiales b√°sicos</option>
                            <option value="Componentes electr√≥nicos">Componentes electr√≥nicos</option>
                            <option value="Almacenamiento">Almacenamiento</option>
                            <option value="Alarmas y audio">Alarmas y audio</option>
                            <option value="Controles">Controles</option>
                            <option value="C√°maras">C√°maras</option>
                            <option value="Dashcams">Dashcams</option>
                            <option value="Sensores y accesorios">Sensores y accesorios</option>
                            <option value="Equipos principales">Equipos principales</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Este nuevo insumo estar√° disponible inmediatamente en la lista de insumos para seleccionar.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarNuevoInsumo()">Agregar Insumo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase + dataService -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Modal Carga Masiva -->
    <div class="modal fade" id="modalCargaMasiva" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-upload"></i> Carga Masiva de Combinaciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="archivoCargaMasiva" class="form-label">Seleccionar archivo JSON:</label>
                        <input type="file" class="form-control" id="archivoCargaMasiva" accept=".json" onchange="procesarArchivoCargaMasiva(event)">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Plantilla de ejemplo:</label>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="descargarPlantilla()">
                            <i class="bi bi-download"></i> Descargar Plantilla
                        </button>
                    </div>

                    <div id="previewCargaMasiva" class="d-none">
                        <h6>Vista previa de la carga:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Tipo Unidad</th>
                                        <th>Tipo Soluci√≥n</th>
                                        <th>Insumos</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPreviewCarga">
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info">
                            <strong>Resumen:</strong>
                            <span id="resumenCargaMasiva"></span>
                        </div>
                    </div>

                    <div id="erroresCargaMasiva" class="d-none">
                        <h6 class="text-danger">Errores encontrados:</h6>
                        <div id="listaErroresCarga" class="alert alert-danger">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarCarga" onclick="confirmarCargaMasiva()" disabled>
                        <i class="bi bi-check-circle"></i> Confirmar Carga
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Funciones de Rastreo -->
    <div class="modal fade" id="modalFuncionesRastreo" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Gesti√≥n de Funciones de Rastreo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Funciones Existentes</h6>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Funci√≥n</th>
                                            <th>Insumos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaFuncionesRastreo">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Agregar/Editar Funci√≥n</h6>
                            <form id="formFuncionRastreo">
                                <div class="mb-3">
                                    <label for="funcionalidadRastreo" class="form-label">Funcionalidad:</label>
                                    <input type="text" class="form-control" id="funcionalidadRastreo" placeholder="Ej: SOS simple">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Insumos:</label>
                                    <div id="insumosRastreoContainer">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control insumo-nombre" placeholder="Nombre del insumo">
                                            <input type="number" class="form-control insumo-cantidad" placeholder="Cantidad" min="1" value="1">
                                            <button type="button" class="btn btn-outline-danger" onclick="eliminarInsumoRastreo(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarInsumoRastreo()">
                                        <i class="bi bi-plus"></i> Agregar Insumo
                                    </button>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-success" onclick="guardarFuncionRastreo()">
                                        <i class="bi bi-save"></i> Guardar Funci√≥n
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormularioRastreo()">
                                        <i class="bi bi-arrow-clockwise"></i> Limpiar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./dataService.js"></script>
    <script src="./accessGuard.js"></script>

    <script>
        (async function(){
            const ok = await window.accessGuard.ensureAuth(['admin','almacen']);
            if (!ok) return;
        })();
        document.addEventListener('DOMContentLoaded', function(){
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await window.dataService.authSignOut(); } catch(_){}
                    window.location.href = './login.html';
                });
            }
        });
        // ===== VARIABLES GLOBALES =====
        const modoCentralizado = (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase());
        let almacenInsumos = {};
        let combinacionEditando = null;
        let datosFiltrados = [];

        // Lista completa de insumos posibles
        let listaInsumos = [
            // Cables y conectores
            'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m',
            'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', 'Cable 2 vias', 'Cable 4 vias',
            '"Y" 4 pines', 'Base Pollak', 'Pollak Macho ', 'Pollak Hembra', 'Cable de 1 polo',
            'Terminal de ojillo', '7 vias liso 2m',
            
            // Materiales b√°sicos
            'Silicon', 'Cinchos grande', 'Cinta de tela', 'Cinta de aislar',
            'Poliflex 3/8', 'Poliflex 1/4', 'Cincho mediado', 'Cincho con grapa',
            'Pija brocante 5/16', 'Tornillo hexagonal 5/16', 'Tornillo 3/8',
            'Tuerca 5/16', 'Tuerca 3/8', 'Rondana 5/16', 'Rondana 3/8',
            'Espiral negro', 'Espiral verde',
            
            // Componentes electr√≥nicos
            'Relevador 2 pasos 2 tiros', 'Relevador 12v', 'Relevador 24v', 'Portarelevador',
            'placa perforada', 'Gabinete 5*7*3',
            
            // Almacenamiento
            'SD 128 Gb', 'SD 256 Gb', 'SD 512 Gb',
            
            // Alarmas y audio
            'Alarma parlante de 3 tonos', 'Alarma parlante programable', 'Bocina', 'Microfono',
            
            // Controles
            'Bot√≥n balancin', 'Boton de panico',
            
            // C√°maras
            'Camara + radar', 'Camara con microfono', 'Camara de reversa', 'Camara Digital (IP)',
            'Camara exterior mini', 'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC',
            'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo',
            
            // Dashcams
            'Dashcam ad2', 'Dashcam c6',
            
            // Sensores y accesorios
            'Sensor magnetico chico', 'Sensor magnetico grande', 'Insider',
            'Led de giro a la derecha', 'Led de giro a la izquierda', 'Limitador de velocidad',
            'Modulo sensor de cinturon seguridad',
            
            // Equipos principales
            'Monitor de VPC', 'Grabador de video 4 ch',
            
            // Sensores VPC
            'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho', 'Sideview izquierdo'
        ];

        // ===== MATRIZ COMPLETA Y CORREGIDA DEL CSV =====
        // FUNCI√ìN ELIMINADA: Ya no se usa la matriz hardcodeada
        function cargarMatrizCompletaCSV() {
            console.warn('‚ö†Ô∏è cargarMatrizCompletaCSV() est√° deprecada. Usa la carga masiva desde JSON.');
            return Promise.resolve({});
        }


        async function cargarDesdeSupabase() {
            try {
                const registros = await window.dataService.fetchAlmacenInsumos();
                // Soporte esquema single-doc: {insumos: {...}}
                let mapa = {};
                if (Array.isArray(registros) && registros.length === 1 && registros[0]._schema === 'single_doc' && registros[0].insumos) {
                    mapa = registros[0].insumos;
                } else {
                    (registros || []).forEach(r => {
                        const tipoUnidad = r.tipoUnidad;
                        const tipoSolucion = r.tipoSolucion;
                        const insumos = r.insumos || {};
                        
                        // Si es un placeholder, crear tipo de veh√≠culo vac√≠o
                        if (tipoSolucion === '_placeholder') {
                            mapa[tipoUnidad] = {};
                        } else {
                            // Procesar soluci√≥n normal
                            if (!mapa[tipoUnidad]) mapa[tipoUnidad] = {};
                            mapa[tipoUnidad][tipoSolucion] = insumos;
                        }
                    });
                }
                almacenInsumos = mapa;
                console.log(`‚úÖ Supabase: ${Array.isArray(registros) ? registros.length : 0} registros`);

                // Si no hay datos en Supabase, mostrar mensaje informativo
                if ((registros || []).length === 0) {
                    console.log('‚ÑπÔ∏è Supabase vac√≠o. No hay combinaciones cargadas.');
                    console.log('üí° Usa la funci√≥n "Carga Masiva" para importar combinaciones desde un archivo JSON.');
                }
            } catch (e) {
                console.error('‚ùå Error cargando Supabase almacen:', e);
                mostrarAlerta('No se pudo cargar almacen desde Supabase', 'danger');
            }
        }

        async function migrarAlmacenLocalASupabase(mapa) {
            try {
                const tareas = [];
                for (const [tipoUnidad, soluciones] of Object.entries(mapa)) {
                    for (const [tipoSolucion, insumos] of Object.entries(soluciones || {})) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        tareas.push(window.dataService.upsertAlmacenInsumoById(id, {
                            id,
                            tipoUnidad,
                            tipoSolucion,
                            insumos: insumos || {},
                        }));
                    }
                }
                for (let i = 0; i < tareas.length; i += 25) {
                    const slice = tareas.slice(i, i + 25);
                    // eslint-disable-next-line no-await-in-loop
                    await Promise.all(slice);
                }
                console.log(`‚úÖ Migraci√≥n completada: ${tareas.length} combinaciones`);
            } catch (error) {
                console.error('‚ùå Error migrando almac√©n a Supabase:', error);
                mostrarAlerta('Error migrando almac√©n a Supabase', 'danger');
            }
        }

        async function cargarFiltros() {
            try {
                console.log('üîÑ Cargando filtros desde Supabase...');
                
                // Cargar tipos desde Supabase
                const [tiposUnidad, tiposSolucion] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion()
                ]);
                
                const nombresUnidad = tiposUnidad.map(t => t.nombre).sort();
                const nombresSolucion = tiposSolucion.map(t => t.nombre).sort();
                

                // Cargar filtro de tipos de unidad
                const selectUnidad = document.getElementById('filtroTipoUnidad');
                selectUnidad.innerHTML = '<option value="">Todos</option>';
                nombresUnidad.forEach(tipo => {
                    selectUnidad.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });

                // Cargar filtro de tipos de soluci√≥n
                const selectSolucion = document.getElementById('filtroTipoSolucion');
                selectSolucion.innerHTML = '<option value="">Todos</option>';
                nombresSolucion.forEach(tipo => {
                    selectSolucion.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });

                // Actualizar listas globales
                tiposUnidadExistentes = nombresUnidad;
                tiposSolucionExistentes = nombresSolucion;
                
                console.log('‚úÖ Filtros cargados desde Supabase');
            } catch (error) {
                console.error('‚ùå Error cargando filtros:', error);
                mostrarAlerta('Error cargando filtros', 'danger');
            }
        }

        function cargarTablaAlmacen() {
            let combinaciones = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    combinaciones.push({
                        tipoUnidad,
                        tipoSolucion,
                        insumos: Object.keys(insumos).length > 0 ? insumos : {}
                    });
                }
            }

            datosFiltrados = combinaciones;
            mostrarCombinaciones(combinaciones);
        }

        function mostrarCombinaciones(combinaciones) {
            const tbody = document.getElementById('tablaAlmacen');
            tbody.innerHTML = '';
            
            if (combinaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay combinaciones disponibles</td></tr>';
                return;
            }

            combinaciones.forEach(combinacion => {
                const row = document.createElement('tr');
                const insumosText = Object.entries(combinacion.insumos)
                    .map(([insumo, cantidad]) => `${insumo}: ${cantidad}`)
                    .join(', ');
                
                row.innerHTML = `
                    <td>${combinacion.tipoUnidad}</td>
                    <td>${combinacion.tipoSolucion}</td>
                    <td>${insumosText}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarCombinacion('${combinacion.tipoUnidad}', '${combinacion.tipoSolucion}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarCombinacion('${combinacion.tipoUnidad}', '${combinacion.tipoSolucion}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar contador de resultados
            document.getElementById('resultadosFiltro').textContent = 
                `Mostrando ${combinaciones.length} combinaciones`;
        }

        function aplicarFiltros() {
            const filtroUnidad = document.getElementById('filtroTipoUnidad').value;
            const filtroSolucion = document.getElementById('filtroTipoSolucion').value;
            const filtroInsumo = document.getElementById('filtroInsumo').value.toLowerCase();

            let combinacionesFiltradas = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    let coincide = true;

                    if (filtroUnidad && tipoUnidad !== filtroUnidad) coincide = false;
                    if (filtroSolucion && tipoSolucion !== filtroSolucion) coincide = false;
                    if (filtroInsumo) {
                        const tieneInsumo = Object.keys(insumos).some(insumo => 
                            insumo.toLowerCase().includes(filtroInsumo)
                        );
                        if (!tieneInsumo) coincide = false;
                    }

                    if (coincide) {
                        combinacionesFiltradas.push({
                            tipoUnidad,
                            tipoSolucion,
                            insumos: Object.keys(insumos).length > 0 ? insumos : {}
                        });
                    }
                }
            }

            mostrarCombinaciones(combinacionesFiltradas);
        }

        function limpiarFiltros() {
            document.getElementById('filtroTipoUnidad').value = '';
            document.getElementById('filtroTipoSolucion').value = '';
            document.getElementById('filtroInsumo').value = '';
            cargarTablaAlmacen();
        }

        async function actualizarEstadisticas() {
            try {
                console.log('üîÑ Actualizando estad√≠sticas desde Supabase...');
                
                // Cargar datos desde Supabase
                const [tiposUnidad, tiposSolucion, tiposInsumo, almacenData] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion(),
                    window.dataService.fetchTiposInsumo(),
                    window.dataService.fetchAlmacenInsumos()
                ]);
                
                // Calcular estad√≠sticas reales desde datos de Supabase
                let totalCombinaciones = 0;
                const insumosUnicos = new Set();
                const tiposSolucionUnicos = new Set();
                
                // Procesar datos seg√∫n el esquema devuelto por Supabase
                if (Array.isArray(almacenData)) {
                    // Esquema por filas (m√°s com√∫n)
                    almacenData.forEach((row, index) => {
                        if (row.tipoUnidad && row.tipoSolucion) {
                            // Esquema por columnas: {tipoUnidad, tipoSolucion, insumos}
                            if (row.tipoSolucion !== '_placeholder') {
                                totalCombinaciones++;
                                tiposSolucionUnicos.add(row.tipoSolucion);
                                
                                // Contar insumos √∫nicos
                                if (row.insumos && typeof row.insumos === 'object') {
                                    Object.keys(row.insumos).forEach(insumo => {
                                        insumosUnicos.add(insumo);
                                    });
                                }
                            }
                        }
                    });
                } else if (almacenData && almacenData.insumos) {
                    // Esquema single-doc: {insumos: {...}}
                    Object.values(almacenData.insumos).forEach(soluciones => {
                        Object.values(soluciones).forEach(insumos => {
                            totalCombinaciones++;
                            Object.keys(insumos).forEach(insumo => {
                                insumosUnicos.add(insumo);
                            });
                        });
                    });
                }
                
                // Actualizar la interfaz
                document.getElementById('totalCombinaciones').textContent = totalCombinaciones;
                document.getElementById('totalInsumos').textContent = insumosUnicos.size;
                document.getElementById('totalTiposUnidad').textContent = tiposUnidad.length;
                document.getElementById('totalTiposSolucion').textContent = tiposSolucionUnicos.size;
                
                console.log('‚úÖ Estad√≠sticas actualizadas desde Supabase:');
                console.log(`  - Combinaciones: ${totalCombinaciones}`);
                console.log(`  - Insumos √∫nicos: ${insumosUnicos.size}`);
                console.log(`  - Tipos de unidad: ${tiposUnidad.length}`);
                console.log(`  - Tipos de soluci√≥n: ${tiposSolucionUnicos.size}`);
                
            } catch (error) {
                console.error('‚ùå Error actualizando estad√≠sticas:', error);
                mostrarAlerta('Error actualizando estad√≠sticas', 'danger');
            }
        }

        function editarCombinacion(tipoUnidad, tipoSolucion) {
            combinacionEditando = { tipoUnidad, tipoSolucion };
            document.getElementById('editTipoUnidad').value = tipoUnidad;
            document.getElementById('editTipoSolucion').value = tipoSolucion;
            
            const insumos = almacenInsumos[tipoUnidad][tipoSolucion] || {};
            const contenedor = document.getElementById('editInsumos');
            contenedor.innerHTML = '';

            // Mostrar insumos existentes
            Object.entries(insumos).forEach(([insumo, cantidad]) => {
                const div = document.createElement('div');
                div.className = 'row mb-2';
                div.innerHTML = `
                    <div class="col-md-8">
                        <input type="text" class="form-control" value="${insumo}" readonly>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" value="${cantidad}" data-insumo="${insumo}">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                contenedor.appendChild(div);
            });

            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalEditarCombinacion')).show();
        }

        async function guardarEdicionCombinacion() {
            const { tipoUnidad, tipoSolucion } = combinacionEditando;
            const contenedor = document.getElementById('editInsumos');
            const nuevosInsumos = {};

            // Recopilar insumos del modal
            const rows = contenedor.querySelectorAll('.row:not(:last-child)');
            rows.forEach(row => {
                const insumo = row.querySelector('input[readonly]')?.value || 
                              row.querySelector('select')?.value;
                const cantidad = row.querySelector('input:not([readonly])')?.value;
                
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });

            // Actualizar almac√©n
            if (!almacenInsumos[tipoUnidad]) almacenInsumos[tipoUnidad] = {};
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;
            
            try {
                // Sincronizar con Supabase si est√° activo
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    // Guardar en localStorage
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
                
                // Actualizar interfaz
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('modalEditarCombinacion')).hide();
                
                mostrarAlerta(`Combinaci√≥n ${tipoUnidad} - ${tipoSolucion} actualizada`, 'success');
            } catch (error) {
                console.error('‚ùå Error guardando edici√≥n:', error);
                mostrarAlerta('Error al guardar los cambios', 'danger');
            }
        }

        async function eliminarCombinacion(tipoUnidad, tipoSolucion) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar la combinaci√≥n ${tipoUnidad} - ${tipoSolucion}?`)) {
                // Eliminar del almac√©n local
                if (almacenInsumos[tipoUnidad] && almacenInsumos[tipoUnidad][tipoSolucion]) {
                    delete almacenInsumos[tipoUnidad][tipoSolucion];
                }
                
                // Si no quedan soluciones para este tipo de unidad, eliminar el tipo
                if (Object.keys(almacenInsumos[tipoUnidad]).length === 0) {
                    delete almacenInsumos[tipoUnidad];
                }
                try {
                    if (modoCentralizado) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        await window.dataService.deleteAlmacenInsumoById(id);
                    } else {
                        localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                    }
                } catch (error) {
                    console.warn('No se pudo guardar cambios', error);
                }
                
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                mostrarAlerta(`Combinaci√≥n eliminada`, 'success');
            }
        }

        async function actualizarListasEnModalNuevaCombinacion() {
            try {
                // Cargar tipos existentes
                await cargarTiposExistentes();
                
                // Actualizar select de tipos de unidad
                const selectUnidad = document.getElementById('nuevoTipoUnidad');
                selectUnidad.innerHTML = '<option value="">Seleccionar tipo de unidad...</option>';
                tiposUnidadExistentes.forEach(tipo => {
                    selectUnidad.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });
                
                // Actualizar select de tipos de soluci√≥n
                const selectSolucion = document.getElementById('nuevoTipoSolucion');
                selectSolucion.innerHTML = '<option value="">Seleccionar tipo de soluci√≥n...</option>';
                tiposSolucionExistentes.forEach(tipo => {
                    selectSolucion.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });
                
                console.log('‚úÖ Listas actualizadas en modal nueva combinaci√≥n');
            } catch (error) {
                console.error('‚ùå Error actualizando listas:', error);
                throw error;
            }
        }

        async function agregarNuevaCombinacion() {
            try {
                await actualizarListasEnModalNuevaCombinacion();

                // Limpiar campos
                document.getElementById('nuevoTipoUnidad').value = '';
                document.getElementById('nuevoTipoSolucion').value = '';

                const cont = document.getElementById('nuevoInsumos');
                cont.innerHTML = '';
                agregarInsumoNueva();

                new bootstrap.Modal(document.getElementById('modalNuevaCombinacion')).show();
            } catch (e) {
                console.error('‚ùå Error preparando modal nueva combinaci√≥n:', e);
                mostrarAlerta('Error preparando el formulario de nueva combinaci√≥n', 'danger');
            }
        }

        function agregarInsumoNueva() {
            const cont = document.getElementById('nuevoInsumos');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-8">
                    <select class="form-control" onchange="this.nextElementSibling.value = this.value">
                        <option value="">Seleccionar insumo</option>
                        ${listaInsumos.map(insumo => `<option value="${insumo}">${insumo}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            cont.appendChild(div);
        }

        async function guardarNuevaCombinacion() {
            const tipoUnidad = document.getElementById('nuevoTipoUnidad').value;
            const tipoSolucion = document.getElementById('nuevoTipoSolucion').value;
            
            if (!tipoUnidad || !tipoSolucion) {
                mostrarAlerta('Especifique tipo de unidad y tipo de soluci√≥n', 'warning');
                return;
            }

            const cont = document.getElementById('nuevoInsumos');
            const rows = cont.querySelectorAll('.row');
            const nuevosInsumos = {};
            rows.forEach(row => {
                const insumo = row.querySelector('select')?.value;
                const cantidad = row.querySelector('input')?.value;
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });
            if (Object.keys(nuevosInsumos).length === 0) {
                mostrarAlerta('Agregue al menos un insumo con cantidad', 'warning');
                return;
            }

            // Agregar al almac√©n
            if (!almacenInsumos[tipoUnidad]) {
                almacenInsumos[tipoUnidad] = {};
            }
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;
            
            try {
                // Sincronizar con Supabase si est√° activo
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    // Guardar en localStorage
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
                
                // Actualizar interfaz
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('modalNuevaCombinacion')).hide();
                mostrarAlerta(`Combinaci√≥n ${tipoUnidad} - ${tipoSolucion} creada`, 'success');
            } catch (error) {
                console.error('‚ùå Error guardando nueva combinaci√≥n:', error);
                mostrarAlerta('Error al guardar la nueva combinaci√≥n', 'danger');
            }
        }

        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // ===== FUNCIONES DE CARGA MASIVA =====
        
        let datosCargaMasiva = [];
        let tiposUnidadExistentes = [];
        let tiposSolucionExistentes = [];
        let tiposInsumoExistentes = [];

        function mostrarModalCargaMasiva() {
            console.log('üîß Abriendo modal de carga masiva...');
            
            // Limpiar el input de archivo
            document.getElementById('archivoCargaMasiva').value = '';
            
            // Ocultar preview y errores
            document.getElementById('previewCargaMasiva').classList.add('d-none');
            document.getElementById('erroresCargaMasiva').classList.add('d-none');
            
            // Deshabilitar bot√≥n de confirmar
            document.getElementById('btnConfirmarCarga').disabled = true;
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalCargaMasiva')).show();
        }

        async function cargarTiposExistentes() {
            try {
                const [tiposUnidad, tiposSolucion, tiposInsumo] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion(),
                    window.dataService.fetchTiposInsumo()
                ]);
                
                tiposUnidadExistentes = tiposUnidad.map(t => t.nombre);
                tiposSolucionExistentes = tiposSolucion.map(t => t.nombre);
                tiposInsumoExistentes = tiposInsumo.map(t => t.nombre);
                
                console.log('‚úÖ Tipos existentes cargados para validaci√≥n');
                console.log('üìã Tipos cargados:');
                console.log('  - Tipos de unidad:', tiposUnidadExistentes);
                console.log('  - Tipos de soluci√≥n:', tiposSolucionExistentes);
                console.log('  - Tipos de insumo:', tiposInsumoExistentes);
            } catch (error) {
                console.error('‚ùå Error cargando tipos existentes:', error);
            }
        }

        function procesarArchivoCargaMasiva(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üìÅ Archivo seleccionado:', file.name);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    console.log('üìÑ Procesando archivo...');
                    const data = JSON.parse(e.target.result);
                    console.log('üìä Datos del archivo:', data);
                    await validarYCargarDatos(data);
                } catch (error) {
                    console.error('‚ùå Error procesando archivo:', error);
                    mostrarError('Error al parsear el archivo JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function validarYCargarDatos(data) {
            console.log('üöÄ Iniciando validaci√≥n de datos...');
            
            // Limpiar errores anteriores
            document.getElementById('erroresCargaMasiva').classList.add('d-none');
            document.getElementById('previewCargaMasiva').classList.add('d-none');
            
            const errores = [];
            const combinacionesValidas = [];
            
            // Validar estructura del JSON
            if (!data.combinaciones || !Array.isArray(data.combinaciones)) {
                errores.push('El archivo debe contener un array "combinaciones"');
                mostrarError(errores.join('<br>'));
                return;
            }
            
            // Cargar tipos existentes antes de validar
            console.log('üîÑ Cargando tipos existentes...');
            await cargarTiposExistentes();
            
            console.log('üìã Tipos existentes cargados:');
            console.log('  - Tipos de unidad:', tiposUnidadExistentes.length);
            console.log('  - Tipos de soluci√≥n:', tiposSolucionExistentes.length);
            console.log('  - Tipos de insumo:', tiposInsumoExistentes.length);
            
            // Verificar que los tipos se cargaron correctamente
            if (tiposUnidadExistentes.length === 0 && tiposSolucionExistentes.length === 0 && tiposInsumoExistentes.length === 0) {
                console.warn('‚ö†Ô∏è No se cargaron tipos existentes. Verificando conexi√≥n con Supabase...');
                return;
            }
            
            // Recopilar todos los tipos √∫nicos que necesitamos crear
            const tiposUnidadNuevos = new Set();
            const tiposSolucionNuevos = new Set();
            const insumosNuevos = new Set();
            
            // Primera pasada: identificar qu√© necesita ser creado
            data.combinaciones.forEach((combinacion, index) => {
                if (combinacion.tipoUnidad && !tiposUnidadExistentes.includes(combinacion.tipoUnidad)) {
                    tiposUnidadNuevos.add(combinacion.tipoUnidad);
                    console.log(`üÜï Tipo de unidad nuevo: ${combinacion.tipoUnidad}`);
                }
                
                if (combinacion.tipoSolucion && !tiposSolucionExistentes.includes(combinacion.tipoSolucion)) {
                    tiposSolucionNuevos.add(combinacion.tipoSolucion);
                    console.log(`üÜï Tipo de soluci√≥n nuevo: ${combinacion.tipoSolucion}`);
                }
                
                if (combinacion.insumos && typeof combinacion.insumos === 'object') {
                    Object.keys(combinacion.insumos).forEach(insumo => {
                        if (!tiposInsumoExistentes.includes(insumo)) {
                            insumosNuevos.add(insumo);
                            console.log(`üÜï Insumo nuevo: ${insumo}`);
                        }
                    });
                }
            });
            
            console.log(`üìä Resumen de tipos nuevos a crear:`);
            console.log(`  - Tipos de unidad: ${tiposUnidadNuevos.size}`);
            console.log(`  - Tipos de soluci√≥n: ${tiposSolucionNuevos.size}`);
            console.log(`  - Insumos: ${insumosNuevos.size}`);
            
            // Crear autom√°ticamente los tipos que no existen
            if (tiposUnidadNuevos.size > 0 || tiposSolucionNuevos.size > 0 || insumosNuevos.size > 0) {
                console.log('üîÑ Creando tipos autom√°ticamente...');
                try {
                    // Crear tipos de unidad
                    for (const tipoUnidad of tiposUnidadNuevos) {
                        console.log(`üîÑ Creando tipo de unidad: ${tipoUnidad}`);
                        await window.dataService.upsertTipoUnidad(tipoUnidad, `Tipo de veh√≠culo: ${tipoUnidad}`, 'vehiculo');
                        tiposUnidadExistentes.push(tipoUnidad);
                    }
                    
                    // Crear tipos de soluci√≥n
                    for (const tipoSolucion of tiposSolucionNuevos) {
                        console.log(`üîÑ Creando tipo de soluci√≥n: ${tipoSolucion}`);
                        await window.dataService.upsertTipoSolucion(tipoSolucion, `Tipo de soluci√≥n: ${tipoSolucion}`, 'solucion');
                        tiposSolucionExistentes.push(tipoSolucion);
                    }
                    
                    // Crear insumos
                    for (const insumo of insumosNuevos) {
                        console.log(`üîÑ Creando insumo: ${insumo}`);
                        await window.dataService.upsertTipoInsumo(insumo, `Insumo: ${insumo}`, 'General', 'piezas');
                        tiposInsumoExistentes.push(insumo);
                        listaInsumos.push(insumo);
                    }
                    
                    // Ordenar listas
                    tiposUnidadExistentes.sort();
                    tiposSolucionExistentes.sort();
                    tiposInsumoExistentes.sort();
                    listaInsumos.sort();
                    
                    console.log(`‚úÖ Creados autom√°ticamente: ${tiposUnidadNuevos.size} tipos de unidad, ${tiposSolucionNuevos.size} tipos de soluci√≥n, ${insumosNuevos.size} insumos`);
                    
                } catch (error) {
                    console.error('‚ùå Error creando tipos autom√°ticamente:', error);
                    errores.push(`Error creando tipos autom√°ticamente: ${error.message}`);
                    mostrarError(errores.join('<br>'));
                    return;
                }
            } else {
                console.log('‚ÑπÔ∏è No hay tipos nuevos que crear');
            }
            
            // Segunda pasada: validar combinaciones (ahora todos los tipos deber√≠an existir)
            data.combinaciones.forEach((combinacion, index) => {
                const erroresCombinacion = [];
                
                // Validar campos requeridos
                if (!combinacion.tipoUnidad) {
                    erroresCombinacion.push('tipoUnidad es requerido');
                }
                
                if (!combinacion.tipoSolucion) {
                    erroresCombinacion.push('tipoSolucion es requerido');
                }
                
                if (!combinacion.insumos || typeof combinacion.insumos !== 'object') {
                    erroresCombinacion.push('insumos debe ser un objeto');
                } else {
                    // Validar insumos
                    Object.keys(combinacion.insumos).forEach(insumo => {
                        const cantidad = combinacion.insumos[insumo];
                        if (!cantidad || isNaN(parseFloat(cantidad)) || parseFloat(cantidad) <= 0) {
                            erroresCombinacion.push(`cantidad inv√°lida para insumo "${insumo}": ${cantidad}`);
                        }
                    });
                }
                
                if (erroresCombinacion.length > 0) {
                    errores.push(`Combinaci√≥n ${index + 1}: ${erroresCombinacion.join(', ')}`);
                } else {
                    combinacionesValidas.push({
                        ...combinacion,
                        index: index + 1,
                        estado: 'V√°lida'
                    });
                }
            });
            
            if (errores.length > 0) {
                mostrarError(errores.join('<br>'));
                return;
            }
            
            // Mostrar preview si todo est√° bien
            datosCargaMasiva = combinacionesValidas;
            mostrarPreviewCarga();
        }

        function mostrarError(mensaje) {
            document.getElementById('listaErroresCarga').innerHTML = mensaje;
            document.getElementById('erroresCargaMasiva').classList.remove('d-none');
            document.getElementById('btnConfirmarCarga').disabled = true;
        }

        function mostrarPreviewCarga() {
            const tbody = document.getElementById('tablaPreviewCarga');
            tbody.innerHTML = '';
            
            datosCargaMasiva.forEach(combinacion => {
                const row = document.createElement('tr');
                const insumosText = Object.entries(combinacion.insumos)
                    .map(([insumo, cantidad]) => `${insumo}: ${cantidad}`)
                    .join(', ');
                
                row.innerHTML = `
                    <td>${combinacion.tipoUnidad}</td>
                    <td>${combinacion.tipoSolucion}</td>
                    <td>${insumosText}</td>
                    <td><span class="badge bg-success">${combinacion.estado}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Mostrar resumen
            document.getElementById('resumenCargaMasiva').textContent = 
                `Se cargar√°n ${datosCargaMasiva.length} combinaciones v√°lidas`;
            
            document.getElementById('previewCargaMasiva').classList.remove('d-none');
            document.getElementById('btnConfirmarCarga').disabled = false;
        }

        async function confirmarCargaMasiva() {
            if (datosCargaMasiva.length === 0) return;
            
            const btnConfirmar = document.getElementById('btnConfirmarCarga');
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';
            
            let exitosas = 0;
            let fallidas = 0;
            const errores = [];
            
            try {
                for (const combinacion of datosCargaMasiva) {
                    try {
                        const id = `${combinacion.tipoUnidad}::${combinacion.tipoSolucion}`;
                        const resultado = await window.dataService.upsertAlmacenInsumoById(id, {
                            id,
                            tipoUnidad: combinacion.tipoUnidad,
                            tipoSolucion: combinacion.tipoSolucion,
                            insumos: combinacion.insumos,
                        });
                        
                        if (resultado) {
                            exitosas++;
                        } else {
                            fallidas++;
                            errores.push(`Error guardando ${combinacion.tipoUnidad} - ${combinacion.tipoSolucion}`);
                        }
                    } catch (error) {
                        fallidas++;
                        errores.push(`Error en ${combinacion.tipoUnidad} - ${combinacion.tipoSolucion}: ${error.message}`);
                    }
                }
                
                // Mostrar resultados
                if (exitosas > 0) {
                    mostrarAlerta(`‚úÖ Carga completada: ${exitosas} combinaciones cargadas exitosamente`, 'success');
                }
                
                if (fallidas > 0) {
                    mostrarAlerta(`‚ö†Ô∏è ${fallidas} combinaciones fallaron. Revisa la consola para m√°s detalles.`, 'warning');
                    console.error('Errores de carga:', errores);
                }
                
                // Actualizar interfaz
                await cargarDesdeSupabase(); // Recargar datos desde Supabase
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('modalCargaMasiva')).hide();
                
            } catch (error) {
                console.error('‚ùå Error durante la carga masiva:', error);
                mostrarAlerta('Error durante la carga masiva: ' + error.message, 'danger');
            } finally {
                // Restaurar bot√≥n
                btnConfirmar.innerHTML = '<i class="bi bi-check-circle"></i> Confirmar Carga';
            }
        }

        function descargarPlantilla() {
            const plantilla = {
                "combinaciones": [
                    {
                        "tipoUnidad": "Tracto",
                        "tipoSolucion": "VPC",
                        "insumos": {
                            "Cable 4 pin 5 m": "1",
                            "Cable 4 pin 7 m": "2",
                            "Silicon": "0.1"
                        }
                    },
                    {
                        "tipoUnidad": "Tracto",
                        "tipoSolucion": "Rastreo avanzado",
                        "insumos": {
                            "Cable 4 vias": "6",
                            "Cincho mediado": "15",
                            "Poliflex 3/8": "8"
                        }
                    },
                    {
                        "tipoUnidad": "SUV",
                        "tipoSolucion": "Dashcam",
                        "insumos": {
                            "SD 256 Gb": "1",
                            "Cable 4 pin 3 m": "2"
                        }
                    }
                ]
            };
            
            const blob = new Blob([JSON.stringify(plantilla, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla_combinaciones.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===== FUNCIONES DE MIGRACI√ìN =====
        
        async function migrarATablasSeparadas() {
            console.log('üöÄ Iniciando migraci√≥n a tablas separadas...');
            
            try {
                // Verificar que dataService est√© disponible
                if (!window.dataService || !window.dataService.client) {
                    console.error('‚ùå dataService no est√° disponible');
                    mostrarAlerta('Error: dataService no est√° disponible', 'danger');
                    return false;
                }
                
                // 1. Obtener tipos existentes de localStorage
                const tiposGlobales = JSON.parse(localStorage.getItem('tipos_globales') || '{"vehiculos":[],"soluciones":[],"insumos":[]}');
                
                console.log('üìã Tipos encontrados en localStorage:', tiposGlobales);
                
                // 2. Migrar tipos de veh√≠culo
                console.log('üöó Migrando tipos de veh√≠culo...');
                for (const vehiculo of tiposGlobales.vehiculos || []) {
                    if (vehiculo && vehiculo.trim()) {
                        await window.dataService.upsertTipoUnidad(vehiculo.trim(), `Tipo de veh√≠culo: ${vehiculo}`);
                        console.log(`‚úÖ Veh√≠culo migrado: ${vehiculo}`);
                    }
                }
                
                // 3. Migrar tipos de soluci√≥n
                console.log('üîß Migrando tipos de soluci√≥n...');
                for (const solucion of tiposGlobales.soluciones || []) {
                    if (solucion && solucion.trim()) {
                        await window.dataService.upsertTipoSolucion(solucion.trim(), `Tipo de soluci√≥n: ${solucion}`, 'General');
                        console.log(`‚úÖ Soluci√≥n migrada: ${solucion}`);
                    }
                }
                
                // 4. Migrar tipos de insumo
                console.log('üì¶ Migrando tipos de insumo...');
                for (const insumo of tiposGlobales.insumos || []) {
                    if (insumo && insumo.trim()) {
                        await window.dataService.upsertTipoInsumo(insumo.trim(), `Tipo de insumo: ${insumo}`, 'General', 'piezas');
                        console.log(`‚úÖ Insumo migrado: ${insumo}`);
                    }
                }
                
                // 5. Verificar migraci√≥n
                console.log('üîç Verificando migraci√≥n...');
                const vehiculosMigrados = await window.dataService.fetchTiposUnidad();
                const solucionesMigradas = await window.dataService.fetchTiposSolucion();
                const insumosMigrados = await window.dataService.fetchTiposInsumo();
                
                console.log(`‚úÖ Veh√≠culos migrados: ${vehiculosMigrados.length}`);
                console.log(`‚úÖ Soluciones migradas: ${solucionesMigradas.length}`);
                console.log(`‚úÖ Insumos migrados: ${insumosMigrados.length}`);
                
                // 6. Limpiar localStorage (opcional)
                const limpiar = confirm('¬øDeseas limpiar los tipos_globales de localStorage? (Recomendado despu√©s de la migraci√≥n)');
                if (limpiar) {
                    localStorage.removeItem('tipos_globales');
                    console.log('üßπ localStorage limpiado');
                }
                
                mostrarAlerta('‚úÖ Migraci√≥n completada exitosamente. Refresca la p√°gina para usar las nuevas tablas.', 'success');
                console.log('‚úÖ Migraci√≥n completada exitosamente');
                console.log('üîÑ Refresca la p√°gina para usar las nuevas tablas');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error durante la migraci√≥n:', error);
                mostrarAlerta('‚ùå Error durante la migraci√≥n: ' + error.message, 'danger');
                return false;
            }
        }

        async function probarTablasSeparadas() {
            console.log('üß™ Probando tablas separadas...');
            
            try {
                // Probar fetch de cada tabla
                const vehiculos = await window.dataService.fetchTiposUnidad();
                const soluciones = await window.dataService.fetchTiposSolucion();
                const insumos = await window.dataService.fetchTiposInsumo();
                
                console.log('üìä Resultados:');
                console.log(`- Veh√≠culos: ${vehiculos.length} registros`);
                console.log(`- Soluciones: ${soluciones.length} registros`);
                console.log(`- Insumos: ${insumos.length} registros`);
                
                // Mostrar algunos ejemplos
                if (vehiculos.length > 0) {
                    console.log('üöó Ejemplo de veh√≠culo:', vehiculos[0]);
                }
                if (soluciones.length > 0) {
                    console.log('üîß Ejemplo de soluci√≥n:', soluciones[0]);
                }
                if (insumos.length > 0) {
                    console.log('üì¶ Ejemplo de insumo:', insumos[0]);
                }
                
                mostrarAlerta('‚úÖ Prueba completada. Revisa la consola para ver los resultados.', 'success');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error probando tablas:', error);
                mostrarAlerta('‚ùå Error probando tablas: ' + error.message, 'danger');
                return false;
            }
        }

        // ===== FUNCIONES DE RASTREO =====
        
        let funcionesRastreoExistentes = [];
        let funcionRastreoEditando = null;

        async function mostrarModalFuncionesRastreo() {
            console.log('üîß Abriendo modal de funciones de rastreo...');
            
            try {
                // Verificar que el modal existe
                const modalElement = document.getElementById('modalFuncionesRastreo');
                if (!modalElement) {
                    console.error('‚ùå Modal modalFuncionesRastreo no encontrado');
                    alert('Error: Modal no encontrado');
                    return;
                }
                
                console.log('‚úÖ Modal encontrado, procediendo...');
                
                // Limpiar formulario
                limpiarFormularioRastreo();
                
                // Cargar funciones existentes
                await cargarFuncionesRastreo();
                
                // Mostrar modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('‚úÖ Modal mostrado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error abriendo modal:', error);
                alert('Error abriendo modal: ' + error.message);
            }
        }

        async function cargarFuncionesRastreo() {
            try {
                console.log('üîÑ Cargando funciones de rastreo desde Supabase...');
                
                // Verificar que dataService est√© disponible
                if (!window.dataService || !window.dataService.fetchFuncionesRastreo) {
                    console.warn('‚ö†Ô∏è dataService no disponible, usando datos de prueba');
                    funcionesRastreoExistentes = [
                        {
                            funcionalidad: 'SOS simple',
                            insumos: [
                                { nombre: 'Boton membrana', cantidad: 1 },
                                { nombre: 'Cable 2 vias', cantidad: 2 }
                            ]
                        }
                    ];
                } else {
                    funcionesRastreoExistentes = await window.dataService.fetchFuncionesRastreo();
                }
                
                console.log(`‚úÖ Funciones cargadas: ${funcionesRastreoExistentes.length}`);
                console.log('üìã Funciones:', funcionesRastreoExistentes);
                
                // Actualizar tabla
                actualizarTablaFuncionesRastreo();
            } catch (error) {
                console.error('‚ùå Error cargando funciones de rastreo:', error);
                console.log('üîÑ Usando datos de prueba como fallback...');
                
                // Datos de prueba como fallback
                funcionesRastreoExistentes = [
                    {
                        funcionalidad: 'SOS simple',
                        insumos: [
                            { nombre: 'Boton membrana', cantidad: 1 },
                            { nombre: 'Cable 2 vias', cantidad: 2 }
                        ]
                    }
                ];
                
                actualizarTablaFuncionesRastreo();
            }
        }

        function actualizarTablaFuncionesRastreo() {
            const tbody = document.getElementById('tablaFuncionesRastreo');
            tbody.innerHTML = '';

            funcionesRastreoExistentes.forEach(funcion => {
                const row = document.createElement('tr');
                const insumosText = funcion.insumos.map(i => `${i.nombre} (${i.cantidad})`).join(', ');
                
                row.innerHTML = `
                    <td>${funcion.funcionalidad}</td>
                    <td>${insumosText}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarFuncionRastreo('${funcion.funcionalidad}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarFuncionRastreo('${funcion.funcionalidad}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editarFuncionRastreo(funcionalidad) {
            const funcion = funcionesRastreoExistentes.find(f => f.funcionalidad === funcionalidad);
            if (!funcion) return;

            funcionRastreoEditando = funcionalidad;
            document.getElementById('funcionalidadRastreo').value = funcion.funcionalidad;
            
            // Limpiar contenedor de insumos
            const container = document.getElementById('insumosRastreoContainer');
            container.innerHTML = '';
            
            // Agregar insumos existentes
            funcion.insumos.forEach(insumo => {
                agregarInsumoRastreo(insumo.nombre, insumo.cantidad);
            });
            
            // Si no hay insumos, agregar uno vac√≠o
            if (funcion.insumos.length === 0) {
                agregarInsumoRastreo();
            }
        }

        async function eliminarFuncionRastreo(funcionalidad) {
            if (!confirm(`¬øEst√°s seguro de eliminar la funci√≥n "${funcionalidad}"?`)) return;

            try {
                const success = await window.dataService.deleteFuncionRastreo(funcionalidad);
                if (success) {
                    mostrarAlerta('Funci√≥n eliminada correctamente', 'success');
                    await cargarFuncionesRastreo();
                } else {
                    mostrarAlerta('Error al eliminar la funci√≥n', 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error eliminando funci√≥n:', error);
                mostrarAlerta('Error al eliminar la funci√≥n: ' + error.message, 'danger');
            }
        }

        function agregarInsumoRastreo(nombre = '', cantidad = 1) {
            const container = document.getElementById('insumosRastreoContainer');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control insumo-nombre" placeholder="Nombre del insumo" value="${nombre}">
                <input type="number" class="form-control insumo-cantidad" placeholder="Cantidad" min="1" value="${cantidad}">
                <button type="button" class="btn btn-outline-danger" onclick="eliminarInsumoRastreo(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function eliminarInsumoRastreo(button) {
            button.parentElement.remove();
        }

        async function guardarFuncionRastreo() {
            const funcionalidad = document.getElementById('funcionalidadRastreo').value.trim();
            if (!funcionalidad) {
                mostrarAlerta('Por favor ingresa el nombre de la funcionalidad', 'warning');
                return;
            }

            // Recopilar insumos
            const insumos = [];
            const insumoNombres = document.querySelectorAll('.insumo-nombre');
            const insumoCantidades = document.querySelectorAll('.insumo-cantidad');

            for (let i = 0; i < insumoNombres.length; i++) {
                const nombre = insumoNombres[i].value.trim();
                const cantidad = parseInt(insumoCantidades[i].value) || 0;
                
                if (nombre && cantidad > 0) {
                    insumos.push({ nombre, cantidad });
                }
            }

            if (insumos.length === 0) {
                mostrarAlerta('Por favor agrega al menos un insumo', 'warning');
                return;
            }

            try {
                const success = await window.dataService.upsertFuncionRastreo(funcionalidad, insumos);
                if (success) {
                    mostrarAlerta('Funci√≥n guardada correctamente', 'success');
                    await cargarFuncionesRastreo();
                    limpiarFormularioRastreo();
                } else {
                    mostrarAlerta('Error al guardar la funci√≥n', 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error guardando funci√≥n:', error);
                mostrarAlerta('Error al guardar la funci√≥n: ' + error.message, 'danger');
            }
        }

        function limpiarFormularioRastreo() {
            funcionRastreoEditando = null;
            document.getElementById('funcionalidadRastreo').value = '';
            
            const container = document.getElementById('insumosRastreoContainer');
            container.innerHTML = '';
            agregarInsumoRastreo(); // Agregar un insumo vac√≠o por defecto
        }

        // ===== INICIALIZACI√ìN =====
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar funciones de migraci√≥n disponibles
            if (modoCentralizado) {
                console.log('üîß Funciones de migraci√≥n disponibles:');
                console.log('1. migrarATablasSeparadas() - Migra datos de localStorage a las nuevas tablas');
                console.log('2. probarTablasSeparadas() - Prueba que las tablas funcionen correctamente');
                console.log('');
                console.log('üí° Ejecuta: migrarATablasSeparadas() para comenzar la migraci√≥n');
            }
            
            // Cargar datos iniciales
            try {
                console.log('üîÑ Cargando datos iniciales...');
                await cargarDesdeSupabase();
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                console.log('‚úÖ Datos iniciales cargados correctamente');
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
            }
        });
    </script>
</body>
</html>
