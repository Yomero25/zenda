<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Almac√©n - Sistema de Trazabilidad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .dashboard-card h2 {
            font-size: 3rem;
            font-weight: bold;
            margin: 0;
        }
        .dashboard-card p {
            margin: 0;
            font-size: 1.1rem;
        }
        .bg-gradient-purple { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-blue { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        .bg-gradient-green { background: linear-gradient(135deg, #fb930c 0%, #f39c12 100%); }
        .bg-gradient-orange { background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%); }
        
        .sidebar {
            background: linear-gradient(135deg, #fb930c 0%, #e67e22 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="text-center mb-4">
                    <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="60" class="mb-3">
                    <h3 class="text-white">
                        <i class="bi bi-gear"></i> Panel de Control
                    </h3>
                </div>
                
                <button class="btn btn-success" onclick="agregarNuevaCombinacion()">
                    <i class="bi bi-plus-circle"></i> Nueva Combinaci√≥n
                </button>
                
                <button class="btn btn-warning" onclick="restaurarAlmacen()">
                    <i class="bi bi-arrow-clockwise"></i> Restaurar Almac√©n
                </button>

                
                <div class="mt-4">
                    <a href="./cotizaciones-completo.html" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Volver al Sistema Principal
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Header -->
                <nav class="navbar navbar-dark bg-dark">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <img src="LOGO TECH SISTEMA ADMON.svg" alt="Logo Empresa" height="40" class="me-3">
                            <span class="navbar-brand mb-0 h1">
                                <i class="bi bi-boxes"></i> Sistema de Trazabilidad
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="./cotizaciones-completo.html" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Principal
                            </a>
                            <button class="btn btn-outline-light btn-sm" id="btnLogout">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Dashboard -->
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-purple">
                                <h2 id="totalCombinaciones">0</h2>
                                <p>Combinaciones</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-blue">
                                <h2 id="totalInsumos">0</h2>
                                <p>Insumos √önicos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-green">
                                <h2 id="totalTiposUnidad">0</h2>
                                <p>Tipos de Unidad</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card bg-gradient-orange">
                                <h2 id="totalTiposSolucion">0</h2>
                                <p>Tipos de Soluci√≥n</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <h5><i class="bi bi-funnel"></i> Filtros</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filtroTipoUnidad" class="form-label">Tipo de Unidad:</label>
                                <select class="form-select" id="filtroTipoUnidad" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                                <select class="form-select" id="filtroTipoSolucion" onchange="aplicarFiltros()">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroInsumo" class="form-label">Buscar Insumo:</label>
                                <input type="text" class="form-control" id="filtroInsumo" placeholder="Escriba para buscar..." onkeyup="aplicarFiltros()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                                </button>
                                <span class="badge bg-info ms-2" id="resultadosFiltro">Mostrando todas las combinaciones</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Matriz -->
                    <div class="card">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #fb930c, #e67e22);">
                            <h4><i class="bi bi-grid-3x3-gap"></i> Matriz de Insumos</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Tipo Unidad</th>
                                            <th>Tipo Soluci√≥n</th>
                                            <th>Insumos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaAlmacen">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Combinaci√≥n -->
    <div class="modal fade" id="modalEditarCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Combinaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <input type="text" class="form-control" id="editTipoUnidad" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                            <input type="text" class="form-control" id="editTipoSolucion" readonly>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Insumos y Cantidades:</label>
                        <div id="editInsumos">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicionCombinacion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Combinaci√≥n -->
    <div class="modal fade" id="modalNuevaCombinacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Combinaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="nuevoTipoUnidad" class="form-label">Tipo de Unidad:</label>
                            <div class="input-group">
                                <select class="form-select" id="nuevoTipoUnidad">
                                    <option value="">Seleccionar tipo de unidad...</option>
                                </select>
                                <button class="btn btn-outline-success" type="button" onclick="mostrarModalNuevoTipo('vehiculo')" title="Agregar nuevo tipo de veh√≠culo">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevoTipoSolucion" class="form-label">Tipo de Soluci√≥n:</label>
                            <div class="input-group">
                                <select class="form-select" id="nuevoTipoSolucion">
                                    <option value="">Seleccionar tipo de soluci√≥n...</option>
                                </select>
                                <button class="btn btn-outline-success" type="button" onclick="mostrarModalNuevoTipo('solucion')" title="Agregar nuevo tipo de soluci√≥n">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Insumos y Cantidades:</label>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="mostrarModalNuevoInsumo()" title="Agregar nuevo insumo">
                                <i class="bi bi-plus-circle"></i> Nuevo Insumo
                            </button>
                        </div>
                        <div id="nuevoInsumos"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="agregarInsumoNueva()">
                        <i class="bi bi-plus"></i> Agregar Insumo
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarNuevaCombinacion()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nuevo Tipo de Veh√≠culo/Soluci√≥n/Insumo -->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevoTipoTitulo">Agregar Nuevo Tipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoTipoNombre" class="form-label" id="modalNuevoTipoLabel">Nombre del nuevo tipo:</label>
                        <input type="text" class="form-control" id="nuevoTipoNombre" placeholder="Ingrese el nombre del nuevo tipo">
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <span id="modalNuevoTipoDescripcion">Este nuevo tipo estar√° disponible inmediatamente para usar en las combinaciones.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarNuevoTipo()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nuevo Insumo -->
    <div class="modal fade" id="modalNuevoInsumo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Insumo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoInsumoNombre" class="form-label">Nombre del nuevo insumo:</label>
                        <input type="text" class="form-control" id="nuevoInsumoNombre" placeholder="Ej. Cable especial 10m">
                    </div>
                    <div class="mb-3">
                        <label for="nuevoInsumoCategoria" class="form-label">Categor√≠a (opcional):</label>
                        <select class="form-select" id="nuevoInsumoCategoria">
                            <option value="">Sin categor√≠a</option>
                            <option value="Cables y conectores">Cables y conectores</option>
                            <option value="Materiales b√°sicos">Materiales b√°sicos</option>
                            <option value="Componentes electr√≥nicos">Componentes electr√≥nicos</option>
                            <option value="Almacenamiento">Almacenamiento</option>
                            <option value="Alarmas y audio">Alarmas y audio</option>
                            <option value="Controles">Controles</option>
                            <option value="C√°maras">C√°maras</option>
                            <option value="Dashcams">Dashcams</option>
                            <option value="Sensores y accesorios">Sensores y accesorios</option>
                            <option value="Equipos principales">Equipos principales</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Este nuevo insumo estar√° disponible inmediatamente en la lista de insumos para seleccionar.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarNuevoInsumo()">Agregar Insumo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase + dataService -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./dataService.js"></script>
    <script src="./accessGuard.js"></script>

    <script>
        (async function(){
            const ok = await window.accessGuard.ensureAuth(['admin','almacen']);
            if (!ok) return;
        })();
        document.addEventListener('DOMContentLoaded', function(){
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await window.dataService.authSignOut(); } catch(_){}
                    window.location.href = './login.html';
                });
            }
        });
        // ===== VARIABLES GLOBALES =====
        const modoCentralizado = (window.dataService && window.dataService.hasSupabase && window.dataService.hasSupabase());
        let almacenInsumos = {};
        let combinacionEditando = null;
        let datosFiltrados = [];

        // Lista completa de insumos posibles
        let listaInsumos = [
            // Cables y conectores
            'Cable 4 pin 1 m', 'Cable 4 pin 3 m', 'Cable 4 pin 5 m', 'Cable 4 pin 7 m',
            'Cable 4 pin 15 m', 'Cable 4 pin 30 m', 'Cable 6 pin 5 m', 'Cable 2 vias', 'Cable 4 vias',
            '"Y" 4 pines', 'Base Pollak', 'Pollak Macho ', 'Pollak Hembra', 'Cable de 1 polo',
            'Terminal de ojillo', '7 vias liso 2m',
            
            // Materiales b√°sicos
            'Silicon', 'Cinchos grande', 'Cinta de tela', 'Cinta de aislar',
            'Poliflex 3/8', 'Poliflex 1/4', 'Cincho mediado', 'Cincho con grapa',
            'Pija brocante 5/16', 'Tornillo hexagonal 5/16', 'Tornillo 3/8',
            'Tuerca 5/16', 'Tuerca 3/8', 'Rondana 5/16', 'Rondana 3/8',
            'Espiral negro', 'Espiral verde',
            
            // Componentes electr√≥nicos
            'Relevador 2 pasos 2 tiros', 'Relevador 12v', 'Relevador 24v', 'Portarelevador',
            'placa perforada', 'Gabinete 5*7*3',
            
            // Almacenamiento
            'SD 128 Gb', 'SD 256 Gb', 'SD 512 Gb',
            
            // Alarmas y audio
            'Alarma parlante de 3 tonos', 'Alarma parlante programable', 'Bocina', 'Microfono',
            
            // Controles
            'Bot√≥n balancin', 'Boton de panico',
            
            // C√°maras
            'Camara + radar', 'Camara con microfono', 'Camara de reversa', 'Camara Digital (IP)',
            'Camara exterior mini', 'Camara lateral derecha de VPC', 'Camara lateral izquierda de VPC',
            'Camara sideview derecho', 'Camara sideview izquierdo', 'Camara tipo clavo',
            
            // Dashcams
            'Dashcam ad2', 'Dashcam c6',
            
            // Sensores y accesorios
            'Sensor magnetico chico', 'Sensor magnetico grande', 'Insider',
            'Led de giro a la derecha', 'Led de giro a la izquierda', 'Limitador de velocidad',
            'Modulo sensor de cinturon seguridad',
            
            // Equipos principales
            'Monitor de VPC', 'Grabador de video 4 ch',
            
            // Sensores VPC
            'Sensor derecho VPC', 'Sensor izquierda VPC', 'Sideview derecho', 'Sideview izquierdo'
        ];

        // ===== MATRIZ COMPLETA Y CORREGIDA DEL CSV =====
        function cargarMatrizCompletaCSV() {
            // MATRIZ CORREGIDA: Sin "Gu√≠a de meta", con Pollaks, datos exactos del CSV
            return Promise.resolve({
                "Tracto": {
                    "VPC": {
                        "Cable 4 pin 5 m": "1",
                        "Cable 4 pin 7 m": "2", 
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    },
                    "Sensor VPC": {
                        "Cable 4 vias": "4",
                        "Sensor derecho VPC": "1",
                        "Sensor izquierda VPC": "1"
                    },
                    "Led de giro": {
                        "Pija brocante 5/16": "10",
                        "Terminal de ojillo": "2",
                        "Poliflex 1/4": "8",
                        "Cable 2 vias": "26",
                        "Led de giro a la derecha": "2",
                        "Led de giro a la izquierda": "2"
                    },
                    "Alarma parlante estandar": {
                        "Tornillo 3/8": "2",
                        "Cinta de tela": "1/2",
                        "Poliflex 3/8": "8",
                        "Cincho mediado": "30",
                        "Pija brocante 5/16": "2",
                        "Cable 4 vias": "6",
                        "Tuerca 3/8": "2",
                        "Rondana 3/8": "2",
                        "Alarma parlante de 3 tonos": "1"
                    },
                    "Alarma parlante programable": {},
                    "Encadenamiento se√±ales": {
                        // NOTA: Los condicionales deben aplicarse en el wizard:
                        // - Si encadenamiento SENCILLO: 1 c√°mara de reversa
                        // - Si encadenamiento FULL: 2 c√°maras de reversa
                        "Cable 4 pin 1 m": "5",
                        "Cable 4 pin 5 m": "1", 
                        "Cable 4 pin 7 m": "1",
                        "Cable 4 pin 15 m": "2",
                        "Base Pollak": "7",
                        "Pollak Macho ": "4",
                        "Pollak Hembra": "4",
                        "Silicon": "1/10",
                        "Cinta de tela": "1",
                        "Poliflex 3/8": "30",
                        "Cincho mediado": "120",
                        "Cincho con grapa": "80",
                        "Pija brocante 5/16": "40",
                        "Cable 2 vias": "40",
                        "Cable 4 vias": "40",
                        "Espiral negro": "1",
                        "Espiral verde": "2",
                        "7 vias liso 2m": "1",
                        "Relevador 2 pasos 2 tiros": "5",
                        "placa perforada": "2.5",
                        "Gabinete 5*7*3": "4",
                        "Camara con microfono": "2",
                        "Camara de reversa": "2"
                    },
                    "MDVR 4 Ch": {
                        "Cable 4 pin 3 m": "1",
                        "Cable 4 pin 7 m": "2",
                        "Cable 4 pin 15 m": "1",
                        "Cable 6 pin 5 m": "1",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "30",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Grabador de video 4 ch": "1"
                    },
                    "MDVR 8 Ch": {
                        "Cable 4 pin 3 m": "1",
                        "Cable 4 pin 7 m": "2",
                        "Cable 4 pin 15 m": "1",
                        "Cable 6 pin 5 m": "1",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "30",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Grabador de video 4 ch": "1"
                    },
                    "Sideview": {
                        "Cable 4 pin 7 m": "4",
                        "Silicon": "1/10",

                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "15",
                        "Cincho mediado": "60",
                        "Pija brocante 5/16": "16",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "10",
                        "Cable 4 vias": "10",
                        "Camara sideview derecho": "1",
                        "Camara sideview izquierdo": "1",
                        "Sideview derecho": "1",
                        "Sideview izquierdo": "1"
                    },
                    "Dashcam": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "5",
                        "Cable 4 vias": "5",
                        "Dashcam ad2": "1",
                        "Dashcam c6": "1"
                    },
                    "Rastreo basico": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo avanzado": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo satelital": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 4 vias": "4",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Insider": {},
                    "Limitador de velocidad": {},
                    "Modulo sensor cinturon": {}
                },
                "Tracto Cabina sobre motor": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    },
                    "Sensor VPC": {
                        "Cable 4 vias": "4",
                        "Sensor derecho VPC": "1",
                        "Sensor izquierda VPC": "1"
                    }
                },
                "Rab√≥n": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Torton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "4.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "3.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "2.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "1.5 ton": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Van pasajeros": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Autobus pasajeros": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "SUV": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Sedan lujo": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Sedan": {
                    "VPC": {
                        "Cable 4 pin 5 m": "3",
                        "Cable 4 pin 15 m": "1",
                        "\"\"\"Y\"\" 4 pines\"": "4",
                        "Silicon": "1/10",
                        "Cinchos grande": "30",
                        "Cinta de tela": "1",
                        "Cinta de aislar": "1",
                        "Poliflex 3/8": "18",
                        "Cincho mediado": "80",
                        "Cincho con grapa": "40",
                        "Pija brocante 5/16": "6",
                        "Terminal de ojillo": "2",
                        "Cable 2 vias": "2",
                        "Camara de reversa": "1",
                        "Camara exterior mini": "1",
                        "Camara lateral derecha de VPC": "1",
                        "Camara lateral izquierda de VPC": "1",
                        "Monitor de VPC": "1"
                    }
                },
                "Motocicleta": {
                    "Rastreo basico": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo avanzado": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "3",
                        "Cable 4 vias": "8",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    },
                    "Rastreo satelital": {

                        "Cinta de aislar": "1",
                        "Cincho mediado": "15",
                        "Pija brocante 5/16": "1",
                        "Terminal de ojillo": "2",
                        "Cable 4 vias": "4",
                        "Relevador 2 pasos 2 tiros": "1",
                        "placa perforada": "1",
                        "Gabinete 5*7*3": "1"
                    }
                }
            });
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ Inicializando almac√©n...');
            try {
                // Limpiar localStorage de tipos para evitar conflictos
                localStorage.removeItem('tipos_globales');
                console.log('üßπ localStorage de tipos limpiado');
                
                if (modoCentralizado) {
                    console.log('üì¶ Modo centralizado (Supabase)');
                    await cargarDesdeSupabase();
                    suscribirRealtimeAlmacen();
                } else {
                    console.log('üóÑÔ∏è Modo localStorage');
                    almacenInsumos = await cargarMatrizCompletaCSV();
                    cargarAlmacenDesdeStorage();
                }
                
                // Limpiar soluciones duplicadas
                limpiarSolucionesDuplicadas();
                
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
            } catch (error) {
                console.error('‚ùå Error inicializando almac√©n:', error);
                mostrarAlerta('Error al inicializar el almac√©n', 'danger');
            }
        });

        // Funci√≥n para restaurar almac√©n si se perdi√≥
        async function restaurarAlmacen() {
            console.log('üîÑ Restaurando almac√©n...');
            try {
                almacenInsumos = await cargarMatrizCompletaCSV();
                console.log(`‚úÖ Matriz restaurada: ${Object.keys(almacenInsumos).length} tipos de unidad`);
                // Sincronizar con Supabase si est√° activo: sembrar por filas (tipo_unidad/tipo_solucion)
                try {
                    if (modoCentralizado) {
                        await migrarAlmacenLocalASupabase(almacenInsumos);
                        console.log('‚úÖ Almac√©n restaurado en Supabase (por filas)');
                    }
                } catch (e) { console.warn('‚ö†Ô∏è Error sincronizando almac√©n en Supabase', e); }

                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                console.log('‚úÖ Almac√©n restaurado');
            } catch (error) {
                console.error('‚ùå Error al restaurar almac√©n:', error);
                mostrarAlerta('Error al restaurar el almac√©n', 'danger');
            }
        }

        // ===== FUNCIONES PRINCIPALES =====
        
        async function cargarDesdeSupabase() {
            try {
                const registros = await window.dataService.fetchAlmacenInsumos();
                // Soporte esquema single-doc: {insumos: {...}}
                let mapa = {};
                if (Array.isArray(registros) && registros.length === 1 && registros[0]._schema === 'single_doc' && registros[0].insumos) {
                    mapa = registros[0].insumos;
                } else {
                    (registros || []).forEach(r => {
                        const tipoUnidad = r.tipoUnidad;
                        const tipoSolucion = r.tipoSolucion;
                        const insumos = r.insumos || {};
                        
                        // Si es un placeholder, crear tipo de veh√≠culo vac√≠o
                        if (tipoSolucion === '_placeholder') {
                            mapa[tipoUnidad] = {};
                        } else {
                            // Procesar soluci√≥n normal
                            if (!mapa[tipoUnidad]) mapa[tipoUnidad] = {};
                            mapa[tipoUnidad][tipoSolucion] = insumos;
                        }
                    });
                }
                almacenInsumos = mapa;
                console.log(`‚úÖ Supabase: ${Array.isArray(registros) ? registros.length : 0} registros`);

                // Si no hay datos en Supabase, intentar migrar desde localStorage o CSV
                const yaMigrado = localStorage.getItem('almacen_migrado_supabase') === 'true';
                if ((registros || []).length === 0 && !yaMigrado) {
                    console.log('‚ÑπÔ∏è Supabase vac√≠o. Intentando migrar desde localStorage o CSV...');
                    let origenMapa = null;
                    try {
                        const almacenGuardado = localStorage.getItem('almacen_insumos');
                        if (almacenGuardado) {
                            origenMapa = JSON.parse(almacenGuardado);
                            console.log('üì• Encontrado almac√©n en localStorage; migrando...');
                        } else {
                            origenMapa = await cargarMatrizCompletaCSV();
                            console.log('üì• Usando matriz CSV por defecto; migrando...');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No fue posible obtener origen para migraci√≥n:', e);
                    }
                    if (origenMapa) {
                        await migrarAlmacenLocalASupabase(origenMapa);
                        localStorage.setItem('almacen_migrado_supabase', 'true');
                        // recargar desde supabase
                        return cargarDesdeSupabase();
                    }
                }
            } catch (e) {
                console.error('‚ùå Error cargando Supabase almacen:', e);
                mostrarAlerta('No se pudo cargar almacen desde Supabase', 'danger');
            }
        }

        async function migrarAlmacenLocalASupabase(mapa) {
            try {
                const tareas = [];
                for (const [tipoUnidad, soluciones] of Object.entries(mapa)) {
                    for (const [tipoSolucion, insumos] of Object.entries(soluciones || {})) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        tareas.push(window.dataService.upsertAlmacenInsumoById(id, {
                            id,
                            tipoUnidad,
                            tipoSolucion,
                            insumos: insumos || {},
                        }));
                    }
                }
                for (let i = 0; i < tareas.length; i += 25) {
                    const slice = tareas.slice(i, i + 25);
                    // eslint-disable-next-line no-await-in-loop
                    await Promise.all(slice);
                }
                console.log(`‚úÖ Migraci√≥n de almac√©n completada (filas)`);
                mostrarAlerta('Almac√©n migrado a Supabase', 'success');
            } catch (e) {
                console.error('‚ùå Error migrando almac√©n a Supabase:', e);
                mostrarAlerta('Error migrando almac√©n a Supabase', 'danger');
            }
        }

        function cargarAlmacenDesdeStorage() {
            const almacenGuardado = localStorage.getItem('almacen_insumos');
            if (almacenGuardado) {
                try {
                    const almacenParsed = JSON.parse(almacenGuardado);
                    // Fusionar con la matriz CSV (prioridad a localStorage)
                    almacenInsumos = { ...almacenInsumos, ...almacenParsed };
                    console.log('‚úÖ Almac√©n cargado desde localStorage');
                } catch (error) {
                    console.error('‚ùå Error parseando almac√©n de localStorage:', error);
                }
            }
        }

        async function cargarFiltros() {
            try {
                console.log('üîÑ Cargando filtros desde Supabase...');
                
                // Cargar tipos desde Supabase
                const [tiposUnidad, tiposSolucion] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion()
                ]);
                
                const nombresUnidad = tiposUnidad.map(t => t.nombre).sort();
                const nombresSolucion = tiposSolucion.map(t => t.nombre).sort();
                
                console.log('üîç DEBUG: Tipos de unidad para filtros:', nombresUnidad);
                console.log('üîç DEBUG: Tipos de soluci√≥n para filtros:', nombresSolucion);

                // Cargar filtro de tipos de unidad
                const selectUnidad = document.getElementById('filtroTipoUnidad');
                selectUnidad.innerHTML = '<option value="">Todos</option>';
                nombresUnidad.forEach(tipo => {
                    selectUnidad.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });

                // Cargar filtro de tipos de soluci√≥n
                const selectSolucion = document.getElementById('filtroTipoSolucion');
                selectSolucion.innerHTML = '<option value="">Todos</option>';
                nombresSolucion.forEach(tipo => {
                    selectSolucion.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });
                
                console.log('‚úÖ Filtros cargados desde Supabase');
            } catch (error) {
                console.error('‚ùå Error cargando filtros desde Supabase:', error);
                // Fallback a datos locales si hay error
                const tiposUnidad = [...new Set(Object.keys(almacenInsumos))].sort();
                const tiposSolucion = [...new Set(
                    Object.values(almacenInsumos).flatMap(obj => Object.keys(obj))
                )].sort();

                const selectUnidad = document.getElementById('filtroTipoUnidad');
                selectUnidad.innerHTML = '<option value="">Todos</option>';
                tiposUnidad.forEach(tipo => {
                    selectUnidad.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });

                const selectSolucion = document.getElementById('filtroTipoSolucion');
                selectSolucion.innerHTML = '<option value="">Todos</option>';
                tiposSolucion.forEach(tipo => {
                    selectSolucion.innerHTML += `<option value="${tipo}">${tipo}</option>`;
                });
            }
        }

        function cargarTablaAlmacen() {
            const tbody = document.getElementById('tablaAlmacen');
            tbody.innerHTML = '';

            let combinaciones = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    combinaciones.push({
                        tipoUnidad,
                        tipoSolucion,
                        insumos: Object.keys(insumos).length > 0 ? insumos : {}
                    });
                }
            }

            datosFiltrados = combinaciones;
            mostrarCombinaciones(combinaciones);
        }

        function mostrarCombinaciones(combinaciones) {
            const tbody = document.getElementById('tablaAlmacen');
            tbody.innerHTML = '';

            combinaciones.forEach((combo, index) => {
                const insumosTexto = Object.keys(combo.insumos).length > 0 
                    ? Object.entries(combo.insumos)
                        .map(([insumo, cantidad]) => `${insumo} (${cantidad})`)
                        .join(', ')
                    : 'Sin insumos';

                const row = `
                    <tr>
                        <td><strong>${combo.tipoUnidad}</strong></td>
                        <td><span class="badge bg-secondary">${combo.tipoSolucion}</span></td>
                        <td style="max-width: 300px; word-wrap: break-word;">${insumosTexto}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editarCombinacion('${combo.tipoUnidad}', '${combo.tipoSolucion}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCombinacion('${combo.tipoUnidad}', '${combo.tipoSolucion}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('resultadosFiltro').textContent = 
                `Mostrando ${combinaciones.length} combinaciones`;
        }

        async function actualizarEstadisticas() {
            try {
                console.log('üîÑ Actualizando estad√≠sticas desde Supabase...');
                
                // Cargar datos desde Supabase
                const [tiposUnidad, tiposSolucion, tiposInsumo, almacenData] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion(),
                    window.dataService.fetchTiposInsumo(),
                    window.dataService.fetchAlmacenInsumos()
                ]);
                
                // Calcular estad√≠sticas reales desde datos de Supabase
                let totalCombinaciones = 0;
                const insumosUnicos = new Set();
                const tiposSolucionUnicos = new Set();
                
                // Procesar datos seg√∫n el esquema devuelto por Supabase
                if (Array.isArray(almacenData)) {
                    // Esquema por filas (m√°s com√∫n)
                    almacenData.forEach(row => {
                        if (row.insumos && typeof row.insumos === 'object') {
                            // Esquema: {tipoUnidad: {tipoSolucion: {insumos: {}}}}
                            Object.values(row.insumos).forEach(soluciones => {
                                if (typeof soluciones === 'object') {
                                    Object.keys(soluciones).forEach(tipoSolucion => {
                                        tiposSolucionUnicos.add(tipoSolucion);
                                        totalCombinaciones++;
                                        
                                        const insumos = soluciones[tipoSolucion];
                                        if (typeof insumos === 'object') {
                                            Object.keys(insumos).forEach(insumo => {
                                                insumosUnicos.add(insumo);
                                            });
                                        }
                                    });
                                }
                            });
                        } else if (row.tipoUnidad && row.tipoSolucion) {
                            // Esquema por columnas: {tipoUnidad, tipoSolucion, insumos}
                            tiposSolucionUnicos.add(row.tipoSolucion);
                            totalCombinaciones++;
                            
                            if (row.insumos && typeof row.insumos === 'object') {
                                Object.keys(row.insumos).forEach(insumo => {
                                    insumosUnicos.add(insumo);
                                });
                            }
                        }
                    });
                } else if (typeof almacenData === 'object') {
                    // Esquema de documento √∫nico
                    Object.values(almacenData).forEach(soluciones => {
                        if (typeof soluciones === 'object') {
                            Object.keys(soluciones).forEach(tipoSolucion => {
                                tiposSolucionUnicos.add(tipoSolucion);
                                totalCombinaciones++;
                                
                                const insumos = soluciones[tipoSolucion];
                                if (typeof insumos === 'object') {
                                    Object.keys(insumos).forEach(insumo => {
                                        insumosUnicos.add(insumo);
                                    });
                                }
                            });
                        }
                    });
                }

                // Actualizar UI con datos reales de Supabase
                document.getElementById('totalCombinaciones').textContent = totalCombinaciones;
                document.getElementById('totalInsumos').textContent = insumosUnicos.size;
                document.getElementById('totalTiposUnidad').textContent = tiposUnidad.length;
                document.getElementById('totalTiposSolucion').textContent = tiposSolucion.length;
                
                console.log('‚úÖ Estad√≠sticas actualizadas desde Supabase:');
                console.log(`  - Combinaciones: ${totalCombinaciones}`);
                console.log(`  - Insumos √∫nicos: ${insumosUnicos.size}`);
                console.log(`  - Tipos de unidad: ${tiposUnidad.length}`);
                console.log(`  - Tipos de soluci√≥n: ${tiposSolucion.length}`);
                console.log('üîç DEBUG: Datos de almacenData:', almacenData);
                console.log('üîç DEBUG: Esquema detectado:', Array.isArray(almacenData) ? 'Array' : 'Object');
                
            } catch (error) {
                console.error('‚ùå Error actualizando estad√≠sticas desde Supabase:', error);
                // Fallback a datos locales si hay error
                const totalCombinaciones = Object.values(almacenInsumos)
                    .reduce((total, soluciones) => total + Object.keys(soluciones).length, 0);
                
                const insumosUnicos = new Set();
                Object.values(almacenInsumos).forEach(soluciones => {
                    Object.values(soluciones).forEach(insumos => {
                        Object.keys(insumos).forEach(insumo => insumosUnicos.add(insumo));
                    });
                });

                const tiposSolucionUnicos = new Set();
                Object.values(almacenInsumos).forEach(soluciones => {
                    Object.keys(soluciones).forEach(tipo => tiposSolucionUnicos.add(tipo));
                });

                document.getElementById('totalCombinaciones').textContent = totalCombinaciones;
                document.getElementById('totalInsumos').textContent = insumosUnicos.size;
                document.getElementById('totalTiposUnidad').textContent = Object.keys(almacenInsumos).length;
                document.getElementById('totalTiposSolucion').textContent = tiposSolucionUnicos.size;
            }
        }

        function aplicarFiltros() {
            const filtroUnidad = document.getElementById('filtroTipoUnidad').value;
            const filtroSolucion = document.getElementById('filtroTipoSolucion').value;
            const filtroInsumo = document.getElementById('filtroInsumo').value.toLowerCase();

            let combinacionesFiltradas = [];
            
            for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                    let coincide = true;

                    if (filtroUnidad && tipoUnidad !== filtroUnidad) coincide = false;
                    if (filtroSolucion && tipoSolucion !== filtroSolucion) coincide = false;
                    if (filtroInsumo) {
                        const tieneInsumo = Object.keys(insumos).some(insumo => 
                            insumo.toLowerCase().includes(filtroInsumo)
                        );
                        if (!tieneInsumo) coincide = false;
                    }

                    if (coincide) {
                        combinacionesFiltradas.push({
                            tipoUnidad,
                            tipoSolucion,
                            insumos
                        });
                    }
                }
            }

            mostrarCombinaciones(combinacionesFiltradas);
        }

        function limpiarFiltros() {
            document.getElementById('filtroTipoUnidad').value = '';
            document.getElementById('filtroTipoSolucion').value = '';
            document.getElementById('filtroInsumo').value = '';
            cargarTablaAlmacen();
        }

        function editarCombinacion(tipoUnidad, tipoSolucion) {
            combinacionEditando = { tipoUnidad, tipoSolucion };
            
            document.getElementById('editTipoUnidad').value = tipoUnidad;
            document.getElementById('editTipoSolucion').value = tipoSolucion;
            
            const insumos = almacenInsumos[tipoUnidad][tipoSolucion] || {};
            const contenedor = document.getElementById('editInsumos');
            contenedor.innerHTML = '';

            // Mostrar insumos existentes
            Object.entries(insumos).forEach(([insumo, cantidad]) => {
                const div = document.createElement('div');
                div.className = 'row mb-2';
                div.innerHTML = `
                    <div class="col-md-8">
                        <input type="text" class="form-control" value="${insumo}" readonly>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" value="${cantidad}" data-insumo="${insumo}">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                contenedor.appendChild(div);
            });

            // Bot√≥n para agregar nuevo insumo
            const divAgregar = document.createElement('div');
            divAgregar.className = 'row mt-3';
            divAgregar.innerHTML = `
                <div class="col-md-12">
                    <button class="btn btn-success btn-sm" onclick="agregarInsumoAEdicion()">
                        <i class="bi bi-plus"></i> Agregar Insumo
                    </button>
                </div>
            `;
            contenedor.appendChild(divAgregar);

            new bootstrap.Modal(document.getElementById('modalEditarCombinacion')).show();
        }

        function agregarInsumoAEdicion() {
            const contenedor = document.getElementById('editInsumos');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-8">
                    <select class="form-control">
                        <option value="">Seleccionar insumo...</option>
                        ${listaInsumos.map(insumo => `<option value="${insumo}">${insumo}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            contenedor.insertBefore(div, contenedor.lastElementChild);
        }

        async function guardarEdicionCombinacion() {
            if (!combinacionEditando) return;

            const { tipoUnidad, tipoSolucion } = combinacionEditando;
            const contenedor = document.getElementById('editInsumos');
            const nuevosInsumos = {};

            // Recopilar insumos del modal
            const rows = contenedor.querySelectorAll('.row:not(:last-child)');
            rows.forEach(row => {
                const insumo = row.querySelector('input[readonly]')?.value || 
                              row.querySelector('select')?.value;
                const cantidad = row.querySelector('input:not([readonly])')?.value;
                
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });

            // Actualizar almac√©n
            if (!almacenInsumos[tipoUnidad]) almacenInsumos[tipoUnidad] = {};
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;
            try {
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
            } catch (error) {
                console.warn('No se pudo guardar cambios', error);
            }
            
            // Actualizar tabla y estad√≠sticas
            cargarTablaAlmacen();
            actualizarEstadisticas();
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalEditarCombinacion')).hide();
            
            mostrarAlerta(`Combinaci√≥n ${tipoUnidad} - ${tipoSolucion} actualizada`, 'success');
        }

        async function eliminarCombinacion(tipoUnidad, tipoSolucion) {
            if (confirm(`¬øEst√° seguro de eliminar la combinaci√≥n ${tipoUnidad} - ${tipoSolucion}?`)) {
                delete almacenInsumos[tipoUnidad][tipoSolucion];
                
                // Si no quedan soluciones para este tipo de unidad, eliminar el tipo
                if (Object.keys(almacenInsumos[tipoUnidad]).length === 0) {
                    delete almacenInsumos[tipoUnidad];
                }
                try {
                    if (modoCentralizado) {
                        const id = `${tipoUnidad}::${tipoSolucion}`;
                        await window.dataService.deleteAlmacenInsumoById(id);
                    } else {
                        localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                    }
                } catch (error) {
                    console.warn('No se pudo guardar cambios', error);
                }
                
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                mostrarAlerta(`Combinaci√≥n eliminada`, 'success');
            }
        }

        // ===== NUEVA COMBINACI√ìN =====
        async function agregarNuevaCombinacion() {
            try {
                // Actualizar las listas de opciones
                await actualizarListasEnModalNuevaCombinacion();

                // Limpiar campos
                document.getElementById('nuevoTipoUnidad').value = '';
                document.getElementById('nuevoTipoSolucion').value = '';

                const cont = document.getElementById('nuevoInsumos');
                cont.innerHTML = '';
                agregarInsumoNueva();

                new bootstrap.Modal(document.getElementById('modalNuevaCombinacion')).show();
            } catch (e) {
                console.error('‚ùå Error preparando modal nueva combinaci√≥n:', e);
                mostrarAlerta('Error preparando el formulario de nueva combinaci√≥n', 'danger');
            }
        }

        function agregarInsumoNueva() {
            const cont = document.getElementById('nuevoInsumos');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-8">
                    <select class="form-control">
                        <option value="">Seleccionar insumo...</option>
                        ${listaInsumos.map(insumo => `<option value="${insumo}">${insumo}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            cont.appendChild(div);
        }

        async function guardarNuevaCombinacion() {
            const tipoUnidad = document.getElementById('nuevoTipoUnidad').value.trim();
            const tipoSolucion = document.getElementById('nuevoTipoSolucion').value.trim();
            if (!tipoUnidad || !tipoSolucion) {
                mostrarAlerta('Especifique tipo de unidad y tipo de soluci√≥n', 'warning');
                return;
            }

            const cont = document.getElementById('nuevoInsumos');
            const rows = cont.querySelectorAll('.row');
            const nuevosInsumos = {};
            rows.forEach(row => {
                const insumo = row.querySelector('select')?.value;
                const cantidad = row.querySelector('input')?.value;
                if (insumo && cantidad) {
                    nuevosInsumos[insumo] = cantidad;
                }
            });
            if (Object.keys(nuevosInsumos).length === 0) {
                mostrarAlerta('Agregue al menos un insumo con cantidad', 'warning');
                return;
            }

            if (!almacenInsumos[tipoUnidad]) {
                almacenInsumos[tipoUnidad] = {};
            }
            almacenInsumos[tipoUnidad][tipoSolucion] = nuevosInsumos;

            try {
                if (modoCentralizado) {
                    const id = `${tipoUnidad}::${tipoSolucion}`;
                    await window.dataService.upsertAlmacenInsumoById(id, {
                        id,
                        tipoUnidad,
                        tipoSolucion,
                        insumos: nuevosInsumos,
                    });
                } else {
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }
            } catch (e) {
                console.warn('No se pudo guardar combinaci√≥n', e);
            }

            cargarFiltros();
            cargarTablaAlmacen();
            actualizarEstadisticas();
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaCombinacion')).hide();
            mostrarAlerta(`Combinaci√≥n ${tipoUnidad} - ${tipoSolucion} creada`, 'success');
        }

        function guardarCambios() {
            if (modoCentralizado) {
                mostrarAlerta('Los cambios ya se guardan autom√°ticamente en Supabase', 'info');
            } else {
                localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                mostrarAlerta('Cambios guardados en el navegador', 'success');
            }
        }

        function exportarAlmacen() {
            const dataStr = JSON.stringify(almacenInsumos, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'almacen_insumos.json';
            link.click();
            URL.revokeObjectURL(url);
            
            mostrarAlerta('Almac√©n exportado correctamente', 'success');
        }

        function importarAlmacen(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const almacenImportado = JSON.parse(e.target.result);
                    almacenInsumos = almacenImportado;
                    
                    await cargarFiltros();
                    cargarTablaAlmacen();
                    await actualizarEstadisticas();
                    
                    mostrarAlerta('Almac√©n importado correctamente', 'success');
                } catch (error) {
                    mostrarAlerta('Error al importar el archivo', 'danger');
                }
            };
            reader.readAsText(file);
        }

        async function resetearAlmacen() {
            if (confirm('¬øEst√° seguro de resetear el almac√©n a los valores por defecto del CSV?')) {
                localStorage.removeItem('almacen_insumos');
                cargarMatrizCompletaCSV().then(async matriz => {
                    almacenInsumos = matriz;
                    await cargarFiltros();
                    cargarTablaAlmacen();
                    await actualizarEstadisticas();
                    mostrarAlerta('Almac√©n reseteado a valores del CSV', 'success');
                });
            }
        }

        function suscribirRealtimeAlmacen() {
            if (!modoCentralizado) return;
            window.dataService.subscribeAlmacenInsumos(async (payload) => {
                try {
                    await cargarDesdeSupabase();
                    await cargarFiltros();
                    cargarTablaAlmacen();
                    await actualizarEstadisticas();
                } catch (e) {
                    console.warn('Realtime almacen refresco fallido', e);
                }
            });
        }

        // ===== FUNCIONES PARA AGREGAR NUEVOS TIPOS =====
        
        let tipoActualAgregando = null; // 'vehiculo', 'solucion', o 'insumo'

        function mostrarModalNuevoTipo(tipo) {
            tipoActualAgregando = tipo;
            const modal = document.getElementById('modalNuevoTipo');
            const titulo = document.getElementById('modalNuevoTipoTitulo');
            const label = document.getElementById('modalNuevoTipoLabel');
            const descripcion = document.getElementById('modalNuevoTipoDescripcion');
            const input = document.getElementById('nuevoTipoNombre');
            
            input.value = '';
            
            if (tipo === 'vehiculo') {
                titulo.textContent = 'Agregar Nuevo Tipo de Veh√≠culo';
                label.textContent = 'Nombre del nuevo tipo de veh√≠culo:';
                input.placeholder = 'Ej. Cami√≥n de carga, Furg√≥n, etc.';
                descripcion.textContent = 'Este nuevo tipo de veh√≠culo estar√° disponible inmediatamente para usar en las combinaciones.';
            } else if (tipo === 'solucion') {
                titulo.textContent = 'Agregar Nuevo Tipo de Soluci√≥n';
                label.textContent = 'Nombre del nuevo tipo de soluci√≥n:';
                input.placeholder = 'Ej. GPS Avanzado, Sistema de Monitoreo, etc.';
                descripcion.textContent = 'Este nuevo tipo de soluci√≥n estar√° disponible inmediatamente para usar en las combinaciones.';
            }
            
            new bootstrap.Modal(modal).show();
        }

        function mostrarModalNuevoInsumo() {
            const modal = document.getElementById('modalNuevoInsumo');
            const input = document.getElementById('nuevoInsumoNombre');
            const categoria = document.getElementById('nuevoInsumoCategoria');
            
            input.value = '';
            categoria.value = '';
            
            new bootstrap.Modal(modal).show();
        }

        async function guardarNuevoTipo() {
            const nombre = document.getElementById('nuevoTipoNombre').value.trim();
            
            if (!nombre) {
                mostrarAlerta('Por favor ingrese un nombre para el nuevo tipo', 'warning');
                return;
            }

            try {
                if (tipoActualAgregando === 'vehiculo') {
                    // Verificar si ya existe en Supabase
                    const tiposExistentes = await window.dataService.fetchTiposUnidad();
                    const existeEnSupabase = tiposExistentes.some(tipo => 
                        tipo.nombre.toLowerCase() === nombre.toLowerCase()
                    );
                    
                    if (existeEnSupabase) {
                        mostrarAlerta('Ya existe un tipo de veh√≠culo con ese nombre en Supabase', 'warning');
                        return;
                    }
                    
                    // Agregar nuevo tipo de veh√≠culo a Supabase
                    await window.dataService.upsertTipoUnidad(nombre, `Tipo de veh√≠culo: ${nombre}`);
                    almacenInsumos[nombre] = {};
                    console.log(`‚úÖ Nuevo tipo de veh√≠culo agregado: ${nombre}`);
                    mostrarAlerta(`Tipo de veh√≠culo "${nombre}" agregado exitosamente`, 'success');
                    
                } else if (tipoActualAgregando === 'solucion') {
                    // Verificar si ya existe en Supabase
                    const tiposExistentes = await window.dataService.fetchTiposSolucion();
                    const existeEnSupabase = tiposExistentes.some(tipo => 
                        tipo.nombre.toLowerCase() === nombre.toLowerCase()
                    );
                    
                    if (existeEnSupabase) {
                        mostrarAlerta('Ya existe un tipo de soluci√≥n con ese nombre en Supabase', 'warning');
                        return;
                    }
                    
                    // Agregar nuevo tipo de soluci√≥n a Supabase
                    await window.dataService.upsertTipoSolucion(nombre, `Tipo de soluci√≥n: ${nombre}`, 'General');
                    console.log(`‚úÖ Nuevo tipo de soluci√≥n agregado: ${nombre}`);
                    mostrarAlerta(`Tipo de soluci√≥n "${nombre}" agregado exitosamente. Se agregar√° cuando crees una nueva combinaci√≥n.`, 'success');
                }

                // Guardar cambios
                if (modoCentralizado) {
                    // En modo centralizado, actualizar Supabase
                    await actualizarAlmacenEnSupabase();
                } else {
                    // En modo localStorage
                    localStorage.setItem('almacen_insumos', JSON.stringify(almacenInsumos));
                }

                // Actualizar la interfaz
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                // Actualizar las listas en el modal de nueva combinaci√≥n
                await actualizarListasEnModalNuevaCombinacion();
                
                // Si estamos en el modal de nueva combinaci√≥n, actualizar el select correspondiente
                if (tipoActualAgregando === 'vehiculo') {
                    const selectUnidad = document.getElementById('nuevoTipoUnidad');
                    if (selectUnidad) {
                        selectUnidad.value = nombre;
                    }
                } else if (tipoActualAgregando === 'solucion') {
                    const selectSolucion = document.getElementById('nuevoTipoSolucion');
                    if (selectSolucion) {
                        selectSolucion.value = nombre;
                    }
                }
                
                // Forzar actualizaci√≥n adicional despu√©s de un breve delay
                setTimeout(async () => {
                    await actualizarListasEnModalNuevaCombinacion();
                }, 200);
                
                // Cerrar modal
                document.getElementById('nuevoTipoNombre').blur();
                bootstrap.Modal.getInstance(document.getElementById('modalNuevoTipo')).hide();
                
            } catch (error) {
                console.error('‚ùå Error guardando nuevo tipo:', error);
                mostrarAlerta('Error al guardar el nuevo tipo', 'danger');
            }
        }

        async function guardarNuevoInsumo() {
            const nombre = document.getElementById('nuevoInsumoNombre').value.trim();
            const categoria = document.getElementById('nuevoInsumoCategoria').value;
            
            if (!nombre) {
                mostrarAlerta('Por favor ingrese un nombre para el nuevo insumo', 'warning');
                return;
            }

            try {
                // Verificar si ya existe en Supabase
                const tiposExistentes = await window.dataService.fetchTiposInsumo();
                const existeEnSupabase = tiposExistentes.some(tipo => 
                    tipo.nombre.toLowerCase() === nombre.toLowerCase()
                );
                
                if (existeEnSupabase) {
                    mostrarAlerta('Ya existe un insumo con ese nombre en Supabase', 'warning');
                    return;
                }

                // Agregar nuevo insumo a Supabase
                await window.dataService.upsertTipoInsumo(nombre, `Tipo de insumo: ${nombre}`, categoria || 'General', 'piezas');
                
                // Agregar a la lista de insumos (actualizar la constante)
                listaInsumos.push(nombre);
                listaInsumos.sort(); // Mantener ordenado
                
                console.log(`‚úÖ Nuevo insumo agregado: ${nombre}`);
                mostrarAlerta(`Insumo "${nombre}" agregado exitosamente`, 'success');
                
                // Actualizar la interfaz
                await cargarFiltros();
                cargarTablaAlmacen();
                await actualizarEstadisticas();
                
                // Actualizar las listas en el modal de nueva combinaci√≥n
                await actualizarListasEnModalNuevaCombinacion();
                
                // Forzar actualizaci√≥n adicional despu√©s de un breve delay
                setTimeout(async () => {
                    await actualizarListasEnModalNuevaCombinacion();
                }, 200);
                
                // Cerrar modal
                document.getElementById('nuevoInsumoNombre').blur();
                bootstrap.Modal.getInstance(document.getElementById('modalNuevoInsumo')).hide();
                
            } catch (error) {
                console.error('‚ùå Error guardando nuevo insumo:', error);
                mostrarAlerta('Error al guardar el nuevo insumo', 'danger');
            }
        }

        async function sincronizarTiposConModulos(tipo, nombre) {
            try {
                // Ya no necesitamos sincronizar con localStorage
                // Los tipos se guardan directamente en las tablas de Supabase
                console.log(`‚úÖ Tipo ${tipo} "${nombre}" guardado en Supabase`);
                
            } catch (error) {
                console.error('‚ùå Error sincronizando tipos:', error);
            }
        }

        // Funci√≥n para limpiar soluciones duplicadas (ya no necesaria con Supabase)
        function limpiarSolucionesDuplicadas() {
            // Ya no necesitamos limpiar duplicados porque usamos Supabase
            console.log('‚úÖ Usando Supabase - no se necesitan limpiezas de duplicados');
        }

        async function actualizarListasEnModalNuevaCombinacion() {
            try {
                console.log('üîÑ Actualizando listas desde Supabase...');
                
                // Cargar tipos desde las nuevas tablas de Supabase
                const [tiposUnidad, tiposSolucion, tiposInsumo] = await Promise.all([
                    window.dataService.fetchTiposUnidad(),
                    window.dataService.fetchTiposSolucion(),
                    window.dataService.fetchTiposInsumo()
                ]);
                
                // Extraer solo los nombres de los tipos
                const nombresUnidad = tiposUnidad.map(t => t.nombre).sort();
                const nombresSolucion = tiposSolucion.map(t => t.nombre).sort();
                const nombresInsumo = tiposInsumo.map(t => t.nombre).sort();
                
                console.log('üîç DEBUG: Tipos de unidad desde Supabase:', nombresUnidad);
                console.log('üîç DEBUG: Tipos de soluci√≥n desde Supabase:', nombresSolucion);
                console.log('üîç DEBUG: Tipos de insumo desde Supabase:', nombresInsumo);
                
                // Actualizar lista de tipos de veh√≠culo
                const selectUnidad = document.getElementById('nuevoTipoUnidad');
                if (selectUnidad) {
                    selectUnidad.innerHTML = '<option value="">Seleccionar tipo de unidad...</option>' + 
                        nombresUnidad.map(t => `<option value="${t}">${t}</option>`).join('');
                    console.log('‚úÖ Select unidad actualizado con', nombresUnidad.length, 'opciones');
                } else {
                    console.warn('‚ö†Ô∏è Select unidad no encontrado');
                }
                
                // Actualizar lista de tipos de soluci√≥n
                const selectSolucion = document.getElementById('nuevoTipoSolucion');
                if (selectSolucion) {
                    selectSolucion.innerHTML = '<option value="">Seleccionar tipo de soluci√≥n...</option>' + 
                        nombresSolucion.map(t => `<option value="${t}">${t}</option>`).join('');
                    console.log('‚úÖ Select soluci√≥n actualizado con', nombresSolucion.length, 'opciones');
                } else {
                    console.warn('‚ö†Ô∏è Select soluci√≥n no encontrado');
                }
                
                // Actualizar lista de insumos
                listaInsumos = nombresInsumo;
                console.log('‚úÖ Lista de insumos actualizada con', listaInsumos.length, 'elementos');
                
                // Actualizar lista de insumos en todos los selects existentes
                console.log('üîç DEBUG: Lista de insumos actual:', listaInsumos);
                const contenedorInsumos = document.getElementById('nuevoInsumos');
                if (contenedorInsumos) {
                    const selects = contenedorInsumos.querySelectorAll('select');
                    console.log('üîç DEBUG: Selects de insumos encontrados:', selects.length);
                    selects.forEach((select, index) => {
                        const valorActual = select.value;
                        select.innerHTML = '<option value="">Seleccionar insumo...</option>' + 
                            listaInsumos.map(insumo => `<option value="${insumo}">${insumo}</option>`).join('');
                        // Mantener el valor seleccionado si a√∫n existe
                        if (valorActual && listaInsumos.includes(valorActual)) {
                            select.value = valorActual;
                        }
                        console.log(`üîç DEBUG: Select ${index} actualizado con ${listaInsumos.length} insumos`);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Contenedor de insumos no encontrado');
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando listas desde Supabase:', error);
                // Fallback a localStorage si hay error
                console.log('üîÑ Usando fallback a localStorage...');
                const tiposGlobales = JSON.parse(localStorage.getItem('tipos_globales') || '{"vehiculos":[],"soluciones":[],"insumos":[]}');
                
                // Actualizar con datos de localStorage como fallback
                const selectUnidad = document.getElementById('nuevoTipoUnidad');
                if (selectUnidad) {
                    const tiposUnidad = [...new Set([...Object.keys(almacenInsumos), ...(tiposGlobales.vehiculos || [])])].sort();
                    selectUnidad.innerHTML = '<option value="">Seleccionar tipo de unidad...</option>' + 
                        tiposUnidad.map(t => `<option value="${t}">${t}</option>`).join('');
                }
                
                const selectSolucion = document.getElementById('nuevoTipoSolucion');
                if (selectSolucion) {
                    const tiposSolucion = [...new Set([...(tiposGlobales.soluciones || [])])].sort();
                    selectSolucion.innerHTML = '<option value="">Seleccionar tipo de soluci√≥n...</option>' + 
                        tiposSolucion.map(t => `<option value="${t}">${t}</option>`).join('');
                }
                
                listaInsumos = [...(tiposGlobales.insumos || [])];
            }
        }

        async function actualizarAlmacenEnSupabase() {
            try {
                // Actualizar todas las combinaciones en Supabase
                const tareas = [];
                for (const [tipoUnidad, soluciones] of Object.entries(almacenInsumos)) {
                    // Si el tipo de veh√≠culo est√° vac√≠o, crear una entrada b√°sica
                    if (Object.keys(soluciones).length === 0) {
                        const id = `${tipoUnidad}::_placeholder`;
                        tareas.push(window.dataService.upsertAlmacenInsumoById(id, {
                            id,
                            tipoUnidad,
                            tipoSolucion: '_placeholder',
                            insumos: {},
                        }));
                    } else {
                        // Procesar soluciones existentes
                        for (const [tipoSolucion, insumos] of Object.entries(soluciones)) {
                            const id = `${tipoUnidad}::${tipoSolucion}`;
                            tareas.push(window.dataService.upsertAlmacenInsumoById(id, {
                                id,
                                tipoUnidad,
                                tipoSolucion,
                                insumos: insumos || {},
                            }));
                        }
                    }
                }
                
                // Ejecutar en lotes de 25
                for (let i = 0; i < tareas.length; i += 25) {
                    const slice = tareas.slice(i, i + 25);
                    await Promise.all(slice);
                }
                
                console.log('‚úÖ Almac√©n actualizado en Supabase');
            } catch (error) {
                console.error('‚ùå Error actualizando almac√©n en Supabase:', error);
                throw error;
            }
        }

        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // ============================================
        // FUNCIONES DE MIGRACI√ìN A TABLAS SEPARADAS
        // ============================================
        
        async function migrarATablasSeparadas() {
            console.log('üöÄ Iniciando migraci√≥n a tablas separadas...');
            
            try {
                // Verificar que dataService est√© disponible
                if (!window.dataService || !window.dataService.client) {
                    console.error('‚ùå dataService no est√° disponible');
                    mostrarAlerta('Error: dataService no est√° disponible', 'danger');
                    return false;
                }
                
                // 1. Obtener tipos existentes de localStorage
                const tiposGlobales = JSON.parse(localStorage.getItem('tipos_globales') || '{"vehiculos":[],"soluciones":[],"insumos":[]}');
                
                console.log('üìã Tipos encontrados en localStorage:', tiposGlobales);
                
                // 2. Migrar tipos de veh√≠culo
                console.log('üöó Migrando tipos de veh√≠culo...');
                for (const vehiculo of tiposGlobales.vehiculos || []) {
                    if (vehiculo && vehiculo.trim()) {
                        await window.dataService.upsertTipoUnidad(vehiculo.trim(), `Tipo de veh√≠culo: ${vehiculo}`);
                        console.log(`‚úÖ Veh√≠culo migrado: ${vehiculo}`);
                    }
                }
                
                // 3. Migrar tipos de soluci√≥n
                console.log('üîß Migrando tipos de soluci√≥n...');
                for (const solucion of tiposGlobales.soluciones || []) {
                    if (solucion && solucion.trim()) {
                        await window.dataService.upsertTipoSolucion(solucion.trim(), `Tipo de soluci√≥n: ${solucion}`, 'General');
                        console.log(`‚úÖ Soluci√≥n migrada: ${solucion}`);
                    }
                }
                
                // 4. Migrar tipos de insumo
                console.log('üì¶ Migrando tipos de insumo...');
                for (const insumo of tiposGlobales.insumos || []) {
                    if (insumo && insumo.trim()) {
                        await window.dataService.upsertTipoInsumo(insumo.trim(), `Tipo de insumo: ${insumo}`, 'General', 'piezas');
                        console.log(`‚úÖ Insumo migrado: ${insumo}`);
                    }
                }
                
                // 5. Verificar migraci√≥n
                console.log('üîç Verificando migraci√≥n...');
                const vehiculosMigrados = await window.dataService.fetchTiposUnidad();
                const solucionesMigradas = await window.dataService.fetchTiposSolucion();
                const insumosMigrados = await window.dataService.fetchTiposInsumo();
                
                console.log(`‚úÖ Veh√≠culos migrados: ${vehiculosMigrados.length}`);
                console.log(`‚úÖ Soluciones migradas: ${solucionesMigradas.length}`);
                console.log(`‚úÖ Insumos migrados: ${insumosMigrados.length}`);
                
                // 6. Limpiar localStorage (opcional)
                const limpiar = confirm('¬øDeseas limpiar los tipos_globales de localStorage? (Recomendado despu√©s de la migraci√≥n)');
                if (limpiar) {
                    localStorage.removeItem('tipos_globales');
                    console.log('üßπ localStorage limpiado');
                }
                
                mostrarAlerta('‚úÖ Migraci√≥n completada exitosamente. Refresca la p√°gina para usar las nuevas tablas.', 'success');
                console.log('‚úÖ Migraci√≥n completada exitosamente');
                console.log('üîÑ Refresca la p√°gina para usar las nuevas tablas');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error durante la migraci√≥n:', error);
                mostrarAlerta('‚ùå Error durante la migraci√≥n: ' + error.message, 'danger');
                return false;
            }
        }

        // Funci√≥n para probar las nuevas tablas
        async function probarTablasSeparadas() {
            console.log('üß™ Probando tablas separadas...');
            
            try {
                // Probar fetch de cada tabla
                const vehiculos = await window.dataService.fetchTiposUnidad();
                const soluciones = await window.dataService.fetchTiposSolucion();
                const insumos = await window.dataService.fetchTiposInsumo();
                
                console.log('üìä Resultados:');
                console.log(`- Veh√≠culos: ${vehiculos.length} registros`);
                console.log(`- Soluciones: ${soluciones.length} registros`);
                console.log(`- Insumos: ${insumos.length} registros`);
                
                // Mostrar algunos ejemplos
                if (vehiculos.length > 0) {
                    console.log('üöó Ejemplo de veh√≠culo:', vehiculos[0]);
                }
                if (soluciones.length > 0) {
                    console.log('üîß Ejemplo de soluci√≥n:', soluciones[0]);
                }
                if (insumos.length > 0) {
                    console.log('üì¶ Ejemplo de insumo:', insumos[0]);
                }
                
                mostrarAlerta(`‚úÖ Prueba completada: ${vehiculos.length} veh√≠culos, ${soluciones.length} soluciones, ${insumos.length} insumos`, 'success');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error probando tablas:', error);
                mostrarAlerta('‚ùå Error probando tablas: ' + error.message, 'danger');
                return false;
            }
        }

        // Auto-ejecutar migraci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si ya se migr√≥
            const migracionCompletada = localStorage.getItem('migracion_tablas_separadas');
            if (!migracionCompletada) {
                console.log('üîß Funciones de migraci√≥n disponibles:');
                console.log('1. migrarATablasSeparadas() - Migra datos de localStorage a las nuevas tablas');
                console.log('2. probarTablasSeparadas() - Prueba que las tablas funcionen correctamente');
                console.log('');
                console.log('üí° Ejecuta: migrarATablasSeparadas() para comenzar la migraci√≥n');
            }
        });
    </script>
</body>
</html>
